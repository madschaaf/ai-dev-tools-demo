const appContext = require('@ebay/app-context-ebay');
const env = require('@ebay/environment-ebay');
const util = require('util');

function getClusterId() {
    const host = process.env.MACHINE_NAME;
    if (host) {
        // we expect a hostname to look something like this:
        // "rnosearchsvc-wdv8j-tess0025.stratus.rno.ebay.com"
        // or "slcyourappname-1-kxl2f.a.140.tess.io"
        const regex = host.includes('-tess') ? /-tess(\d+)\./ : /.*\.(\d+)\.tess\.io/;
        const matches = host.match(regex) || [];
        return matches.length > 0 && parseInt(matches[1]);
    }
}

function getTracingEndpoint(endpoints) {
    if (process.env.TRACING_ENDPOINT) {
        return process.env.TRACING_ENDPOINT;
    }

    if (env.isDev()) {
        return endpoints.default;
    }

    let vpc = appContext.vpc?.toLowerCase();
    if (vpc === 'pci' || vpc === 'rnpci' || vpc === 'tcop' || vpc === 'tcp') {
        if (vpc === 'tcp') {
            vpc = 'tcop';
        }
        return endpoints.secure.includes('%s') ? util.format(endpoints.secure, vpc) : endpoints.secure;
    }

    const clusterId = process.env.TESS_CLUSTER_ID || getClusterId();
    if (clusterId) {
        return endpoints.default.includes('%s') ? util.format(endpoints.default, clusterId) : endpoints.default;
    }
    return;
}

module.exports.getClusterId = getClusterId;
module.exports.getTracingEndpoint = getTracingEndpoint;
