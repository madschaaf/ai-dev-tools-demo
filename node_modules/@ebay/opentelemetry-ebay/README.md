# @ebay/opentelemetry-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/opentelemetry-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/opentelemetry-ebay /job/master) 
[![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/opentelemetry-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/opentelemetry-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/opentelemetry-ebay)](http://sonar/dashboard/index?id=opentelemetry-ebay)

Open telemetry standard open tracing implementation using Jaeger as backend.

## Usage

```shell
$ npm install @ebay/opentelemetry-ebay
```

```js
const { ROOT_CONTEXT, trace, context, SpanKind, SpanStatusCode, propagation } = require('@opentelemetry/api');
const tracing = require('@ebay/opentelemetry-ebay');

// express middleware
function middleware(req, res, next) {
    // will return tracer only when it is enabled
    // Note: at the start up it may not return enable till config is fully loaded which is async.
    //   In case you are not ok with this, you can use tracing.isReady async property
    if (tracing.isEnabled()) {
        const rootCtx = propagation.extract(ROOT_CONTEXT, req.headers);
        const tracer = tracing.getTracer();
        const span = tracer.startSpan('handleRequest', {
            attributes
        }, propagation.extract(ROOT_CONTEXT, req.headers))
        const ctx = trace.setSpan(rootCtx, span);

        const closeSpan = Hoek.once((spanStatus, message) => {
            // set attributes
            // and complete
            span.end();
        });
        res.once('finish', () => closeSpan(SpanStatusCode.OK));
        res.once('close', () => closeSpan(SpanStatusCode.ERROR, 'ECONNRESET'));
        res.once('error', (err) => closeSpan(SpanStatusCode.ERROR, err.message));

        return context.with(ctx, next);
    }

    next();
}
```

## Finding out if the current request is sampled
```js
function doStuff(req, res) {
    if (req.otel.isRecording) {
        let traceId = req.otel.traceId;
        let spanId = req.otel.spanId;
        // whatever logging you want to tie to tracing
        // like Sherlock Events!
    }
}
```

## Standard configuration

By default OTEL is enabled in production with a small sample percent and all dev / staging / feature pool spans will be kept. View them on console.sherlock.io or console.dev.sherlock.io

For PCI/RNPCI C3, secure attribute is used, for all other VPC's default is used to evaluate endpoint.

```json
"tracing": {
    "enabled": true,
    "endpoints": {
        "default": "grpc://monitoring-trace-collector.istio-production.svc.%s.tess.io:4317",
        "secure": "grpc://trace-collector-%s.vip.ebay.com:443"
    } 
}
```

## Adding more instrumentation

```json
"tracing": {
    "enabled": true,
    "instrumentations": {
        "graphql": {
            "enabled": true,
            "module": "path:@opentelemetry/instrumentation-graphql",
            "constructorName": "GraphQLInstrumentation",
            "config": {
                "allowAttributes": true,
                "depth": 2,
                "mergeItems": true
            }
        }
    }
}
```

## Non-standard configuration
```javascript
const tracing = require('@ebay/opentelemetry-ebay');
...
app.use(tracing());
...
app.listen(8080);
```

## GraphQL support

The module provide @opentelemetry/instrumentation-graphql in case application needs it.
To activate it, please update application/config/config.json by adding a special flag for graphql instrument

```json
"tracing": {
    "enabled": true,
    "instrumentations": {
        "graphql": {
            "enabled": true
        }
    }
}
```
