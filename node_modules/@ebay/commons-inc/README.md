# commons-inc

[![Build Status](https://ci.altus.vip.ebay.com/ebaykrakn-4389/buildStatus/icon?job=commons-inc)](https://ci.altus.vip.ebay.com/ebaykrakn-4389/job/commons-inc) [![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/commons-inc.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/commons-inc)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/commons-inc)](http://sonar/dashboard/index?id=commons-inc)


The module provides middleware and general context metadata for app.
This module is called from [commons-ebay](https://github.corp.ebay.com/nodejs/commons-ebay).

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/commons-inc/blob/master/CHANGELOG.md#changelog)

## Install

```
  npm install commons-inc --save
```

Note that middleware setup is typically handled for you in a Unified Node.js
application by the config/middleware.json file.

## API

If you need to manually configure this module to your Express middleware stack:

Middleware:
```javascript
app.use(require('commons-inc').commons({
    // configure cal logger settings
    cal: {
        type: 'cal',  // type of logger, possible: cal, console
        formatter: 'cal', // formatters for the logger: cal, silent
        settings: {
            host: 'cal.vip.qa.ebay.com',
            environment: 'core_staging',
            poolname: 'nodetest'
        }
    }
}));
```
## Custom server error 500
By default, setting the error code to 500 causes a redirect to http://pages.ebay.com/messages/page_not_responding.html.  You can prevent this behavior setting ```res.customPageError = true ``` so that you can supply a custom error page.

For example,

```javascript
'use strict';

const errorTemplate = require('marko').load(require.resolve('./error.marko'));

function serverErrorView(req, res, next) {
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate, max-age=0');
    res.setHeader('Expires', '0');
    res.status(500);

    const model = {
        prevModule: req.query ? req.query.path : ''
    };

    res.customPageError = true;

    errorTemplate.render(model, res);
    return true;
}

module.exports = function() {
    return serverErrorView;
};

module.exports.serverErrorView = serverErrorView;

```

## COS Headers
You can now access the COS headers on the client side using following methods, we have filtered out the sensitive data from the headers like userId and deviceId.

```javascript:
X-EBAY-C-ENDUSERCTX: ```window.cosHeadersInfo.getEndUserContext()```
X-EBAY-C-TRACKING:```window.cosHeadersInfo.getTrackingHeaders()```

In case your app page is cached by CDN, you must use the route flag cosHeadersInfo set to false to suppress it to avoid leaking user data.

routes.json
```JSON
[
    {
        "route": "GET / => ./src/pages/index",
        "pageName":"DefaultPage",
        "cosHeadersInfo": false
    }
]
```

## OpenFeature Flag

We have added an OpenFeature flag to remove the `X-EBAY-C-ENDUSERCTX` header from the COS headers. 
If an application needs to opt out of `X-EBAY-C-ENDUSERCTX`, they need to reach out to the `#nodejs` 
team so that we can allowlist their application in the Touchstone feature flag. 
By default, the flag is disabled, and we can enable it based on the application. 
In case of an issue, we can mark the flag as false for the specific application without needing to restart the application.

