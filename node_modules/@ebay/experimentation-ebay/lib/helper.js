'use strict';

var extend = require('extend');
var svcclient = require('@ebay/service-client-ebay');
var logger = require('@ebay/logging-inc').logger('experimentation-ebay/helper');

module.exports = {

    mergeRequestParams: function mergeRequestParams(defaultParams, configParams, params) {
        // Override default values with values in config file
        extend(true, defaultParams, configParams && configParams.genericParams);
        extend(true, defaultParams.contextParams, configParams && configParams.contextualParams);
        extend(true, defaultParams.filterCriteria, configParams && configParams.filterCriteria);

        // Override the default/global configs with request specific params
        if (params && typeof params === 'object') {
            extend(true, defaultParams, params);
        }

        return defaultParams;
    },

    invokeExperimentationSvc: function invokeExperimentationSvc(request, callback) {
        var provider = svcclient.context({}).getClient('experimentation');

        logger.debug('EP.svc.request', request);
        provider.post({
            body: JSON.stringify(request || {})
        }).end(function(error, response) {
            if (error) {
                return callback(error);
            }
            if (response.statusCode < 200) {
                error = new Error('Unexpected response from the experiementation service, body: ' +
                    (response.body ? response.body.toString() : 'no body'));
                error.statusCode = response.statusCode;
                logger.error(error);
                return callback(error);
            }
            logger.debug('EP.svc.response', response.body);

            callback(error, response.body);
        });
    },

    isCookieHeader: function isCookieHeader(headerName) {
        return /cookies/i.test(headerName) || /cookie/i.test(headerName);
    }
};
