
const { Metrics, namespaces } = require('@ebay/prometheus-ebay');

const EP_PROMETHEUS_NAMESPACE = 'epadaptor';
const EP_API_REQUESTS_DURATION_METRIC_NAME =
    'ep_experimentation_requests_duration_ns';
const EP_API_REQUESTS_COUNT_METRIC_NAME = 'nodejs_experimentation_requests_count';
const STATUS_LABEL_KEY = 'status';

// See Raptor-experimentation-component MicrometerExperimentationClientMetrics for reference
const DEFAULT_MED_BUCKETS = [
    0.001, 0.006, 0.015, 0.025, 0.045, 0.055, 0.065, 0.1, 6,
];
class MetricsPublisher {

    constructor() {
        this.metrics;
        this.usageCounter;
        this.apiLatencySla;
        if (MetricsPublisher._instance) {
            return MetricsPublisher._instance;
        }
        MetricsPublisher._instance = this;
        const instance = namespaces[EP_PROMETHEUS_NAMESPACE];
        if (instance) {
            this.metrics = instance;

        } else {
            this.metrics = new Metrics(EP_PROMETHEUS_NAMESPACE);
        }
        this.usageCounter = this.metrics.createCounter(
            EP_API_REQUESTS_COUNT_METRIC_NAME,
            'Counts the usage of experimentation-ebay module',
            [STATUS_LABEL_KEY],
        );

        this.apiLatencySla = this.metrics.createHistogram(
            EP_API_REQUESTS_DURATION_METRIC_NAME,
            'ep_api_requests_duration_ns_seconds histogram',
            ['epApiName'],
            DEFAULT_MED_BUCKETS,
        );
    }
}
module.exports = new MetricsPublisher();
