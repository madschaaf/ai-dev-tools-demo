'use strict';

var Cal = require('@ebay/cal');
var logger = require('@ebay/logging-inc').logger('experimentation-ebay/bpool');

module.exports = function bpoolHandler(requestContext, callback) {

    // Add tracking data to soj
    var trackingData = requestContext.getTrackingGuidFlags();
    if (trackingData) {
        requestContext.deserializeTrackingHeader(trackingData);
        logger.debug('Tracking data: %s deserialized', trackingData);
    }

    var experimentId = requestContext.getProxyExperiement();
    var treatmentId = requestContext.getProxyTreatment();

    logger.debug('Data from BPool headers: Experiment ID: %s,Treatment ID: %s',
		experimentId, treatmentId);

    if (experimentId && treatmentId) {
        requestContext.trackServedTreatment({
            treatmentId: treatmentId,
            experimentId: experimentId
        });
        requestContext.setResponseHeader('X-eBay-Served-Treatments',
            encodeURIComponent(treatmentId));
        // TODO: send COS reponse headers for service context
	}

    // handle response flow
    requestContext.onResponse(function handleResponse(cb) {
        // get the experimentId and treatmentId of the Proxy experiment and
    	// add it to sojourner

        Cal.createTransaction('EPProxy',
            requestContext.getCommand() + '-EPProxy').complete();
        cb();
    });

    callback();
};
