const fs = require('fs');
const path = require('path');
const Metrics = require('./metrics');

class Build extends Metrics {
    postMetrics(commandType) {
        const metrics = this.getCommonMetrics();
        let telemetry = {};

        try {
            const fileName = commandType ? `${commandType}.json` : 'telemetry.json';
            telemetry = require(path.resolve(process.cwd(), fileName));
            fs.unlinkSync(path.join(process.cwd(), fileName));
            metrics.status = 'ok';
        } catch(err) {
            metrics.status = 'Missing telemetry.json file.';
        }

        if(!telemetry.startTime) {
            telemetry.startTime = Date.now();
        }
        if(commandType && process.env.CI_ONLY_BUILD === 'true') {
            commandType = commandType+'-ci-only';
        }

        const eventType = commandType || process.env.npm_lifecycle_event || 'postinstall';
        const type = eventType.replace('post','');
        metrics.type = type;
        metrics.startTime = telemetry.startTime;
        metrics.endTime = Date.now();

        // Add the new fields
        metrics.durationTelemetryScripts = telemetry.durationTelemetryScripts;
        metrics.durationDependencyDownload = telemetry.durationDependencyDownload;
        metrics.durationBuild = telemetry.durationBuild;
        metrics.durationSwuCheck = telemetry.durationSwuCheck;
        metrics.durationLint = telemetry.durationLint;
        metrics.durationTest = telemetry.durationTest;
        metrics.durationCoverage = telemetry.durationCoverage;
        metrics.durationE2ETest = telemetry.durationE2ETest;
        metrics.durationCIReporting = telemetry.durationCIReporting;
        metrics.durationCustomScript = telemetry.durationCustomScript;
        metrics.durationDeploymentBundle = telemetry.durationDeploymentBundle;
        metrics.durationTotal = telemetry.durationTotal;
        metrics.durationTotalNoTest = telemetry.durationTotalNoTest;

        metrics.totalTimeInSec = (metrics.endTime - telemetry.startTime)/1000;
        this.publishToES(metrics);
    }
}

module.exports = Build;
