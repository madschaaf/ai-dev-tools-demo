# iaf-ebay 
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=iaf-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/iaf-ebay)   [![security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/iaf-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/iaf-ebay/)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/iaf-ebay)](http://sonar/dashboard/index?id=iaf-ebay)


This module provides support for integrating with the Identity Assertion Framework (IAF) service and should be used to call IAF-protected services. This module provides an API for generating IAF tokens that can be passed to IAF-protected services.

It also provides support for services so it can validate IAF tokens passed by clients.

IAF tokens can be generated to authenticate the calling application and can, optionally, be generated to also identify a previously authenticated user.

This module exposes plain API as well as request based one that depends on ebay-request-context module to set logged-in user information into request.

For more details on the IAF framework, please see [Wiki: IAF (Identity Assertion Framework)](https://wiki.vip.corp.ebay.com/pages/viewpage.action?pageId=59935388)

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/iaf-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

```
npm install iaf-ebay --save
```

# Usage

To generate a token that only identifies the current application, the following API should be used:

```javascript
req.ebay.iaf.getAppToken(function(error, token){
    if(error){
        console.log(error);
    } else {
        console.log(token);
    }
});
```

To generate a token that identifies both the current application and the authenticated user associated with an incoming request, the following API should be used:

```javascript
req.ebay.iaf.getUserToken(function(error, token){

});

```

It is also possible to generate a token that is scoped to a specific service as shown in the following usage:

```javascript
req.ebay.iaf.getAppToken({ targetService: 'PAYPAL'}, function(error, token){

});

// Or for a user token:
req.ebay.iaf.getUserToken({ targetService: 'PAYPAL'}, function(error, token){

});
```

Note, if there is no information of logged-in user in the request, null will be resolved.

By default this module will get IAF token by value, if you'd like to retrieve IAF service by reference, do following :

```javascript
req.ebay.iaf.getAppToken({ targetService: 'PAYPAL' , byReference : true}, function(error, token){

});

// Or for a user token:
req.ebay.iaf.getUserToken( { targetService: 'PAYPAL' , byReference : true}, function(error, token){

});

```

# API specifications

You can access plain API via require('@ebay/iaf-ebay').iaf

<a name="getAppToken" />

### getAppToken(options, callback)

get the Application Token.

__Arguments__
* `options` - The options Object. options object has the following keys:
    * `targetService` - The name of the relying party for which the security token is requested. This may help in determining the security policy specific to that relying party to mint the token.
    * `byReference` - If true, requests security soken by references and by value if false. Default is security token by value. The kind of token returned is determined based on domain policies.
    * `consumerId` - consumer id. By default, it will use current application id.
    * `secret` - secret. By default, it will use current application id.
    * `attributeRequest` - custom attributes. Format as an array of objects
        * `name` - Name of the attribute
        * `nameFormat` - [OPTIONAL] Format of the data. By default, it will be String
        * `friendlyName` - [OPTIONAL] Default value is ''
        * `value` - Array of values for the custom attribute
* `callback(err, token, meta)` - A callback which is called when function getAppToken has finished, or an error occurs.


__Examples__


```js
req.ebay.iaf.getAppToken(options, function(error, token, meta) {
    console.log('token expires on: ', new Date(meta.expirationDate));
});
```

---------------------------------------

<a name="getUserToken" />

### getUserToken(options, callback)

get the user Token

__Arguments__
* `options` - The options Object. options object has the following keys:
    * `targetService` - The name of the relying party for which the security token is requested. This may help in determining the security policy specific to that relying party to mint the token.
    * `byReference` - If true, requests security soken by references and by value if false. Default is security token by value. The kind of token returned is determined based on domain policies.
    * `userId` - user id. By default, it will use user id from the current request .
    * `accountId` - account id. By default, it will use user account id from the current request.
    * `consumerId` - consumer id. By default, it will use current application id.
    * `secret` - secret. By default, it will use current application id.
    * `attributeRequest` - custom attributes. Format as an array of objects
        * `name` - Name of the attribute
        * `nameFormat` - [OPTIONAL] Format of the data. By default, it will be String
        * `friendlyName` - [OPTIONAL] Default value is ''
        * `value` - Array of values for the custom attribute
* `callback(err, token, meta)` - A callback which is called when function getUserToken has finished, or an error occurs.



__Examples__


```js
req.ebay.iaf.getUserToken({ targetService: 'PAYPAL' , byReference : true}, function(error, token, meta) {
    console.log('token expires on: ', new Date(meta.expirationDate));
    console.log('token attributes: ', meta.attributes);
});
```
---------------------------------------

<a name="validateUserToken" />

### validateUserToken(options | token, callback)

validate the user Token

__Arguments__
* `options` - The options object or token. options object has the following keys:
    * `token` - token to validate
    * `consumerId` - The application consumerId.
    * `secret` - The application secret.
* `callback(err, token, meta)` - A callback which is called when function validateUserToken has finished, or an error occurs.

__Examples__


```js
req.ebay.iaf.validateUserToken(token, function(error, token, meta) {
    console.log('token expires on: ', new Date(meta.expirationDate));    
    console.log('token attributes: ', meta.attributes);    
});
```
---------------------------------------

<a name="getSecurityTokenByRef" />

### getSecurityTokenByRef(options | reference, callback)

get token by reference

__Arguments__
* `options` - The options object or string reference. options object has the following keys:
    * `reference` - token reference
    * `consumerId` - The application consumerId.
    * `secret` - The application secret.
* `callback(err, token)` - A callback which is called when function getSecurityTokenByRef has finished, or an error occurs.

__Examples__


```js
req.ebay.iaf.getSecurityTokenByRef(reference, function(error, token) {

});
```

---------------------------------------

<a name="logout" />

### logout(options, callback)

Invalidate token

__Arguments__
* `options` - The options Object. options object has the following keys:
    * `userId` - user id. By default, it will use user id from the current request .
    * `accountId` - account id. By default, it will use user account id from the current request.
    * `consumerId` - consumer id. By default, it will use current application id.
    * `secret` - secret. By default, it will use current application id.
    * `domain` - domain. By default, it will be EBAYUSER
    * `reference` - token reference that needs to be invalidated
    * `requester` - requester attributes. The REQUESTER will be the SUBJECT from the IAF login request
        * `domain` - domain used for the creating the login token
        * `format` - format used for login token
        * `value` - value used to generate the login token
* `callback(err, res)` - A callback which is called when function logout has finished, or an error occurs.


__Examples__


```js
req.ebay.iaf.logout({
    consumerId: consumerId,
    secret: secret,
    domain: 'EBAYUSER',
    reference: tokenRef,
    userId: <userId>,
    accountId: <immutableId>,
    requester: {
        domain : 'EBAYAPP',
        format : 'USERNAME',
        value : consumerId
    }
}, function (err, res) {
    console.log(err, res);
});
```

---------------------------------------

<a name="authenticateUser" />

### authenticateUser(options, callback)

Authenticate User

__Arguments__
* `options` - The options Object. options object has the following keys:
    * `userId` - user id. By default, it will use user id from the current request .
    * `userSecret` - user secret. By default, it will use secret from the current request.
    * `consumerId` - consumer id. By default, it will use current application id.
    * `secret` - secret. By default, it will use current application id.    
	* `requestSecurityToken` - response will return user token if its true. By default, it will be false
* `callback(err, token, meta)` - A callback which is called when function getAuthenticateUser has finished, or an error occurs.



__Examples__


```js
req.ebay.iaf.getAuthenticateUser({ userId: 'iaf_test_1',userSecret: 'pa11word$',domain: 'COMMERCIALDIRECTUSER',requestSecurityToken:true}, function(error, token) {
    console.log('user token ', token);    
});
```

# Prerequisite & trouble shooting
<pre>
IAF service requires client application to login before calling its other api. So this module will try to read application id and secret for login IAF service.
Application secret is generated as part of metadata during application registration. So you need to first registration of your application. As for how to register your application , please reference use altus application creation.

If you failed to get app IAF token or user IAF token ( get null ), you should first check whether your application has been correctly registered.

To check whether your application has been successfully registered, you can:
  1) If you have admin privilege of config editor ( feel free to skip this step, if you don't have the privilege.)
     You can go to config editor to check whether your application is there:

     * For QA, please visit http://qa-configeditor.corp.ebay.com/cfgedit/login.html

     * For production, please visit http://cfgeditor/cfgedit/login.html

     * Please login config editor with your NT login and "raptormetadata" as "Domain" field ( note its default value is "E|ebay.com" or "E|qa.ebay.com")

     * After login, please click "Go" button and then all the application will be listed at left side, you can check whether your application is there by search your application name.

     * Under your application name, click the label "application" under it, the metadata details will be shown on the right side of the page.

     * Search for "parameters['stagingSecret']" field for QA, or "parameters['productionSecret']" field in your metadata.

  2) Go to AR to check whether your application metadata is there:

     * https://release.corp.ebay.com/release/asset/index.do

     * In the dropdown list, choose "Consumer" and input your application name to search

     * If your application has been successfully registered, it will be listed in the result, click "View" to view the details.

     * In the detailed table, click the "Credential.xml" link in "Consumer Credential File" field, the Credential.xml file will be downloaded.

     * Check this file to see whether your QA and produciton application secret is there:
     &lt;name&gt;production&lt;/name&gt;
        &lt;secret&gt;3d9c74a5-ff2f-410f-a0ee-4a863017bfef&lt;/secret&gt;
        &lt;status&gt;SUCCESS&lt;/status&gt;
        &lt;tokens&gt;
            &lt;iafToken&gt;v^1.1#i^1#I^2#f^0#p^1#d^2015-05-23T08:03:42.001Z#r^0#t^H4sIAAAAAAAAAKVUfUwbZRinUFCCjEX3QYzO5nBABnd937srvb7SLoWBNmFjG2zOJWNcr+/BSXvX3HtdwZmNYcIGjg0yt5iZGDBDtrgsmSbMLPNjS4xRMSMETTRmbkTpdCbb4pLxx0y8ltK1qGji/XN53+f3vM/v+T0foDsvf13vC733Cy2PZA93g+5siwUWgPy83IplOdlP5maBNIBluPvZbmtPzs1qIoaCYbQVk7CmEmzzbXBTIpZZl5OvkvkAB7gqnrL51AVAs+amJMiyAVHmOMj6q6SA37QTEsE+lRiiargpFkCOhpBmYTOECHCIZxkA4E7Kth3rRNFUE8IAytYZCqoEJQi4qYiuIk0kCkGqGMIEGRJq8m5sQCYShXXN0CQtSHkSdFEinJ7mv7S7SAjWDTMu5fF562ubqu1pr3iSCjQZohEhmadaLYBt28VgBC8dgCTQqCkiSZgQyu6Zj5D5KPIu0EiI7HfJgoN3Qt7JuVyAc/5/Ef+zCBki1mt6SDSW9o3fKAFaTkARVg3F6PpnLU0d/C9jyUieNpnOvg22+G9LRAwqsoJ1N1VX433Ju3kz5YnHxX6xiw6Jegc2wkFRwrRktlokhHUlgGRTHixwIs0LIkvzTr9A+zFfRUsOl+yCsl+GoiNJYj5SUvxFLGo1NaDE0ye2TZpRg81ccKbIADnSRDZBjWqj7pWNOFsT56CBg2a5ZiCkF8O+UNuI0a7Gq41Dpjy2xPHfS5nyNgxd8UcMnHphsSEhnzmZ4bASoBYbEx2abIRO4qbaDSOM7PZoNMpEOUbT2+wssB64AqB9x8aGJqkdh0QqBVf+Hp8OppVEJhI2vYiCjK6wSaXTbDozvtpGeSB0CYIrKXsmK8/i279cpKVszxyT1BQt7B5PVuKDPZaPQY/lornfgAAYWAnW5eVss+Y8VkIUAzOKKDMSYYjSpprDp2OmA3eFRUVHiAW8KzvPsj5wf0Vr2l4c3gWKU5sxPwcWpK1J8NRDSy4sWl0IOQhZCCHgeHYnKHlotcJV1hXojfKBY9tedMUKJ5n1efXHYnNvnQSFKZDFkptl7bFklY7tuXRhuqj0/OzA8D1h6vTg+faBR39Z3vfTuUJ8tWDs4IPdtu8OD54daRmor/YKc86ssu+PTpR/9fW7jY+feL30ucEzE6vrWq62f8ZcHxvfteNTp3BhcuaDV3/74svjfe/vu2UM0IqvLPZH9FTNymsHemfuRMiWofG2Gz+sRTX3KiYuVy5vXYVaRj4fGTk9d3L/Kcv+J478XtIw8+0rU3vFN2d3f3gjVmebevDMe2dv9n+z7/Kt1iP8Rbm3su9QVfHzv/bH6q5l3347NjoYaykaPzd7+PqdrSOjJyqF4jUfRRlye2xZxY9lezp6RofeOYhqVvZPNz99Zeju9M+Tdy+9dqbzk+ZDqmdv+Zr5Ov4JRBn4/bEGAAA=&lt;/iafToken&gt;
        &lt;/tokens&gt;
    &lt;/credential&gt;
    &lt;credential&gt;
        &lt;name&gt;staging&lt;/name&gt;
        &lt;secret&gt;d18d3f5e-b616-448c-a659-e6ced2f5fb2d&lt;/secret&gt;
        &lt;status&gt;SUCCESS&lt;/status&gt;
        &lt;tokens&gt;
            &lt;iafToken&gt;v^1.1#i^1#I^2#f^0#p^1#d^2015-05-23T08:03:43.730Z#r^0#t^H4sIAAAAAAAAAKVUXWgcVRTO/oZYYx9qrYjCMrUIaWf33rkzm53b7MAmsbiwaWo2xhoxcnf2bjLt7swy945JCrbbEFIfav2DVkRL9EnzIhQEfehDC6W0IuSl4oM+9CGmT0JBqD7p3cnudjZqFJyX4d7znXO+851zD2jE+wZWXlh50B/qDa82QCMcCsFdoC8eO/hYJPxUrAcEAKHVxrON6FLk3hAjtWodT1BWd2xGE/nRrKQrIA1UHWWQUkJITUuJvN0GTDrCTjRUgZVSWdNUPWOWhZ0xj+ZtxonNs5ICIJIhlBU4CSEGCKsoOYjAtJSYoi6zHFtAkkBKLNSqNsM+gazkuTZ2CLMYtkmNMsxNXMyNFbBA4rrrcMd0qpLh08V+Ojfgv7M7YYy6XOSVjHzuyEhxKBWIYrQUKHLCPdZ9GnHKNDFFqh7dOQHz0bjomSZlTEoZWxm6g+Jcm4YvMkwDmhlMq2UTlUyUHvz/Iv5nEbpEPOK4NcJ39m3eWGW54kMxtbnFF/9ZS6FD6QQ1eet0VDjnRxPN34seqVoVi7pZ6fnh3Cu5Y8cko5mXlsiiXCPuScrrVWJS2RSj5tWoa5VxBek6zSAiqxmiyOpgKSOXqJqWTU2v6GIIK5BoLRJbmVrib2Mx4thlq1k+Sxx1+DAVtdBukQHWAiIL0Lg97uYqvMlW4DQZaLKCJkEm2IxUu7cen7Ob3aY1IU/CP/57KzvenLtWyeO0E2G7wZcvK5F63SpL243+hLYGYYFlpTnO6ziVmp+fT86jpOPOphQQPXsNwNTxsULRnKM1InXg1t/jg2DZ8isxqfBiFuaLdUFlQQydyG/PSgbS01q7B92kjO23f7kIVJzqfiWdR9RePUaP/8GlUBYshXSx3kAGJOEhMBCPvBSNPLqfWZwmLVJJmizJrFlbvD2XJk/SxTqxXIx1pCvheCg3dE5bD6zF1dfAk53F2BeBuwJbEjz90BKDu/f1QwShAiEESEXTYP9DaxQ+EX38m/Am+Ghl96vfvvzHL31fh399f/3mOujvgEKhWE/0bCNuOfTCc2/+fvfO5vDYxMYNuPz28v3fTn1+4p3CTG7q49vhO70Hxg/+MH5gLXP6+u3ze9c+WBi9et44c0o6k7j16bmLM4f2DH218d3eS70fvnu1unw58vPpi59cmih8dt87HPtypv+Na88om7ON5Qs/fTG979balcLcvcOvDzy4+9bGZfT9I+/9uCXjn6NmcSMvBgAA&lt;/iafToken&gt;
        &lt;/tokens&gt;
    &lt;/credential&gt;

If you can't find your application, please register your application again. If still failed, please Altus team.
If you can't find your application secret, please contact : DL-eBay-App-Registration-Support &lt;DL-eBay-App-Registration-Support@ebay.com&gt;
</pre>

## Known Issues
Currently all app secret stored in AR / MDDF are only encoded instead of encrypted. So this module doesn't include the decryption logic to decode the app secret. However in the future raptor will encrypt its production app secret, so we need to decrypt them too in the future. The contact is:
Anand, Manju &lt;manand@paypal.com&gt;
