'use strict';

var assert = require('assert');
var utils = require('./fixtures/utils');

var Async = require('async');

var Iaf = require('../lib/iaf-request').Iaf;
var serviceValidation = require('./fixtures/service');

describe(__filename, function () {

    it('should get app token', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        iaf.getAppToken(function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(/^v\^/.test(token), 'app token must be returned');
            done();
        });
    });
    
    it('should get asac token', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        iaf.getAsacToken(function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(/^v\^/.test(token), 'app token must be returned');
            done();
        });
    });

    it('should fail to get app token, due to missing callback', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        try {
            iaf.getAppToken();
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should fail to get user token, due to missing callback', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        try {
            iaf.getUserToken();
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should fail to get token ref token, due to missing callback', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        try {
            iaf.getSecurityTokenByRef();
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should fail to authenticate token, due to missing callback', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        try {
            iaf.authenticateToken();
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should fail to authenticate request, due to missing callback', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        try {
            iaf.authenticateRequest();
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should get app token reference', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        iaf.getAppToken({
            byReference: true,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^1')>-1, true);
            done();
        });
    });

    it('should authenticate app token', function (done) {
        const req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        const iaf = new Iaf(req);

        const consumerId = 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2';
        const secret = '64d60917-d063-4d13-bdb6-a8b93c3b06f5';

        Async.waterfall([
            next => {
                iaf.getUserToken({
                    consumerId,
                    secret,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken',
                    attributeRequest : [
                        {
                            name : 'test1',
                            friendlyName : 'TESTING',
                            value : [1]
                        }
                    ]     
                }, function (err, token) {
                    if (err) {
                        return done(err);
                    }
                    next(null, token);
                });
            },

            (token) => {
                iaf.authenticateToken({
                    token: token,
                    includeAttributes: true,
                    consumerId,
                    secret,
                    targetService: 'ScopedToken'
                }, (err, userMeta, attributes) => {
                    try {
                        if (err) {
                            return done(err);
                        }
                        assert.ok(attributes.expirationDate);
                        assert.ok(attributes.attributes);
                        done();    
                    }
                    catch (err) {
                        done(err);
                    }
                });
            }
        ], done);
    });

    it('should get app token by reference', function (done) {
        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        var iaf = new Iaf(req);

        Async.waterfall([

            function requestAppTokenRef(next) {

                iaf.getAppToken({
                    byReference: true,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, tokenRef) {
                    next(err, tokenRef);
                });
            },

            function validateToken(tokenRef, next) {
              assert(tokenRef.indexOf('v^1.1')>-1, true);
              assert(tokenRef.indexOf('#r^1')>-1, true);
                next(null, tokenRef);
            },

            function getSecurityTokenByRef(tokenRef, next) {
                iaf.getSecurityTokenByRef({
                    reference: tokenRef
                }, function (err, token) {
                    next(err, token);
                });
            },

            function validateToken(token, next) {
              assert(token.indexOf('v^1.1')>-1, true);
              assert(token.indexOf('#r^0')>-1, true);
                next();
            }
        ], done);
    });

    it('should get public user token', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getJSPersistentUserId = function getJSPersistentUserId() {
            return 'us2014.q';
        };

        req.ebay.getPersistentAccountId = function getPersistentAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should get public user token, overwriting parameters', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getJSPersistentUserId = function getJSPersistentUserId() {
            return 'us2014.q';
        };

        req.ebay.getPersistentAccountId = function getPersistentAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken',
            userId: null
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should get user token', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getLevel1UserId = function getLevel1UserId() {
            return 'us2014.q';
        };

        req.ebay.getAccountId = function getAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'Hosted',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should get public user token reference, getUserToken', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getJSPersistentUserId = function getJSPersistentUserId() {
            return 'us2014.q';
        };

        req.ebay.getPersistentAccountId = function getPersistentAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            byReference: true,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^1')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should get user token reference, getUserToken', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getLevel1UserId = function getLevel1UserId() {
            return 'us2014.q';
        };

        req.ebay.getAccountId = function getAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            byReference: true,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'Hosted',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^1')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should fail due to missing user id, getUserToken', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getAccountId = function getAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            byReference: true,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'Hosted',
            targetService: 'ScopedToken'
        }, function (err) {
            assert.equal('userId must be provided', err.message);
            done();
        });

    });

    it('should fail due to missing account id, getUserToken', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getLevel1UserId = function getLevel1UserId() {
            return 'us2014.q';
        };

        var iaf = new Iaf(req);

        iaf.getUserToken({
            byReference: true,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'Hosted',
            targetService: 'ScopedToken'
        }, function (err) {
            assert.equal('accountId must be provided', err.message);
            done();
        });
    });

    // COMMERCIALDIRECTUSER is no longer valid domain
    it.skip('should return token for the given user', function (done) {

        var req = utils.injectRequest({
            appName: 'nodedemo1'
        });
        // make empty user and account id
        req.test = true;

        req.ebay.getLevel1UserId = function getLevel1UserId() {
            return 'us2014.q';
        };

        req.ebay.getAccountId = function getAccountId() {
            return 1264442622;
        };

        var iaf = new Iaf(req);
        iaf.authenticateUser({
          userId: 'iaf_test_1',
          userSecret: 'pa11word',
          domain: 'COMMERCIALDIRECTUSER',
          requestSecurityToken:true
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            done();
        });
    });

});
