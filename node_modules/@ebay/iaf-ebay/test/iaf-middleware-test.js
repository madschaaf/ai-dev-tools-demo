'use strict';

var iaf = require('../'),
    assert = require('chai').assert,
    configBean = require('@ebay/config-bean-ebay'),
    utils = require('./fixtures/utils');

describe(__filename, function () {

    before(function(){
      process.env.NODE_ENV = 'test';
    });

    it('IAF client should be able to get app token', function (done) {
        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf()(req, {}, function () {
            req.iaf.getAppToken(function (err, token) {
                assert.ok(token);
                done();
            });
        });

    });

    it('IAF client should be able to get app token by reference', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf()(req, {}, function () {
            req.iaf.getAppToken({
                byReference: true,
                targetService: 'ScopedToken'
            }, function (err, token) {
                assert.ok(token);
                //assert.ok(/^v\^1.1#i\^1#I\^3#f\^0#p\^1#r\^1#t\^/.test(token), 'app token must be a reference');
                assert(token.indexOf('v^1.1')>-1, true);
                assert(token.indexOf('#r^1')>-1, true);

                done();
            });
        });

    });

    it('IAF client should be able to get app token by value', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'nodedemo1';

          iaf()(req, {}, function () {
              req.iaf.getAppToken(function (err, token) {
                  assert.ok(token);
                  assert.ok(/^v\^/.test(token), 'app token must be returned');
                  done();
              });
          });
      });

      it('IAF client should be able to get app token by value', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'nodedemo1';

          iaf()(req, {}, function () {

              req.iaf.getAppToken({byReference: null }, function (err, token) {
                  assert.ok(token);
                  assert.ok(/^v\^/.test(token), 'app token must be returned');
                  done();
              });

          });

      });

      it('IAF client should be able to get app token for specific service', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'nodedemo1';

          iaf()(req, {}, function () {

              req.iaf.getAppToken({targetService: 'PAYPAL' }, function (err, token) {
                  assert.ok(token);
                  assert.ok(/^v\^/.test(token), 'app token must be returned');
                  done();
              });

          });
      });

      it('IAF client should be able to get user token for app nodedemo1', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'nodedemo1';

          iaf()(req, {}, function () {

              req.iaf.getUserToken(function (err, token) {
                  assert.ok(token);
                  assert.ok(/^v\^/.test(token), 'app token must be returned');
                  done();
              });

          });

      });

      // app not existed
      it('IAF client can not get app token due to wrong app name', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'wrong';

          iaf()(req, {}, function () {

              req.iaf.getAppToken(function (err, token) {
                  assert.ok(err);
                  assert.equal(err.message.indexOf('Fail to find app metadata for wrong') > -1, true);
                  assert.ok(!token);
                  done();
              });

          });
      });

      // app name is empty, use current app ebay-iaf
      it('IAF client can not get app token due to missing app name', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = '';

          iaf()(req, {}, function () {

              req.iaf.getAppToken(function (err, token) {
                  assert.ok(err);
                  assert.equal('appName is required', err.message);
                  assert.ok(!token);
                  done();
              });

          });
      });

      it('IAF client due to missing user id', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'nodedemo1';
          req.test = {};
          req.test._accountid = '-1';

          iaf()(req, {}, function () {

              req.iaf.getUserToken(function (err, token) {
                  assert.ok(err);
                  assert.equal('userId must be provided', err.message);
                  assert.ok(!token);
                  done();
              });

          });

      });

      it('IAF client with empty account id', function (done) {

          var req = utils.injectRequest();
          req.ebay.appContext.appName = 'nodedemo1';
          req.test = {};
          req.test._userid = 'weima';
          req.test._accountid = null;

          iaf()(req, {}, function () {

              req.iaf.getUserToken(function (err, token) {
                  assert.ok(err);
                  assert.equal('accountId must be provided', err.message);
                  assert.ok(!token);
                  done();
              });

          });

      });

  });
