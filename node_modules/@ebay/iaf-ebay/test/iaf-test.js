'use strict';

var assert = require('assert');

var async = require('async');

var iaf = require('../lib').iaf;
var serviceValidation = require('./fixtures/service');
var TokenUtils = require('./fixtures/token');

var consumerId = 'ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1';
var secret = '29109fe8-ac5a-48f8-af69-c93c47b8da0b';

describe(__filename, function () {

    it('should get app token', function (done) {
        iaf.getAppToken({
            consumerId: consumerId,
            secret: secret
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(/^v\^/.test(token), 'app token must be returned');
            done();
        });
    });

    it('should get app token with scope', function (done) {
        const services = require('../lib/services');

        iaf.getAppToken({
            consumerId: consumerId,
            secret: secret,
            scope: 'https://api.ebay.com/oauth/scope/core@application'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);

            services.login('urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
            '64d60917-d063-4d13-bdb6-a8b93c3b06f5', (err, authClient) => {
                assert.ok(!err, err && err.stack);
                authClient.authenticateToken(token, (err, token, details) => {
                    assert.ok(!err, err && err.stack);
                    /**
                     * Example
                     {
                        expirationDate: 1679154064723,
                        domain: 'EBAYAPP',
                        accountId: undefined,
                        userId: 'ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1',
                        attributes: {
                            scope: 'https://api.ebay.com/oauth/scope/core@application',
                            scopePolicy: 'FirstParty'
                        }
                    }
                     */
                    assert.ok(details.expirationDate > Date.now());
                    assert.strictEqual(details.domain, 'EBAYAPP');
                    assert.strictEqual(details.userId, 'ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1');
                    assert.deepStrictEqual(details.attributes, {
                        scope: 'https://api.ebay.com/oauth/scope/core@application',
                        scopePolicy: 'FirstParty'
                    });
                    done();
                });
            });    
        });
    });

    it('should get asac token', function (done) {
        iaf.getAsacToken({
            consumerId: consumerId,
            secret: secret
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(/^v\^/.test(token), 'app token must be returned');
            done();
        });
    });

    it('should get app token using old name for secret', function (done) {
        iaf.getAppToken({
            consumerId: consumerId,
            appSecret: secret
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(/^v\^/.test(token), 'app token must be returned');
            done();
        });
    });

    it('should get app token reference', function (done) {
        iaf.getAppToken({
            consumerId: consumerId,
            secret: secret,
            byReference: true,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^1')>-1, true);
            done();
        });
    });

    it('should get app token by reference', function (done) {

        async.waterfall([

            function requestAppTokenRef(next) {
                iaf.getAppToken({
                    consumerId: consumerId,
                    secret: secret,
                    byReference: true,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, tokenRef) {
                    next(err, tokenRef);
                });
            },

            function validateToken(tokenRef, next) {
              assert(tokenRef.indexOf('v^1.1')>-1, true);
              assert(tokenRef.indexOf('#r^1')>-1, true);
                next(null, tokenRef);
            },

            function getSecurityTokenByRef(tokenRef, next) {
                iaf.getSecurityTokenByRef({
                    consumerId: consumerId,
                    secret: secret,
                    reference: tokenRef
                }, function (err, token) {
                    next(err, token);
                });
            },

            function validateToken(token, next) {
              assert(token.indexOf('v^1.1')>-1, true);
              assert(token.indexOf('#r^0')>-1, true);
                next();
            }
        ], done);
    });

    it('should get user token', function (done) {
        iaf.getUserToken({
            consumerId: consumerId,
            secret: secret,
            userId: 'us2014.q',
            accountId: 1264442622,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    describe('custom domain:', () => {
        const services = require('../lib/services');
        const login = services.login;

        after(() => {
            services.login = login;
        });

        it('should get user token', done => {
            services.login = (...args) => {
                const cb = args.pop();
                cb(null, {
                    requestSecurityToken: options => {
                        assert.equal('CUSTOM', options.domain);
                        done();
                    }
                });
            };

            iaf.getUserToken({
                consumerId: consumerId,
                secret: secret,
                userId: 'us2014.q',
                accountId: 1264442622,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax',
                targetService: 'ScopedToken',
                expiryInSec: 72001,
                domain: 'CUSTOM'
            }, function (err, token) {});
        });

        it('should get app token', done => {
            services.login = (...args) => {
                const cb = args.pop();
                cb(null, {
                    requestSecurityToken: options => {
                        assert.equal('CUSTOM', options.domain);
                        done();
                    }
                });
            };

            iaf.getAppToken({
                consumerId: consumerId,
                secret: secret,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax',
                targetService: 'ScopedToken',
                expiryInSec: 72001,
                domain: 'CUSTOM'
            }, function (err, token) {});
        });
    });

    it('should get user token by value with expiration specified', function (done) {
        const expiryInSec = 72001;
        const startTs = Date.now();
        iaf.getUserToken({
            consumerId: consumerId,
            secret: secret,
            userId: 'us2014.q',
            accountId: 1264442622,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken',
            expiryInSec: 72001
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            TokenUtils.openToken(token)
                .then(details => {
                    const expirationTs = details.attributes.expirationDate;
                    const timePassed = Date.now() - startTs;
                    assert.ok(expirationTs > Date.now());
                    assert.ok(expirationTs < startTs + (expiryInSec * 1000) + timePassed + 1000);
                    done();
                })
                .catch(done);

        });
    });

    it('should get user token by value with ebayAppId, ebayDevId, and ebayCertId specified', function (done) {
        const appId = `AdminApp`;
        const devId = `Admintest1`;
        const certId = `AdminCertificate`;
        iaf.getUserToken({
            consumerId: consumerId,
            secret: secret,
            userId: 'us2014.q',
            accountId: 1264442622,
            scope: 'https://api.ebay.com/oauth/scope/sell@user',
            type: 'ajax',
            targetService: 'ScopedToken',
            ebayAppId: appId,
            ebayDevId: devId,
            ebayCertId: certId
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            TokenUtils.openToken(token)
                .then(details => {
                    const tokenAppId = details.attributes.attributes.AppId;
                    const tokenDevId = details.attributes.attributes.DevId;
                    const tokenCertId = details.attributes.attributes.Cert;
                    assert.equal(tokenAppId, appId);
                    assert.equal(tokenDevId, devId);
                    assert.equal(tokenCertId, certId);
                    done();
                })
                .catch(done);

        });
    });

    it('should get user token by ref with expiration specified', function (done) {
        const expiryInSec = 72001;
        const startTs = Date.now();

        iaf.getUserToken({
            consumerId: consumerId,
            secret: secret,
            userId: 'us2014.q',
            accountId: 1264442622,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken',
            byReference: true,
            expiryInSec: expiryInSec
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^1')>-1, true);
            TokenUtils.openToken(token)
                .then(details => {
                    const expirationTs = details.attributes.expirationDate;
                    const timePassed = Date.now() - startTs;
                    assert.ok(expirationTs > Date.now());
                    assert.ok(expirationTs < startTs + (expiryInSec * 1000) + timePassed + 1000);
                    done();
                })
                .catch(done);
        });
    });

    it('should get user token, using old name for secret', function (done) {
        iaf.getUserToken({
            consumerId: consumerId,
            appSecret: secret,
            userId: 'us2014.q',
            accountId: 1264442622,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should get user token reference, getUserToken', function (done) {
        iaf.getUserToken({
            consumerId: consumerId,
            secret: secret,
            byReference: true,
            userId: 'us2014.q',
            accountId: 1264442622,
            scope: 'https://api.ebay.com/oauth/scope/@public',
            type: 'ajax',
            targetService: 'ScopedToken'
        }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^1')>-1, true);
            serviceValidation.validateUserToken(token, true, done);
        });
    });

    it('should fail due to missing user id, getUserToken', function (done) {
        try {
            iaf.getUserToken({
                consumerId: consumerId,
                secret: secret,
                accountId: 1264442622,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax'
            }, function () {
            });
        }
        catch (err) {
            assert.equal('userId must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing account id, getUserToken', function (done) {
        try {
            iaf.getUserToken({
                consumerId: consumerId,
                secret: secret,
                userId: 'some',
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax'
            }, function () {
            });
        }
        catch (err) {
            assert.equal('accountId must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing consumer id, getUserToken', function (done) {
        try {
            iaf.getUserToken({
                secret: secret,
                userId: 'some',
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax'
            }, function () {
            });
        }
        catch (err) {
            assert.equal('consumerId must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing secret, getUserToken', function (done) {
        try {
            iaf.getUserToken({
                consumerId: consumerId,
                userId: 'some',
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax'
            }, function () {
            });
        }
        catch (err) {
            assert.equal('secret must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing consumer id, getAppToken', function (done) {
        try {
            iaf.getAppToken({
                secret: secret,
            }, function () {
            });
        }
        catch (err) {
            assert.equal('consumerId must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing secret, getAppToken', function (done) {
        try {
            iaf.getAppToken({
                consumerId: consumerId,
            }, function () {
            });
        }
        catch (err) {
            assert.equal('secret must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing callback, getAppToken', function (done) {
        try {
            iaf.getAppToken({
                consumerId: consumerId,
            });
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing callback, authenticateToken', function (done) {
        try {
            iaf.authenticateToken({});
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should fail due to missing callback, getUserToken', function (done) {
        try {
            iaf.getUserToken({});
        }
        catch (err) {
            assert.equal('callback must be provided', err.message);
            done();
        }
    });

    it('should authenticate public user token', function (done) {

        async.waterfall([
            iaf.getUserToken.bind(iaf, {
                consumerId: consumerId,
                secret: secret,
                userId: 'us2014.q',
                accountId: 1264442622,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax',
                targetService: 'ScopedToken'
            }),

            function authenticate(token, next) {
                iaf.authenticateToken({
                    consumerId: 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                    targetService: 'ScopedToken',
                    token: token
                }, next);
            },

            function validateToken(result, meta, next) {
                assert.equal('EBAYUSER/us2014.q',
                    result);
                assert.equal('EBAYUSER',
                    meta.domain);
                assert.equal('1264442622',
                    meta.accountId);
                assert.equal('us2014.q',
                    meta.userId);
                assert.ok(meta.expirationDate);
                assert.equal('https://api.ebay.com/oauth/scope/@public', meta.attributes.scope);
                next();
            }
        ], done);
    });

    it('should authenticate user token', function (done) {

        async.waterfall([
            iaf.getUserToken.bind(iaf, {
                consumerId: consumerId,
                secret: secret,
                userId: 'us2014.q',
                accountId: 1264442622
            }),

            function authenticate(token, next) {
                iaf.authenticateToken({
                    consumerId: 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                    token: token
                }, next);
            },

            function validateToken(result, meta, next) {
                assert.equal('EBAYUSER/us2014.q',
                    result);
                assert.equal('EBAYUSER',
                    meta.domain);
                assert.equal('1264442622',
                    meta.accountId);
                assert.equal('us2014.q',
                    meta.userId);
                assert.equal('EBAYUSER/us2014.q',
                    result);
                next();
            }
        ], done);
    });

    it('should authenticate app token', function (done) {

        async.waterfall([
            iaf.getAppToken.bind(iaf, {
                consumerId: consumerId,
                secret: secret
            }),

            function authenticate(token, next) {
                iaf.authenticateToken({
                    consumerId: 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                    token: token
                }, next);
            },

            function validateToken(result, meta, next) {
                assert.equal('EBAYAPP',
                    meta.domain);
                assert.equal(undefined,
                    meta.accountId);
                assert.equal('ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1',
                    meta.userId);
                assert.equal('EBAYAPP/ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1',
                    result);
                assert.ok(meta.expirationDate);
                next();
            }
        ], done);
    });

    it('should fail to authenticate invalid app token', function (done) {

        async.waterfall([
            iaf.getAppToken.bind(iaf, {
                consumerId: consumerId,
                secret: secret
            }),

            function authenticate(token, next) {
                iaf.authenticateToken({
                    consumerId: 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                    token: 'v^1.1#i^1#I^3#f^0#p^1#d^2016-09-23T14:08:11.574Z#r^0#t^H4sIAAAAAAAASHAJSKAAKWUXWwMURTHO93tStOWF0HEx3QQ0Wa2987Hzu5lV7YfYoUuupVoSNyZucvo7syae5eWSNYSHhpCCRUiJRESHwkvIhGReOEBD0Q84kXwICFBPJnddtuth5KYl8md8z8f8zvnHlAI1LccXXv0RxM3o3a0AAq1HAcbQH2grnWmr3Z+XQ2oEnCjhaUFf9F3fRXF2UwObSY059iU8InOqBAmMpGxrBNTUmQZC3zCrthTTlSQI5GIosOwqcEICOmyZ6c0TxI2ZdhmUUECUBWBLEpqCmoIhBGEQVVT+gR+C3Gp5dieJAgEfiCbsSkq548KeddGDqYWRTbOEoqYgXriG9YjT4lyrsMcw8kIsXK1qJzOrfKf3h1TSlzm5RViifianmQ80dnVnVrVVhUrNo6hh2GWp1NPHY5J+C04kyfTp6FlNerJGwahVGiLjWWYGhTFK8WUSUeAphM9rRohPWTIKv5/lP+MYgrKNY6bxWx639IXyxTTZSkiNrPY4N+IejT03cRg46duL0Siky+9NuVxxkpbxI0KXe3xrfGNG4UY0fGgmMVuP2G5DDaIaHgjl88S1zKRoUmSaUiGqBKsiIommaIeNlRRhxqU00rIVAgcL2Asyzj+PyrocGzTKgGgfLfD2on3N2Qq5hBSqzB7oqSddONpVqrU04VEEBElOQWV6na0VbqbZ7vsUr9J1gPEl49/b2ZlVCaHY2J2KvcuVlN+YJFDoMiFvKsNVNAKV4DlAV+v39fIU4uRoIXTQWrttL15c0mwnwzmsOUiBMOaWhvgVg/0b63eB6PbwbyJjVDvgw1V6wEsmLTUwVlzm6AKZEmFGghD2AeWTFr9cI5/9sWaJ5HNH/cG4IlnL0eufntXbG3vAE0TIo6rq/EfKuz5fm/3hyO9Dec+dx95fKs5GR4mfafu/UoP4U/hu/sXb2++1nTy8Mz0yLJlw3eXvzh452zxzAi+PNT4eN3PBwdvPni4LxW/kny7zR5Y1Hgp+jr5+kZhQ1tm4av39+8MXfg6W3l+rKX/0VPf6Ru3D4CPb3aw4eM3TyrRtV3nV35p/vXkzNzeMYa/AaofP+coBQAA'
                }, next);
            }
        ], function (err) {
            assert.ok(err);
            assert.equal('iaf:service', err.type);
            done();
        });
    });

    it('should fail to authenticate expired app token', function (done) {

        async.waterfall([
            iaf.getAppToken.bind(iaf, {
                consumerId: consumerId,
                secret: secret
            }),

            function authenticate(token, next) {
                iaf.authenticateToken({
                    consumerId: 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                    token: 'v^1.1#i^1#I^3#f^0#p^3#d^2015-02-26T05:13:27.254Z#r^0#t^H4sIAAAAAAAAAO1WTWwbRRSOHScoalIuFUVVkVZLK1SCvbPr3XU81IZtflRLbWripJBIFRrvzibb2Lurndn8SAGZNAqIH/XCASEURQLEAVUK4hBxgEPFBYlIIHoJ6gE4VBSQOMIBCLPrn9gGkkhUpQd8sd/O99773rffjAdUunseXT27+ktf5L7oegVUopGIeAj0dHf1H+6MHuvqAE2AyHrlRCW23Pn9aYLKJReOYeI6NsFcbijDS+aAJEmqrqRlrEiGwXM5uw4YdzK8KBYVKWWoYtFUioYssXVCfJyzCUU2ZflAVOIgGZeUcTEFxSSUUglJkad47iL2iOXYDJIAPLdQLtkEhgQyvO/Z0EHEItBGZUwg1WFBO38OMiR0PYc6ulPisyFdGLbzmvL3TkeEYI+yvnw2p40ULmi5oeHR8dNCU61sTYcCRdQnrdGgY2DuIir5eO82JETDgq/rmBBeyFY7tBaFWp1MKLVqmKiI0iZSZalopIr/XsoDS9Ei5YjjlRHdOzd4YhlxM4RCbFOLLu6nKFOjeBnrtBaNshK5IS74espHJcu0sJfhh89okxOF4TGeK+TznjNnGdgIxBGllJhSFaDIfNZCps+oA7HWpFqpJnFbl0HHNqxgSMKNOvQMZoxxu5SgSUoGumBf8DSTBmwaOHUcKM2S11+gb1jY1jHbEdSz9KBP20oWF9EiZIwhYzxn6RgS3XExDKSqPqjRbiS0xS2lhbaZGs3ojB04C5fZq+DCcA/bBHu9NofQaFc3w99aUzKTAIC0IquGkdSLxn9kzWzgDi2fFwJR42XkzWLqlpCO4zoTwy9jzzKgLBdlFelmPCkN6HHZUPR4Oq3guIRVrEooKQNT/t+dd9OdlEGKPsUNh7YvcCMeq2aUFgOtMnzIgeeag/aM8Aiu2WmBZPgZSl0oCPPz84n5ZMLxpgUJAFF45vy5gj6Dy4hvYK39wXEr9LXOODA8pIsu47HAfMua29N8NsgnrAByrUQgYEJ3yoKD2K4TQraCzl7jk8h1S5aOAiXqorWwz7Y/3UcVzXVzRl2VanAAVWLL0c27p4xmlC2bcbsjAw/hud2Bq8E9ZYNwWMo2gHhHxh1kJ1592vD3vTdsQIudhMzU+KAjC/94BPzlf0dovX5mO8KPuByBYDmishssUEC/eAo80t05Eevs5YhFcYKdXQliTdvsVuXhxCxedJHlQSgOpJRod+SJhdnJ5mvv+iXwYOPi29MpHmq6BYPjuytd4v1H+0QFJCVFTIlJKTUFHt5djYkPxI7kl3/YONH/5trq5uffrvc+/YHvvnMS9DVAkUhXR+yFyuzYVfry0GvHr1/Ovy5Pvfr+pri2JVz7ceLWT4+9FO0Vbm7dhB+d/EZ6/jstjd5a2Vk4aror/tXHuz7W3u2YWPpan7ki3Xr7y9sd164LkzfWdnp+2x6W4IsfPnTqyOGlZ1ff2FS/2vlj+5Vfv9j+bMN87+ezz3Vc2vokubLx+23t02NX/KUbVQ3/BFzAcl8PDAAA'
                }, next);
            }
        ], function (err) {
            assert.ok(err);
            assert.equal('iaf:service', err.type);
            done();
        });
    });

    it('should fail to authenticate due to incorrect credentials', function (done) {

        async.waterfall([
            iaf.getAppToken.bind(iaf, {
                consumerId: consumerId,
                secret: secret
            }),

            function authenticate(token, next) {
                iaf.authenticateToken({
                    consumerId: 'urn:ebay-marketplace-consumerid:7se80615d-56f3-4796-a265-2298a5312ce2',
                    secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                    token: 'v^1.1#i^1#I^3#f^0#p^3#d^2015-02-26T05:13:27.254Z#r^0#t^H4sIAAAAAAAAAO1WTWwbRRSOHScoalIuFUVVkVZLK1SCvbPr3XU81IZtflRLbWripJBIFRrvzibb2Lurndn8SAGZNAqIH/XCASEURQLEAVUK4hBxgEPFBYlIIHoJ6gE4VBSQOMIBCLPrn9gGkkhUpQd8sd/O99773rffjAdUunseXT27+ktf5L7oegVUopGIeAj0dHf1H+6MHuvqAE2AyHrlRCW23Pn9aYLKJReOYeI6NsFcbijDS+aAJEmqrqRlrEiGwXM5uw4YdzK8KBYVKWWoYtFUioYssXVCfJyzCUU2ZflAVOIgGZeUcTEFxSSUUglJkad47iL2iOXYDJIAPLdQLtkEhgQyvO/Z0EHEItBGZUwg1WFBO38OMiR0PYc6ulPisyFdGLbzmvL3TkeEYI+yvnw2p40ULmi5oeHR8dNCU61sTYcCRdQnrdGgY2DuIir5eO82JETDgq/rmBBeyFY7tBaFWp1MKLVqmKiI0iZSZalopIr/XsoDS9Ei5YjjlRHdOzd4YhlxM4RCbFOLLu6nKFOjeBnrtBaNshK5IS74espHJcu0sJfhh89okxOF4TGeK+TznjNnGdgIxBGllJhSFaDIfNZCps+oA7HWpFqpJnFbl0HHNqxgSMKNOvQMZoxxu5SgSUoGumBf8DSTBmwaOHUcKM2S11+gb1jY1jHbEdSz9KBP20oWF9EiZIwhYzxn6RgS3XExDKSqPqjRbiS0xS2lhbaZGs3ojB04C5fZq+DCcA/bBHu9NofQaFc3w99aUzKTAIC0IquGkdSLxn9kzWzgDi2fFwJR42XkzWLqlpCO4zoTwy9jzzKgLBdlFelmPCkN6HHZUPR4Oq3guIRVrEooKQNT/t+dd9OdlEGKPsUNh7YvcCMeq2aUFgOtMnzIgeeag/aM8Aiu2WmBZPgZSl0oCPPz84n5ZMLxpgUJAFF45vy5gj6Dy4hvYK39wXEr9LXOODA8pIsu47HAfMua29N8NsgnrAByrUQgYEJ3yoKD2K4TQraCzl7jk8h1S5aOAiXqorWwz7Y/3UcVzXVzRl2VanAAVWLL0c27p4xmlC2bcbsjAw/hud2Bq8E9ZYNwWMo2gHhHxh1kJ1592vD3vTdsQIudhMzU+KAjC/94BPzlf0dovX5mO8KPuByBYDmishssUEC/eAo80t05Eevs5YhFcYKdXQliTdvsVuXhxCxedJHlQSgOpJRod+SJhdnJ5mvv+iXwYOPi29MpHmq6BYPjuytd4v1H+0QFJCVFTIlJKTUFHt5djYkPxI7kl3/YONH/5trq5uffrvc+/YHvvnMS9DVAkUhXR+yFyuzYVfry0GvHr1/Ovy5Pvfr+pri2JVz7ceLWT4+9FO0Vbm7dhB+d/EZ6/jstjd5a2Vk4aror/tXHuz7W3u2YWPpan7ki3Xr7y9sd164LkzfWdnp+2x6W4IsfPnTqyOGlZ1ff2FS/2vlj+5Vfv9j+bMN87+ezz3Vc2vokubLx+23t02NX/KUbVQ3/BFzAcl8PDAAA'
                }, next);
            }
        ], function (err) {
            assert.ok(err);
            assert.equal('iaf:service', err.type);
            assert.equal('bad-credentials', err.code);
            done();
        });
    });

    it('should be able to add custom attributes to token', function (done) {

       async.waterfall([
           iaf.getUserToken.bind(iaf, {
               consumerId: consumerId,
               secret: secret,
               userId: 'us2014.q',
               accountId: 1264442622,
               scope: 'https://api.ebay.com/oauth/scope/@public',
               type: 'ajax',
               targetService: 'ScopedToken',
               attributeRequest : [
                   {
                       name : 'test1',
                       friendlyName : 'TESTING',
                       value : [1]
                   }
               ]
           }),

           function authenticate(token, next) {
               iaf.authenticateToken({
                   consumerId: 'urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                   secret: '64d60917-d063-4d13-bdb6-a8b93c3b06f5',
                   targetService: 'ScopedToken',
                   token: token
               }, next);
           },

           function validateToken(result, meta, next) {
               assert.equal('EBAYUSER/us2014.q',
                   result);
               assert.equal('EBAYUSER',
                   meta.domain);
               assert.equal('1264442622',
                   meta.accountId);
               assert.equal('us2014.q',
                   meta.userId);
               assert.ok(meta.expirationDate);
               assert.equal('https://api.ebay.com/oauth/scope/@public', meta.attributes.scope);
               assert.equal('1',meta.attributes.test1);
               next();
           }
       ], done);
   });

    it('should be able to invalidate a token', function (done) {

        async.waterfall([

            function requestAppTokenRef(next) {
                iaf.getUserToken({
                    consumerId: consumerId,
                    secret: secret,
                    byReference: true,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, tokenRef) {
                    next(err, tokenRef);
                });
            },

            function validateToken(tokenRef, next) {
              assert(tokenRef.indexOf('v^1.1')>-1, true);
              assert(tokenRef.indexOf('#r^1')>-1, true);
              next(null, tokenRef);
            },

            function logout(tokenRef, next) {
                iaf.logout({
                    consumerId: consumerId,
                    secret: secret,
                    domain: 'EBAYUSER',
                    reference: tokenRef,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    requester: {
                        domain : 'EBAYAPP',
                        format : 'USERNAME',
                        value : consumerId
                    }
                }, function (err, res) {
                    done();
                });
            }
        ], done);
    });

    it('should throw an error when invalidate a token that is already invalidated', function (done) {

        async.waterfall([

            function requestAppTokenRef(next) {
                iaf.getUserToken({
                    consumerId: consumerId,
                    secret: secret,
                    byReference: true,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, tokenRef) {
                    next(err, tokenRef);
                });
            },

            function validateToken(tokenRef, next) {
              assert(tokenRef.indexOf('v^1.1')>-1, true);
              assert(tokenRef.indexOf('#r^1')>-1, true);
              next(null, tokenRef);
            },

            function logout(tokenRef, next) {
                iaf.logout({
                    consumerId: consumerId,
                    secret: secret,
                    domain: 'EBAYUSER',
                    reference: tokenRef,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    requester: {
                        domain : 'EBAYAPP',
                        format : 'USERNAME',
                        value : consumerId
                    }
                }, function (err, res) {
                    next(err, tokenRef);
                });
            },

            function logout(tokenRef, next) {
                iaf.logout({
                    consumerId: consumerId,
                    secret: secret,
                    domain: 'EBAYUSER',
                    reference: tokenRef,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    requester: {
                        domain : 'EBAYAPP',
                        format : 'USERNAME',
                        value : consumerId
                    }
                }, function (err, res) {
                    done();
                });
            }
        ], done);
    });

    it('should not be able to open an invalidated token', function (done) {

        async.waterfall([

            function requestAppTokenRef(next) {
                iaf.getUserToken({
                    consumerId: consumerId,
                    secret: secret,
                    byReference: true,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, tokenRef) {
                    next(err, tokenRef);
                });
            },

            function validateToken(tokenRef, next) {
              assert(tokenRef.indexOf('v^1.1')>-1, true);
              assert(tokenRef.indexOf('#r^1')>-1, true);
              next(null, tokenRef);
            },

            function logout(tokenRef, next) {
                iaf.logout({
                    consumerId: consumerId,
                    secret: secret,
                    domain: 'EBAYUSER',
                    reference: tokenRef,
                    userId: 'us2014.q',
                    accountId: 1264442622,
                    requester: {
                        domain : 'EBAYAPP',
                        format : 'USERNAME',
                        value : consumerId
                    }
                }, function (err, res) {
                    next(err, tokenRef);
                });
            },

            function authenticate(tokenRef, next) {
                iaf.authenticateToken({
                    consumerId: consumerId,
                    secret: secret,
                    targetService: 'ScopedToken',
                    token: tokenRef
                }, function (err, res) {
                    done();
                });
            },
        ], done);
    });

    // COMMERCIALDIRECTUSER is no longer valid domain
    it.skip('should not be able to process invalid password', function (done) {
          iaf.authenticateUser({
            consumerId: 'urn:ebay-marketplace-consumerid:f9f465c1-d0aa-4a55-9ce0-c29ab651bebc',
            secret: '004d302e-1bf2-44e3-b165-38fa9c2bdf62',
            userId: 'iaf_test_1',
            userSecret: 'password',
            domain: 'COMMERCIALDIRECTUSER',
            requestSecurityToken:true
          }, function (err, tokenRef) {
            assert.ok(err);
            assert.equal('iaf:service', err.type);
            assert.equal('bad-credentials', err.code);
            done();
          });
    });
    it('should not be able to process invalid domain', function (done) {
          iaf.authenticateUser({
            consumerId: 'urn:ebay-marketplace-consumerid:f9f465c1-d0aa-4a55-9ce0-c29ab651bebc',
            secret: '004d302e-1bf2-44e3-b165-38fa9c2bdf62',
            userId: 'iaf_test_1',
            userSecret: 'password',
            domain: 'EBAYUSER',
            requestSecurityToken:true
          }, function (err, tokenRef) {
            assert.ok(err);
            assert.equal('iaf:service', err.type);
            assert.equal('bad-credentials', err.code);
            done();
          });
    });

    // COMMERCIALDIRECTUSER is no longer valid domain
    it.skip('should return token for the given user', function (done) {

          iaf.authenticateUser({
              consumerId: 'urn:ebay-marketplace-consumerid:f9f465c1-d0aa-4a55-9ce0-c29ab651bebc',
              secret: '004d302e-1bf2-44e3-b165-38fa9c2bdf62',
              userId: 'iaf_test_1',
              userSecret: 'pa11word',
              domain: 'COMMERCIALDIRECTUSER',
              requestSecurityToken:true
          }, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert(token.indexOf('v^1.1')>-1, true);
            assert(token.indexOf('#r^0')>-1, true);
            done();
          });
    });
});
