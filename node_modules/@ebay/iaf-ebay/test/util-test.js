'use strict';

var assert = require('assert');

var utils = require('../lib/utils');

console.log(new Date().toString());

describe(__filename, function () {
	var expectedToken = 'H4sIAAAAAAAAAKVUXWjTUBRe1q463VRENicDQ/xDJd1N2rTJda22+2EB7aadQycKt+nNjGuTkpuqexm14l7GHhScMhAq+DRwA2U+if/6KoqoDyIoIiiKooIMQUy7dut82ARDIJx7vnPOl++ce0DGVb1tqGPoZy21pDKXAZlKiuKWg2pX1fYVjsp1VRWgDEDlMhszzqzjajNByUQK7sMkZegE03JrgFF5QZQUjIEoIUGRYgwt6yVAtxFgBNHnkXycx6/GvXEsYttPSBrLOrGQbgUYHnACCziWl7oBD+2X97s5v6eXoXuwSTRDtyFuwNAnkwmdwAKBAJM2dWggohGooyQm0FJgNLRnN7SRMGUalqEYCSZYoAsL5cyy+IXDESHYtOy6TFAOtUc7Q3JrW6S7uaksV7CoQ9RCVprMt1qMOKZ7UCKNFy5DCmgYTSsKJoRpCs5UmJ8UhkpkClJL8ZioxgAGPq9XVUXw/1L+sxTzpGw3zCSyFo7Nn2hxVi1AIdYtzRpYTFFbjdgxrFhFK2KnkFvp/GdvGiU0VcNmgGkLhw6GurqYYL46jqEBNonMfmylEkjBrGKPXTqJTS0OVY8kYdGDWK+IeNbrj4lsDHt9rCJIqsSpMZVDQpHETKViC/5i0WLocS0vAqEjhhXG9h/h+VJzUCiT2gZ16p1mSLXybG2cjwX+PI73lLekqdThtHVUz/ccJ22R6IK5eENL4zI3ILPzU7p7wYrCw2UpCLKUz77fQADbua1gi8ux3+mooYlmYbeGVDfR+nR75kzs7scDKaSZEHKiX6h0UTtP9h8sXwq5w2Dt7FqodnDLy3YEaJzzVHEr62s5AXC8BHjA8/5esGHO6+TqnGu+HBqcvuF9c/Pe9XPj8tIf7z6fj+RA7SyIoqoqnKcy412H74ztepb7+PxE26fHT4JHDjgidQ+mXrCnX0zIX1vFh42m2dDRk2q4JA33fk/2hXeMvF81cavmUf3bxm/rX53dPJZSL4ebRn5H3t1ediD6MvDrxygdTrVcuHjmBpCPH5reN4Unsy5wd/Xg6If468nxBrVt08i1Ryuv3H867R8emtHwDyg1DB4tBQAA';

	it('should parse token', function () {
		var expectedTime = Date.now() + 100000;
		var token = 'v^1.1#i^1#I^3#f^0#p^1#d^' + new Date(expectedTime).toISOString() + '#r^0#t^' + expectedToken;
		var tokenInfo = utils.parse(token);
		assert.ok(tokenInfo);
		assert.equal(token, tokenInfo.token);
		assert.equal(expectedTime, tokenInfo.expiration());
		assert.ok(!tokenInfo.isExpired());
		assert.ok(!tokenInfo.isByReference());
	});

	it('should parse expired token', function () {
		var token = 'v^1.1#i^1#I^3#f^0#p^1#d^2014-07-29T23:02:27.173Z#r^0#t^' + expectedToken;
		var tokenInfo = utils.parse(token);
		assert.ok(tokenInfo);
		assert.equal(token, tokenInfo.token);
		assert.ok(tokenInfo.isExpired());
		assert.ok(!tokenInfo.isByReference());
	});

	it('should format asac token options', () => {
		const request = utils.formatTokenRequest({
			domain: 'ASAC20',
			consumerId: 'app-id'
		});

		assert.deepEqual({
			'$byReference': false,
			'subject': {
				'$identityDomain': 'ASAC20',
				'identifier': {
					'$format': 'USERNAME',
					value: null
				}
			},
			'attributeAssertion': [
				{
					'$Name': 'AppId',
					'$NameFormat': 'String',
					'$FriendlyName': 'ApplicationID',
					'AttributeValue': {
						'$xmlns:xs': 'http://www.w3.org/2001/XMLSchema',
						'$xsi:type': 'xs:string',
						'$value': 'app-id'
					}
				}
			]
		}, request);
	});
});