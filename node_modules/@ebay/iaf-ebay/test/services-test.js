'use strict';

var assert = require('assert');
const { EventEmitter } = require('events');

var async = require('async');
const nock  = require('nock');

var services = require('../lib/services');
var serviceValidation = require('./fixtures/service');

var consumerId = 'ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1';
var secret = '29109fe8-ac5a-48f8-af69-c93c47b8da0b';

function gethttpunch() {
    try {
        return require('@ebay/httpunch');
    } catch (e) {
        return require('@ebay/servicecore/node_modules/httpunch');
    }
}

describe(__filename, function () {
    afterEach(() => {
        nock.cleanAll();
    });

    it('should login under unp app', function (done) {
        services.login('urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
            '64d60917-d063-4d13-bdb6-a8b93c3b06f5', function (err, authClient) {

            assert.ok(!err, err && err.stack);
            assert.ok(authClient);
            done();
        });

    });

    describe('caching login token', function () {
        // intercept soap request to see if cache was not used
        var count = 0;
        var httpunch = gethttpunch();
        var _httpResuest = httpunch.request;

        before(function () {
            httpunch.request = function (options) {
                if (options.hostname === 'iafsvc.vip.qa.ebay.com') {
                    count++;
                }
                return _httpResuest.apply(httpunch, arguments);
            };
            services.reset();
            count = 0;
        });

        after(function () {
            httpunch.request = _httpResuest;
        });
        
        it('should login', function (done) {
            services.login(consumerId, secret, function (err, client) {
                assert.ok(!err, err && err.stack);
                assert.ok(client);

                assert.ok(/^v\^/.test(client.token));
                assert.equal(consumerId, client.consumerId);
                assert.ok(/^v\^/.test(client.headers['X-EBAY-SOA-SECURITY-IAFTOKEN']));
                assert.equal(1, count);
                done();
            });
        });

        it('should cache login token', function (done) {

            services.login(consumerId, secret, function (err, client) {
                assert.ok(!err, err && err.stack);
                assert.ok(client);

                assert.ok(/^v\^/.test(client.token));
                assert.equal(consumerId, client.consumerId);
                assert.ok(/^v\^/.test(client.headers['X-EBAY-SOA-SECURITY-IAFTOKEN']));
                assert.equal(1, count);
                done();
            });
        });
    });

    describe('login, guid', function () {
        // intercept soap request to see if cache was not used
        var count = 0;
        var httpunch = gethttpunch();
        var _httpResuest = httpunch.request;
        let guidHeader;

        before(() => {
            httpunch.request = function (options) {
                if (options.hostname === 'iafsvc.vip.qa.ebay.com') {
                    guidHeader = options.headers['X-EBAY-SOA-REQUEST-GUID'];
                    count++;
                }
                return _httpResuest.apply(httpunch, arguments);
            };
            services.reset();
            count = 0;
        });

        after(function () {
            httpunch.request = _httpResuest;
            services.reset();
            while(process.domain) {
                process.domain.exit();
            }
        });

        it('should not use guid', function (done) {
            require('request-local').run(new EventEmitter(), new EventEmitter(), (err, ctx) => {
                ctx.request = {
                    ebay: {
                        getGuid() {
                            return 'good-guid';
                        }
                    }
                };
                
                services.login(consumerId, secret, function (err, client) {
                    try {
                        assert.ok(!err, err && err.stack);
                        assert.ok(client);
        
                        assert.strictEqual('no-guid', guidHeader);
                        done();
                    }
                    catch (err) {
                        done(err);
                    }
                });    
            });
        });
    });

    describe('login failures', function () {

        // intercept soap request to see if cache was not used
        var httpunch = gethttpunch();
        var _httpResuest = httpunch.request;
        var errCode;

        before(function () {
            httpunch.request = function (options) {
                return {
                    end: function (callback) {
                        if (errCode === 'TIMEDOUT') {
                            var err = new Error('Test timeout error');
                            err.code = errCode;
                            process.nextTick(callback.bind(null, err));
                        }
                        else {
                            process.nextTick(callback.bind(null, null, {
                                statusCode: errCode,
                                body: 'Http test error'
                            }, 'Http test error'));
                        }
                    }
                };
            };
            services.reset();
        });

        after(function () {
            httpunch.request = _httpResuest;
        });

        it('should timeout', function (done) {
            errCode = 'TIMEDOUT';
            services.login(consumerId, secret, function (err, client) {
                assert.ok(err);
                assert.equal('TIMEDOUT', err.code);
                assert.ok(!client);

                done();
            });
        });

        it('should get 404', function (done) {
            errCode = 404;
            services.login(consumerId, secret, function (err, client) {
                assert.ok(err);
                assert.equal('HTTP404', err.code);
                assert.ok(!client);

                done();
            });
        });

    });

    it('should get app token', function (done) {
        services.login(consumerId, secret, function (err, client) {
            assert.ok(!err, err && err.stack);
            assert.ok(client);

            client.requestSecurityToken(function (err, token) {
                assert.ok(!err, err && err.stack);
                assert.ok(/^v\^/.test(token), 'app token must be returned');
                done();
            });
        });
    });

    it('should get app token reference', function (done) {
        services.login(consumerId, secret, function (err, client) {
            assert.ok(!err, err && err.stack);
            assert.ok(client);

            client.requestSecurityToken({
                byReference: true,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax',
                targetService: 'ScopedToken'
            }, function (err, token) {
                assert.ok(!err, err && err.stack);
                assert(token.indexOf('v^1.1')>-1, true);
                assert(token.indexOf('#r^1')>-1, true);
                done();
            });
        });
    });

    it('should get app token by reference', function (done) {

        var _client;

        async.waterfall([
            services.login.bind(services, consumerId, secret),

            function requestAppTokenRef(client, next) {
                _client = client;
                client.requestSecurityToken({
                    byReference: true,
                    scope: 'https://api.ebay.com/oauth/scope/@public',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, tokenRef) {
                    next(err, tokenRef);
                });
            },

            function validateToken(tokenRef, next) {
              assert(tokenRef.indexOf('v^1.1')>-1, true);
              assert(tokenRef.indexOf('#r^1')>-1, true);
                next(null, tokenRef);
            },

            function getSecurityTokenByRef(tokenRef, next) {
                _client.getSecurityTokenByRef(tokenRef, next);
            },

            function validateToken(token, next) {
              assert(token.indexOf('v^1.1')>-1, true);
              assert(token.indexOf('#r^0')>-1, true);
                next();
            }
        ], done);
    });

    it('should get user token', function (done) {
        services.login(consumerId, secret, function (err, client) {
            assert.ok(!err, err && err.stack);
            assert.ok(client);

            client.requestSecurityToken({
                domain: 'EBAYUSER',
                userId: 'us2014.q',
                accountId: 1264442622,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax',
                targetService: 'ScopedToken'
            }, function (err, token) {
                assert.ok(!err, err && err.stack);
                assert(token.indexOf('v^1.1')>-1, true);
                assert(token.indexOf('#r^0')>-1, true);
                serviceValidation.validateUserToken(token, true, done);
            });
        });
    });

    it('should get user token reference', function (done) {
        services.login(consumerId, secret, function (err, client) {
            assert.ok(!err, err && err.stack);
            assert.ok(client);

            client.requestSecurityToken({
                byReference: true,
                domain: 'EBAYUSER',
                userId: 'us2014.q',
                accountId: 1264442622,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax',
                targetService: 'ScopedToken'
            }, function (err, token) {
                assert.ok(!err, err && err.stack);
                assert(token.indexOf('v^1.1')>-1, true);
                assert(token.indexOf('#r^1')>-1, true);
                serviceValidation.validateUserToken(token, true, done);
            });
        });
    });

    it('should fail to get user token', function (done) {
        services.login(consumerId, secret, function (err, client) {
            assert.ok(!err, err && err.stack);
            assert.ok(client);

            client.requestSecurityToken({
                domain: 'EBAYUSER',
                accountId: 1264442622,
                scope: 'https://api.ebay.com/oauth/scope/@public',
                type: 'ajax'
            }, function (err, token) {
                assert.ok(!err, err && err.stack);
                assert(token.indexOf('v^1.1')>-1, true);
                assert(token.indexOf('#r^0')>-1, true);
                serviceValidation.validateUserToken(token, false, done);
            });
        });
    });

    describe('user token request', function () {

        // intercept soap request to see request details
        var httpunch = gethttpunch();
        var _httpResuest = httpunch.request;
        var requests = [];

        before(function (next) {
            httpunch.request = function (options) {
                requests.push({
                    rurl: options.hostname,
                    data: options.body,
                    headers: options.headers,
                    options: options
                });
                return _httpResuest.apply(httpunch, arguments);
            };
            services.reset();
            requests = [];
            require('request-local').run(next);
        });

        after(function () {
            httpunch.request = _httpResuest;
        });

        it('should provide parameters for user token request', function (done) {
            services.login(consumerId, secret, function (err, client) {
                assert.ok(!err, err && err.stack);
                assert.ok(client);

                client.requestSecurityToken({
                    assertions: true,
                    userId: 'us2014.q',
                    accountId: 1264442622
                }, function (err, token) {
                    assert.ok(!err, err && err.stack);
                    assert.ok(/^v\^/.test(token), 'app token must be returned');
                    var data = requests[requests.length-1].data;
                    assert.ok(data.indexOf('<iaf:requestSecurityTokenRequest '+
                        'xmlns:iaf="http://www.ebay.com/marketplace/iaf/v1/services" byReference=\'false\'>'+
                            '<iaf:subject identityDomain=\'EBAYAPP\'>'+
                                '<iaf:identifier format=\'USERNAME\' immutableId=\'1264442622\'>'+
                                    '<iaf:value>ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1</iaf:value>'+
                                '</iaf:identifier>'+
                            '</iaf:subject>'+
                        '</iaf:requestSecurityTokenRequest>') !== -1);
                    done();
                });
            });
        });

    });

    it('should authenticate app token', function (done) {

        var _client;

        async.waterfall([
            services.login.bind(services, consumerId, secret),

            function requestAppTokenRef(client, next) {
                _client = client;
                client.requestSecurityToken(function (err, token) {
                    next(err, token);
                });
            },

            function authenticateToken(token, next) {
                _client.authenticateToken(token, next);
            },

            function validateToken(result, meta, next) {
                assert.equal('EBAYAPP/ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1',
                    result);
                next();
            }
        ], done);
    });

    it('should authenticate user scoped token', function (done) {

        async.waterfall([
            services.login.bind(services, 'urn:ebay-marketplace-consumerid:ac91819e-8d14-4f3a-b956-ebc9bc65b420',
                'c4e0d783-0dca-41f7-a278-f5c95bfdbd13'),

            function requestUserTokenRef(client, next) {
                client.requestSecurityToken({
                    domain: 'EBAYUSER',
                    userId: 'iafuser01',
                    accountId: '1271765054',
                    scope: 'https://api.ebay.com/oauth/scope/core@application',
                    type: 'ajax',
                    targetService: 'ScopedToken'
                }, function (err, token) {
                    assert.ok(!err, err && err.stack);
                    serviceValidation.validateUserToken(token, true, next.bind(null, null, token));
                });
            },

            function getAuthClient(token, next) {
                services.login('urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    '64d60917-d063-4d13-bdb6-a8b93c3b06f5', function (err, authClient) {

                    next(err, token, authClient);
                });
            },

            function authenticateToken(token, authClient, next) {
                authClient.authenticateToken({
                    token: token,
                    targetService: 'ScopedToken'
                }, next);
            },

            function validateToken(result, meta, next) {
                assert.equal('EBAYUSER/iafuser01',
                    result);
                next();
            }
        ], done);
    });

    it('should authenticate app token', function (done) {

        async.waterfall([
            services.login.bind(services, 'urn:ebay-marketplace-consumerid:ac91819e-8d14-4f3a-b956-ebc9bc65b420',
                'c4e0d783-0dca-41f7-a278-f5c95bfdbd13'),

            function requestAppTokenRef(client, next) {
                client.requestSecurityToken(function (err, token) {
                    assert.ok(!err, err && err.stack);
                    next(err, token);
                });
            },

            function getAuthClient(token, next) {
                services.login('urn:ebay-marketplace-consumerid:7e80615d-56f3-4796-a265-2298a5312ce2',
                    '64d60917-d063-4d13-bdb6-a8b93c3b06f5', function (err, authClient) {

                    next(err, token, authClient);
                });
            },

            function authenticateToken(token, authClient, next) {
                authClient.authenticateToken(token, next);
            },

            function validateToken(result, meta, next) {
                assert.equal('EBAYAPP/urn:ebay-marketplace-consumerid:ac91819e-8d14-4f3a-b956-ebc9bc65b420',
                    result);
                next();
            }
        ], done);
    });

});
