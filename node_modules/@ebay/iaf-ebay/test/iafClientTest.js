'use strict';

var iaf = require('../'),
    assert = require('chai').assert,
    utils = require('./fixtures/utils');

var TIMEOUT = 50000;

var consumerId = 'ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1';
var secret = '29109fe8-ac5a-48f8-af69-c93c47b8da0b';

describe(__filename, function () {

    beforeEach(function () {
        require('../lib/services').reset();
    });

    it('IAF client should be able to get app token', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf.getAppToken(req, null, function (err, token) {
            assert.ok(token);
            done();
        });

    });

    it('IAF client should be able to get app token by reference', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf.getAppToken(req, {byReference: true }, function (err, token) {
            assert.ok(token);
            done();
        });

    });

    it('IAF client should be able to get app token by value', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf.getAppToken(req, {byReference: false }, function (err, token) {
            assert.ok(token);
            done();
        });
    });

    it('IAF client should be able to get app token by value', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';
        iaf.getAppToken(req, {byReference: null }, function (err, token) {
            assert.ok(token);
            done();
        });

    });

    it('IAF client should be able to get app token for specific service', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';
        iaf.getAppToken(req, {targetService: 'PAYPAL' }, function (err, token) {
            assert.ok(token);
            done();
        });
    });

    it('IAF client should be able to get user token for app nodedemo1', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf.getUserToken(req, null, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(token);
            done();
        });

    });

    it('IAF client should be able to get user token for app nodedemo1, empty options', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf.getAppToken(req, {}, function (err, token) {
            assert.ok(!err, err && err.stack);
            assert.ok(token);
            done();
        });

    });

    it('IAF client should be able to get user token for app xonyx', function (done) {
        this.timeout(25000);

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'xonyx';

        iaf.getUserToken(req, {
            byReference: true,
            targetService: 'PAYPAL'
        }, function (err, token) {
            assert.ok(token);
            done();
        });

    });

    // app not existed
    it('IAF client can not get app token', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'wrong';

        iaf.getAppToken(req, null, function (err, token) {
            assert.ok(!token);
            done();
        });
    });

    // app name is empty, use current app ebay-iaf
    it('IAF client can not get app token', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'none';

        iaf.getAppToken(req, null, function (err, token) {
            assert.ok(!token);
            done();
        });
    });

    it('IAF client with invalid account id', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';
        req.test = {};
        req.test._accountid = '-1';

        iaf.getUserToken(req, null, function (err, token) {
            assert.ok(err);
            assert.ok(!token);
            done();
        });

    });

    it('IAF client with empty account id', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';
        req.test = {};
        req.test._accountid = null;

        iaf.getUserToken(req, null, function (err, token) {
            assert.ok(!token);
            done();
        });

    });

    it('IAF client with empty username and account id', function (done) {

        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';
        req.test = {};
        req.test._userid = null;
        req.test._accountid = null;

        iaf.getUserToken(req, null, function (err, token) {
            assert.ok(!token);
            done();
        });

    });

    it('IAF client should be able to get Security token by reference', function(done) {
        var req = utils.injectRequest();
        req.ebay.appContext.appName = 'nodedemo1';

        iaf.getUserToken(req, {
            byReference: true
        }, function (err, tokenRef) {
            assert.ok(tokenRef);

            iaf.getSecurityTokenByRef(req, {
                consumerId: consumerId,
                secret: secret,
                reference: tokenRef
            }, function (err, token) {
                assert.ok(token);
                done();
            });
        });
    });

});
