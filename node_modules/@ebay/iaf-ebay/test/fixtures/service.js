'use strict';

var assert = require('assert');
var path = require('path');
var objutil = require('objutil');
var servicecore = require('@ebay/servicecore');

var clientName = path.basename(__filename, '.js');

function factory(config, transport) {
    return {
        invoke: function invoke(productId, limit, token, callback) {
            var options = objutil.mixin(config, {
                qs: '?action=report&reason=101',
                path: '/10000000000820536/spam',
                headers: {
                    Authorization: 'Bearer '+token,
                    'Content-type': 'application/json'
                }
            }, {});

            transport(options, callback);
        }
    };
}

servicecore.register(clientName, factory);

module.exports.invoke = function invoke(productId, limit, token, callback) {



    var service = servicecore.create(clientName, {
        dnslookup: false,
        'protocol': 'http',
        'hostname': 'www.cosgrc.stratus.qa.ebay.com',
        // 'port': 8080,
        followRedirect: false,
        'basepath': '/buy/review/v1/review',
        'transport': 'generic',
        'method': 'POST',
        'keepAlive': false,
        'maxSockets': 10,
        'timeout': 5000,
        'rejectUnauthorized': true,
        'markdownthreshold': 10
    });

    service.invoke(productId, limit, token, function (err, res) {
        callback(err, res && res.body);
    });


};

exports.validateUserToken = function validateUserToken(token, shouldBeValid, callback) {
    module.exports.invoke(1002564999, 10, token, function (err, response) {
        assert.ok(!err || err.statusCode === 404);
        var result = response instanceof Buffer ? response.toString() : response;
        console.log('result->', err, result);
        if (shouldBeValid) {
            assert.ok(result.indexOf('invalid_token') === -1, 'should be valid token');
        }
        else {
            assert.ok(result.error_code);
        }
        callback();
    });
};
