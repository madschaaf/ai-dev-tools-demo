'use strict';

var assert = require('assert');
var objutil = require('objutil');

var EventEmitter = require('events').EventEmitter;
var commonsEbay = require('@ebay/commons-ebay/middleware');
var serviceValidation = require('./fixtures/service');

var iaf = require('../');

function invokeAjax(done) {
    var req = new EventEmitter();
    req.headers = {
        host: 'ebay.com'
    };
    req.url = 'www.ebay.com';

    var res = Object.assign(new EventEmitter(), {
        setHeader() {}
    });

    require('request-local/middleware').create()(req, res, function () {

        var appname = 'urwwidget';
        require('@ebay/commons-ebay/lib/app-context').appName = appname;

        commonsEbay()(req, res, function () {
            req.ebay = objutil.mixin({
                getAccountId: function getAccountId() {
                    return '1264442622';
                },
                getLevel1UserId: function getLevel1UserId() {
                    return 'us2014.q';
                }
            }, req.ebay);

            iaf.getUserToken(req, {
                byReference: true,
                type: 'ajax',
                scope: 'https://api.ebay.com/oauth/scope/@public',
                targetService: 'ScopedToken'
            },
            function (err, token) {
                assert.ok(!err, err && err.stack);
                assert.ok(/^v\^1/.test(token));
                serviceValidation.validateUserToken(token, true, done);
            });
        });
    });

}

describe(__filename, function () {
    it('ajax', function (done) {
        this.timeout(20000);
        invokeAjax(done);
    });
});
