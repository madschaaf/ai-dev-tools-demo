/**
 * Created by cdeshpande on 11/20/14.
 */

'use strict';

var iaf = require('../'),
    assert = require('chai').assert,
    tokenUtils = require('./fixtures/token'),
    utils = require('./fixtures/utils');

describe(__filename, function () {

    const consumerId = 'ebay-marketplace-consumerid:c722dc2c-5ea4-472d-b8c5-b1713f46d4e1';
    const appSecret = '29109fe8-ac5a-48f8-af69-c93c47b8da0b';

    var oldToken = 'v^1.1#i^1#r^0#I^3#f^0#p^1#d^2016-05-21T20:05:11.770Z#t^H4sIAAAAAAAAAKWUT0gUURzHnd1VEbOCyiIrhlGolFnfmz/756UrayYtlautGhoRb2ff1OjuzDbvLeih2oSM6FZQHToI/aFDBRV1KDKCDBIPhYdK6NShKKgOQR0Kml1dXTtY0FyGN7/v7898fr/3A9myivrRnaPfq7hy11gWZF0cBytBRVlpw3K3a31pCSgScGPZuqxnxH2zieJUMo32Epq2TEr4SFuz4PdhiImsy1jHfhxQBD5iFgTdlmOXArqsyZIKsJSQ4tCxU5ohEZMybLJmQQJQESEUJdAtyQioCEKv3w/6Bb6X2NSwTEfiBQI/lEqaFOULaBYytoksTA2KTJwiFDENxcJ7diNHidK2xSzNSgqhfLkon84u8l/aHVNKbObkFUKRcHssGo607ejobmosihWa4xBjmGXo4tN2K0H4XpzMkKXT0LwaxTKaRigVGkOzGRYHReFCMXnUDkSfFtTjGBLoUyTt/1H+M4pFKNstO4XZ0r65L0ZC1PNSRExmsOG/EXVoxAeIxuZOHU6ISBufe3VlcNLQDWI3Cztaw33hzk4hlMtO4nhYTGF7kLB0EmtE1Jyxy6SIbSSQLgeDJCBjUQlgSVT88YAYJ4pP1NSgHoR6XIdYnStiNtNcC/6oYrtlJowcBMp3WKyVOH9EFqOWkFqE2hFFzagd1lmuWkfnE4EqSrBbAsUtaSx0OMMOm7mek5QDic8f/97QwrgsDMj8/BTuXqgk/8ARDoERzufcb6CCBrgVbC5z93jcy3hqMOI1sO6lxiHTmTmbeAfJcBobNkIw4FddZVzL0GBf8VIYOwDWza+FCjesLNoRYMOCpRSuWFsFFQglIMlAhbAf1C5YPbDas7p118mfv3b/WDl1T38oG5UTXQNfjoKqeRHHlZZ4TmQ3HZvcjz/XupRwTyz28drZfnzj+Kry6VPg5cSFlue1B67AR+fGay+/z56Zmdlyhhv1VN9+ej7w7s7Z01+nNt5+9GBNr3T3yd2umn3y60PbokeOxe5fuvrx4TS91B+5cHO8/dv0ReVD76QVeDVTV1e9k0WzLx5/qrn67FZL2vvmev3Bt7MMfwODKP4VLQUAAA==';

    beforeEach(function () {
        require('../lib/services').reset();
    });

    it('IAF client should get HTTP error for trying to validate user provided token, without consumerId', function (done) {

        var req = utils.injectRequest();
        req.headers.authorization = 'bearer ' + oldToken;
        req.ebay.appContext.appName = 'nodedemo1';

        var config = {};
        config.appSecret = appSecret;
        iaf.validateUserToken(req, config, function (err) {
            assert.ok(err);
            assert.ok(err.stack.indexOf('Incorrect credentials') !== -1);
            done();
        });

    });

    it('IAF client should get HTTP error for trying to validate user provided token, without valid appSecret credentials', function (done) {

        var req = utils.injectRequest();
        req.headers.authorization = 'bearer ' + oldToken;
        req.ebay.appContext.appName = 'nodedemo1';

        var config = {};
        config.consumerId = consumerId;

        iaf.validateUserToken(req, config, function (err) {
            assert.ok(err);
            assert.ok(err.stack.indexOf('Incorrect credentials') !== -1);
            done();

        });

    });


    it('IAF client should be able to validate user token with authorized credentials: Valid token scenario', function (done) {

        var req = utils.injectRequest();

        tokenUtils.getAppToken((err, validToken) => {
            req.headers.authorization = 'bearer ' + validToken;
            req.ebay.appContext.appName = 'nodedemo1';

            var config = {};
            config.consumerId = consumerId;
            config.appSecret = appSecret;

            iaf.validateUserToken(req, config, function (err, token) {
                assert.ok(!err, err && err.stack);
                assert.ok(token);
                done();
            });
        });
    });

    it('IAF client should be able to validate user token with authorized credentials: Valid token with ' +
    'bearer uppercased', function (done) {

        var req = utils.injectRequest();

        tokenUtils.getAppToken((err, validToken) => {
            req.headers.authorization = 'Bearer ' + validToken;
            req.ebay.appContext.appName = 'nodedemo1';

            var config = {};
            config.consumerId = consumerId;
            config.appSecret = appSecret;

            iaf.validateUserToken(req, config, function (err, token) {
                assert.ok(!err, err && err.stack);
                assert.ok(token);
                done();
            });
        });

    });

    it('IAF client should be able to validate user token with authorized credentials: Valid token with ' +
    'bearer uppercased, middleware', function (done) {

        var req = utils.injectRequest();
        tokenUtils.getAppToken((err, validToken) => {
            req.headers.authorization = 'Bearer ' + validToken;

            req.ebay.appContext.appName = 'nodedemo1';
            var config = {};
            config.consumerId = consumerId;
            config.appSecret = appSecret;

            iaf()(req, {}, function () {
                req.iaf.authenticateRequest(config, function (err, token) {
                    assert.ok(!err, err && err.stack);
                    assert.ok(token);
                    done();
                });
            });
        });
    });

    it('IAF client should be able to validate user token with authorized credentials: Invalid token scenario', function (done) {

        var req = utils.injectRequest();
        var inValidToken = 'v^1.1#i^1#r^0#I^3#f^0#p^1#t^H4sIAAAAAAAAAO1XX2gcRRjPJZdIiEktalPUh2ONlBp2d2b/3J8ld+nlT+lhk5y92Cah0s7uziXb3O0uO3O9HChcUyiUCKIoBaWl9kEQKrToQy15VcEHQST6pmK1iL4oFKUv4uzmcrkLNimmYh7cl2V2ft/M9/2+3zc7H6h2dD577tC5P7pDD7VeroJqaygEu0BnR3t/T1vrE+0toAEQulztq4YX234aIKhYcLUjmLiOTXAkM5LkjISUUBQ1kU/IZlzGMhfJ2GuASSfJxbGuSABEEygOlYQM2DwhJZyxCUU2TXISgAoPIS/BSUnWgKpBRYBQneEiR7FHLMdmEIFZLRQLNtECB5JcybM1BxGLaDYqYqJRQ8ulxw5rDKm5nkMdwylwqcBdLdjOa7Df3BwRgj3K9uVSmfTB3EQ6MzI6PjkgNqyVqvGQo4iWSPNo2DFx5CgqlPDm25AAreVKhoEJ4cTU6g7Ni2rpNWcCqqNRADCWjVjcTChssH0q75uKJioPOl4R0c1t/S+WyecDqIZtatHKVowyNvRT2KC10ThbIjMS8V/Pl1DBylvYS3KjQ+npdDbLRXLZrOectkxs+tz4vmAdVfgi8uYxdQvIwLzBRFgqYs8yNUmXFd1UZV4yooBX5Cjm4wZQeT2hxhKmEoemonOpB7FKLbBV72tp3RDZsGOblk8siYw7dAgzlnBz+iRNbUgfA03YE146T30G6jh5Pc2SpMz4IlpVTYnO2b6OcJERHwmGW4tkTYJMdH6t11L/t0LEMtBVSY+yctclaMb+IyGmaloQN0uZouhKFBl5XpbiBq+YqsEnEirmJRzFUQnJCsgr/2vx39MipZ6llyiu63HjREBqkhsuWGxysuJibiMiOE5rYlkgSW6OUlcTxXK5LJRlwfFmRfaDgeLU2OGcMYeLiKtjra3BvBWo1sDMilgaZQ4kuQWmSra5PculDjmEYnOtNJpcSm38eo/Qcobj4qxTsIzKzooNEpr1ax15tLKtCI0geScsc2fF9wBL6J/xYiG6sxiBCoxGIXuU7cXFriw7Ki7DKQp+pgXkuoKHXOp4Aks09ZxCAXvChGUaw/XhtkInfjHvrOB9e8IWQK61SgJjQ3QQ++2Lgbeiwc70A4yZ8Dw7g5B/2N8vBeI9D/G1u0L9niA2NwepluCBiyENLIairL8AKuiH+8G+jrYXwm0PR4hFsWChvECsWZvdeT0szOOKiyxP02A8prZ2hAYX5qcbm5LLL4K99baksw12NfQo4Kn1mXa4q7ebSR1KUJKBCpUZ8PT6bBjuCT92YOnGXfPU7b63bkrPnZjq273c/+oR0F0HhULtLeEz1Tz69fhvK690v3H2+Mx15VLmpWv28snrX4pX97xzWs9+vPTZD7sufr3cc/fHP4/defvJldjnV59J3Rotf3PmdevRnrHBXx6f/2Lw+1vXLrTOfbX35Ae33+y68PO7A1Nk5uaVix+NTr/27dmlT4cmv3tk9/nzx957/1IptrLv995y/539H37ycjm0fKN3lcO/ANP9r+ytDQAA';
        req.headers.authorization = 'bearer ' + inValidToken;

        var config = {};
        config.consumerId = consumerId;
        config.appSecret = appSecret;

        iaf.validateUserToken(req, config, function (err, token) {
            assert.ok(err);
            assert.ok(!token);
            done();
        });

    });


    it('IAF client should be able to validate user token with authorized credentials: Invalid token scenario, middleware', function (done) {

        var req = utils.injectRequest();
        var inValidToken = 'v^1.1#i^1#r^0#I^3#f^0#p^1#t^H4sIAAAAAAAAAO1XX2gcRRjPJZdIiEktalPUh2ONlBp2d2b/3J8ld+nlT+lhk5y92Cah0s7uziXb3O0uO3O9HChcUyiUCKIoBaWl9kEQKrToQy15VcEHQST6pmK1iL4oFKUv4uzmcrkLNimmYh7cl2V2ft/M9/2+3zc7H6h2dD577tC5P7pDD7VeroJqaygEu0BnR3t/T1vrE+0toAEQulztq4YX234aIKhYcLUjmLiOTXAkM5LkjISUUBQ1kU/IZlzGMhfJ2GuASSfJxbGuSABEEygOlYQM2DwhJZyxCUU2TXISgAoPIS/BSUnWgKpBRYBQneEiR7FHLMdmEIFZLRQLNtECB5JcybM1BxGLaDYqYqJRQ8ulxw5rDKm5nkMdwylwqcBdLdjOa7Df3BwRgj3K9uVSmfTB3EQ6MzI6PjkgNqyVqvGQo4iWSPNo2DFx5CgqlPDm25AAreVKhoEJ4cTU6g7Ni2rpNWcCqqNRADCWjVjcTChssH0q75uKJioPOl4R0c1t/S+WyecDqIZtatHKVowyNvRT2KC10ThbIjMS8V/Pl1DBylvYS3KjQ+npdDbLRXLZrOectkxs+tz4vmAdVfgi8uYxdQvIwLzBRFgqYs8yNUmXFd1UZV4yooBX5Cjm4wZQeT2hxhKmEoemonOpB7FKLbBV72tp3RDZsGOblk8siYw7dAgzlnBz+iRNbUgfA03YE146T30G6jh5Pc2SpMz4IlpVTYnO2b6OcJERHwmGW4tkTYJMdH6t11L/t0LEMtBVSY+yctclaMb+IyGmaloQN0uZouhKFBl5XpbiBq+YqsEnEirmJRzFUQnJCsgr/2vx39MipZ6llyiu63HjREBqkhsuWGxysuJibiMiOE5rYlkgSW6OUlcTxXK5LJRlwfFmRfaDgeLU2OGcMYeLiKtjra3BvBWo1sDMilgaZQ4kuQWmSra5PculDjmEYnOtNJpcSm38eo/Qcobj4qxTsIzKzooNEpr1ax15tLKtCI0geScsc2fF9wBL6J/xYiG6sxiBCoxGIXuU7cXFriw7Ki7DKQp+pgXkuoKHXOp4Aks09ZxCAXvChGUaw/XhtkInfjHvrOB9e8IWQK61SgJjQ3QQ++2Lgbeiwc70A4yZ8Dw7g5B/2N8vBeI9D/G1u0L9niA2NwepluCBiyENLIairL8AKuiH+8G+jrYXwm0PR4hFsWChvECsWZvdeT0szOOKiyxP02A8prZ2hAYX5qcbm5LLL4K99baksw12NfQo4Kn1mXa4q7ebSR1KUJKBCpUZ8PT6bBjuCT92YOnGXfPU7b63bkrPnZjq273c/+oR0F0HhULtLeEz1Tz69fhvK690v3H2+Mx15VLmpWv28snrX4pX97xzWs9+vPTZD7sufr3cc/fHP4/defvJldjnV59J3Rotf3PmdevRnrHBXx6f/2Lw+1vXLrTOfbX35Ae33+y68PO7A1Nk5uaVix+NTr/27dmlT4cmv3tk9/nzx957/1IptrLv995y/539H37ycjm0fKN3lcO/ANP9r+ytDQAA';
        req.headers.authorization = 'bearer ' + inValidToken;
        req.ebay.appContext.appName = 'nodedemo1';

        var config = {};
        config.consumerId = consumerId;
        config.appSecret = appSecret;

        iaf()(req, {}, function () {
            req.iaf.authenticateRequest(config, function (err, token) {
                assert.ok(err);
                assert.ok(!token);
                done();
            });
        });

    });

});
