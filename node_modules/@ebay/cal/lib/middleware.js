'use strict';

var nsutils = require('./nsutils');
var threads = require('./threads');
var constants = require('./constants');
var correlationId = require('./correlationId');
var appContext = require('@ebay/app-context-ebay');
var configBean = require('@ebay/config-bean-ebay');

var calLogger, appContext;

module.exports = function middleware(options) {
    options = options || {};
    var enableBuffering = (typeof options.enableBuffering === 'boolean') ? options.enableBuffering : false;
    var enableNestedCal = options.enableNestedCal === undefined ? false : options.enableNestedCal;
    var releaseTimeout = options.releaseTimeout || 25000; //auto release timeout 25s
    var bufferFlushDelay = options.bufferFlushDelay || 0;

    calLogger = require('./index');
    appContext = require('@ebay/app-context-ebay');
    const modconfig = require('@ebay/module-config-inc');
    const configPromise = new Promise(resolve => {
        modconfig(module, (err, cfg) => {
            //for err handling, skip it as no error will be thrown 
            cfg.on('change', () => configCal(options, cfg));
            configCal(options, cfg);
            resolve(cfg);
        });
    });

    return async function cal(req, res, next) {
        var isReleased = false;
        var releaseTimer;
        const routeReleaseTimeout = req.route && req.route.config && req.route.config.releaseTimeout || releaseTimeout;

        try {
            // await for config read to complete
            await configPromise;
            nsutils.run(
                req, res, function () {
                nsutils.set(constants.BUFFER_FLUSH_DELAY, bufferFlushDelay);
                nsutils.set(constants.IS_BUFFERING, enableBuffering);
                nsutils.set(constants.IS_NESTED_CAL, enableNestedCal);
                nsutils.set(constants.RELEASE_TIMEOUT, routeReleaseTimeout);
                nsutils.set(constants.TX, null);
                var threadId = threads.getNextThreadId();
                nsutils.set(constants.THREAD_ID, threadId);
                req.threadId = threadId;    //For backward compatibility
                nsutils.set('correlationId', correlationId(req));
                // reset counter
                nsutils.set('nextId', null);
    
                var releaseThreadId = function releaseThreadId() {
                    if (isReleased) {
                        return;
                    }
                    isReleased = true;
                    threads.releaseThreadId(threadId);
                    clearTimeout(releaseTimer);
                    releaseTimer = undefined;
                    res.removeListener('close', releaseThreadId);
                    res.removeListener('finish', releaseThreadId);
                    res.removeListener('error', releaseThreadId);
                };
                res.once('close', releaseThreadId);
                res.once('finish', releaseThreadId);
                res.once('error', releaseThreadId);
    
                //Auto release the CAL transaction, in case of error
                releaseTimer = setTimeout(function () {
                    releaseThreadId();
                }, routeReleaseTimeout);
    
                next();
            });
        }
        catch (err) {
            console.error('Failure in CAL middleware', err);
        }
    };
};

// ebay-scope-conversion-skip-after
function configCal(options, cfg) {
    const config = options.cal || {};
    //Switch to localhost for filebeats when the flag is true
    if(appContext.useFileBeatsForCAL === 'yes') {
        let bean = configBean.getBeanById('nodejs.config.cal.general');
        let host = process.env.CAL_HOST || 'localhost';
        let port = process.env.CAL_PORT || 1118;
        
        bean && bean.set('commons:cal:host', host);
        bean && bean.set('commons:cal:port', port);

        cfg.set('commons:cal:host', host);
        cfg.set('commons:cal:port', port);
        config.settings = Object.assign({}, cfg.get('commons:cal'));
    }
    else {
        config.settings = Object.assign({}, cfg.get('commons:cal'), config.settings);
    }
    
    config.settings.poolname = config.settings.poolname || appContext.poolName;

    const type = config.type || 'cal',
        format = config.format || 'cal';

    calLogger.setDefaultWriteStream(type, config.settings);
    calLogger.defaults.formatter = calLogger.formatter[type === 'cal' ? 'cal' : format];
}
