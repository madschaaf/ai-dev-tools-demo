/* eslint-disable max-len */

'use strict';
const envEbay = require('@ebay/environment-ebay');
const yaml = require('js-yaml');
const path = require('path');
const fs = require('fs');
const util = require('util');
const readdir = util.promisify(require('fs').readdir);
const appContext = require('@ebay/app-context-ebay');

/*
    Directly reading from file because raptor-config-ebay won't be available unless the app starts and discovery is executed before appStart in build-ebay/startup
 */
module.exports = async() => {
    const ymlFilePath = await getYmlFilePath();
    if (fs.existsSync(ymlFilePath)) {
        try {
            const doc = yaml.safeLoad(fs.readFileSync(ymlFilePath, 'utf8'), {
                json: true // making sure that duplicate keys are overwritten
            });
            const result = {};
            if (doc && Object.entries(doc).length > 0) {
                for (const [urn, arr] of Object.entries(doc)) {
                    result[urn] = arr.find(a => a.serviceTag !== undefined).serviceTag;
                }
            }
            return result;
        } catch (e) {
            console.error('[service-discovery-ebay] Yaml parsing for service-discovery-config.yaml failed ', e);
        }
    }
};

async function getYmlFilePath() {
    let root = path.join(
        `.cache/globalconfig/sd_${appContext.appName}/`); // raptor uses .appdata/.globalconfig
    if (envEbay.isNotDev()) {
        // ContainerPDLC use config_home env variable, if we didn't detect this env, fall back to c3 path
        if (process.env.CONTAINER_PDLC === 'true' && process.env.CONFIG_HOME) {
            root = path.join(process.env.CONFIG_HOME, `/sd_${appContext.appName}`);
        } else {
            root = path.join(process.env.CRONUSAPP_HOME || '', `manifests/active/.configs/active/sd_${appContext.appName}`);
        }
    }
    const files = (fs.existsSync(root) && await readdir(root)) || [];
    // picking up the first match, because it's the protocol; there'll always be only one
    const fileName = files.find(f => (! /^\..*/.test(f)) && f.indexOf('.yaml') > -1);
    if (fileName) {
        return path.join(root, fileName || '');
    }
}
