'use strict';
/* eslint-disable chai-friendly/no-unused-expressions */

const cfBean = require('@ebay/config-bean-ebay');
const BEAN_ID = 'ServiceDiscoveryClientConfigBean';
const beanDef = {
    'configbean': true,
    'id': BEAN_ID,
    'alias': BEAN_ID,
    'group': 'nodejs.config',
    'desc': 'Service Discovery Client Config Bean',
    'attributes': [
        {
            'name': 'enabled',
            'value': 'true',
            'desc': '',
            'readable': 'true',
            'writable': 'true'
        },
        // {
        //     'name': 'connectTimeout',
        //     'value': 2000,
        //     'desc': '',
        //     'readable': 'true',
        //     'writable': 'true'
        // },
        // {
        //     'name': 'retries',
        //     'value': 3,
        //     'desc': '',
        //     'readable': 'true',
        //     'writable': 'true'
        // },
        {
            'name': 'forceRefresh',
            'value': Date.now(),
            'desc': '',
            'readable': 'true',
            'writable': 'true',
            'type': 'timestamp'
        },
        {
            'name': 'exclusions',
            'value': [],
            'desc': '',
            'readable': 'true',
            'writable': 'true'
        }
    ]
};

class DiscoveryClientConfigBean {
    constructor() {
        this._bean = cfBean.getBeanById(BEAN_ID) || cfBean.define(beanDef);
        this._bean.on('changed', () => {
            if (this._bean.get('forceRefresh') > Date.now() - 6000) {
                this._forceRefreshCallback && this._forceRefreshCallback();
            }
        });
    }

    get enabled() {
        return this._bean.get('enabled');
    }

    get exclusions() {
        return this._bean.get('exclusions');
    }

    set forceRefreshCallback(v) {
        this._forceRefreshCallback = v;
    }
}

module.exports = new DiscoveryClientConfigBean();
