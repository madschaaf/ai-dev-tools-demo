'use strict';
/* eslint-disable chai-friendly/no-unused-expressions */
const fs = require('fs');
const path = require('path');
const logger = require('@ebay/logging-inc').logger('service-discovery-ebay');
const CACHE_DIR = path.resolve(process.cwd(), '.cache');
const SERVICE_DISCOVERY_JSON = path.join(CACHE_DIR, '.discovery.json');

module.exports.writeDataToFile = (data, JSON_FILE_PATH = SERVICE_DISCOVERY_JSON) => new Promise((resolve, reject) => {
    const stream = fs.createWriteStream(JSON_FILE_PATH);
    let doResolve = true;
    stream.once('finish', () => {
        if (doResolve) {
            resolve(data);
            logger.info('Successfully written service-discovery json file ');
        }
    });
    stream.once('error', e => {
        doResolve = false;
        reject(e);
    });
    data.lastUpdatedTime = Date.now();
    stream.write(JSON.stringify(data));
    stream.end();
});

module.exports.createCacheDirIfNotExists = () => new Promise((resolve, reject) => {
    fs.stat(CACHE_DIR, (err, stats) => {
        if (err || !stats.isDirectory()) {
            fs.mkdir(CACHE_DIR, secondErr => {
                if (secondErr) {
                    logger.error('Unable to create .cache directory for storing .discovery.json ', secondErr);
                    reject(secondErr);
                } else {
                    resolve();
                }
            });
        } else {
            resolve();
        }
    });
});
