# service-discovery-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/service-discovery-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/service-discovery-ebay/job/master/)

This module provides the ability to resolve service endpoints using service discovery.

*  [Introduction](#introduction)

*  [Usage](#usage)

*  [Endpoint Resolution](#endpoint-resolution)

    *  [App startup](#scenario-1--app-startup)
    *  [App restart (box nuke)](#scenario-2--app-restart-box-nuke)
    *  [Process crash](#scenario-3--process-crash-note---nodejs-runs-3-child-processes)

*  [New service registration in ServiceRegistry](#new-service-registration-in-serviceregistry)

*  [Enable service discovery (or force-refresh)](#enable-service-discovery-or-force-refresh)

*  [Disable service discovery](#disable-service-discovery)

    *  [Disable for service : Method 1](#disable-for-service--method-1)
    *  [Disable for service : Method 2](#disable-for-service--method-2)
    *  [Disable on a Box](#disable-on-a-box)
    *  [Disable for application](#disable-for-application)

*  [Miscellaneous](#miscellaneous)

    *  [Service tag support](#service-tag-support)

*  [Usecases](#usecases)

    *  [Before app startup](#before-app-startup)
    *  [At app startup](#at-app-startup)
    *  [Force refresh endpoints](#force-refresh-endpoints)
    *  [Runtime endpoint lookup](#runtime-endpoint-lookup)

## Introduction

This module uses [service-discovery restful API](https://github.corp.ebay.com/raptor-io-apps/authzsvc-io/blob/master/service-discovery-api-reference.md#get-all-serviceintances-with-system-labels-and-application-labels)
to query the data corresponding to a given environment (classOfService, paasRealm, applicationName, vpc) and store in a cached file during application startup.

In dev/test environment the cache is created asynchronously & will not halt application startup. In case of failure, warnings will be logged in dev/test environment and error otherwise.

## Usage

If your app uses latest version of service-client-ebay (v4.1.0) or above, discovery is installed but disabled by default. Set `enabled:true` in VI Configuration bean `ServiceDiscoveryClientConfigBean` and force a refresh of endpoints as mentioned [here.](#enable-service-discovery-andor-refresh-endpoints)

Note 
-  VI will show the ultimately resolved endpoint in corresponding service's configbean
-  If a service is not registered in service-discovery, then it's endpoint will fallback to your applications' config.json. In other words, service-discovery endpoint takes higher priority over config.json endpoint if resolved.

### Interface
*  `loadCacheFromFile`
Loads cache from `.cache/.discovery.json` into memory
*  `lookup`
Given a serviceId, returns corresponding endpoint
*  `refreshCache`
Force refresh the endpoints and load in memory

## Endpoint Resolution
Resolution happens according to environment. Local environment (dev/test) is treated as staging for the purpose of service-discovery.
 
### Scenario 1 : App startup
Once the app (re)starts, if discovery is enabled then service-discovery data is fetched and cached in a file.
This cache is used to decide endpoints during service-calls and updates corresponding services' `.configbean` with discovered endpoints.
It also adds/updates an attribute `_discovered={timestamp}` only if it is less than the `timestamp` property of `ServiceDiscoveryClientComponentStatus`  
All subsequent service-calls are resolved using `.configbean` thereafter. 

### Scenario 2 : App restart (box nuke)
If service-discovery is down, when the app restarts; then it'll fallback to the last stored configuration in `.configbean`s.
Otherwise, it will be same as above scenario.

### Scenario 3 : Process crash (NOTE - Nodejs runs 3 or more child processes)
If the app is running & service has been already discovered (`_discovered` in services' `.configbean`) then discovery won't override `.configbean` again with discovered endpoints. At which point any changes to `.configbean` will take priority over discovery endpoint.

## New service registration in ServiceRegistry
[http://raptor/raptor/2.9.x/docs/Service-Discovery/service-registry.md](http://raptor/raptor/2.9.x/docs/Service-Discovery/service-registry.md)

## Enable service discovery (or force-refresh) 
In order to enable discovery and do a `forceRefresh` of endpoints, use VI configuration bean `ServiceDiscoveryClientConfigBean`. Update attribute `forceRefresh` to `now` and attribute `enabled` to `true`.

## Disable Service Discovery
### Disable for service : Method 1
By adding `"discovery":false`, to service configuration. Sample configuration
```json
{
    "services": {
        "sample-service": {
            "hostname": "example.com",
            "discovery": false
        }
    }
}
```
### Disable for service : Method 2
Provide list of services to exclude through VI configuration bean `ServiceDiscoveryClientConfigBean` attribute `exclusions`
```
exclusions: ["urn:REST:serviceOne", "urn:REST:serviceTwo"]
```
### Disable on a box

Service Discovery can be enabled/disabled on box by using `ServiceDiscoveryClientConfigBean` config bean.

URL: `http://<Host-IP>:8083/admin/v3console/ViewConfigCategoryXml?id=ServiceDiscoveryClientConfigBean`

### Disable for application

Application team can enable/disable service discovery by adding below configuration in their `config/config.json`

```json
{
    "@ebay/service-discovery-ebay": {
        "enabled": true
    }
}
```
Config bean to check for application flag `http://<host-ip>:8083/admin/v3console/ViewConfigCategoryXml?id=nodejs.config.service-discovery-ebay.common`

## Miscellaneous
### Service Tag Support
Please refer the [corresponding docs.](https://github.corp.ebay.com/MultiRepoDocs/raptor-docs/blob/RAPTOR-2.9.X-RELEASE/docs/Service-Discovery/README.md#service-tag-support)

## Usecases
### Before App Startup
Fetch endpoints, write to local file and validate
### At App Startup
Read from local file and create in-memory cache
### Force refresh endpoints
Fetch endpoints, write to local file, validate and update in-memory cache
### Runtime endpoint lookup
Read from cache and fallback if absent
