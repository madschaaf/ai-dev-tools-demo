# @ebay/openfeature-ebay

The module provides openfeature spec API for nodejs. This module is intended to replace experimentation-ebay as support for both Feature Flagging and Experimentation going forward.

## Breaking change in version 2.1.0

In 2.1.0, the client has been moved into openfeature context. Access client using `req.ebay.openfeature.client` previously `req.ebay.openfeature`



# Installation

```
npm install @ebay/openfeature-ebay
```

openfeature-ebay middleware requires device detection middleware with a higher order priority

```json
"device-detection-ebay": {
    "enabled": true,
    "priority": 112,
    "module": {
        "name": "@ebay/device-detection-ebay",
        "method": "middleware"
    }
},
```

# Usage

## From middleware

To register the openfeature-ebay module as a middleware, add the middleware configuration into the `middleware.json` file.
This middleware is meant to replace experimentation-ebay. If your app still relies on experimentation-ebay then you can use
the priority at `"priority": 118,` Please check with your middleware.json to set the correct priority. It needs to be higher number
than tracking-ebay and device-detection-ebay.

```json
"openfeature-ebay": {
    "enabled": true,
    "priority": 118,
    "module": {
        "name": "@ebay/openfeature-ebay",
        "method": "middleware"
    }
},
```

A new `req.ebay.openfeature` object will be created. The object will contain openfeature sdk client as well as ebay specific functionality. It will be created automatically with a default Openfeature Provider configured by this module.
By utilizing the middleware configuration, no additional setup is required by the application user if they are using the default openfeature provider.
In the future, we will likely move the ep service call to the middleware function in order to prefetch feature flags that are needed for the application/request

### Rendering using marko async

```js
export default async (req, res) => {
    // you can pass additional evaluation context in the request for custom attributes
    const evalCtx: EvaluationContext = {
        myKey: 'myValue',
    };
    res.marko(template, {
        myString: req.ebay.openfeature.client.getStringValue(
            'my_ff_1',
            'true',
            evalCtx
        ),
    });
};
```

### Using async/await

```js
export default async (req, res) => {
    const myString = await req.ebay.openfeature.client.getStringValue(
        'my_ff_1',
        'true'
    );
    res.marko(template, {
        myString: myString,
    });
};
```

#### DO NOT CHANGE PRIORITY and NAME(name should be `openfeature-ebay`)

```js
"openfeature-ebay": {
    "enabled": true,
    "priority": 118,
    "module": {
        "name": "@ebay/openfeature-ebay",
        "method": "middleware"
    }
},
```

### Disable Openfeature by route

In routes.json for your desired route, you can disable openfeature by setting openfeature configuration to false.
By disabling openfeature, `req.ebay.openfeature` will no longer be returned. Please ensure your route does not have any code reference to openfeature.
Note: If your route is rendering global header, it is not recommended to disable openfeature without consulting with the global header team as this will affect
their experiments and feature flags.

```json
{
    "route": "POST /disabledOpenfeature => ./src/pages/qualification/disabledOpenfeature",
    "pageName":"TestDisabledOpenfeature",
    "openfeature": {
        "enabled": false
    }
},
```

### Use the default provider outside of request flow

Outside the request flow, the user will need to import the fflagClient and include the qualification criteria manually and pass in the key value pairs as part of the hook hints. See [hook hints](https://docs.openfeature.dev/docs/specification/sections/hooks#42-hook-hints)
Note that the minimum required input values is a `siteId`, `channelId`, and `guid`. Even if your feature is user id based, a guid is necessary as part of the UBI event tracking pipeline.

```js
import {
    OpenFeatureProvider,
    FFlagClient,
    QualificationCriteriaHook,
} from '@ebay/openfeature-ebay';
import { OpenFeature } from '@openfeature/js-sdk';

const qualificationCriteria = {
    siteId: 0,
    channelId: 1,
    guid: '12d8b2661850ae313acdaeeafffffff1',
};
const evalCtx: EvaluationContext = {};
const flagEvalOptions: FlagEvaluationOptions = {
    hooks: [new QualificationCriteriaHook()],
    hookHints: qualificationCriteria,
};
OpenFeature.setProvider(new OpenFeatureProvider());
const openfeatureClient = OpenFeature.getClient();
const value = await openfeatureClient.getStringValue(
    'leon_ff_1',
    'true',
    evalCtx,
    flagEvalOptions
);
```

### Using a custom provider of your choice

```js
import { MY_PROVIDER } from '../MyProvider';

OpenFeature.setProvider(MY_PROVIDER);
const openfeatureClient = OpenFeature.getClient();
const value = await openfeatureClient.getStringValue('custom_ff', 'default');
```

## Drop Tags usage

By default, epsvc will drop the ep tags for you. If you do not wish to drop any ep tags such as `!xt`, you can disable tag drop by including the TagDropHook and setting the hook hints with the dropTag:false value as seen here.

```javascript
const flagEvalOptions: FlagEvaluationOptions = {
    hooks: [new TagDropHook()],
    hookHints: { dropTag: false },
};

await openfeatureClient.getStringValue( 'my_ff_1', 'failure', evalCtx, flagEvalOptions);
```

## Details

There are two flavors of openfeature client SDK. You can simply return the flag evaluation value using getValue, or return the details using getDetails. Details will include information such as the variant id, reason, and error messages.
See: [Detailed Flags Evaluation](https://docs.openfeature.dev/specification/sections/flag-evaluation#14-detailed-flag-evaluation)


## Custom Attributes

To utilize custom attributes, you can include the key value in the `contextParams` object in evaluation context as seen below. The current attribute types that are supported are strings and numbers.

```javascript
const evalCtx: EvaluationContext = {
    contextParams: {
        SITEID: '0',
        EP_STRING_CUSTOM_ATTRIBUTE: 'custom_string',
        EP_INTEGER_CUSTOM_ATTRIBUTE: 1234567,
    },
};

await openFeatureClient.getStringValue( 'my_ff_1', 'failure', evalCtx);
```

## Any ID usage

To use Any ID experimentation, you can include the ANY_ID_TYPE in the evaluation context. Then you can set the targeting key as the any id key

```javascript
const evalCtx: EvaluationContext = {
    ANY_ID_TYPE: 'myAnyIdType'
};

evalCtx.targetingKey = 'myAnyId';
```

# Openfeature API Spec

See detailed documentation at [openfeature spec](https://docs.openfeature.dev/docs/specification/sections/flag-evaluation)

In general, openfeature supports 4 types of evaluations:

```js
// example boolean flag evaluation
const myBool = client.getBooleanValue('bool-flag', false);

// example overloaded string flag evaluation with optional params
const myString = client.getStringValue(
    'string-flag',
    'N/A',
    evaluationContext,
    options
);

// example number flag evaluation
const myNumber = client.getNumberValue('number-flag', 75);

// example overloaded structure flag evaluation with optional params
const myStruct =
    client.getObjectValue <
    MyStruct >
    ('structured-flag',
    { text: 'N/A', percentage: 75 },
    evaluationContext,
    options);
```

## Smart Client Feature (Experimental)
Smart client feature is designed to reduce the latency of feature flag network call by only evaluating flags that are relevant to the application.
In order to enable the feature please reach out to the experimentation team through #experimentation-support slack channel to request access to the feature.
Currently it is enabled for a pool-by-pool basis.



# Internal development guide

## Setup typescript
```
npm install -g typescript
npm link typescript
```

## Compiling in ts

Using yarn script

```
yarn build
```

Manually

```
tsc
```

Before building, it is recommended to clean out the autogenerated folders

```
yarn clean
```

or

```
rm -rf ./dist
```

## Entry by middleware

In order to import the library as a middleware, the path to the middleware is referencing `index.js` in the src directory. The default method will export the middleware function in the library. In addition, other modules are exported here.

```js
import QualificationCriteriaHook from './hooks/QualificationCriteriaHook';
import OpenFeatureProvider from './provider/OpenFeatureProvider';
import FFlagClient from './FFlagClient';

exports.middleware = require('./middleware');
export { QualificationCriteriaHook, OpenFeatureProvider, FFlagClient };
```

## Entry by API

Deprecated and removed.

## FFlagClient

FFlagClient, or Feature Flag Client is a client that wraps the service client request to epsvc endpoint

# Testing

Tests are written using Mocha JS framework and mocked with Sinon js. Coverage is using Istanbul.

### Run tests

```
yarn test
```

### Run coverage

After running coverage, the report can be found in coverage/lcov-report directory. Open the index.html file in the browser.

```
yarn coverage
```
