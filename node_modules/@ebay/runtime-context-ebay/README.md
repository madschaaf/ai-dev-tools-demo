runtime-context-ebay
=====================

The module extends [oja/runtime](https://github.com/dimichgh/oja) framework to adapt to ebay infrastructure and provide context based approach for structuring business logic.

![context diagram](./docs/images/context.png)

# Install

```
$ npm install runtime-context-ebay -S
# or
$ yarn add runtime-context-ebay
```

# Features

The adaptation to ebay infrastruture includes easy access to:

* async/await style programming
* request query, body and path params via `context.parameters`
* services, automatically discovers all services defined in config/config.json files in application repo and makes them available via `context.services.<action name>`
* ebay context is available at `context.ebay`
* i18n is available as `context.i18n`
* domain actions defined in `config/config.json/runtime-context/<domain>/<action name>` and available as context.<domain>.<action name>
* request/response are available in `context.incoming.request` and `context.outgoing.response`, but it is recommended to avoid using them directly and provide access or update actions instead

Demo:
<br/>
<p align="left">
    <img src="https://github.corp.ebay.com/nodejs/brand/blob/master/images/oja-tip-controller-to-action.gif" alt="converting controller to action" width="500" /><br /><br />
</p>

To learn more please see the below video tutorials:
<p align="left">
    <a href="https://go/learn-oja">
    <img src="https://github.corp.ebay.com/nodejs/brand/raw/master/images/video-tutorials-matrix-logo.jpg" alt="Node.JS Video Tutorials Logo" width="332" />
    </a>
    <br /><br />
</p>

# Usage

## Integration into application

### Business actions

Context based approach allows to slice business logic into small, independent actions.

The action interface assumes async/await pattern and has a very simple interface

```js
module.exports = async context => {
    // do any actions here
};
```

Or if one wants to pass any parameters separately

```js
module.exports = context => async parameters => {
    // do any actions here
};
```

Example of how the declared actions/service can be used in application code.

src/actions/history.js
```js
module.exports = async context => {
    const userId = context.query.userId;
    // then one can execute any function available in the runtime context
    const userData = await context.actions.getUserData(userId);
    ....
};
```

### Configuration

The context is defined/configured in `app/config/config.json/runtime-context`via a list of actions.

Example:

config/config.json:

```json
{
    "services": {
        "usersvc": {
            "hostname": "userdata.vip.ebay.com",
            "socketTimeout": 2000
        }
    },
    "runtime-context": {
        "controllers": {
            "history": "path:src/controllers/history/action"
        },
        "actions": {
            "getUserData": "path:src/actions/get-user-data",
            "updateUserData": "path:src/actions/update-user-data"
        },
        "sales": {
            "purchaseHistory": "path:src/myebay/purchase-history",
            "wishList": "path:src/slaes/wish-list"
        }
    }
}
```

Or below structure assumes that the first level of folders are domains and the next level of files are actions

```json
{
    "runtime-context": {
        "sources": [
            "path:src/actions",
            "path:src/other-actions"
        ]
    }
}
```

One can apply a filter to the given folders for action discovery

```json
{
    "runtime-context": {
        "sources": [
            {
                "source": "path:src/actions",
                "filter": "regexp:\-action\.js"
            },
            {
                "source": "path:src/other-actions",
                "filter": "path:src/my-action-filter"
            }
        ]
    }
}
```

#### Action filer API

```js
async filepath => {
    // note that, it is async and you can do async operations (read file context and analyze the file, for example)
    // to decide if the given file path is action or not
    return true; // or false
}
```

One can even provide their own resolver that should return back one of the above json objects

```json
{
    "runtime-context": "path:src/context-resolver"
}
```

#### Context resolver API

```js
async options => {
    // put your resolution code here
    // it must resolve to
    return {
        functions: {}
    }
}
```

NOTE: one can define as many domains as needed.
Domains such as controllers and services are reserved by the framework.

Once application data is configured as shown above, it becomes available in runtime context passed to every context based function.

### Controller

First, we should define page controller action that we will register in config.json below

* History page action

    src/contorllers/history/action.js
    ```js
    const { Response } = require('@ebay/runtime-context-ebay').express;
    module.exports = async context => {
        context.incoming.response.setHeader('Content-Type', 'text/html; charset=utf-8');

        // NOTE: no need to wrap into try/catch as it is already handled by context express handler below

        // access some parameters
        const userId = context.parameters.userId;
        // then one can execute any function available in the runtime context
        const userData = await context.actions.getUserData(userId);
        // then we can get purshase history
        const history = await context.sales.purchaseHistory(userData.accountId);

        // form the model
        const viewModel = {
            userData,
            locality: req.locality,
            appmeta: {
                pageName: req.ebay.getPageName(),
                pageId: req.ebay.getPageId()
            }
        };

        // You can render template
        // =======================

        template.render(viewModel, context);
        // wait for response rendering to end
        // good for testing  
        // wait for the render end        
        await context.end();
        // =======================
        /*
            Or in case of Ajax or redirect, one can return response object explicitly
            =======================
            return Response({
                status: 200,
                headers,
                body: String or Readable stream
            });
            =======================
        */
    };
    ```

    src/actions/get-user-data.js
    ```js
    module.exports = context => async userId => {
        // NOTE: how easy one can access service defined in config.json
        const response = await context.services.usersvc.get({
            userId
        }).end();
        // imaginary service response
        return response.body.userInfo;
    };
    ```

* Controller action registration

    config/config.json:
    ```json
    {
        "runtime-context": {
            "controllers": {
                "history": "path:src/actions/history.js"
            }
        }
    }
    ```

* History page controller

    To integrate into existing route matcher, we still need to provide express based handler, but it is a very simaple one.

    ```js
    const Context = require('@ebay/runtime-context-ebay');
    // note that you can create your own wrapper if really needed
    module.exports = Context.expressHandler('history', options);
    ```

### File based configuration

In order to automate configuration of the actions we can rely on folder structure

```json
{
    "runtime-context": {
        "sources": [ "path:../src" ]
    }
}
```

The folder structure could look as follows given the above runtime-context configuration.

```
app/src
    /controllers
      /history.js
    /actions
      /getUserData.js
      /updateUserData.js
    /sales
      /purchaseHistory.js
      /wishList.js
```

### Unit testing

Any action or services defined in config/config.json can be easily mocked.

#### Mocking service result in get-user-data action

```js
const Context = require('@ebay/runtime-context-ebay');

describe('get-user-data action', () => {
    it('should mock service data for action', async () => {
        const context = Context.create();
        context.services.define('usersvc', {
            statusCode: 200,
            body: {
                userInfo: {
                    some: ['user', 'data']
                }
            }
        });

        // NOTE: it will automatically discover your actions from config.json file
        const userData = await context.actions.getUserData('john');
        Assert.deepEqual({
            some: ['user', 'data']
        }, userData);
    });

    it('should mock service error for action', async () => {
        const context = Context.create({
            services: {
                // NOTE: you can specify response object as part of context as well
                usersvc: new Error('BOOM')
            }
        });

        try {
            await context.actions.getUserData('john');
            return Promise.reject(new Error('should have failed'));
        }
        catch (err) {
            Assert.equal('BOOM', err.message);
        }
    });

    it('should mock service stream', async () => {
        const context = Context.create({
            services: {
                // NOTE: you can specify response object as part of context as well
                usersvc: ['chunk1', 'chunk2', null] // << mark the end
            }
        });

        const buffer = [];
        for await (const chunk of context.actions.getUserData('john')) {
            buffer.push(chunk);
        }
        Assert.equal('chunk1,chunk2', buffer.join('',));
    });

    it('should mock service stream delays', async () => {
        const context = Context.create({
            services: {
                // NOTE: you can specify response object as part of context as well
                usersvc: ['chunk1', Promise.resolve('chunk2'), null] // << mark the end
            }
        });

        const buffer = [];
        for await (const chunk of context.actions.getUserData('john')) {
            buffer.push(chunk);
        }
        Assert.equal('chunk1,chunk2', buffer.join('',));
    });
});
```

#### Mocking get-user-data action for src/contorllers/history/action.js

```js
const Context = require('@ebay/runtime-context-ebay');

describe('controller action', () => {
    it('should render hisotry page', async () => {
        const context = Context.create({
            // mock response
            properties: {
                response: {
                    set() {},
                    write(data) {
                        // collect into response
                        this.buffer.push(data);
                    }
                    end() {
                        // complete response
                    }
                }
            },
            functions: {
                actions: {
                    // mock get user data action
                    getUserData: {
                        some: ['user', 'data']
                    }
                }
            }
        });

        // call hisotry controller action and wait till it is done
        await context.controllers.history();
        // assert
        Assert.deepEqual({
            some: ['user', 'data']
        }, context.response.buffer);
    });

    it('should mock action failures if any', async () => {
        const context = Context.create({
            // mock response
            properties: {
                response: {
                    set() {},
                },
            },
            functions: {
                actions: {
                    // mock get user data action error
                    getUserData: new Error('BOOM')
                }
            }
        });

        try {
            await context.controllers.history();
        }
        catch (err) {
            Assert.equal('BOOM', err.message);
        }
    });
});
```
