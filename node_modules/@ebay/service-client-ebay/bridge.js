
'use strict';

const Provider = require('@ebay/service-client-ebay');

module.exports = (req, res, next) => {
    // When bridge mode is not transition or empty, it assumed to be in final mode (commons to new use-cases),
    // otherwise it is assumed to be in transition mode, where it can be switched between browser->service and browser->fe->service mode.
    const bridgeMode = req.headers['x-ebay-bridge-mode'];
    const clientId = req.headers['x-ebay-client-id'];
    const path = req.headers['x-ebay-client-target-path'];

    // guard against hackers
    const allowedServices = req.route && req.route.config && req.route.config.allowedServices;
    if (!allowedServices || !allowedServices.includes(clientId)) {
        next(new Error(`Attempt to use unauthorized client ${clientId}`));
        return;
    }

    const body = req.body && Object.keys(req.body).length > 0 && req.body || undefined;
    const request = {
        method: req.method.toUpperCase(),
        path,
        body: body && JSON.stringify(body),
        qs: req.query
    };

    const contentType = req.headers['content-type'];
    if (contentType) {
        request.headers = {
            'content-type': contentType
        }
    }

    // adding `-bridge` to allow two configs for the "same" clientId when in transition mode
    const bridgeClientId = (bridgeMode === 'transition' || !bridgeMode) ? `${clientId}-bridge` : clientId;
    Provider.context(req).getClient(bridgeClientId).request(request).end((err, response) => {
        if (err) {
            next(err);
            return;
        }
        if (response.body instanceof Buffer) {
            return res.status(response.statusCode).end(response.body.toString());
        }
        res.json(response.body);
    });
}
