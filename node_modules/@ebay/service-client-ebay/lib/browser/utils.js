'use strict';

var Hmv = require('@ebay/header-multi-value-ebay');

function mixinMvHeaders(srcHeaders, targetHeaders, mvHeadersRepo) {
    mvHeadersRepo = mvHeadersRepo || {};
    targetHeaders = targetHeaders || {};
    /*
     * Merges source headers to target headers
     *  if header name is in mvHeadersRepo then it is multi-value and we need to merge
     *    if source and target are not empty, we need to parse each and merge and toString to target
     *    if source is empty, target should be presevred
     *    if target is empty, should be assigned to target
     *  otherwise - just assign source to target (override) if not empty or preserve target
    */

    // clean up empty targets
    Object.keys(targetHeaders).forEach(function forEach(key) {
        if (!targetHeaders[key]) {
            delete targetHeaders[key];
        }
    });
    // mixin
    return srcHeaders ? Object.keys(srcHeaders).reduce(function reduce(target, key) {
        var srcHeader = srcHeaders[key];
        var targetHeader = target[key];
        if (targetHeader && srcHeader && mvHeadersRepo[key]) {
            var targetMv = Hmv.parse(targetHeader);
            var srcMv = Hmv.parse(srcHeader);
            srcMv.names().forEach(function forEach(name) {
                targetMv.set(name, srcMv.get(name));
            });
            targetHeader = targetMv.toString();
            target[key] = targetHeader;
        }
        else {
            target[key] = srcHeader || targetHeader;
        }
        // clean up empty values
        if (!target[key]) {
            delete target[key];
        }
        return target;
    }, targetHeaders) : targetHeaders;
}

function mixin(src, target) {
    if (src && typeof src === 'object' && target && typeof target === 'object') {
        target = target || {};
        Object.keys(src).forEach(function (key) {
            var srcVal = src[key];
            var targetVal = target[key];
            target[key] = mixin(srcVal, targetVal);
        });
        return target;
    }
    return src || target;
}


module.exports.mixinMvHeaders = mixinMvHeaders;
module.exports.mixin = mixin;
