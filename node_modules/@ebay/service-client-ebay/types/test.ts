import { Request } from 'express';
import * as Provider from '@ebay/service-client-ebay';
import { createReadStream } from 'fs';

async (req: Request) => {
    // req is http request from the request flow or mock context
    const client = Provider.context(req).getClient('my-client-id');
    client
        .get({
            userId: 123121
        })
        .set('header-foo', 'header-bar')
        .set('header-A', 'header-B')
        .path('/path/to/resource')
        .end((err, data) => {
            console.log(err, data);
        });

    // or parameterized path
    client
        .get({
            userId: 123121
        })
        .set('foo', 'bar')
        .set('A', 'B')
        .path('/path/to/:resource', { resource: 12345 })
        .end((err, data) => {
            console.log(err, data);
        });

    client
        .get({
            foo: 'bar'
        })
        .end((err, res) => {
            console.log('Got service response:', err || res);
        });

    // ednAsAsync
    const response = await client
        .get({
            foo: 'bar'
        })
        .endAsAsync();
    console.log(response.body.toString());

    // GET
    client
        .get({
            param1: 'value1',
            param2: 'value2'
        })
        .set('Cache-Control', 'no-cache')
        .set('multi-value-header')
        .set('foo', 'bar')
        .set('qaz', 'qwe')
        .build()
        .end((err, resource) => {
            if (err) {
                console.error(err);
                return;
            }
            const chunk = resource && resource.body;
            if (chunk) {
                console.log(chunk);
            } else {
                console.log('end of stream');
            }
        });

    // POST
    client
        .post({
            body: 'post request body',
            qs: {
                param1: 'value1',
                param2: 'value2',
            },
            path: 'path/to/target'
        })
        .end((err, resource) => {
            if (err) {
                console.error(err);
                return;
            }
            const chunk = resource && resource.body;
            if (chunk) {
                console.log(chunk);
            } else {
                console.log('end of stream');
            }
        });

    // PUT
    client
        .put({
            body: 'put request body',
            qs: {
                param1: 'value1',
                param2: 'value2',
            },
            path: 'path/to/target'
        })
        .end((err, resource) => {
            if (err) {
                console.error(err);
                return;
            }
            const chunk = resource && resource.body;
            if (chunk) {
                console.log(chunk);
            } else {
                console.log('end of stream');
            }
        });

    // DELETE
    client
        .delete('path/to/resource')
        .end((err, resource) => {
            if (err) {
                console.error(err);
                return;
            }
            const chunk = resource && resource.body;
            if (chunk) {
                console.log(chunk);
            } else {
                console.log('end of stream');
            }
        });

    // PATCH
    client
        .patch({
            body: 'patch request body',
            qs: {
                param1: 'value1',
                param2: 'value2',
            },
            path: 'path/to/target'
        })
        .end((err, resource) => {
            if (err) {
                console.error(err);
                return;
            }
            const chunk = resource && resource.body;
            if (chunk) {
                console.log(chunk);
            } else {
                console.log('end of stream');
            }
        });

    const requestOptions = {
        method: 'POST',
        body: JSON.stringify({
            foo: createReadStream('./test/fixtures/file.txt'), // read streams
            bar: Buffer.from('hello'),                            // buffers
            qaz: 'world',                                         // strings
            custom: {
                value: 'world',
                options: {                                        // starting with httpunch@^1.5.0
                    filename: 'file-name',                        // profile your own file name
                    contentType: 'text/html'                      // force content type
                }
            }
        })
    };
    const context = {
        foo: 'default context'
    };
    Provider
        .context(req || context)
        .getClient('multipart-client-id')
        .request(requestOptions, (err, res) => {
            console.log('Got service response:', err || res);
        });

    client
        .request(requestOptions)
        .end((err, resource) => {
            if (err) {
                console.error(err);
                return;
            }
            const chunk = resource && resource.body;
            if (chunk) {
                console.log(chunk);
            } else {
                console.log('end of stream');
            }
        });

    client
        .get()
        .options({
            'cache-key': '<cache key>'
        });

    // Context setup for a request to an external service
    Provider.setupContext({
        oauth: {
            'app-name': 'nodedemo1'  // provide app name for authentication if needed
        },
        tracking: false // disable tracking
    },
        (err, context) => {
            if (err) {
                console.error(err.stack);
                return;
            }
            if (context) {
                // got a context similar to req.ebay
                console.log(context);
                // mock marketplace ID
                context.siteInfo['marketplace-id'] = 'EBAY_DE';

                context
                    .getClient('my-service')
                    .get()
                    .end((err, options) => {
                        if (err) {
                            console.error(err.stack);
                        }
                    });
            }
        });

    client
        .post({
            body: JSON.stringify({
                changeSetId: '5000680819'
            })
        })
        .options({
            operation: 'findChangeSetById'
        })
        .end((err, response) => {
            if (response) {
                console.log('response: ', response.body);
            }
        });

    interface ResourceResult {
        systemId: string;
        clientURI: string;
        cdnUrl?: string;
        secureCdnUrl?: string;
    }

    interface ResourceServerResponseBody extends Provider.ResponseData {
        host: {
            external?: string;
            internal: string;
            secureExternal?: string;
            secureInternal: string;
        };
        result: ResourceResult[];
    }

    function makePost(
        name: string,
        body: {
            clientUri?: string[];
            hateoas: boolean;
            softTouch?: boolean;
            resource?: any;
            validate?: boolean;
            creator?: string;
        },
        path?: string
    ): Promise<ResourceServerResponseBody | undefined> {
        return new Promise((resolve, reject) => {
            let client = Provider.context({})
                .getClient(name)
                .request({
                    body: JSON.stringify(body),
                    method: "POST",
                });

            if (path) {
                client = client.path(path);
            }

            client.end((err, response) => {
                if (err) {
                    reject(err);
                    return;
                }
                resolve(response as ResourceServerResponseBody);
            });
        });
    }
};
