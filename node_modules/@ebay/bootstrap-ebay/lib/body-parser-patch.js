'use strict';

const bodyParser = require('body-parser');
const iconv = require('iconv-lite');

/* eslint max-len:off */
const suspectRx = /"(?:_|\\u005f)(?:_|\\u005f)(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006f)(?:t|\\u0074)(?:o|\\u006f)(?:_|\\u005f)(?:_|\\u005f)"/;

const _json = bodyParser.json;
Object.defineProperty(bodyParser, 'json', {
    configurable: true,
    enumerable: true,
    get: function () {
        return json;
    }
});
function json(options = {}) {
    options.verify = protoPoisonVerify(options.verify);
    return _json.call(bodyParser, options);
}

function protoPoisonVerify(next) {
    return function (req, res, body, encoding) {
        const str = (typeof body !== 'string' && encoding !== null) ?
            iconv.decode(body, encoding) :
            body;
        if (str && str.match(suspectRx)) {
            const err = new Error(`Body security violation, it must not have __proto__ property`);
            err.statusCode = 400;
            throw err;
        }
        if (next) {
            next(req, res, body, encoding);
        }
    };
}

