'use strict';

const Assert = require('assert');

const tryRequire = require('try-require');

const logger = require('@ebay/logging-inc').logger('caching');
let cacheProviders = {};

module.exports = function cache(pipe, config) {
    let provider;
    let options;

    pipe.on('request', (request, next) => {
        logger.info('cache handler', pipe.context.clientId);
        options = request;
        const enabled = options.cache && options.cacheKey;
        if (!enabled) {
            // skip
            return next();
        }

        const providerModule = options.cache['cache-provider'] ||
            config && config['cache-provider'];
        Assert.ok(providerModule, 'Cache provider is not specified in service client configuration');

        provider = cacheProviders[providerModule] ||
            (cacheProviders[providerModule] = tryRequire(providerModule));

        if (!provider) {
            throw new Error(`Cache provider cannot be found, name: "${
                providerModule}"`);
        }

        provider.get(options.cacheKey, (err, result) => {
            if (result) {
                return pipe.respond({
                    body: result.body,
                    statusCode: result.statusCode,
                    fromCache: true
                });
            }

            next();
        });
    });

    // continue request flow
    pipe.on('response', (response, next) => {
        const result = {
            body: response.body,
            statusCode: response.statusCode
        };

        if (provider) {
            provider.put(options.cacheKey, result, (err) => {
                if (err) {
                    logger.error('Failed to save in cache', err);
                }
            });
        }

        // continue response flow
        next();
    });
};

module.exports.reset = function reset() {
    cacheProviders = {};
};
