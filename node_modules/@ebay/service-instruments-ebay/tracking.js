'use strict';

const logger = require('@ebay/logging-inc').logger(
    'service-instruments-ebay/tracking');

const RuntimeError = require('./lib/errors').RuntimeError;

const Utils = require('./lib/sse-utils');

module.exports = function trackingHandler(pipe, config) {
    const app = pipe.context.app;
    const request = app ? app.request : undefined;
    const ebay = request ? request.ebay : undefined;
    const tracking = ebay ? ebay.tracking : undefined;
    const trackingInFirstChunk = config && config.tracking && config.tracking.trackingInFirstChunk;

    // eslint-disable-next-line no-shadow
    pipe.on('request', (request, next) => {
        logger.info('tracking handler ', pipe.context.clientId);

        const options = request;
        if (options.tracking === false) {
            return next();
        }

        if (tracking) {
            options.headers = options.headers || {};
            tracking.addTrackingHeadersForRequest(options.headers);
        }
        else {
            logger.warn(new RuntimeError(
                'Cannot add tracking, the tracking context is not found, ' +
                'please make sure you use tracking middleware'));
        }

        next();
    });

    let headers, doneTracking, isChunkedResponse;

    pipe.on('response', (response, next) => {
        isChunkedResponse = Utils.isChunkedResponse(response);
        headers = response.headers;

        if (tracking && (trackingInFirstChunk || !isChunkedResponse && response.headers)) {
            doneTracking = true;
            if (tracking.handleResponse) {
                tracking.handleResponse(response);
            }
            else {
                tracking.handleResponseHeaders(response.headers);
            }
        }

        next();
    });

    pipe.on('response:data', (chunk, next) => {
        if (tracking &&
            isChunkedResponse &&
            Utils.isTrackingResponse(chunk)) {
            if (!doneTracking) {
                doneTracking = true;
                tracking.handleResponseHeaders(chunk.data);
            }
            pipe.resume(); // swallow tracking chunk
            return;
        }

        next();
    });

    /**
     * To handle Experience services using chunked reponse but using response headers
     * instread of tracking chunck for tracking.
     */
    pipe.on('response:end', (next) => {
        if (headers &&
            tracking &&
            !doneTracking) {
            tracking.handleResponseHeaders(headers);
        }

        next();
    });
};
