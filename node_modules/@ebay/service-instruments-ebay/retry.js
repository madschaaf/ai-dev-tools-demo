'use strict';

require('util');
require('url');
require('objutil');

const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/retry');

module.exports = function retry(pipe) {
    let retryCount = 0;
    const clientId = pipe.context.clientId;
    let maxRetryAttempts = 0;
    let _request;

    pipe.on('request', (request, next) => {
        // make a simple clone as some instruments can change it
        _request = Object.assign({}, request);
        logger.info('retry handler', clientId);
        const options = request;
        maxRetryAttempts = isIdempotent(options.method ||
            'GET') || options['force-retry'] || options.forceRetry ? options.retry || 0 : 0;

        next();
    });

    pipe.on('error', (err, next) => {
        if (err.code === 'ETIMEDOUT' || err.code === 'ECONNRESET') {
            if (retryCount++ >= maxRetryAttempts) {
                return next();
            }
            logger.warn('Timed out calling the service %s, will retry, current try: %d, limit: %d',
                clientId, (retryCount - 1), maxRetryAttempts);

            // re-try again with original options
            pipe.request(Object.assign({}, _request));
            return;
        }

        next();
    });
};

/**
 * check if the HTTP method is idempotent
 *
 * @param {string} methodName
 * @return {boolean}
 */
function isIdempotent(methodName) {
    return ['GET', 'PUT', 'HEAD', 'OPTIONS', 'DELETE'].indexOf(methodName.toUpperCase()) !== -1;
}
