'use strict';

const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/identityContext');

module.exports = function identityContext(pipe) {
    const req = pipe.context.app ? pipe.context.app.request : undefined;

    pipe.on('request', async (request, next) => {
        logger.info('identity context handler', pipe.context.clientId);
        const options = request;

        if (req && req.ebaySessionContext) {
            options.headers = {
                ...options.headers,
                ...req.ebaySessionContext.buildHeader()
            };
            delete options.headers['X-EBAY-C-ENDUSERCTX'];
        }

        next();
    });
};
