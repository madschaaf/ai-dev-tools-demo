'use strict';

const Objutil = require('objutil');
const requestLocal = require('request-local');
const SOA_HEADERS = require('./soa-headers');
const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/soap');

module.exports.adapt = function adaptToEbay(options, wsdl) {
    const headers = {};

    const tns = wsdl.definitions.xmlns.tns;
    const svcName = wsdl.definitions.$name;

    headers[SOA_HEADERS.USECASE_NAME] = `${svcName}Client`;
    if (tns) {
        headers[SOA_HEADERS.SERVICE_NAME] = `{${tns}}${svcName}`;
    }
    else {
        headers[SOA_HEADERS.SERVICE_NAME] = svcName;
    }

    headers[SOA_HEADERS.REQUEST_DATA_FORMAT] = 'XML';
    // by default always include guid, but in some cases we need to skip it
    // to break circular dependency per https://jirap.corp.ebay.com/browse/NODE-3407
    const includeGuid = !options.soap || options.soap.guid !== false;
    headers[SOA_HEADERS.REQUEST_GUID] = includeGuid && getGuid() || 'no-guid';
    headers[SOA_HEADERS.RESPONSE_DATA_FORMAT] = 'XML';
    headers[SOA_HEADERS.SERVICE_OPERATION_NAME] = options.operation;
    headers[SOA_HEADERS.VERSION] = '1.0.0';

    const rlogid = getRLogId();
    if (rlogid) {
        headers.rlogid = rlogid;
    }

    Objutil.merge(headers, options.headers);
    return options;
};

function getGuid() {
    try {
        const req = requestLocal.data.request;
        return req.ebay && req.ebay.getGuid();
    }
    catch (e) {
        logger.warn('soap:getGuid request-local error');
    }
}

function getRLogId() {
    try {
        const req = requestLocal.data.request;
        return req.ebay && req.ebay.getRlogId();
    }
    catch (e) {
        logger.warn('soap:getRLogId request-local error');
    }
}
