'use strict';

const Objutil = require('objutil');
const StreamUtils = require('./transports/stream-utils');
const TransportUtils = require('./transports/utils');
const Hoek = require('hoek');

/**
 * Transport send response stream object back to client to handle streaming response
 * @type {exports}
 */
module.exports = function streamResponse(pipe, config) {
    pipe.on('request', (request, next) => {
        if (request['stream-response'] === false) {
            return next();
        }
        config && Objutil.merge(config, request);

        // add x-forwarded-for
        TransportUtils.addXFF(pipe, request, config);

        const req = StreamUtils.startStream(request);
        req.once('response', (response) => {
            req.res = response;
            if (response.statusCode >= 300) {
                pipe.respond(response);
                return;
            }
            req.res = response;

            req.res.body = response; // make it readable stream
            pipe.respond(req.res);
        });
        req.on('error', Hoek.once((err) => pipe.throw(err)));
        req.end();
    });
};
