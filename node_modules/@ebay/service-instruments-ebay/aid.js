'use strict';
const Logger = require('@ebay/file-logger');
const logger = new Logger('gis_aid_log_file');
const appContext = require('@ebay/app-context-ebay');

module.exports = function aid(pipe, config) {
    let aidObj = undefined;
    pipe.on('request', (request, next) => {
        const options = request;
        if (options.aid === false) {
            return next();
        }
        aidObj = {};
        aidObj.X_EBAY_C_ENDUSERCTX = request.headers?.['X-EBAY-C-ENDUSERCTX'];
        aidObj.client_app = appContext.appName;
        aidObj.http_method = request.method;
        aidObj.service_hostname = request.hostname;
        aidObj.service_basepath = request.basepath;
        aidObj.agent = 'service-client-ebay';
        next();
    });

    pipe.on('error', (err, next) => {
        if (aidObj) {
            aidObj.error = {
                message: err.message,
                stack: err.stack,
                code: err.code
            };
            writeToLogger();
        }
        next(err);
    });

    pipe.on('response', (response, next) => {
        if (aidObj) {
            aidObj.status = response.statusCode;
            writeToLogger();
        }
        next();
    });

    function writeToLogger() {
        logger.log(aidObj);
    }
};
