'use strict';

const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/header-propagation');

module.exports = function headerPropagation(pipe, config) {
    const req = pipe.context.app ? pipe.context.app.request : undefined;

    pipe.on('request', (request, next) => {
        logger.info('header propagation handler', pipe.context.clientId);

        // Get client config
        const clientConfig = request.headerPropagation || config?.headerPropagation;

        // If we have headers from the incoming request and a configuration for allowed headers
        if (req?.headers && clientConfig?.allow && Array.isArray(clientConfig.allow)) {
            // Convert allowed headers to lowercase for case-insensitive comparison
            const allowedHeaders = clientConfig.allow.map(h => h.toLowerCase());

            // Copy allowed headers from incoming request to outgoing request
            allowedHeaders.forEach(headerName => {
                const headerValue = req.headers[headerName];
                if (headerValue !== undefined) {
                    request.headers = {
                        ...request.headers,
                        [headerName]: headerValue
                    };
                }
            });
        }

        next();
    });
};
