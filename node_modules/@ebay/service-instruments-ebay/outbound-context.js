'use strict';

const Objutil = require('objutil');
const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/outboundContext');
const appContext = require('@ebay/app-context-ebay');

module.exports = function outboundContext(pipe) {
    const req = pipe.context.app ? pipe.context.app.request : undefined;
    const ebay = req && req.ebay;

    pipe.on('request', (request, next) => {
        logger.info('outboundContext handler', pipe.context.clientId);
        const options = request;
        if (request['outbound-context'] === false) {
            return next();
        }
        if (req) {
            options.headers = options.headers || {};

            // add commerce OS headers
            if (ebay) {
                const buildContextArgs = [];
                if (pipe.context.appTokenOnly) {
                    buildContextArgs.push(key => key !== 'origUserId');// exclude origUserId for app tokens
                }
                if (request['outbound-context']?.useCOSMarketplaceId) {
                    // add null for filter if missing as we are going to use buildOutboundContext
                    if (!buildContextArgs.length) {
                        buildContextArgs.push(() => true);
                    }
                    buildContextArgs.push(true);
                }
                const ctx = buildContextArgs.length ?
                    ebay.buildOutboundContext(...buildContextArgs) :
                    ebay.outboundContext;
                if (ctx) {
                    options.headers = Objutil.mixin(ctx, options.headers, {});
                }
                const rlogid = ebay.getRlogId && ebay.getRlogId();
                if (rlogid) {
                    options.headers.rlogid = rlogid;
                }
                if (appContext.consumerId) {
                    options.headers['x-ebay-consumer-id'] = appContext.consumerId;
                    options.headers['x-ebay-client-app-name'] = appContext.appName;
                }
            }
        }

        next();
    });
};
