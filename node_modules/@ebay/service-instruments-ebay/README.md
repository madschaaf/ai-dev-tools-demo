# service-instruments-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/service-instruments-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/service-instruments-ebay/job/master/) [![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/service-instruments-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/service-instruments-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/service-instruments-ebay)](http://sonar/dashboard/index?id=service-instruments-ebay)


The module provides instrumentation for service-client-ebay module with ebay specific instruments.

The architecture is based on [trooba framework](https://github.com/trooba)

The default instruments:
* tracing - adds `X-EBAY-C-REQUEST-ID` header which will have `rci`, `ri`, `node_id` for service calls
    * Tracing can be disabled by passing option `tracing: false` in service options. (By default tracing is enabled)
    ```json
        "my-service": {
            "protocol": "http:",
            "hostname": "localhost",
            "port": 7777,
            "socketTimeout": 1000,
            "tracing": false, //Disables tracing
            "transport": "generic",
            "instruments": ["my-instrument", "my-another-instrument", "cal", "circuit"],
            "circuit": {
                "circuitBreakerErrorThresholdPercentage": 50,
                "circuitBreakerRequestVolumeThreshold": 20
            }
        }
    ```
* cal - provides cal transaction
* cache - provides caching feature
* circuit - provides Hystrix circuit, config bean, error handling
    * fallback is optional function that will be used as a fallback; example:
    ```js
        require('@ebay/service-client-ebay')
        .context({})
        .getClient('some-client')
        .get({foo:'bar'})
        .fallback((err, request) => {
            // do fallback here and return promise
            return Promise.resolve({
                body: 'fallback'
            })
        })
        .end((err, response) => {});
    ```
    * configuration of circuit breaker (_NODE_ legacy values markdown-threshold/auto-markup-timeout will no longer work:
    ```
    {
        "my-service": {
            "circuit": {
                "circuitBreakerErrorThresholdPercentage": 50, // default
                "circuitBreakerRequestVolumeThreshold": 20, // default
                "circuitBreakerSleepWindowInMilliseconds": 5000, // default
                "requestVolumeRejectionThreshold": 0 // default
            }
        }
    }
    ```
      * For more details parameters, please check [hystrix circuit breaker wiki](https://github.com/Netflix/Hystrix/wiki/Configuration#CommandCircuitBreaker)
      * On configuring hystrix alerts in sherlock please use this [reference](https://docs.google.com/document/d/15uQtvrxjdLpTrCL66JJI-N0a9dx8ajBrSD8dg6_SW9o/edit#)
* config - bootstraps handlers from module-config-inc
* ep - provides experimentation for services
* retry - provides retry logic and works only for `'GET', 'PUT', 'HEAD', 'OPTIONS', 'DELETE'` http methods. There is an optional `force-retry` and 'forceRetry' attribute which can be used to force retry for other http methods.
* outbound-context - provides handler that sets request headers from req.ebay.outboundContext.
* oauth - sets app or user token to request headers
* tracking - provides tracking for services
* ep - provides experimentation instrument. possible values (empty by default):
  * OPTIN_COOKIE
  * EPRESULT
* metrics - provides request metrics collection using [metrics-ebay](https://github.corp.ebay.com/nodejs/metrics-ebay)
* discovery - provides service endpoint resolution using [service-discovery-ebay](https://github.corp.ebay.com/nodejs/service-discovery-ebay). Discovery can be disabled for a service by setting `discovery:false`. See [below for example.](#example-of-service-with-service-discovery-disabled)
* https - provides ability to invoke services using eBay Root Certificate or Self Signed Certifacte for SSL setup.
* compress - provides gzip for response.
* noop - no operation handler used to skip specific steps without changing application configurations.
* graphql - provides logging and instrumentation for GraphQL gateway calls to domain graph services (DGS) or implementation services.
* app-token - should be used when no web request context is available.

The default transports:
* http - provide http/s transport
* pipe - provides piping of web request to the downstream service and response from service to web response
* grpc - provides grpc transport, TODO: extend from trooba-grpc-transport
* sse - provides sse transport
* mje - multipart/json transport
* xhr - provides xhr transport
* sifr - provide sifr transport, client side transports that uses sifr protocol to communicate to api.ebay.com.
* mock - provides mock 'generic' transport for tests / loading page with mock-data.
* mock-multi-chunk - provides mock 'sse' / 'mje' transport for tests / loading page with mock-data.

Other tools:
* RuntimeError - allows to wrap an error passed in callback or create a new one and specify code/statusCode/type. It is also useful to capture post call stacktrace in async flow.

todo:
* add component status

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/service-instruments-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

```
npm install service-instruments-ebay --save
```

# Usage

## Configuration

### GraphQL API

Code:
```typescript
/// <reference path="./graphql.d.ts" />

// version @ebay/service-instruments-ebay@1.22.0
// mark the ownership of the provider that allows to search for service configurations
const provider = require('@ebay/service-instruments-ebay').use(__dirname);
// this is a sharable client instance, can be shared between web requests, but you can create as many as you want
const client = await Provider.createClient('your-client-id');
// create a client mapped to the given web request, non-sharable
const contextualClient = client.webRequest(request);
// make an API call based on client API config
const response = await contextualClient.query(`query fakeNewOperationName { data }`);
```

config.json:
```json
{
   "services": {
      "your-client-id": {
         "hostname": "graphql.gateway.hostname",
         "protocol": "https:",
         "socketTimeout": "3000",
         "graphql": true
      }
   }
}
```

### Using cache feature with service-client-ebay module

Code:
```javascript
var provider = require('@ebay/service-client-ebay'); // version 2.x
provider.context(webRequest).getClient('my-client')
.get()
.options({
    'cache-key': <cache key>
})
```
Service client configuration with cache provider:
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "cache": {
        "cache-provider": "path:./src/providers/my-provider"
    }
}
```

## Service configuration

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "instruments": ["my-instrument", "my-another-instrument", "cal", "circuit"],
    "circuit": {
        "circuitBreakerErrorThresholdPercentage": 50,
        "circuitBreakerRequestVolumeThreshold": 20
    }
}
```

### Sharing default service config

There are cases when the app has many services which shares the same configuration with only difference in hostname.

In such case one can define default client config (example shown bellow) as part of `service-instruments-ebay` configuration and then set only the hostname for each service as you make a call.

Config:
```json
"service-instruments-ebay": {
    "default-client-config": {
        "protocol": "https:",
        "socketTimeout": 1000,
        "transport": "generic",
        "instruments": ["my-instrument", "my-another-instrument", "cal", "circuit"],
        "circuit": {
            "circuitBreakerErrorThresholdPercentage": 50,
            "circuitBreakerRequestVolumeThreshold": 20
        }
    }
}
```

### Extending service config

In some case one may want to extend configuration defined under `service-instruments-ebay` section.

Config:
```json
"service-instruments-ebay": {
    "default-client-config": {
        "protocol": "https:",
        "socketTimeout": 1000,
        "transport": "generic",
        "instruments": ["my-instrument", "my-another-instrument", "cal", "circuit"],
        "circuit": {
            "circuitBreakerErrorThresholdPercentage": 50,
            "circuitBreakerRequestVolumeThreshold": 20
        }
    },
    "foo-client-config": {
        "protocol": "https:",
        "socketTimeout": 1000,
        "transport": "generic",
        "instruments": ["my-instrument", "my-another-instrument", "cal", "circuit"],
        "circuit": {
            "circuitBreakerErrorThresholdPercentage": 50,
            "circuitBreakerRequestVolumeThreshold": 20
        }
    }
},
"services": {
    "bar-client": {
        "extends": "foo-client-config",
        "hostname": "some.service.ebay.com"
    }
}
```

### Using COS marketplace id instead of legacy one.

Some ebay services require latest standard marketplace id for countries with double marketplaces like Canada with French and English markets, Belgium with NL and FR, etc. You can use bellow flag to force it to use COS marketplace id (ex: EBAY-BE) instead of legacy which is default (ex: EBAY-BENL).


```json
{
    "services": {
        "my-client": {
            "hostname": "some.service.ebay.com",
            "outbound-context": {
                "useCOSMarketplaceId": true
            }
        }
    }
}
```

### Custom json parser

The injected parser must provide API as standard json parser.
```ts
interface Parser {
    parse(data: string): any
}
```

Configuration
```json
{
    "services": {
        "bigint-client-config": {
            "protocol": "https:",
            "hostname": "some.service.ebay.com",
            "socketTimeout": 1000,
            "transport": "generic",
            "json-parser": "path:json-bigint"
        }        
    }
}
```

* Example using service-client-ebay API:
```js
const provider = require('@ebay/service-client-ebay');
const contextualProvider = await provider.context(webRequest);
const client = contextualProvider.getClient('my-service');
const response = await client.get().options({
    hostname: 'localhost'
});
```

* Example using service-instruments-ebay API:
```js
const provider = require('@ebay/service-instruments-ebay').use(__dirname);
const client = await provider.createClient('my-service').webRequest(webRequest);
const response = await client.get().options({
    hostname: 'localhost'
});
```

Note: when framework cannot find you client id, it will use default client config to contract the service client instance.

### Example of proxy transport

#### Streaming service response back to web response

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "pipe"
}
```

#### Streaming web request to the service and service response back to web response

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "pipe",
    "pipeRequest": true
}
```

#### Streaming service response with transformer back to web response

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "pipe",
    "pipe": {
        "response": {
            "transform": "path:src/transformer"
        }
    }
}
```

src/transformer:
```js
const { Transform } = require('stream');

function tryParse(data) {
    try {
        return JSON.parse(data);
    }
    catch (err) {
        return data;
    }
}

module.exports = (options) => new Transform({
    transform(chunk, _encoding, callback) {
        const data = tryParse(String(chunk));
        if (data.id) {
            data.id = data.id.toUpperCase();
            callback(null, JSON.stringify(data));
            return;
        }
        callback(null, chunk);
    }
});
```

### Example of service using eBay Root Certificate for SSL, with https instrument
```json
"my-service": {
    "protocol": "https:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "https": "eBayRootCert"
}
```

### Example of service using TCP keep alive, with https instrument
```json
"my-service": {
    "protocol": "https:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "https": {
        "keepAlive": true
    }
}
```
Keep alive is based on research done by Ruslan Prytula and published here https://wiki.corp.ebay.com/pages/viewpage.action?pageId=945305943#r1vinode/mweb:NodeJSlatencyissues-EnablingkeepAliveforreco%2Clbs%2Cebaytrackingsvc%2Cexperimentation%2Cvi_module_api

This work resulted in the following PRs:
https://github.corp.ebay.com/nodejs/httpunch/pull/35/files
https://github.corp.ebay.com/nodejs/service-instruments-ebay/pull/88

### Example of service with oauth user token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "token": ["user"],
        "jwt": true // <<< request JWT token
    }
}
```

### Example of service with oauth app token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "token": ["app"]
    }
}
```

### Example of service with oauth token with fallback from user token to recognized user token to app token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "token": ["user", "recognized-user", "app"]
    }
}
```

### Example of service with oauth user token and specific scope
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "scope": "http://api.ebay.com/oauth/scope/@public",
        "token": ["user"]
    }
}
```

### Example of service with oauth app token with multiple specific scopes
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "scope": [
            "http://api.ebay.com/oauth/scope/@public",
            "http://api.ebay.com/oauth/scope/sell@application"
        ],
        "token": ["app"]
    }
}
```

### Example of service with oauth user and fallback to app token and scopes specific to each type of token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "scope": {
            "user": "http://api.ebay.com/oauth/scope/@public",
            "app": "http://api.ebay.com/oauth/scope/app@public"
        },
        "token": ["user", "app"]
    }
}
```

### Example of service with custom header propagation
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "headerPropagation": {
        "allow": ["Accept", "render_role"]
    }
}
```

The `headerPropagation` configuration allows you to specify which custom headers should be propagated from the incoming request to downstream services. This is particularly useful for Federated GraphQL (FGQL) systems where domain-specific headers need to be forwarded to subgraphs.

- `allow`: An array of header names that should be propagated. The header names are case-insensitive.

You can also disable header propagation for a specific request by setting `header-propogation: false` in the request options.

### Example of service with service discovery disabled
```json
"my-service-endpoint-to-discover": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "discovery": false
}
```

### Example of service with cookies included into the service request from app request
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "cookies": {
        "request": true
    }
}
```

### Example of service with cookies set from the service response into app response
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "cookies": {
        "response": true
    }
}
```
Example of service with cookies included into service request from app request and set from service response into app response
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "cookies": {
        "request": true,
        "response": true
    }
}
```

### Example configuration for graphql gateway services configuration

```json
"my-dgs-service": {
    "protocol": "https:",
    "hostname": "localhost",
    "method": "POST",
    "basepath": "/graphql",
    "socketTimeout": 1000,
    "graphql": true,
    "rejectUnauthorized": false
}
```

### Example configuration to include method in logging

Add `logMethod` true to any service configuration.

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "method": "POST",
    "socketTimeout": 1000,
    "logMethod": true
}
```

### Customize trust-fabric token in header

By default TF token will be added to x-ebay-tf-authorization, but some service may require a different header name.

* Add `authorization` header with TF token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "trust-fabric": {
        "addAuthorizationHeader": true
    }
}
```

* Add `tf_token` custom header with TF token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "trust-fabric": {
        "headerName": "tf_token"
    }
}
```

* Add `tf_token` custom header with TF token with bearer prefix
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "trust-fabric": {
        "headerName": {
            "name": "tf_token",
            "bearer": true
        }
    }
}
```
## Deep Merge Feature

When making service requests, you can enable deep merging of request configuration with service configuration by setting the `deepMerge` flag to `true` in your request. This allows for more sophisticated merging behavior where nested objects are merged recursively instead of being overwritten completely.

### Usage

```javascript
const provider = require('@ebay/service-instruments-ebay').use(__dirname);
const client = await provider.createClient('my-service');
const contextualClient = client.webContext(webRequest);

// Enable deep merge for this request
const response = await contextualClient.get({
    headers: {
        'content-type': 'application/json',
        'custom-header': 'request-value'
    },
    timeout: 3000,
    customConfig: {
        nested: {
            requestValue: 'from-request'
        }
    },
    deepMerge: true // Enable deep merge
});
```

### Configuration

Service configuration with nested objects:

```json
{
    "services": {
        "my-service": {
            "protocol": "https:",
            "hostname": "api.example.com",
            "headers": {
                "authorization": "Bearer token123",
                "x-api-key": "config-key"
            },
            "timeout": 5000,
            "customConfig": {
                "nested": {
                    "configValue": "from-config"
                }
            }
        }
    }
}
```

### Behavior

- **When `deepMerge: true`**: All configuration fields are deeply merged. Nested objects are combined recursively, with request values taking precedence over config values for conflicting keys.
  - Request headers are preserved and merged with config headers
  - Nested objects are merged deeply instead of being replaced
  - Arrays and primitive values from the request take precedence

- **When `deepMerge: false` (default)**: Uses `Object.assign()` behavior where config values completely replace request values for the same keys.

### Example Result

With the above configuration and request, the final merged request would contain:

```javascript
{
    headers: {
        'content-type': 'application/json',    // from request
        'custom-header': 'request-value',      // from request
        'authorization': 'Bearer token123',    // from config
        'x-api-key': 'config-key'             // from config
    },
    timeout: 3000,                            // from request (takes precedence)
    customConfig: {
        nested: {
            requestValue: 'from-request',      // from request
            configValue: 'from-config'         // from config
        }
    }
}
```

## Error wrapping

```javascript
function readData(url, callback) {
    if (!url) {
        throw new RuntimeError({
            message: 'URL must be present'
            type: 'user'
        });
    }
    request(url, function (err, response) {
        if (err) {
            return callback(new RuntimeError({
                message: 'Failed to get data'
                error: err, // keeps stack trace
                code: 1,  // 1 by default
                type: 'system'  // system by default
            }))
        }
        if (response.statusCode >= 400) {
            return callback(new RuntimeError({
                message: 'Failed to get data'
                error: err, // keeps stack trace
                code: 2,  // 1 by default
                statusCode: response.statusCode,
                type: 'http'
            }))
        }
        callback(null, response);
    });
}
```

## eBay Root Cert

To validate ebay root certs please do these steps:

* Create a simple js script, generate-certs.js
```js
const certs = require('./ebay-root-certs');
console.log(certs.join(''))
```
* Run `node generate-certs.js > NodeJS.certs`
* Run `openssl crl2pkcs7 -nocrl -certfile  NodeJS.certs | openssl pkcs7 -print_certs -text -noout | grep " Not After"`

The last command will print out the certs expiration.

### Updating certs

You can load updated certs from this locations
* https://ebayinc.sharepoint.com/teams/SelfService/Directory%20Services/SitePages/Active%20Directory%20Certificates%20Services%20Help%20Site.aspx
* sectigo root cert, download it from this link: https://wiki.vip.corp.ebay.com/pages/viewpage.action?pageId=562535062#id-2019Comodo/SectigoCert-3Sectigo
