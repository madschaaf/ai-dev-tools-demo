'use strict';

const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/sddz-proxy');
const env = require('@ebay/environment-ebay');
const globalConfig = require('@ebay/raptor-config-ebay/lib/globalConfig');
const path = require('path');
const tryRequire = require('try-require');
const utils = require('./lib/utils');
const trustFabricClient = require('@ebay/trust-fabric-ebay');
// Use v4 ONLY in local sddz zone, v3 for other environments
// eslint-disable-next-line max-len
const tokenGenerator = (env.isDevZone() && env.isDev()) ? new trustFabricClient.TokenGenerator({ version: 'v4' }) : trustFabricClient;

let sddzConfigPath, sddzConfig;

module.exports = function sddzProxy(pipe, config) {
    pipe.on('request', (request, next) => {
        const clientId = pipe.context.clientId;

        const isDevZoneEnv = env.isDevZone();

        if (!isDevZoneEnv) {
            return next();
        }

        const options = request;
        const { hostname, method } = options;

        // Read values from GlobalConfig
        try {
            sddzConfigPath = sddzConfigPath || path.join(globalConfig.getConfigRootPath(), 'sddz', 'sddz.json');

            if (!sddzConfig) {
                sddzConfig = tryRequire(sddzConfigPath);
                if (!sddzConfig) {
                    logger.warn(`[SDDZ-PROXY] Failed to load SDDZ config, clientId: ${clientId}`);
                }
            }
        }
        catch (error) {
            logger.error(`[SDDZ-PROXY] Error loading SDDZ config, clientId: ${clientId}`, {
                error: error.message
            });
            return next();
        }

        const proxyVips = sddzConfig?.proxyVips;
        const proxyUri = sddzConfig?.proxyUri;
        const proxyReadTimeout = sddzConfig?.proxyReadTimeout;

        if (!hostname || !proxyVips || !proxyUri) {
            return next();
        }

        const isProxyAllowed = proxyVips.some(allowedHost => {
            const exactMatch = hostname === allowedHost;
            const subdomainMatch = hostname.endsWith(`.${allowedHost}`);
            return exactMatch || subdomainMatch;
        });

        if (!isProxyAllowed) {
            return next();
        }

        const proxyHost = sddzConfig.proxyUri;
        options.sddz = {
            isProxyAllowed: isProxyAllowed,
            proxyHost: proxyHost,
            proxyReadTimeout: proxyReadTimeout
        };
        const url = utils.formatUrl(options);
        logger.info(`[SDDZ-PROXY] Proxy enabled for ${url}, clientId: ${clientId}`);

        tokenGenerator.getToken({ htm: method, htu: url }, (err, tfToken) => {
            if (err) {
                // log only for information purposes here
                // eslint-disable-next-line max-len
                logger.warn(`[SDDZ-PROXY] Error while getting TF token(v4) for proxy host ${hostname}, clientId: ${clientId}`, { error: err.message, stack: err.stack });
            }

            if (!err && tfToken) {
                options.headers = options.headers || {};
                options.headers['Proxy-Authorization'] = `Bearer ${tfToken}`;
            }
            next();
        });
    });
};
