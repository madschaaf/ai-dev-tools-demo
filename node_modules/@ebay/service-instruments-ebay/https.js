'use strict';

const { Agent } = require('https');
const logger = require('@ebay/logging-inc').logger('service-instruments-ebay/https');
const ebayRootCerts = require('./ebay-root-certs');
const agents = new Map();
const env = require('@ebay/environment-ebay');

/**
 * @param {String|undefined} clientId
 * @param {Object} options {ca: [], keepAlive: true, path: null} etc ...
 * @return {https.Agent}
 */
const ensureAgent = (clientId, options) => {
    if (!clientId) {
        return new Agent(options);
    }
    if (!agents.has(clientId)) {
        agents.set(clientId, new Agent(options));
    }
    return agents.get(clientId);
};

module.exports = function httpsHandler(pipe) {
    pipe.on('request', (request, next) => {
        logger.info('https handler', pipe.context.clientId);
        const options = request;
        const { agent, https, protocol, secureProtocol } = options;

        // If HTTPS agent is already set or https is disabled
        if (agent || https === false) {
            return next();
        }

        // according to LB team we should now always use eBayRootCerts for any https connection
        // some modules (iaf-ebay) use secureProtocol, which will not work unless the attribute is removed
        // thus leaving the check for them to let iaf-ebay be cleaned up and tested
        if (https || (protocol === 'https:' && !secureProtocol)) {
            const { clientId } = pipe.context;
            const agentOptions = {
                // according to LB team we should now always use eBayRootCerts for any https connection
                // NODE-5296: Enable keepAlive for all https connections with 20sec keepAliveMsecs
                keepAlive: true,
                keepAliveMsecs: 20000
            };

            // Setup Proxy if required for SDDZ/DevZone
            const isDevZoneEnv = env.isDevZone();

            if (isDevZoneEnv && request.sddz) {
                const useProxy = request.sddz?.isProxyAllowed || false;
                const proxyHost = request.sddz?.proxyHost;
                const proxyReadTimeout = request.sddz?.proxyReadTimeout;

                if (useProxy && proxyHost) {
                    try {
                        const { HttpsProxyAgent } = require('https-proxy-agent');
                        const proxyAgentOptions = {
                            ...agentOptions
                        };

                        // Apply SDDZ-specific timeouts if configured
                        if (proxyReadTimeout) {
                            proxyAgentOptions.readTimeout = proxyReadTimeout;
                        }
                        const proxyAgent = new HttpsProxyAgent(proxyHost, proxyAgentOptions);

                        logger.info(
                            `[HTTPS-HANDLER] Using proxy agent for ${request.hostname}, clientId: ${clientId}`,
                            { proxyReadTimeout }
                        );
                        options.agent = proxyAgent;
                        return next();
                    }
                    catch (error) {
                        logger.error(`[HTTPS-HANDLER] Failed to create proxy agent, clientId: ${clientId}`, {
                            error: error.message,
                            proxyHost
                        });
                        // Fall back to regular agent creation below
                    }
                }
            }

            // PERF FIX
            // Set Runtime CA certs only if ENABLE_STATIC_CA_CERTS is not set
            // During deployment we set NODE_EXTRA_CA_CERTS from the cert
            // file and enable flag using ENABLE_STATIC_CA_CERTS
            if (process.env.ENABLE_STATIC_CA_CERTS === 'true') {
                logger.info('https handler, ENABLE_STATIC_CA_CERTS is ENABLED i.e Static Certs enabled');
            }
            else {
                logger.info('https handler, ENABLE_STATIC_CA_CERTS is DISABLED i.e Dynamic Certs enabled');
                agentOptions.ca = ebayRootCerts;
            }
            if (Object(https) === https) {
                Object.assign(agentOptions, https);
            }
            options.agent = ensureAgent(clientId, agentOptions);
        }
        next();
    });
};
