'use strict';

const Objutil = require('objutil');
const httpfy = require('./http-api');

module.exports = function transport(pipe, config) {
    pipe.on('request', (request) => {
        const options = request;
        config && Objutil.merge(config, options);

        if (!options.mockData) {
            throw new Error(`Cannot find mock data for ${pipe.context.clientId}`);
        }

        const data = (typeof options.mockData === 'string' ?
            require(options.mockData) : options.mockData);

        // we are looking for an array of chunks to write into the response stream
        if (!Array.isArray(data) || data.length === 0) {
            throw new Error(`Mock Data is not the right format or is empty`);
        }

        let i = 0;
        const limit = data.length;

        function getData() {
            if (i < limit) {
                pipe
                    .streamResponse({
                        statusCode: 200
                    })
                    .write(data.shift());
                // re-wire for next write
                setTimeout(getData, 1000);
            }
            else {
                pipe
                    .streamResponse({
                        statusCode: 200
                    })
                    .end();
            }
            i = i + 1;
        }

        // starts at 0
        process.nextTick(getData);
    });

    httpfy(pipe);
};
