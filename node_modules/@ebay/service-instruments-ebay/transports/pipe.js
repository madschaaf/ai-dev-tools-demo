'use strict';

const Hoek = require('hoek'),
    httpfy = require('./http-api');

const Objutil = require('objutil');
const StreamUtils = require('./stream-utils');
const TransportUtils = require('./utils');

const transformers = {};

function getResponseTransformStream(contentType, config) {
    const transformPath = config?.transform;
    if (transformPath) {
        const createTransform = transformers[transformPath] || (() => {
            const ret = transformers[transformPath] = require(transformPath);
            return ret;
        })();

        return createTransform(contentType, config);
    }
}

module.exports = (pipe, config) => {
    pipe.on('request', (request) => {
        config && Objutil.merge(config, request);
        const pipeRequest = (config || request).pipeRequest;

        const onceError = Hoek.once((err) => {
            pipe.throw(err);
        });

        if (pipeRequest) {
            Object.assign(request.headers, pipe.context.app.request.headers);
        }

        // add x-forwarded-for
        TransportUtils.addXFF(pipe, request, config);

        let pipeStarted = false;
        const req = StreamUtils.startStream(request);
        req.once('abort', () => {
            if (pipeStarted) {
                pipe.context.app.response.socket.destroy();
            }
        });
        req.on('error', onceError);
        let isEnded = false;
        req.once('response', (response) => {
            pipe.context.app.response.once('close', () => {
                if (!isEnded) {
                    response.destroy();
                }
            });
            req.res = response;
            pipe.context.app.response.writeHead(response.statusCode, response.headers);
            response.once('end', () => {
                isEnded = true;
                // mark response as complete
                pipe.respond({
                    statusCode: response.statusCode,
                    headers: response.headers
                });
            });
            // pipe
            const outputTransform = getResponseTransformStream(
                response.headers?.['content-type'], request.pipe?.response);
            if (outputTransform) {
                response.pipe(outputTransform).pipe(pipe.context.app.response);
            }
            else {
                response.pipe(pipe.context.app.response);
            }
            pipeStarted = true;
        });

        if (pipeRequest) {
            pipe.context.app.request.pipe(req);
            return;
        }
        req.end();
    });

    httpfy(pipe);
};
