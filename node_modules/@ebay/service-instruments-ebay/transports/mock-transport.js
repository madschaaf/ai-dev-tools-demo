'use strict';

const Objutil = require('objutil');
const httpfy = require('./http-api');

module.exports = function transport(pipe, config) {
    pipe.on('request', (request) => {
        const options = request;
        config && Objutil.merge(config, options);

        if (options.echo) {
            setImmediate(() => {
                pipe.respond(request);
            });
            return;
        }

        if (!options.mockData) {
            throw new Error(`Cannot find mock data for ${pipe.context.clientId}`);
        }

        const data = (typeof options.mockData === 'string' ?
            require(options.mockData) : options.mockData);

        setImmediate(() => {
            pipe.respond(data);
        });
    });

    httpfy(pipe);
};
