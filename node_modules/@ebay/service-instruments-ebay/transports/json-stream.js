'use strict';

const cal = require('@ebay/cal');

const JStream = require('jstream'),
    Hoek = require('hoek'),
    httpfy = require('./http-api');
require('../lib/utils');

const Objutil = require('objutil');
const StreamUtils = require('./stream-utils');

/**
 * Generic transport is just a passthrough to httpunch (regular http request) with JSON parsing for JSON content-type.
 * @type {exports}
 */
module.exports = function JsonStreamTransport(pipe, config) {
    pipe.on('request', (request) => {
        const st = Date.now();
        let req;        //eslint-disable-line
        let responseStream;

        const onceError = Hoek.once((err) => {
            pipe.throw(err);
        });

        const jsonStream = new JStream();
        jsonStream.on('data', (model) => {
            // record time taken for obtaining specific module
            cal.createTransaction('Model', model.name, (
                err, event) => {
                event.timestamp = st;
                event.complete();
            });

            responseStream.write(model);
        })
            .on('error', (err) => {
                let statusCode = req.res && req.res.statusCode;
                statusCode = statusCode >= 400 ? statusCode : undefined;
                err.statusCode = statusCode || 'ParseError';
                onceError(err);
            })
            .once('end', () => {
                responseStream.end();
            });

        config && Objutil.merge(config, request);
        req = StreamUtils.startStream(request);
        req.on('error', onceError);
        req.once('response', (response) => {
            if (response.statusCode >= 300) {
                /** Handle this for redirection and error cases separately..
                 All can have valid data
                 ***/
                response.once('finish', () => {
                    pipe.respond(req.res);
                });
                return;
            }
            responseStream = pipe.streamResponse(response);
            response.pipe(jsonStream);
        });

        req.end();
    });

    httpfy(pipe);
};
