'use strict';

require('@ebay/header-multi-value-ebay');
const Httpunch = require('@ebay/httpunch');
const Objutil = require('objutil');
require('@ebay/header-multi-value-ebay');
const debug = require('debug')('@ebay/service-instruments-ebay/http-transport');

const httpfy = require('./http-api');
const TransportUtils = require('./utils');
const { default: ono } = require('@jsdevtools/ono');
const jsonParsers = {};

module.exports = function transport(pipe, config) {
    pipe.on('request', (request) => {
        const options = request;
        config && Objutil.merge(config, options);

        TransportUtils.updateRequest(options);
        TransportUtils.validateLongVip(options);
        // add x-forwarded-for
        TransportUtils.addXFF(pipe, request, config);

        let reply = function reply(response) {
            pipe.respond(response);
        };

        if (process.domain) {
            reply = process.domain.bind(reply);
        }

        debug('# request', options);
        const req = nsBindRequest(Httpunch.request(options));
        req.end((error, response) => {
            if (options.debug === true || options.debug === 'true') {
                const addlMaskheaders = options.maskHeaders || [];
                TransportUtils.generateHeadersInfo(options.headers, addlMaskheaders);
                TransportUtils.generateMetricsEvents(req.metrics);
            }

            if (error) {
                pipe.throw(error);
                return;
            }

            const encoding = response.headers && response.headers['content-encoding'];
            if (encoding !== 'gzip' && Httpunch.utils.isJSON(response)) {
                const jsonParserPath = options['json-parser'];
                if (jsonParserPath && response.body) {
                    const jsonParser = jsonParsers[jsonParserPath] || (() => {
                        jsonParsers[jsonParserPath] = require(jsonParserPath);
                        return jsonParsers[jsonParserPath];
                    })();

                    try {
                        response.body = jsonParser.parse(response.body);
                    }
                    catch (err) {
                        pipe.throw(ono(err, 'Failed to parse JSON response body'));
                        return;
                    }
                }
                else {
                    response.body = Httpunch.utils.tryParse(response.body);
                }
            }

            reply(response);
        });
    });

    httpfy(pipe);
};

function nsBindRequest(req) {
    process.domain && process.domain.add(req);

    return req;
}
