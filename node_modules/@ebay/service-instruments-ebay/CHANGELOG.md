# ChangeLog

## v4.52.0
* Swicth TrustFabric token to V4 for SDDZ Async Proxy Calls
https://jirap.corp.ebay.com/browse/NODE-5933

## v4.51.0
* NODE-5808: Added SDDZ/DevZone Proxy for requests initiating from DevZone
https://jirap.corp.ebay.com/browse/NODE-5808

## v4.50.0
* Added deepMerge utility function for complete object replacement during configuration merging, https://jirap.corp.ebay.com/browse/NODE-5719

## v4.46.2
* Enable Custom Header Propagation in NodeJS Client, https://jirap.corp.ebay.com/browse/NODE-5504

## v4.46.1
* Traffic mirror headers are not being propagated by the service-client, https://jirap.corp.ebay.com/browse/NODE-5475

## 4.44.0
* Enabled  KeepAlive by default for ALL HTTPS calls, `keepAlive: true, keepAliveMsecs: 20000` for service calls with 20sec timeout, https://jirap.corp.ebay.com/browse/NODE-5296

## 4.43.0
* Added support for custom json parsers in http transport, https://jirap.corp.ebay.com/browse/NODE-5090

## v4.42.5
* NODE-5049: Update span time creation logic

## v4.42.4
* NODE-5013: Added Span for mesh

## v4.42.3
* Buckets distribution nodejs + remove clientName, https://jirap.corp.ebay.com/browse/NODE-4858

## v4.42.0
* Added JWT token support for app token

## v4.41.7
* Fix: Changed name of metrics from http_client_mesh_requests_ms to http_client_mesh_requests_duration_ms
* Changes for Moving away from runtime certs to static certs for Performance optimization

## v4.41.7
* Added mesh service client metrics 
https://docs.google.com/document/d/1VVoA504EUd8PJxcxjvIfdvQ3kKIz6gTWaIHpc8cqX44/edit

## v4.41.1
* Changed stream-response to instrument from transport, https://jirap.corp.ebay.com/browse/VELOCITY-511

## v4.41.0
* Added new transport to pass response to the client to handle stream or single chunk, https://jirap.corp.ebay.com/browse/VELOCITY-511

## v4.40.0
* Fixed execution order to run aid after outbound context instrument
* Force inject aid for services that have only explicit list of instruments

## v4.38.0
* Enabling aid instrument for prod for all apps.

## v4.37.0
* Enabling aid instrument for staging for all apps.

## v4.36.0
* Added tranform support for pipe response stream, https://jirap.corp.ebay.com/browse/NODE-4360

## v4.35.0
* Added: pipe transport must shutdown response stream when source stream is closed/reset, https://jirap.corp.ebay.com/browse/NODE-4355

## v4.34.1
* Change: "extend" to "extends", https://jirap.corp.ebay.com/browse/NODE-4243

## v4.34.0
* Added: extend property for service client, https://jirap.corp.ebay.com/browse/NODE-4243

## v4.31.0
* Added: support for default client configuration to dynamically create clients, https://jirap.corp.ebay.com/browse/NODE-3871

## v4.30.3
* Fix: graphql service client logs undefined endpoint () in CAL, https://jirap.corp.ebay.com/browse/NODE-4162

## v4.30.2
* ServiceClient endpoint through prometheus should show exemplars and show real URI, https://jirap.corp.ebay.com/browse/NODE-4075

## v4.30.1
* trust-fabric should lazy load hostipchecker, https://jirap.corp.ebay.com/browse/NODE-4100

## v4.30.0
* NameService clients should not use TF token check and always set it, https://jirap.corp.ebay.com/browse/NODE-4085

## v4.28.0
* Implement WebClient style prometheus metrics on Nodejs serviceclients, https://jirap.corp.ebay.com/browse/NODE-3981

## v4.27.0
* ESLint fixes

## v4.26.1
* Fix: bootstrap API loses default instruments when custom instruments are defined, https://jirap.corp.ebay.com/browse/NODE-3992

## v4.26.0
* @ebay/opentelemetry-ebay@^2 major upgrade, https://jirap.corp.ebay.com/browse/NODE-3043
  * tracer instrument has been updated to new opentelemetry API
  * Switched browser test from 7000 to 8000 as 7000 is taken on osx m1
* service instrumentation opentelemtry should use better clientId, https://jirap.corp.ebay.com/browse/NODE-3740

## v4.25.0
* Switched to @ebay/soap-temp-ebay, https://jirap.corp.ebay.com/browse/NODE-3925

## v4.24.0
* Added X-EBAY-SESSION-AUTHORIZATION to security filter, https://jirap.corp.ebay.com/browse/NODE-3914
* Given that all the header names eventually converted to lower case, made the logic case insensitive.

## v4.22.0
* Added new API to create client out of bootstrap to fix race condition, https://jirap.corp.ebay.com/browse/NODE-3860
* Added typescript definitions

## v4.20.1
* Fix: Unable to verify the first certificate for cswebworkflow application, https://jirap.corp.ebay.com/browse/NODE-3898

## v4.20.0
* GraphQL client API

## v4.19.1
* Added BuildId to Span Attributes
https://jirap.corp.ebay.com/browse/NODE-3597

## v4.19.0
* Added custom header name for trust fabric token

## v4.18.1
* Fix: tracing module not found when making service calls

## v4.18.0
* Added Open telemetry instrumentation

## v4.17.0
* Added: addAuthorizationHeader option to populate authorization header with tf token, https://jirap.corp.ebay.com/browse/NODE-3188

## v4.16.0
* Fixed: trust-fabric token emitted without a bearer token, https://jirap.corp.ebay.com/browse/NODE-3496

## v4.15.1
* Moved @ebay/oauth-ebay to the direct dependency list, https://jirap.corp.ebay.com/browse/NODE-3484

## v4.15.0
* Added basic app-token instrument, https://jirap.corp.ebay.com/browse/NODE-3396

## v4.14.0
* Added option to skip guid in soap instrument, https://jirap.corp.ebay.com/browse/NODE-3407

## v4.13.0
* tracking HRC tag support changes

## v4.12.0
* TCP keep alive support by Ruslan Prytula
* Removed error logging in keep-alive logic (re-try will be implemented in httpunch)

## v4.11.0
* Added support for request binary stream, https://jirap.corp.ebay.com/browse/NODE-3167

## v4.10.1
* Fixed: remove payload logging for security reasons, https://jirap.corp.ebay.com/browse/NODE-3143

## v4.10.0

* Added GraphQL logging instrumentation for gateway applications
* Added `logMethod` option to include the method in logging service requests

## v4.9.6
* Added a lot more certs from https://ebayinc.sharepoint.com/teams/SelfService/Directory%20Services/SitePages/Active%20Directory%20Certificates%20Services%20Help%20Site.aspx and sectigo root cert, download it from this link:
https://wiki.vip.corp.ebay.com/pages/viewpage.action?pageId=562535062#id-2019Comodo/SectigoCert-3Sectigo
## v4.9,4
* Adding https instrument to all custom instruments to handle the case when discovery services changes the service protocol from http to https
## v4.9.3
* Enabled ebay root certs by default whenever https protocol is detected
* Added two missing certificates, https://jirap.corp.ebay.com/browse/NODE-2952

## v4.9.2
* service-instruments-ebay fails to define config bean for scoped modules, https://jirap.corp.ebay.com/browse/NODE-2934

## v4.9.1
* Fixed: FORWARD_RLOGID issue in CAL https://jirap.corp.ebay.com/browse/NODE-2920

## v4.9.0
* Added support for proxy option, https://jirap.corp.ebay.com/browse/NODE-2919

## v4.8.0
* Added: pipe transport that pipes service response into web response as a stream, https://jirap.corp.ebay.com/browse/NODE-2901

## v4.7.3
* Fixed: should exclude origUserId from outboundContext when the requested token is app token, https://jirap.corp.ebay.com/browse/NODE-2866

## v4.7.2
* Fixed: FORWARD_RLOGID is not sent by default, moved to tracing.

## v4.7.0/4.7.1
* Added: Added `x-ebay-tf-authorization` header as part of Zero trust initiative.
https://jirap.corp.ebay.com/browse/NODE-2771

## v4.6.1
* Added: Logging Forward Rlogid for CAL tracing.
https://jirap.corp.ebay.com/browse/NODE-2783

## v4.7.0
* Added: make sure TF token is not injected for request going external, https://jirap.corp.ebay.com/browse/NODE-4094

## v4.6.0
* Added: Log warning on short vip usage, https://jirap.corp.ebay.com/browse/NODE-2656

## v4.5.5
* Fixed: Added `eBayRootCerts` by default for HTTPS service discovery. https://jirap.corp.ebay.com/browse/NODE-2731

## v4.5.4
* Oauth should report error when ebay context is missing, https://jirap.corp.ebay.com/browse/NODE-2652

## v4.5.3
* Turned off header suppression

## v4.5.2
* Added exception for short vips

## v4.5.1
* Added exception for localhost for https://jirap.corp.ebay.com/browse/NODE-2539

## v4.5.0
* Implemented: Do not send ebay header to external service, https://jirap.corp.ebay.com/browse/NODE-2539
* Moved: discovery instrument up in the chain before outboundContext which now has dependency on hostname

## v4.4.1
* Fixed: should allow query parameters and empty body, https://jirap.corp.ebay.com/browse/NODE-2419
* Added: enable/disable options for outboundContext, https://jirap.corp.ebay.com/browse/NODE-2589

## v4.4.0
* Added X-EBAY-CONSUMER-ID and X-EBAY-CLIENT-APP-NAME to outbound context, https://jirap.corp.ebay.com/browse/NODE-2348

## v4.3.14
* Added `tlsSocketProtocol` to service's config bean

## v4.3.13
* Updated `timestamp` to `lastUpdatedTime` as changed by service-discovery-ebay

## v4.3.12
* CAL now correctly logs `requestURL`. https://jirap.corp.ebay.com/browse/NODE-2198

## v4.3.11
* Added logging `ri` & `node_id` in CAL for OutBound Calls. https://jirap.corp.ebay.com/browse/NODE-2181

## v4.3.10
* Discovery endpoints are now updated on the basis of when .discovery.json file was written; not when forceRefresh was requested. https://jirap.corp.ebay.com/browse/NODE-2219
* Fixed failing tests (endpoint has changed)

## v4.3.9
* Injected discovery automatically even if instruments are explicitly defined

## v4.3.8
* Fixed: EP should check isEnabled flag on response as well, https://jirap.corp.ebay.com/browse/NODE-2004

## v4.3.7``
* Fixed: multiple soap header in request should be handled correctly.

## v4.3.6
* Prevented discovery from throwing error if service configbean is not defined

## v4.3.5
* Read applicationLabels from config.json, instead of allowing to override using service-client-ebay
* Read service urn from config.json for service-discovery

## v4.3.4
* Move eslint to devDependencies

## v4.3.3
* Changed service-discovery logging error to warning

## v4.3.2
* Removed basepath resolution from service-discovery. It'll only be used to discovery endpoint (host, protocol, port)

## v4.3.1
* Fixed service-discovery dependency pointing to github

## v4.3.0
* Added service-discovery as an instrument to resolve service endpoints at runtime.

## v4.2.0
* Added response headers to mje/sse streams per https://jirap.corp.ebay.com/browse/NODE-1778

## v4.1.4
* Fixed: Response Headers are now logged without encoding
https://jirap.corp.ebay.com/browse/NODE-1552

## v4.1.3
* Fixed: Support for passing additional header names for masking
https://jirap.corp.ebay.com/browse/NODE-1607

## v4.1.2 - contribution by Swathi Prasad
* Fixed 'generateHeadersInfo is not a function' error by pointing it to right utils file

## v4.1.1
* Fixed: should attach response to error object whenever it is available, https://jirap.corp.ebay.com/browse/NODE-1577

## v4.1.0
* Added support for soap header objects, https://jirap.corp.ebay.com/browse/NODE-1561

## v4.0.15
* Increase SIFR abort timeout to 5 seconds to support slow internet connection cases.

## v4.0.14
* Fixed: Issue while deploying to Altus - http://resreposvc.vip.ebay.com:80 down, https://jirap.corp.ebay.com/browse/RAPTORSUP-779

## v4.0.13
* Changed JSON to HeaderMultiValue for Headers logging to CAL

## v4.0.12
* Added a flag to disable COS 2.0 XFF feature for services that are not ready. One of them is esams legacy service.

## v4.0.11
* Added: log request headers into CAL in case of error, https://jirap.corp.ebay.com/browse/NODE-891
* Implemented x-forwarded-for per COS 2.0 spec: https://wiki.vip.corp.ebay.com/pages/viewpage.action?spaceKey=ARCH&title=End+to+End+Support+for+ClientIP+using+XFF#tabs-notification-2, https://jirap.corp.ebay.com/browse/NODE-1366
* Fixed: metrics disappeared for platform modules, https://jirap.corp.ebay.com/browse/NODE-1396
* Fixed: should show custom instruments if used in corresponding service config bean

## v4.0.10
* Added context method specific to ebay platform context

## v4.0.9
 * Added feature for converting short vip/stratus to FQDN
 * Added config for some known hosts
 * Made tracking handler configurable to control where the tracking data should come from response headers or chunk

## v4.0.8
* http-api should use only isomorphic functionality as it is used in browser as well

## v4.0.7
* Fix: service-instruments-ebay: no response/error received after retry for legacy pipelines, https://jirap.corp.ebay.com/browse/NODE-1254
* Fix: service-client-ebay via http-api instrument suppresses uncaught errors, https://jirap.corp.ebay.com/browse/NODE-1250

## v4.0.6
* Fix: config does not pass configuration to other handlers, https://jirap.corp.ebay.com/browse/NODE-1241

## v4.0.5
* Integrated with trooba-hystrix-handler
* Added mock transport for easy mocking for app developers
* Added fallback method to http API
* Added hystrix metrics publishing to sherlock
* Fixed: service-client-ebay should clear up an error count after successful call - https://github.corp.ebay.com/nodejs/instrument-inc/issues/28
* Fixed: service-instrument-ebay/circuit does not honor config bean changes - https://jirap.corp.ebay.com/browse/NODE-1114

## v4.0.3
* Fixed retry logic to clone the original request object for retry attempt
* Corrected unit tests

## v4.0.2
* Don't overwrite error.type if it is set to any value other than error.

## v4.0.1
* Lazy initialize MetricsServices to avoid cycles

## v4.0.0
* Update depenendcies that bring in peer dependencies

## v1.0.2
* Fixed: RuntimeError should allow to overwrite message attribute.

## v1.0.1
* Fixed: error handler should not re-set error message; it should wrap error into a new error with message that contains url metadata. This would prevent uncaught errors when they are frozen.
* Circuit handler should not auto-mark up a service that was manually marked down (Verified with unit-test)
* Soap handler should correctly format error message received from backend when multiple errors come.

## v2.0.0
* Renamed the module
* Deprecated instruments-ebay and instruments-inc
* Refactored to [Trooba framework](https://github.com/trooba/trooba)
* Added multipart json transport

## instruments-ebay@2.0.0 and instruments-inc
* Merged instrument-ebay/inc to service-instruments-ebay and refactored to adhere to [trooba framework](https://github.com/trooba)
* Upgraded to service-client-ebay@2+
* Removed dependencies on servicecore
* Removed instrument and transport registry. Now it dynamically resolves instruments

## v1.0.7
* Enhancement: HTTPS instrument to access services using eBay Root certificate or Self Signed certificate for SSL setup.

## v1.0.6
* Fixed: added scopes to getRecognizedUserToken and getPublicRecognizedUserToken.

## v1.0.5
* Fixed: should handle error passed in the response body, https://github.corp.ebay.com/nodejs/instrument-ebay/issues/39
* Fixed: should pass http error status code when fail to parse the body in case the service returns non XML response

## v1.0.4
* Fixed: oauth instrument should not fail with NPE due to bad scope in tolerant/browser mode: https://jirap.corp.ebay.com/browse/NODE-310
* Corrected OPTIN_COOKIE unit tests that started failing due to changes in ep module

## v1.0.3
* Removed unused dependencies

## v1.0.2
* Added initial support for browser instrumentation

## v0.2.2
* Added initial support for browser instrumentation

## v0.2.1
* Added metrics for soap instrument to measure marshaling/unmarshaling

## v0.2.2
* Fixed request-local dependency

## v0.2.1
* Fixed: Instrumentation w/Errors

## v0.2.0
* Enhancement: Enabled EP instrumentation for Experience Services
* Fixed: Instrumentation w/Errors

## v0.1.16
* Enhancement: Enabled EP instrumentation for Experience Services

## v0.1.15
* Fixed: Formatted EP Header values
* Fixed: Added SSE Tracking Header Support

## v0.1.14
* Fixed: Sending right Headers from EP

## v0.1.13
* Added function to reset soap clients.
* Fixed: soap should correctly handle error.

## v0.1.12
* Added missing cache instrument registration.

## v0.1.11
* Added soap instrument

## v0.1.10
* Added cache instrument

## v0.1.9
* Added error attributes per COS 2.0

## v0.1.8
* Fixed: wrapping runtime into runtime fails.
* Added: more unit tests for error property inheritance

## v0.1.7
* Added support for giving specific scope per token request.
* Added RuntimeError class to simplify wrapping of generic errors with instrumentation like type, code, statusCode and preserving the original stack while allowing to capture post async call stack trace.

## v0.1.6
* Provides standard ebay instrumentation for generic transports.
* You can define your own transport and have it instrumented via [service-client-ebay module](https://github.corp.ebay.com/nodejs/service-client-ebay).
    Transport interface:

    ```javascript
    function epsTransportFactory() {
      return function epsTransport(options, callback) {
        // do something here
        callback(err, response);
      };
    }
```
* You can define your instrument and register it for others to use: https://github.corp.ebay.com/nodejs/instrument-inc#registration
