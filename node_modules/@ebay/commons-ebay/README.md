# commons-ebay 

[![Build Status](https://go/-/nodejsci/job/nodejs/job/commons-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/commons-ebay/job/master/) [![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/commons-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/commons-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/commons-ebay)](http://sonar/dashboard/index?id=commons-ebay)

The module provides middleware and general context metadata for ebay app.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/commons-ebay/blob/master/CHANGELOG.md#changelog)

# Usage

Once the `@ebay/commons-ebay` middleware runs an `ebay` object will be added to the `req` object. The `req.ebay` object will expose an API with various methods and properties described in the API section below.

Code example:

```javascript
module.exports = function (req, res, next) {
    console.log('Marketplace ID:', req.ebay.getMarketplaceId());
});
```

## TODO: 

* https://github.corp.ebay.com/commerceos/cos-experimentation/blob/master/experimentation.md

# API

The methods/properties described below are available in `req.ebay` namespace:

## Request-related Methods

- **getAcceptLanguages()** - get accept language
- **getAreaId()** - returns ebay area id
- **getCoBrandId()** - returns ebay cobrand id
- **getPartnerId()** - returns ebay partner id
- **getRemoteAddr()**  - return remote ip of Caller (Immediate Caller)
- **getClientIP()**  - return Client ip (Browser IP)
- **getRlogId()** - provides rlogid for the current context
- **getServerName()** - returns server name as well
- **getSiteInfo()** - returns siteInfo data
- **getUserAgent()** - returns user agent string
- **isCookieSupportedEnabled()** - check if cookie support is enabled or not.
- **isInternalHost()** - check if IP is internal or not and if internal has VI update access or not
- **isInternalRequest()** - checks if is internal request or not. Can be used to protect corp only data.
- **isSecure()** - check if request has secure content
- **requestUrl** - returns request URL
- **getSiteId()** - returns ebay site ID

## Application-related

- **appContext** - returns appContext. Refer [App Context](https://github.corp.ebay.com/nodejs/commons-ebay/blob/master/docs/AppContext.md)
- **appMeta** - returns app meta data
- **getMarketplaceId(commerceOsCompatible)** - gets the marketplaceId, default `EBAY-US`, if commerceOsCompatible is true it will return latest standard marketplace id, for example for BEFR, it will return EBAY-BE or EBAY-FRBE otherwise which is a legacy one.
- **getTerritoryId()** - gets the territoryId, default `US`

## GUID-related

- **getGuid()** - get or create a GUID for the request

## Machine-related

- **getMachineTagCookie** - gets the machine tag cookie

## Page-related

- **getPageId** - returns page id
- **getPageName** - returns page name, Refer [PageName](https://github.corp.ebay.com/nodejs/commons-ebay/blob/master/docs/PageName.md)
- **signInPageUrl** - returns sign-in page URL. The pages that do not require user authentication will not not sign-in link. In order to force it you can use routes.json and add `sign-in-link`:
```json
{    
    "path": "/commons-sign-in-link",
    "methods": ["GET", "POST"],
    "pageName": "CommonPage",
    "sign-in-link": true  // force signin link
}, 
{    
    "path": "/commons-sign-in-link-skip-ru",
    "methods": ["GET", "POST"],
    "pageName": "CommonPage",
    "sign-in-link": {
        "skip-ru": true // in some cases app wants to set its own RU parameter
    }
}
```

## User-related

- **getAccountId()** -
- **getAdminUserId(userId)** - Get the admin user ID from given string or cookie
- **getLevel1UserId()** -
- **getLevel2UserId()** -
- **getLevel2UserIdUnstripped()** - Get user ID from level 2 user ID cookie
- **getPersistentVisitorAccountId()** - For LightWeight(LW) accounts, this API returns account id from cookie
- **isEmailVisitor()** - For LightWeight(LW) accounts, this API returns true/false from cookie bit flag
- **getPersistentAccountId()** -
- **getPersistentUserId()** - Get user ID from persistent user id cookie
- **hasAdminUserId(userId)** - Check if admin user ID is available is available for the provider user ID
- **hasGuestCookie()** - Check if user has a guest cookielet within the session cookie
- **hasLevel1UserId()** - Check if user id for level one page in cookie exists
- **hasLevel2UserId()** - Check if user id for level two page in cookie exists
- **hasUserId()** - Check if the user ID is available as part of the cookies
- **isLoggedInAsGuest()** - Check if user is logged in as a guest
- **getPresentationUserId()** - Get user id for UI presentation use, such as header personalized greeting, etc.
- **getUserId()** -
- **getBestUserId()** - This will attempt to scan all possible sources for user id and return it back to the caller. It is best guess and should not be used for user operations. 
- **getJSPersistentUserId()** -
- **getUserIdSignIn()** -
- **getUserFirstName()** -
- **getLevel1ExtUserId()** -
- **getLevel2PageType()** -
- **getSignInWelcomeUsed()** -
- **getLevel1Checksum()** - One character checksum to identify the person using the persistent cookie. null if no persistent cookie.
- **getSignInPrefFlags()** - Get the flags which represent the user's signin preferences
- **getUserBandwidth** - Returns user bandwidth object which has below method, actual bandwidth of the user
- **getUserBandwidthToOrigin** - Returns user bandwidth object which has below method. Origin bandwidth is bandwidth WRT ebay origin.

```javascript
    let userBW = req.ebay.getUserBandwidth(); or req.ebay.getUserBandwidthToOrigin();

    userBW.isLow() //Returns true/false
    userBW.isLowMedium() //Returns true/false
    userBW.isMediumHigh() //Returns true/false
    userBW.isHigh() //Returns true/false
```


## Transforming Post parameters to Get 

Upon certain circumstances, you might want to convert the `Request.body` part of your Request POST to be converted to `GET` querystring parameters. 

Example is : 
1. You are posting to a page which is behind L1 Session 
2. The user is not signed in 
3. The authorization module redirects the user to Signin page w/a Redirect URL 
4. But the post parameters are lost.

To overcome this you can override the route w/a configuration `post2Get` set to true. 

Example Route: `routes.json`
```JSON
    {
        "path": "* /xo",
        "handler": "require:./src/app/handlers/view",
        "pageName": "ReviewYourPurchase",
        "security": "L1SESSION",
        "post2Get": true
    }
```

## Middleware config
commons-ebay middleware can be configured in application code (middleware.json) as follows

    "commonsebay": {
        "enabled": true,
        "priority": 102,
        "module": {
            "name": "@ebay/commons-ebay/middleware",
            "arguments": [{
                "cal": {
                    "type": "@ebay/cal", // type of logger, possible: cal, console
                    "formatter": "@ebay/cal" // formatters for the logger: cal, silent
                },
                "defaultCobrandId" : 2 //Override the cobrandId in X-EBAY-C-TRACKING header which is set by default to 0
            }]
        }
    }


## Splitting CAL traffic into international, country specific and core

If you application needs to split CAL traffic into country specific or CORE vs INTL, you can put the following configuration into your application config/config.json

```json
{
    "commons": {
        "cal": {
            "IntlDiffCmdName": false,
            "CountryDiffCmdName": false
        }
    }
}
```

For INTL vs CORE traffic, please set IntlDiffCmdName to true, for country specific traffic, you can set CountryDiffCmdName to true.
The parameters are optional and false by default, so you can omit the ones you are not setting.
