'use strict';

var appMeta = require('@ebay/appmeta-ebay');
var debug = require('debuglog')('@ebay/commons-ebay');
var Assert = require('assert');
//Return contextual data about the application
var appContext = require('@ebay/app-context-ebay');
var logger = require('@ebay/logging-inc').logger('commons-ebay/appContext');

appContext.init = function init(options, callback) {
    Assert.ok(callback, 'callback is required');
    options = options || {};
    var appName = options && options.appName || appContext.appName;

    appMeta.load(appName, function cb(err, result) {
        if (err) {
            logger.error('Failed to load App-Meta', appName, err);
            return callback(err);
        }
        return callback(null, result);
    });

    setImmediate(initExpSvcAppMetas, options);
};

function initExpSvcAppMetas(options) {
    let loadAppMeta = appMeta.loadWithtoutAppSecret || appMeta.load;
    let dependentSvcs = options.experienceService || appContext.experienceService;

    appContext.experienceService = dependentSvcs;

    if (dependentSvcs) {
        appContext.defaultExpSvc = Array.isArray(dependentSvcs) ? dependentSvcs[0] : dependentSvcs;
    }

    var svcsList = [];
    debug('Trying to initialize Experience Service MetaData %s', dependentSvcs);
    if (dependentSvcs) {
        if (Array.isArray(dependentSvcs) && dependentSvcs.length > 0) {
            svcsList = dependentSvcs;
        } else {
            svcsList.push(dependentSvcs);
        }
    }

    svcsList.forEach(function iter(svc) {
        debug('Initialize Experience Service MetaData %s', svc);
        loadAppMeta(svc, function cb(err, result) {
            if (err) {
                logger.error('Failed to load Experience Service App-Meta', svc, err);
            }
        });
    });

}

module.exports = appContext;
