'use strict';

const CC = require('../constants/country-codes');

const CONST = {
    ACCEPT_LANGUAGE: 'Accept-Language',
    DEFAULT_LANGUAGE: 'en-US',
    LANGUAGE_REGEX: /^([A-Za-z]{2})-([A-Za-z]{2})/
};

function getAcceptLanguages(context) {
    const req = context.getRequest();
    const isService = context.isService;
    // allow using accept-language header for service and webview (native apps)
    const allowAcceptLanguage = isService ||
        // FE web view
        !!context.webView;

    // The below code is for service application
    var langs,
        languages = context.acceptLanguages;

    if (!languages) {
        languages = [];
        langs = allowAcceptLanguage && req.headers && (req.headers[CONST.ACCEPT_LANGUAGE] || req.header(CONST.ACCEPT_LANGUAGE.toLowerCase())) || '';

        if (langs) {
            langs = langs.split(',') || [];
            for (var i in langs) {
                var language = langs[i];
                language = language.trim();
                var tokens = language.match(CONST.LANGUAGE_REGEX);

                if (tokens) {
                    var country = tokens[2].toUpperCase(),
                        lang = tokens[1].toLowerCase();
                    if (CC.indexOf(country) !== -1) {
                        languages.push(lang + '-' + country);
                    }
                }
            }
        }

        if (languages.length === 0 && req.locality && req.locality.locale) {
            languages.push(req.locality.locale);
        }
        if (languages.length === 0 && !isService) {
            languages.push(CONST.DEFAULT_LANGUAGE);
        }
        context.acceptLanguages = languages;
    }
    return languages;
}


module.exports = {
    getAcceptLanguages: getAcceptLanguages
};
