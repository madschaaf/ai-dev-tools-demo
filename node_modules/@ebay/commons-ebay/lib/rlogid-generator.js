'use strict';

var os = require('os'),
    appContext = require('./app-context');

var s_xors = [6, 7, 3, 5];

/*
 * req.pageStartTime from commons-inc
 * req.threadId from cal
 */
module.exports.generate = function (req) {
    var idData = [];
    var machineName = getMachineName(appContext.poolName, os.hostname());
    var ts = (req.pageStartTime || Date.now()).toString(16);
    var threadId = req.threadId || 1;
    threadId = '0x' + threadId.toString(16);
    idData.push(machineName);
    idData.push(ts);
    idData.push(threadId);
    return idData.join('-');
};

function getMachineName(poolName, hostname) {
    var machineName = [];
    // staging has odbName suffix
    poolName = poolName + (process.env.ODBMO_NAME &&
        process.env.PAAS_REALM === 'staging' && `-${process.env.ODBMO_NAME}` || '');

    if (process.env.CONTAINER_PDLC){
        poolName = appContext.calPoolName || poolName;
    }
    machineName.push(poolName);
    machineName.push(hostname);
    return encodeURIComponent(encrypt(machineName.join('::')));
}

module.exports.getMachineName = getMachineName;

function encrypt(str) {
    var encryptedStr = [];
    for (var i = 0; i < str.length; i++) {
        var k = str.charCodeAt(i);
        var l = k^(s_xors[i % 4]);
        encryptedStr.push(String.fromCharCode(l));
    }
    return encryptedStr.join('');
}
