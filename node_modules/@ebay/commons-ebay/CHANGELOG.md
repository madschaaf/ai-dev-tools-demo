# ChangeLog
## v5.22.5
* NODE-5873: Header propagation issue | FGQL, https://jirap.corp.ebay.com/browse/NODE-5873

## v5.22.4
* NODE-5847: fallback to merch soj guid if exists, https://jirap.corp.ebay.com/browse/NODE-5847

## v5.22.3
* NODE-5795: eBay Merchant services: Requesting for new cookie to propagate guid info,
https://jirap.corp.ebay.com/browse/NODE-5795

## v5.18.3
* NODE-5073: Moved OTEL log to top after payload
https://jirap.corp.ebay.com/browse/NODE-5073

## v5.18.2
* NODE-5089: Application URL not capped in EndUserCtx, https://jirap.corp.ebay.com/browse/NODE-5089

## v5.17.0
* Added propagation for `X-EBAY-C-ISOLATE` header to outbound context. If that header exists
on incoming requests, or an isolate querystring exists, or an isolate cookie exists, or `ISOLATE`
exists as an environment variable for the process, it will propagate the value to outbound context
under `X-EBAY-C-ISOLATE` (assuming the isolate is a valid value, which is 3-12 alphanumeric
characters). It will also issue a `SET-COOKIE` header on the response for the isolate cookie.
If none of those exist, then it won't be added to the outbound context.
If an empty string is set for any of those, the header isn't propagated, and a `SET-COOKIE` header
is set on the response to expire the isolate cookie.
[STGTST-3469](https://jirap.corp.ebay.com/browse/STGTST-3469).

## v5.16.5
* NODE-4439: Added `calPageName` to req.ebay context for showing same name in OTEL

## v5.16.3
* Fix: EDP duplicate corr-id, https://jirap.corp.ebay.com/browse/NODE-4416

## v5.16.2
* Added Sandbox env

## v5.16.1
* Bug fix for 5.16.0

## v5.16.0
* NODE-4345: SEC-GPC header propagation via alternate mechanism

## v5.15.1
* Fix: edp causes NPE, https://jirap.corp.ebay.com/browse/NODE-4321

## v5.15.0
* Added: X-EBAY-EDP to downstream applications for Node.js, https://jirap.corp.ebay.com/browse/NODE-4313

## v5.13.0
* Added: DNS TTL Global Config, https://jirap.corp.ebay.com/browse/NODE-4156

## v5.12.1
* Fix: app-context-ebay typescript definitions do not match js API, https://jirap.corp.ebay.com/browse/NODE-4079

## v5.12.0
* Added: Propagate x-ebay-c-trackable-id request header to downstream calls, https://jirap.corp.ebay.com/browse/NODE-3998

## v5.11.2
* Fix: service needs to support X-EBAY-C-TERRITORY-ID in addition to X-EBAY-TERRITORY-ID, https://jirap.corp.ebay.com/browse/NODE-3989

## v5.11.1
* Updated missing types in index.d.ts

## v5.11.0
* Migrated typescript definitions from @ebay/types-ebay, https://jirap.corp.ebay.com/browse/NODE-3575

## v5.10.0
* Added: getBestUserId fallback to security attributes when tracking header does not have buid for service case, https://jirap.corp.ebay.com/browse/NODE-3609

## v5.9.0
* Added: skip-ru flag to req.route.config to let apps specify their own ru, https://jirap.corp.ebay.com/browse/NODE-3421

## v5.8.1
* Moved silent verification attributes to end-user-context buildHeader, https://jirap.corp.ebay.com/browse/NODE-3486

## v5.8.0
* Added SILENT_VERIFICATION_STATUS and SILENT_VERIFICATION_TIMESTAMP to end user context, https://jirap.corp.ebay.com/browse/NODE-3486

## v5.7.5
* Added: Support for ClientHints Propagation in End User Context

## v5.7.2
* Fixed: should use odbMoName as suffix for staging in rlogid, https://jirap.corp.ebay.com/browse/NODE-3021
## v5.7.1
* Added: To skip sign in url fecth for L0SESSION pages.

## v5.7.0
* Added isPiggybacked and contextualLocation to end user context, https://jirap.corp.ebay.com/browse/NODE-2939 and https://jirap.corp.ebay.com/browse/NODE-2942

## v5.6.0
* Added: filter for end user context key to allow excluding certain fields when building context for service calls, https://jirap.corp.ebay.com/browse/NODE-2866

## v5.5.3
* dependency upgrades

## v5.5.2
* Fix: nodejs services: user token is detected when app token is used, https://jirap.corp.ebay.com/browse/NODE-2876
## v5.5.1
* Fix: end user context header should be ignored by frontend, https://jirap.corp.ebay.com/browse/NODE-2864

## v5.5.0
* Implemented: Introduce CORE vs INTL URL command logging in node js platform, https://jirap.corp.ebay.com/browse/NODE-2832

## v5.4.4
* Added: Cal Backward tracing rlogid 
https://jirap.corp.ebay.com/browse/NODE-2782

## v5.4.3
* fixed: origClientId in ENDUSERCTX not populated from legacy client id, https://jirap.corp.ebay.com/browse/NODE-2619

## v5.4.2
* The fix for admin user API, https://jirap.corp.ebay.com/browse/NODE-2623

## v5.4.1
* Upgrade to latest utils-ebay changes for TLS version mappings

## v5.4.0
* Added logging of X-eBay-Client-TLS-Version header as part of URL request logging, https://jirap.corp.ebay.com/browse/NODE-2603

## v5.3.0
* Added webview support in regard to getSojGuid and getCorrelationId, https://jirap.corp.ebay.com/browse/NODE-2622
* Added support of getAcceptLanguages for webview which will be used as a a list for content resolution in i18n-ebay, https://jirap.corp.ebay.com/browse/NODE-2616

## v5.2.9
* Fixed: should not override cguid in service flow, https://jirap.corp.ebay.com/browse/NODE-2355

## v5.2.8
* Fixed: should be tollerant to invalid headers, https://jirap.corp.ebay.com/browse/NODE-2350

## v5.2.7
* Seperated `tracing` `ri/rci/node_id` from `outboundcontext`

## v5.2.6
* Updated QA end points

## v5.2.5
* Fixed: EBAY-GB and EBAY-UK should resolve to siteId = 3 for services flow, https://jirap.corp.ebay.com/browse/NODE-2104

## v5.2.4
* Corrected spelling of getPostalCode and setPostalCode for sessiona aware context.

## v5.2.3
* Fixed: Missing value for requestid & correlationId tags, https://jirap.corp.ebay.com/browse/NODE-2027.

## v5.2.2
* Should provide correct return url for apps composed of sub apps via the use of originalUrl.

## v5.2.1
* Roll back v5.1.4 changes, set cacheMode=cache for UFES cache create requests.

## v5.2.0
* Shipping awareness support context header, https://jirap.corp.ebay.com/browse/MTPROD-953

## v5.1.4
* Added urn for service-discovery

## v5.1.3
* Added URL encoding for BOT header

## v5.1.2
* Added BOT Header propagation via `outboundcontext` instrument to ALL outbound connections.
https://jirap.corp.ebay.com/browse/NODE-1939
https://docs.google.com/document/d/1NjmwqBSSi5MNh-aGfg3eCxYYz50w8r2XAI_XZPBoPyY/edit#

## v5.1.1
* isAuthorized condition added for userid in case of MUAA

## v5.1.0
* Removed delegator account id from the origUserId of endUserCtx
* Extended user id to support account and login context

## v5.1.0 (rolled back)
* Added cachePageId to c-tracking header for UFES project

## v5.0.0
* Added support for delegator account id and added delegatorAcctId to origUserId of endusrctx that would be propagated to downstream services.

## v4.2.3
* Corrected getPageId logic for service context

## v4.2.2
* Corrected user-mixins for service usecase 

## v4.2.1
* Added masking for getRequestURL when it has sensitive params

## v4.2.0
* Added propgation of mirrored request id to all downstream services per https://jirap.corp.ebay.com/browse/NODE-1780

## v4.1.7
* Swicthed cookie from `PERSISTENT_VISITOR_ACCOUNT_ID` to `ACTOR_ID` for LightWeight Account
https://jirap.corp.ebay.com/browse/NODE-1769

## v4.1.6
* Added API's for `getPersistentVisitorAccountId` and `isEmailVisitor`
* Added `userId` to EndUserContext for Light Weight account use case
https://docs.google.com/document/d/1CwzSorwlfBYuMwbWq9HRLdoBOGGwPRfd0ThFzTYiyFc/edit?ts=5b914aee

## v4.1.5
* Added `Node_Id` & modified `ri(request id)` as per the spec 
https://wiki.vip.corp.ebay.com/pages/viewpage.action?spaceKey=GlobalPF&title=Distributed+Tracing+Across+Framework
https://docs.google.com/document/d/1nfWcDP10LOwvb3rzjpDQcU4K1g2OteyiD6grbeEw854/edit#


## v4.1.4
* Added Additional CAL logging for IP spoofing(127.0.0.1) https://jirap.corp.ebay.com/browse/NODE-1686

## v4.1.3
* Added site-info resolution logic for service uses cases and mini-sites

## v4.1.2
* Channel User (appname) not granted access to Channel in eSAMS, https://jirap.corp.ebay.com/browse/RAPTORSUP-1662

## v4.1.1
* Fixed: Server Name is Always ebay.com & Script Path is not Complete in CAL Log
https://jirap.corp.ebay.com/browse/NODE-1610

## v4.1.0
* Added: security token support for getLevel1UserId and getAccountId when security context is injected by auth-ebay, https://jirap.corp.ebay.com/browse/NODE-1513

## v4.0.18
* Fixed: req.ebay.isInternalHost should use remote address ip instead of clientIP to make it consistent with ip detection service

## v4.0.17
* Experience service related changes

## v4.0.16
* Enhancement: Override getUserAgent method for service application to use end user context

## v4.0.15
* Fix: NODE-1369, Fix incorrect sign in URLs for mini sites (CAFR, BENL, BEFR)

## v4.0.14
* Added support for UFES Tracking Cache TTL headers

## v4.0.12/13
* This change allows app developer to override the default cobrandId(0) set in X-EBAY-C-TRACKING header.

## v4,0.11
* In case when cookies are not available, getBestUserId will log warning instead of failing. This will be tolerant to the use-case which use outbound context but do not have cookies available.

## v4.0.10
* should init req.ebay.requestUrl before end-user-context is inited.

## v4.0.9
* commons-ebay should automatically set guessedUserId for the apps to utilize, https://jirap.corp.ebay.com/browse/NODE-1300

## v4.0.8
* Fixed issue for reporting incorrect script in CAL instead of path

## v4.0.7
* Added additional logging in CAL

## v4.0.5
* Make commons-inc an independent middleware
* Added support for UFES Tracking Cache Key/Mode headers
* https://wiki.vip.corp.ebay.com/display/TRACKING/Tracking+Request+and+Response+Header+Propagation

## v4.0.4
* Added `getUserBandwidthToEdge` & `getUserBandwidthToOrigin` for retrieving User bandwidth bucket

## v4.0.3
* In `isInternalHost` Switched API from `remoteAddr` to `clientIP` to get real Client IP

## v4.0.2
* Added new API getClientIP
* Added XFF Header to CAL log
* Fixed failing tests

## v4.0.1
* Upgrade locale-ebay in dev dependency

## v4.0.0
* Remove peer and unwanted dependencies and upgrade dependencies

## v0.2.56
* Send fullSiteExperience flag in EndUserContext only when _fsom cookie is true or redirect query parameter is set to mobile

## v0.2.55
* Removed `isSecure` for masking, added `@ebay/security-ebay` for config based sensitive parameters
* Added check for `isInternalHost` when `x-ebay-akamai-9` exists.
* Fixed: should use X-eBay-Original-URL whenever b-pool proxy request is detected

## v0.2.54
* Added `getPageNameFromRoute` for fetching page name from routes

## v0.2.53
* Add fullSiteExperience flag to EndUserContext

## v0.2.52
* Added support for a-pool X-eBay-New-GUID per https://github.corp.ebay.com/nodejs/commons-ebay/issues/64
* Fixed: should log only parameters names when context is secure per https://github.corp.ebay.com/nodejs/commons-ebay/issues/63

## v0.2.50
* Upgraded service-client-ebay to 1.x and switch to explicit request context.
* Added: clientId to end user context to support deviceId validation

## v0.2.49
* Fixed: should set currency from locality to user cultural preferences: https://jirap.corp.ebay.com/browse/NODE-348

## v0.2.49
* Switched to `@ebay/utils-ebay` for `getRemoteAddr` and `getServerName`
* Added more logging for appmeta

## v0.2.48
* Fixed: Multiple IP in `x-ebay-client-ip` Headers
* Fixed: Incorrect IP address fetching from `x-forwarded-for` Headers

## v0.2.47
* COS 3.0 updates: https://jirap.corp.ebay.com/browse/NODE-275
* Fixed #51: Moved `cookes-ebay` from dev to prod dependencies

## v0.2.46
* Fixed: Adding string check before doing indexOf

## v0.2.45
* Fixed Signin URL for mobile web i.e `m.ebay.com`

## v0.2.44
* Removed unused dependencies

## v0.2.42
* Fixed: Changed to use `getDCCorelationGUID` for `X-TRACKING` headers

## v0.2.41
* Performance optimizations
* Added sign-in-link options to the route if non-secure route needs to generate a sign-in-link

## v0.2.40
* Added support for “applicationURL” in EndUserCtx
* Changes for IP address as per Node 4.x

## v0.2.39
* Should set req.ebay,returnUrl even for non-secure pages. As part of optimization signin url was made to be generated only for auth pages which disabled returnUrl for non-secure pages.
* Extracted app context into app-context-ebay module (experience service init part is attached by commons-ebay to avoid circular dependencies).
* Should correctly format rlogid for thread ids below 10 in hex form, i.e. should be 0x1, 0x2, etc.

## v0.2.38
Fixed; should pass only base url to kernel getSignInLink call to parsing/stringifying the whole url
Fixed: should not request sign-in link when it is not needed, which is when route security is not set

## v0.2.37
Fixed: Issue of `request.body` querystring only for content types `text/html` or by route parameter `post2get`

## v0.2.36
Enhancement: Added `getExpSvcOperationId` from req.ebay context
Enhancement: Enabled `experience-service` context from the App's GPAAS section
Fixed: Querystring url for empty request body

## v0.2.35
Fixed: Querystring url for empty request body
Fixed: Moved `request` module to `dev-dependencies`

## v0.2.34
Fixed: Added `request.body` post parameters to construct the redirect URL query parameters
Fixed: Not to log error when the URL is not part of the Application router.json

## v0.2.33
Fixed: should log error when a page does not have page id.

## v0.2.32

Fixed : Adding back the cal config bean

## v0.2.31

Fixed : Setting `End-User-Ctx` Http Headers Keys are set to LowerCase(), NodeJS `http.request.headers` are lowercases.

## v0.2.30
* Added: refresh currency list every day

## v0.2.29
* Fixed: Double encoding for Signin Page URL on calling kernel-services-ebay

## v0.2.28
* Fixed: should read marketplaceId and territoryId in lower or upper case from header successfully

## v0.2.27
* Fixed: should handle IP with spaces when checking for internal IP

## v0.2.26
* Moved hostip-checker-ebay to peerDependency

## v0.2.25
* Added: nodejs service support.
* Split eBay context into service context and web context accessible at req.ebay.
