'use strict';

var provider = require('@ebay/service-client-ebay');
var logger = require('@ebay/logging-inc').logger('pathfinder-ebay');
var moduleConfig = require('@ebay/module-config-inc');
var appContext = require('@ebay/app-context-ebay');
var assert = require('assert');
var tryRequire = require('try-require');
var env = require('@ebay/environment-ebay');
var cal = tryRequire('@ebay/cal');

function logSOJEvents(sojData, req, callback) {
    req = req || {};
    assert.ok(sojData, 'sojData is required');
    assert.ok(callback, 'callback is required');
    assert.equal(typeof sojData, 'object' ,'sojData should be object');

    moduleConfig(module, function(err, config) {
        if(err) {
            logger.error('Cannot load module config for pathfinder-ebay/logEvents', err);
        }

        var client = provider.context(req).getClient('pathfinderservice');

        //Send Tracking headers to Pathfinder Service
        let cTracking = req.headers && req.headers['x-ebay-c-tracking'];
        let cTrackableId = req.headers && req.headers['x-ebay-c-trackable-id'];
        
        let headers = {};
        if(cTracking) {
            headers['x-ebay-c-tracking'] = cTracking;
        }

        if(cTrackableId) {
            headers['x-ebay-c-trackable-id'] = cTrackableId;
        }

        logger.info('Invoking pathfinder service for logging SOJ events');
        sojData.rheosHeader = buildRheosHeader(config.get('schemaId'));

        let sojPayload = JSON.stringify(sojData);
        
        //Log SOJ Payload when Debug flag is Enabled
        if(config.get('services:pathfinderservice:debug') || env.isDev() || env.isQA()) {
            cal && cal.createEvent('pathfinderservice', 'Payload', 0, sojPayload).complete();
        } else {
            cal && cal.createEvent('pathfinderservice', 'Payload', 0, 'Payload NOT Logging, enable debug flag to log Payload').complete();
        }

        client.post({
            body: sojPayload,
            headers: headers
        })
        .end(function (err, response) {
            if(err) {
                return callback(new Error('Failed to POST SOJ events to pathfinder ' + err));
            }
            callback(null, response.body);
        });
    });
}

function buildRheosHeader(schemaId) {
    return {eventCreateTimestamp: Date.now(), eventSentTimestamp: Date.now(), schemaId: schemaId, eventId: null, producerId: 'behavior.pulsar.sojevent.producer'};
}

exports.logSOJEvents = logSOJEvents;