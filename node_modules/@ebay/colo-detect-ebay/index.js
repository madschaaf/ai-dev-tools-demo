'use strict';

/**
 * coloDetect - Uses heuristics to determine datacenter it is running in.
 *              Applications should never use this module. They need to
 *              be location-independent. It is for tasks like metrics
 *              collection where the ability to drill down by data center
 *              is important to resolving location-specific issues.
 *
 * @return last third component in the result of running hostname -f.
 *         Ideally, you should call this once and keep the result as
 *         calling a shell operation is not the most efficient thing.
 *         Note that there are heuristics here. For ebay, the general
 *         hostname -f form is host.xxx.ebay.com where xxx might be
 *         slc, chd, qa usually.
 *         eBay: Whatever is in the 3rd from the right part of the
 *               fully qualified hostname
 *
 */
var shell = require('shelljs');
var deployEnv = require('@ebay/environment-ebay');
var os = require('os');
var parts;
var hostname;

var path = require('path');
var tryRequire = require('try-require');
var metadata = process.env.CRONUSAPP_HOME &&
    tryRequire(path.join(process.env.CRONUSAPP_HOME, '.metadata.json'));

module.exports.coloDetect = function coloDetect(testHost) {
    // For K8s deployment, FQDN will not have datacenter anymore.
    // Derive datacenter from metadata.json, else fallback to previous
    if(metadata && metadata['instance.datacenter']) {
        return metadata['instance.datacenter'].toLowerCase();
    }

    var env = process.env.DEPLOY_ENV,
    deploySite = process.env.DEPLOY_SITE;

    if (!env || /development|test/.test(env)) {
        return 'development';
    }
    if (deploySite) {
      return deploySite.toLowerCase();
    }
    parts = getHostParts(testHost);

    // Structure:
    // parts[0]=hostname, parts[1]=slc|phx|chd..., parts[2]=ebay, parts[3]=com
    if (parts[parts.length - 2] === 'ebay') {
        return  parts[parts.length - 3];
    }
    return '';
};

// Determine the MX host for the colo
// eBay is always atom
module.exports.coloMxDetect = function coloMxDetect(testHost) {
    var mxhost = 'mx.vip.ebay.com';
    if(!deployEnv._env || deployEnv.isDev() || deployEnv.isTest()) {
        mxhost = 'atom.corp.ebay.com';
    } else if (deployEnv.isStage() || deployEnv.isLnp()) {
        mxhost = 'mxrc.vip.qa.ebay.com';
    }
    return mxhost;
};

function getHostName() {
    if(!hostname) {
        var result = shell.exec('hostname -f', { silent: true });

        if (result.code !== 0 || !result.stdout) {
          console.error('Cannot determine host name', result);
          hostname = os.hostname();
          return hostname;
        }
        hostname = result.stdout.trim();
    }
    return hostname;
}

// Returns an array with the parts of the FQDN of the host
function getHostParts (testHost) {
  var res;

  if (testHost) {
    res = testHost;
  } else {
    res = getHostName();
  }

  var parts = res.split('.');
  if (parts.length <= 3) {
    var err = new Error("Cannot determine colo from " + res + ". Expected host.colo.xxx.com format");
    console.error(err.message);
    return [];
  }
  return parts;
}

module.exports.getHostName = getHostName;
