'use strict';

class Enum {
    constructor(name, value) {
        this.name = name;
        this.value = value !== undefined ? value : name;
    }

    toString() {
        return this.name;
    }
}

/*
* Define enum values
* @param EnumCtr is an enum constructor
* @param values is an array of simple values or key-value-pairs of name and value
*/
function define(values) {
    if (!values) {
        throw new Error('Enum values must be provided');
    }

    let _frozen = false;
    const EnumCtr = class extends Enum {
        constructor(name, value) {
            super(name, value);
            if (_frozen) {
                throw new Error('Cannot modify enum list');
            }
        }
    };

    const isKvp = values && typeof values === 'object' && !Array.isArray(values);
    const keys = arguments.length > 1 ?
        [].slice.call(arguments) :
        isKvp ? Object.keys(values) : values;

    if (!keys.length) {
        throw new Error('Enum values must be provided');
    }

    const VALUES = keys.reduce((memo, key) => {
        if (!key) {
            throw new Error('Enum values must be provided');
        }
        let val = isKvp ? values[key] : key;
        if (val === undefined) {
            throw new Error(`Enum (${key}) value must be provided`);
        }

        if (typeof val === 'object') {
            val = Object.freeze(val);
        }

        const enumValue = memo[key] = Object.freeze(new EnumCtr(key, val));
        Object.defineProperty(EnumCtr, key, {
            enumerable: false,
            configurable: false,
            writable: false,
            value: enumValue
        });
        return memo;
    }, {});

    _frozen = true; // prevent instantiation

    EnumCtr.valueOf = function (name) {
        if (VALUES[name] === undefined) {
            throw new Error(`Enum ${name} is not defined`);
        }
        return VALUES[name];
    };

    EnumCtr.values = Object.keys(VALUES).map(name => VALUES[name]);

    // force to fail if wrong enum values are used
    return new Proxy(Object.freeze(EnumCtr), {
        get(target, name, ctr) {
            if (target[name] === undefined) {
                throw new Error(`Enum ${name} is not defined`);
            }
            return Reflect.get(...arguments);
        }
    });
}

module.exports = Enum;
module.exports.define = define;
