"use strict";

var	path = require('path'),
	fs = require('fs'),
	cs = require('../constants'),
	async = require('async'), 
	propUtil = require('properties');

module.exports = exports = {
	parse : parse,
	convert : convert
};


/**
 * Parse the properties file to generate the JSON file.
 */
function parse(options, callback) {

	options = options || {};
	var file = options.file;
	if (!fs.existsSync(file)) {
		return callback(new Error("Could not find the properties file " + file));
	}
	var outFile = options.outFile || path.join(path.basename(file), path.basename(file, '.properties') + '.json');

	propUtil.parse(file, { path : true, separators : ";" }, function (error, obj){
		
		if (error) {
			return callback(error);
		}
		if (!obj) {
			return callback(new Error("Error in parsing the properties file." + file));
		}
		
		fs.writeFile(outFile, JSON.stringify(obj, null, 2), function (err){
			if (err) {
				return callback(err);
			}
			return callback(null);
		});
		
	});	
}

function convert(options, callback) {

	options = options || {};
	options.propsDir = options.propsDir || cs.PROPS_DIR;
	options.outDir = options.outDir || cs.FORMATS_CONFIG_DIR;

	fs.readdir(options.propsDir, function(err, files){
		if (err) {
			return callback(err);
		}
		
		async.each(files, function(file, cb) {
			
			//Resolve the Complete file path
			file = path.resolve(options.propsDir, file);
			if (fs.existsSync(file) && path.extname(file) === '.properties') {
				
				var opts = {};
				opts.file = file;
				opts.outFile = path.join(options.outDir, path.basename(file, '.properties') + '.json');
				parse(opts, function(err){
					return cb(err);
				});
			} else {
				return cb();
			}

		}, function(err){
			// if any of the saves produced an error, err would equal that error
			if (err) {
				return callback(err);
			}
			return callback(null);
		});
	});

	
}