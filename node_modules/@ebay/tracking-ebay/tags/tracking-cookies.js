'use strict';

var taasHelper = require('../lib/taas/helper');
var logger = require('@ebay/logging-inc').logger('tracking-ebay:cookie-tag');

function renderCommitCookiesCode(req, res, context, taasContext) {
    var cookies = req.ebay.cookies;

    /*
    cookieData: [
        { cookieletID: '352', cookieValue: {}, actionType: 'D' },
        { cookieletID: '344', cookieValue: {}, actionType: 'D' },
        { cookieletID: '999', cookieValue: '3065243', actionType: 'A' }
    ],
     */
    if (taasHelper.updateCookies(req, res, taasContext)) {
        var nonce = req && req.csp && req.csp.nonce ? 'nonce="'+req.csp.nonce+'"' : '';
        var cookieManager = cookies.getCookieManager()._rawCookieManager;
        var commitCookiesCode = cookieManager.getBrowserCommitCode();
        if (commitCookiesCode) {
            context.write('<script'+nonce+'>' + commitCookiesCode + '</script>');
        }
    }
}

module.exports = {
    render: function (input, context) {
        var res = context.stream;
        var req = res && res.req;
        if (!req) {
            req = context.global && context.global.req;
        }
        var _tracking = req.ebay.tracking;

        if (!_tracking.getTaasContext) {
            logger.warn('Failed to render tracking-cookie helper, tracking context is not available');
            return;
        }

        var asyncContext = context.beginAsync();
        _tracking.getTaasContext(function (err, taasContext) {
            if (err) {
                logger.error('tracking async fragment failed: ', err);
            }
            else {
                renderCommitCookiesCode(req, res, asyncContext, taasContext);
            }
            asyncContext.end();
        });
    }
};
