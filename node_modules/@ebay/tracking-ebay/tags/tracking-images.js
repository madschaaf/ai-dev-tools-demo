'use strict';

var imgTagTemplate = '<img id="{jsId}" alt="" border="0" height="0" src="{src}" style="display:none" width="0" />';
var logger = require('@ebay/logging-inc').logger('tracking-ebay:image-tag');
var util = require('./util');

function renderTrackingImages(context, taasContext) {
    var headerURL = taasContext.response.headerURL;
    if (headerURL) {
        headerURL = Array.isArray(headerURL) ? headerURL : [headerURL];
        // temp fix to workaroud the problem in generating more than one tracking image due to soj guid
        // generated and use in the same request https://github.corp.ebay.com/nodejs/cookies-ebay/issues/14
        if (headerURL.length > 1) {
            var _headerURL = headerURL.filter(function filter(url) {
                return /\/roverns\//.test(url);
            });
            // now if non roverns was found, use all
            headerURL = _headerURL.length === 0 ? headerURL : _headerURL;
        }
        headerURL.forEach(function (url) {
            var jsId = /\/roverns\//.test(url) ? 'taasroverns' : 'taasroversync';
            context.write(imgTagTemplate.replace('{src}', url).replace('{jsId}', jsId));
        });
    }
}

module.exports = {
    render: function (input, context) {
        var req = util.getRequest(context);
        var _tracking = req.ebay.tracking;

        if (!_tracking.getTaasContext) {
            logger.warn('Failed to render tracking-image helper, tracking is not available');
            return;
        }

        var asyncContext = context.beginAsync();
        _tracking.getTaasContext(function (err, taasContext) {
            if (err) {
                logger.error('tracking async fragment failed: ', err);
            }
            else {
                renderTrackingImages(asyncContext, taasContext);
            }
            asyncContext.end();
        });
    }
};
