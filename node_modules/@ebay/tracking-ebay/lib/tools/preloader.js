'use strict';

var fs = require('fs');
var pathUtils = require('path');
var helper = require('../entities/entity-helper.js');
var async = require('async');
var tracking2meta = require('../services/tracking20-metadata-service');

function loadTracking20EventTypeMetadata(callback) {
    tracking2meta.getResourceInstancesByEventType(function (err, res) {
        if (err || !(res && res.body)) {
            console.error('[WARN]: Failed to load tracking2 event type metadata', err);
            return callback(err);
        }
        var location = pathUtils.join(__dirname, '../../resources/tracking2-event-metadata.json');
        fs.writeFileSync(location, JSON.stringify(res.body.eventTypes));
        console.log('[INFO]: Loaded event type metadata: ', location);
        return callback();
    });
}


module.exports = function (destination, callback) {
    var args = Array.prototype.slice.call(arguments);
    callback = args.pop();
    destination = args.shift() || pathUtils.join(__dirname, '../../resources');
    async.parallel([
        function loadGlobalFlags(callback) {
            helper.loadGlobalFlags(function (err, data) {
                if (err) {
                    console.error('[WARN]: Failed to load global flags, using default flags', err.message);
                    return callback(err);
                }
                var location = pathUtils.join(destination, 'global-flags.json');
                data.forEach(function forEach(obj) {
                    delete obj.headers;
                });
                fs.writeFileSync(location,
                    JSON.stringify(data));
                console.log('[INFO]: Loaded global flags metadata: ', location);
                callback();
            });
        },
        function loadTags(callback) {
            helper.loadTags(function (err, data) {
                if (err) {
                    console.error('[WARN]: Failed to load tags, using default tags', err.message);
                    return callback(err);
                }
                delete data.headers;
                var location = pathUtils.join(destination, 'tags.json');
                fs.writeFileSync(location,
                    JSON.stringify(data));
                console.log('[INFO]: Loaded tags metadata: ', location);
                callback();
            });
        },
        function loadModules(callback) {
            helper.loadModules(function (err, data) {
                if (err) {
                    console.error('[WARN]: Failed to load modules, using default modules', err.message);
                    return callback(err);
                }

                delete data.headers;
                var location = pathUtils.join(destination, 'modules.json');
                fs.writeFileSync(location,
                    JSON.stringify(data));
                console.log('[INFO]: Loaded modules metadata: ', location);
                callback();
            });
        },

        function loadTracking20EventTypeMetadata(callback) {
            return loadTracking20EventTypeMetadata(callback);
        }
    ], callback);
};

module.exports.loadTracking20EventTypeMetadata = loadTracking20EventTypeMetadata;