'use strict';

const crypto = require('crypto');
const TIMESTAMP_BYTE_COUNT = 3;
const MAX_BYTE = 0xFF;

// CIID corresponds to current impression instance Id
// In current system, ciid is generated at taas and used as
// page impression instance Id.
// In case of experience services, ciid generated by page aggregator experience 
// service is sent back to node.js service and overridden on the ciid provided by taas.
// In cases like node.js calling different experience services (dropping tracking events)
// for providing page content simultaneously, there is no common page impression instance Id
// to tie all the page content providers. 
// This utility class ports code from 
// https://github.corp.ebay.com/Tracking/raptor-tracking-component/blob/master/
// raptor-tracking-impl/src/main/java/com/ebay/tracking/helper/ServerResponseID.java
// to generate ciid used to indicate page impression instance Id.
// Only change is instead of relying on host IP address for last 2 bytes, we will use random
// bytes 

function nextId() {
    try {
        const creationTime = Date.now();

        const rawImpressionIdBytes = new Uint8Array(5).fill(0);
        let bitsToShift = 0;
        
        // first 3 bytes for timestamp 
        for (let idx=0; idx < TIMESTAMP_BYTE_COUNT; idx++) {
            bitsToShift = (2 - idx) * 8;
            const mask = MAX_BYTE << bitsToShift;
            rawImpressionIdBytes[idx] = (creationTime & mask) >> bitsToShift;
        }

        // 4-5 bytes    
        const randomBytes = crypto.randomBytes(2);
        rawImpressionIdBytes.set(randomBytes, TIMESTAMP_BYTE_COUNT);

        return Buffer.from(rawImpressionIdBytes).toString('base64');
    } catch (ex) {
        console.error("Failed to get ServerResponseID:", ex.message);
    }
}

module.exports = {
    nextId : nextId
};