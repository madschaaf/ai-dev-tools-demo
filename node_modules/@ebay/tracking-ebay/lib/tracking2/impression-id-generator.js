'use strict';

/**
 * Test impression ID Work
*/

const utils = require('./common-utils');
const Base64 = require('./base64coder').KernelBase64;

/**
 * Take 3 low order bytes of time and 2 low order bytes of ipv4 address
 * concatenate them and base64 encode to produce SIID.
 */
module.exports.newImpressionID = function newImpressionID() {
    const hostAddr = utils.getIPAddress();

    if(!hostAddr || hostAddr.length < 4) {
        return;
    }

    const buf = new Int8Array(5);
    const time = Date.now().toString(16).substr(-6);
    const ip = utils.ipToHex(hostAddr).substr(-4);
    const siid = time + ip;

    for (let i=0,j=0; i < siid.length; i+=2, j++) {
        buf[j] = parseInt(siid[i] + siid[i+1], 16);
    }

    return Base64.encode(buf, false);
};