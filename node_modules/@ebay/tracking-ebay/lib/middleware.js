'use strict';

var trackingEntityCache = require('./entities/cache.js');
var logger = require('@ebay/logging-inc').logger('tracking-ebay:middleware');
var TrackingFactory = require('./tracking-context');
const Async = require('async');
const webView = require('./webview');

module.exports = function tracking(options) {

    return function trackingMiddleware(req, res, next) {
        req.ebay = req.ebay || {};
        var tracking = req.ebay.tracking =
            TrackingFactory.getFactory(req.ebay.isService ? 'service' : 'web').create(req, res, options);
        if (!tracking.isTrackingEnabled()) {
            return next();
        }
        Async.series([
            done => {
                logger.begin('middleware', 'Tracking', function (tx) {
                    trackingEntityCache
                        .get(tracking.flagsEnabled ? tracking.pageId : undefined, function (err) {
                            if (err) {
                                tx.fail(err);
                                // in case of error, we skip webview
                                next();
                                return;
                            }
                            tracking.track();
                            tx.end();
        
                            done();
                        });
                });
            },

            // continue to tracking webview if any
            done => webView(req, res, done)
        ], next);
    };
};