"use strict";

const eBayTags = require('../../entities/tags.js');
const eBayFlags = require('../../entities/flags.js');
const SojournerEventEnum = require('../../soj/sojourner-event-enums.js');

function track(req, res) {
	const ebay = req.ebay;
	const _tracking = req.ebay.tracking;
	const sojournerContext = _tracking.sojournerContext;
	const trackingContext = ebay.getCorrelationTracking();

	sojournerContext.addContext(eBayTags.G, ebay.getGuid());
	sojournerContext.addContext(eBayTags.T, ebay.getSiteId());
	sojournerContext.addContext(eBayTags.P, trackingContext.getPageId() || ebay.getPageId());
	trackingContext.getCorrelationGuid() && sojournerContext.addData(SojournerEventEnum.APPLICATION, eBayTags.CORRELATION_GUID, trackingContext.getCorrelationGuid());

	const endUserContext = ebay.getEndUserContext();
	const accountId = endUserContext && endUserContext.getOriginalUserIdContext() && endUserContext.getOriginalUserIdContext().accountId;

	if (accountId > 0) {
		sojournerContext.addContext(eBayTags.BU, accountId);
	}

	const isBot = req.headers['X-EBAY-BOT-HDR'];
	if (isBot) {
		sojournerContext.setAppFlag(eBayFlags.GlobalFlags.DETECTED_BOT, true);
		sojournerContext.setContextFlag(eBayFlags.GlobalFlags.DETECTED_BOT, true);
	}

	if (ebay.getGuid() && ebay.getGuid().length > 7) {
		var hashStr = ebay.getGuid().substring(6, 8);
		var d0 = parseInt(hashStr.charAt(0), 16);
		var d1 = parseInt(hashStr.charAt(1), 16);
		if (d0 >= 0 && d1 >= 0) { // don't use junk guid data
			sojournerContext.addContext(eBayTags.H, hashStr);
		}
	}

	const correlationSession = ebay.tracking.getCorrelationSession();

	if (correlationSession && correlationSession.getUAID()) {
		sojournerContext.addContext(eBayTags.UAID, correlationSession.getUAID().toString());
	}
 }

 module.exports = {
	track: track
 };