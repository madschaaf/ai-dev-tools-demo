'use strict';

const Hoek = require('hoek');
const onHeaders = require('on-headers');
const deployEnv = require('@ebay/environment-ebay');

const Tags = require('../../entities/tags.js');
const trackingBookKeeping = require('./bookkeeping');
const trackingTaasHelper = require('../../taas/helper.js');
const SojournerWriter = require('../../soj/sojourner-writer.js');
const SojournerEventEnum = require('../../soj/sojourner-event-enums.js');
const logger = require('@ebay/logging-inc').logger('tracking-ebay:tracking-context:service-context');

const Context = require('../context');

class WebContext extends Context {
    constructor(req, res) {
        super(req, res);
    }

    updateSojournerBookKeeping() {
        trackingBookKeeping.updateSojournerBookKeeping(this.req);
    }

    instrumentResponse() {
        const res = this.res;
        const _end = res.end;
        const req = this.req;
        const cookies = req.ebay.cookies;
        const sojournerContext = this.sojournerContext;

        res.end = Hoek.once(function trackingEnd() {
            const pageInfoEnabledHeaders = req && req.headers && (req.headers['X-EBAY-PAGE-INFO'.toLowerCase()] ||
                req.headers['X-EBAY-PAGE-INFO']);
            const pageInfoEnabledRequestParams = req && req.query && (req.query._showsoj ||
                req.query._showSoj);
            const pageInfoEnabled = pageInfoEnabledHeaders || pageInfoEnabledRequestParams;

            if ((deployEnv.isDev() ||
                deployEnv.isTest() ||
                deployEnv.isNotProd() && (pageInfoEnabled === 'true' || pageInfoEnabled === true)) &&
                    /text\/html/.test(res.getHeader('content-type')) &&
                    res.statusCode === 200) {
                SojournerWriter.writeToPageSource(sojournerContext, res);
            }

            logger.info('SOJ Logging to CAL is Disabled, instead posting to Pathfinder. To log tracking Payload in CAL, enable debug flag in VI for Pathfinder service');
            
            if (res.statusCode === 300 || res.statusCode === 301 || res.statusCode === 302) {
                // we need to add rdt=1 when there is redirect
                // it will helps the analytics team to produce correct
                // query since xp service drops page id during redirects
                
                sojournerContext.addContext(Tags.RDT, '1');
            }
            //Write to Pathfinder and to CAL (SOJ are last in CAL, to avoid any issues)
            SojournerWriter.writeToPathfinder(req, res, sojournerContext, function(){
                logger.info('Pathfinder data posted');
            });

            _end.apply(res, arguments);
        });

        //process request
        trackingBookKeeping.updateTrackingCookiesBookKeeping(this.req);

        trackingBookKeeping.updateSojournerBookKeeping(this.req);

        trackingTaasHelper.track(this.req, this.res);

        //before headers flushed to client, make sure cookies are updated accordingly from taas resonse.
        onHeaders(res, function () {

            if (res.statusCode === 300 || res.statusCode === 301 || res.statusCode === 302) {
                //update cookie for redirect

                //??? not sure, what this means
                cookies.setCookieValue(cookies.Cookies.PAGE_SOURCE_INFO,
                    cookies.getCookieValue(cookies.Cookies.PAGE_SOURCE_INFO));
                cookies.setCookieValue(cookies.Cookies.SOJOURNER_TRACKING,
                    cookies.getCookieValue(cookies.Cookies.SOJOURNER_TRACKING));
            }

            //log response code to soj
            sojournerContext.addData(SojournerEventEnum.APPLICATION,
                Tags.HTTPResponseCode, res.statusCode);
        });
    }
}

module.exports = WebContext;
