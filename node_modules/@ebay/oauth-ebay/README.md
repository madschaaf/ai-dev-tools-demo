# oauth-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/oauth-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/oauth-ebay/job/master/) [![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/oauth-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/oauth-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/oauth-ebay)](http://sonar/dashboard/index?id=oauth-ebay)


This module can get Application Token and User Token via oauth rest service.

Token can be used to call commerce-os Services(http://commerceos/).

Application Token does not need user to be logged in.

User Token can be gotten only after user logged in since the service will use the cookie after user logged in.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/oauth-ebay/blob/master/CHANGELOG.md#changelog)

# 1 Prerequisite

You will need to register and udpate the app using the Fulcrum tool.

## Register Application on QA Environment

For QA consumers, use https://www.fulcrum.stratus.ebay.com/cos/home to update your consumer as an OAuth client.

### Step 1:

In the Client ID input box, input the Consumer-ID of your application.

To get consumerid, you can check the package.json file in your project folder.

Or you can go to ar to search with your appname in

https://release-asset.corp.ebay.com/release/asset/index.do

then you can get the consumer-id.

For example, for nodedemo1 application, it's Consumer-ID is `urn:ebay-marketplace-consumerid:f399e83a-48a2-47b8-be46-c59f91fbf1a5`.

Then click `Lookup` Button, by default , choose `Type` as `Hosted`, choose 'Scope policy' as `1stParty`.

For `Redirect Url`, use some fake url, recommend to use `https://openidconnect.ebay.com/accept.html`.

Then click `Update` Button.

The scope and secrets will be updated.

### Step 2:

In the Client ID input box, input the Consumer-ID of your application again.

Then click `Lookup` Button, you should be able to see `Allowed scopes`.

Furthermore, you can check the details via services by appending the consumerid to url

http://oauthclnt.vip.qa.ebay.com/oauthclnt/core/v1/detail/<consumer-id>

For example, details of nodedemo1 project is:

http://oauthclnt.vip.qa.ebay.com/oauthclnt/core/v1/detail/urn:ebay-marketplace-consumerid:f399e83a-48a2-47b8-be46-c59f91fbf1a5



## Register Application on Production Environment

For Production consumers, use https://www.northstar.stratus.ebay.com/cos/clientreg to update your consumer as an OAuth client.

Update Steps is similar as above QA steps.

Please remember to set up a Redirect URL (could be a dummy URL, such as https://openidconnect.ebay.com/accept.html ) if your test consumer is a Hosted Web application.

# 2 Installation

There are also some peer dependencies that need to be installed and shared with other module.
```javascript
npm install servicecore --save
```
Then install the dependency to this oauth-ebay module.
```javascript
npm install oauth-ebay --save
```


# 3 Usage

### Step 1. Dependency to Other Modules

Middleware of `cookie-ebay` module is needed for the User Token.
```javascript
app.use(require('@ebay/cookies-ebay/middleware').cookies());
```

Note that the above installation is typically handled for you in a Unified Node.js
application by the config/middleware.json file.


### Step 2. Use oauth Middleware to get Application Token or User Token
```javascript
var ebayOauth = require('@ebay/oauth-ebay');
app.use(ebayOauth());
app.use(async (req, res, next) => {
    try {
        const appToken = await req.ebay.oauth.getApplicationToken();
        console.log(appToken);
    }
    catch (err) {
        // handle error
    }
});
```

### Step 3. Using the Token value for calling some services
##### The recommended way of calling other services is via [service-client-ebay](https://github.corp.ebay.com/nodejs/service-client-ebay)
Sample configuration:
```json

"my-service": {
    "protocol": "http:",
    "hostname": <host>,
    "port": <port>,
    "socketTimeout": 5000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "app-name": "nodedemo1",
        "scope": "https://api.ebay.com/oauth/scope/@public",
        "token": ["user"]
    }
}
```
[More samples](https://github.corp.ebay.com/nodejs/instrument-ebay#service-configuration)

##### The old way:
The `token` value should be used with a in a Authorization header sent with the request for a service.

The format of the Authorization header is
```
Authorization: Bearer <token value>

```
For example
```
Authorization: Bearer v^1.1#i^1#r^0#I^3#f^0#p^1#t^H4sIAAAAAAAAAO1XXWgcRRzP5S7R0KZa+4n4cGwL2tbdnd3b+1pyp5dLaw/ycXpntYESZ2dnkzF7u8vOnMmByhlsQfyAgi/1QUKbvhRKQRT64IP6FkEUBBX6qIJiFURp++CDs5vL5RLapJiKefBejrn5/Wf+v9//95+bAc3evsNnjp+52R+5r3u+CZrdkYiyDfT19hzZEe1+uKcLdAAi882Dzdhc9KcBCmu2pz+Dqec6FMdLQzlBRYaJlKSRSSVBEqpQiJecZUDVzQkJNW3AhIbVtGakTIT4PKV1XHIogw7j8UDRRKCKqloFQFdUHaiSms6OC/ET2KfEdThEAkJ8tmY7VA8TyAl139FdSAnVHVjDVGdIrxRGhnWO1D3fZS5ybSEfpquH2/kd8euHQ0qxz/i+Qr5UOFYZK5SGjo5WB+SOtfItHSoMsjpdPSq6Jo6fgHYdr78NDdF6pY4QplSQ80s7rF5ULywnE0qNELQgzEIVaIpmaObmpbxrKVZJecz1a5CtHxv8QkzRCqE6dhhhjY0U5WoYL2LEWqNRvkRpKB58PV2HNrEI9nPC0cHCyUK5LMQr5bLvvkRMbAbaBLlgAzbEGvSnMfNsiLCIuAnrNewTU+fu01JmJiNaimqJWhqmREOzMqJhZbNZg1tTgVDI34tVWsSWsm+VdQ2zouuYJBCWxkddNoi5Snht+UBH+ThozBnzCxYLFGjjtJUyayA1HphoyTV1NuUEPsI1Lnw8HG5skmULctMFvd4q/W2NqIBsJoMhSGbShoEs+B8ZMd/ygrxeybSgZBBZYkLNIFEzk0jMZpNYVHEKp1R+MgFL+9+L/54XGfOJUWe47ce1E6GoOaFoEz5ZbXhYWIsIj9OWWWZpTphizNNleWZmRppJSK4/KasAKPLzI8MVNIVrUGhjycZgkYSuRZhHUaIznkBOmOWu5Js7k0L+uEsZNpdbY1VK+bW/3oFaBbkeLrs2QY2txU2hrBz0OvRZY1MMUVi8CWJuLX73sIX+mS4Esq2liJLIJgBvZFXdHC9+ZdlSvJBbk4JKS9DzJB96zPUlXmjmu7aNfWmMmKjYHm6KOg2aeWuRD+IpXwB6ZEkErobsQv63L4fZyk96dYOfPgMx4y6Zy3c8u5evCO3rgbz6TZDvCj/KXEQHc5EUf1aAJDiiHAKP9kafjUW3xylhWCLQkiiZdPhV18fSNG54kPi6rmTSye7eyBOz0yc73yLzp8D+9mukL6ps63iagEdWZnqUB/b1KxpQ1UA/Fajj4MDKbEzZG9tNdr7wV/X1W+c+OPvYtdSfH9nF3269C/rboEikpyv2WnNkOLFncvuXzqL74O4fr+5LXr3yVenjV39fWLj0zfvTr7y3M5Y791TP99c/sR9frEZP7/31jS/87g8T2eqBqcXe5/YvAHhtqP/mzw+BG599W7yEBsmViV1vDr596Lu3wP2lry+fmri86/rZzycvLEzHD49/evAPtuOH86cvXhh4efzG+V/eGU66Sxr+DQjW2yikDQAA
```

You can also validate the token using the following tool:
http://www.iafconsole.stg.stratus.qa.ebay.com/iafapp/iaf

##### Legacy tag for commerce-os-client-ebay module

```html
<!-- allow module pick token based on user status -->
<auth-token clientId="nodedemo" scope="https://api.ebay.com/oauth/scope/@public" />
<!-- force to generate specific token -->
<auth-token clientId="nodedemo" scope="https://api.ebay.com/oauth/scope/@public" type="App" />
<auth-token clientId="nodedemo" scope="https://api.ebay.com/oauth/scope/@public" type="User" />
<auth-token clientId="nodedemo" scope="https://api.ebay.com/oauth/scope/@public" type="RecognizedUser" />
```

# 4 API References
## [require('@ebay/oauth-ebay')](lib/index.js)
* `require('@ebay/oauth-ebay').oauth()`  - A middleware need to be called before using the following functions to get tokens.
* `[DEPRECATED] req.ebay.oauth.getAppToken(appname, scopes, type, callback)` - return the token in the callback for give application name and scope.
    * `callback` (`function`) - The callback function is in the format of `function(err, token){}`
    * The returned token object in the callback function has the following properties.
        + `value` (`string`) - the token value.
        + `expiration` (`number`) - expriation time in milliseconds.
        + `type` (`string`) - The value is 'app' for application token.
    * `appName` (`string`, optional) - the application name for the token. The default value will be read from the "ebay.appName" property in the application's package.json file.
    * `scope`  (`string`, optional) - the scope for getting the token, scope could be viewed from the service details.
    * `type` spefies the type of client ('ajax' or 'Hosted').
* `req.ebay.oauth.getApplicationToken({ scopes, type, jwt, refresh })` - return the token in the callback for given scope, app type (Hosted|JavaScript) and jwt (to get jwt token format, possible values are 'provider=IAM;type=JWT', 'provider=IAM;type=JWT;managed=true', 'disabled').
    * `callback` (`function`) - The callback function is in the format of `function(err, token){}`
    * The returned token object in the callback function has the following properties.
        + `value` (`string`) - the token value.
        + `expiration` (`number`) - expriation time in milliseconds.
        + `type` (`string`) - The value is 'app' for application token.
    * `appName` (`string`, optional) - the application name for the token. The default value will be read from the "ebay.appName" property in the application's package.json file.
    * `scope`  (`string`, optional) - the scope for getting the token, scope could be viewed from the service details.
    * `type` spefies the type of client ('ajax' or 'Hosted').

* `req.ebay.oauth.getPublicAppToken(appname, scopes, callback)` - return the public token in the callback for give application name and scope.
    * `callback` (`function`) - The callback function is in the format of `function(err, token){}`
    * The returned token object in the callback function has the following properties.
        + `value` (`string`) - the token value.
        + `expiration` (`number`) - expriation time in milliseconds.
        + `type` (`string`) - The value is 'app' for application token.
    * `appName` (`string`, optional) - the application name for the token. The default value will be read from the "ebay.appName" property in the application's package.json file.
    * `scope`  (`string`, optional) - the scope for getting the token, scope could be viewed from the service details.
* `req.ebay.oauth.getUserToken(appname, scopes, callback)` - return the user token for give application name and scope.
    * `callback` (`function`) - The callback function is in the format of `function(err, token){}`
    * The returned token object in the callback function has the following properties.
        + `value` (`string`) - the token value.
        + `expiration` (`number`) - expriation time in milliseconds.
        + `type` (`string`) - The value is 'user' for user token.
    * `appName` (`string`, optional) - the application name for the token. The default value will be read from the "ebay.appName" property in the application's package.json file.
    * `scope`  (`string`, optional) - the scope for getting the token, scope could be viewed from the service details.
* `req.ebay.oauth.getPublicUserToken(appname, scopes, callback)` - return the public user token for give application name and scope.
    * `callback` (`function`) - The callback function is in the format of `function(err, token){}`
    * The returned token object in the callback function has the following properties.
        + `value` (`string`) - the token value.
        + `expiration` (`number`) - expriation time in milliseconds.
        + `type` (`string`) - The value is 'user' for user token.
    * `appName` (`string`, optional) - the application name for the token. The default value will be read from the "ebay.appName" property in the application's package.json file.
    * `scope`  (`string`, optional) - the scope for getting the token, scope could be viewed from the service details.


# 5 Advanced Usage

Usage demo in a demo project :
```javascript
https://github.corp.ebay.com/nodejs/EbayTestApp/blob/master/src/pages/oauth/oauth.js
```
