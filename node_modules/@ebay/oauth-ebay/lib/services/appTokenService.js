'use strict';

const assert = require('assert');
const provider = require('@ebay/service-client-ebay');

const oauthUtil = require('../oauthUtil');
const Cons = require('../middleware/COSConstants');
const logger = require('@ebay/logging-inc').logger('ebay-oauth:appTokenService');
const ono = require('@jsdevtools/ono');
const ebayAppMeta = require('@ebay/appmeta-ebay');
const appContext = require('@ebay/app-context-ebay');
const modConfig = require('@ebay/module-config-inc');
const loadConfig = require('util').promisify(modConfig);

module.exports.getAppToken = async function getAppToken(appName, scopes, options, callback) {
	var args = Array.prototype.slice.call(arguments);
	callback = args.pop();
	appName = args.shift();
	scopes = args.shift();
	options = args.shift() || {};
	assert.ok(appName, 'appName should not be empty!');

	const tokenInfo = await module.exports.getApplicationToken({
		...options,
		scopes,
		appName
	}).catch(err => err);

	if (tokenInfo instanceof Error) {
		return callback(tokenInfo);
	}

	callback(null, tokenInfo);
};

module.exports.getApplicationToken = function getApplicationToken(options) {
	const scopes = options?.scopes && (Array.isArray(options.scopes) ? options.scopes : [options.scopes]) || [Cons.PUBLIC_SCOPE];
	const appName = options?.appName || appContext.appName;

	return new Promise((resolve, reject) => {
		// given that app token always belongs to host app, we skip appName and always rely on app-context-ebay
		ebayAppMeta.get(appName, false, async function (err, meta) {
			if (err) {
				return reject(ono(err, `Failed to get app meta for ${appName}`));
			}

			const consumerId = meta.getConsumerId() || appContext.consumerId;
			const appSecret = meta.getAppSecret();
			if (!appSecret) {
				return reject(new Error(`App secret is missing for ${appName}, consumerId: ${consumerId}`));
			}

			const oauthGlobalConfig = await loadConfig(__dirname);
			const jwt = options?.jwt || oauthGlobalConfig.get('oauth-ebay:jwt');

			const headers = {
				authorization: `Basic ${Buffer.from(`${consumerId}:${appSecret}`).toString('base64')}`,
				...(jwt !== 'disabled' && {
					'x-ebay-c-idp': jwt
				} || {})
			};

			provider.context({}).getClient('oauthAppTokenSvcV2').request({
				body: `grant_type=client_credentials&scope=${oauthUtil.getScopeQuery(scopes)}`
			}).options({
				headers
			}).end((err, response) => {
				if (err) {
					if (err.body?.error_description === 'client is not authorized to use this authorization grant type') {
						logger.error('Client is not authorized to use this authorization grant type, Please register your app with Fulcrum.');
					}
					return reject(ono(err, 'Failed to get app token'));
				}
				resolve(response && response.body);
			});
		});
	});
};
