/* jslint strict:false */
/*global window:false, ebay:false*/
/* jshint strict: false */
(function ($win) {
    "use strict";

    var _tokenPrefix = "Bearer";
    var _clientTokens = {};

    $win.ebay = $win.ebay || {};

    var _tokenTypes = {"app": "app", "user" : "user", "recognized": "recognized"};
    function getClient(clientid) {
        var client = null;

        if(!client){
            client = _clientTokens[clientid];
        }
        return client;
    }

    function initClient(clientid) {
        if (clientid) {
            if(!_clientTokens[clientid]){
                _clientTokens[clientid] = {};
            }
            return _clientTokens[clientid];
        } else {
            return null;
        }
    }



    function addToken(clientid, type, token) {
        var client = initClient(clientid);
        token.createdDtTime = new Date().getTime();

        var expirationInMs = token.expiration;
        if(expirationInMs !== undefined && expirationInMs > 0){
            token.isExpired = function(){
                var now = new Date().getTime();
                return (now) >= (expirationInMs);
            };
        }else{
            token.isExpired = function(){
                return false;
            };

        }
        client[type] = token;
    }

    function isValid(token) {
        if( (token !== undefined && token !==null) && (token.value !== undefined && token.value !== null) ){

            if(token.isExpired()){
                return false;
            }else{
                return true;
            }
        }else{
            return false;
        }
    }

    function getTokenValue(token){
        if(isValid(token)){
            if(token.value.indexOf(_tokenPrefix)<0){
                return (_tokenPrefix + " " + token.value);
            }else{
                return (token.value);
            }
        }else{
            return null;
        }
    }

    function getTokenFromStore(clientid, type) {
        var client = getClient(clientid, type);
        if (client) {
            var token = client[type];
            return getTokenValue(token);
        } else {
            return null;
        }
    }

    function getClientToken(clientid){
        var client = getClient(clientid);
        var userToken = null;
        var appToken = null;
        var recognizedToken = null;
        if (client) {
            userToken = getTokenFromStore(clientid, _tokenTypes.user);
            if(userToken !== undefined && userToken !== null){
                return userToken;
            }else{
                recognizedToken = getTokenFromStore(clientid, _tokenTypes.recognized);
                if(recognizedToken !== undefined && recognizedToken !==null){

                }
                else {
                    return getTokenFromStore(clientid, _tokenTypes.app);
                }
            }
        }else{
            return null;
        }
    }

    ebay.auth = {
        setEnvironment: function(environment){

        },
        getEnvironment: function(){

        },
        getRecognizedUserToken : function(clientid) {
            return getTokenFromStore(clientid, _tokenTypes.recognized);
        },
        getUserToken : function(clientid) {
            return getTokenFromStore(clientid, _tokenTypes.user);
        },
        getAppToken : function(clientid) {
            return getTokenFromStore(clientid, _tokenTypes.app);
        },
        getToken: function(clientid){
            return getClientToken(clientid);
        },
        setToken : function(clientid, token) {
            addToken(clientid, token.type, token);
        },
        authorize : function() {
        },
        init: function(clientAuthTokens){
            for(var clientid in clientAuthTokens){
                if(clientAuthTokens.hasOwnProperty(clientid)){
                    this.setToken(clientid, clientAuthTokens[clientid]);
                }
            }
        }
    };

}).call(this,window);

(function($win, authTokens){
    "use strict";
    var authModule = $win && $win.ebay ? $win.ebay.auth : null;

    if(authModule !== null){
        ebay.auth.init(authTokens);
    }
}).call(this, window, window.ebayAuthTokens);
