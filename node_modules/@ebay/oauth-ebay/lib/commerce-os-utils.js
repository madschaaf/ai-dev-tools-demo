'use strict';

const ServiceDetails = require('./services/serviceDetail');

module.exports.validateClientType = function validateClientType(type, appName, callback) {
    if (!appName) {
        return callback(new Error('validateClientType: appName is missing'));
    }

    ServiceDetails.getAppServiceDetail(appName, function (err, details) {
        if (err) {
            return callback(err);
        }

        if (!details) {
            err = new Error(`Service details are empty for application name:${appName}`);
            err.code = 'SYS_ERROR';
            return callback(err);
        }

        var dtype = details.type === 'JavaScript' ? 'ajax': details.type;
        // AXIS-19367(raptor-cos-usercontext-component PR#110): handle Gateway UserToken case
        dtype = details.type === 'Gateway' ? 'Hosted': dtype;
        if (type && dtype && dtype === type) {
            return callback(null, details);
        }

        err = new Error(`Application (app-name:${appName}) details type:${dtype} does not match use-case type:${type}, for more info check your application in go/fulcrum`);
        err.code = 'VALIDATION_ERROR';
        return callback(err);
    });
};

module.exports.validateClientScope = function validateClientScope(scopes, appName, callback) {
    if (!scopes) {
        return callback(new Error(`validateClientScope: scopes parameter is empty while validating scopes for application name:${appName}`));
    }
    if (!appName) {
        return callback(new Error(`validateClientScope: appName parameter is missing`));
    }

    if (!Array.isArray(scopes)) {
        scopes = [scopes];
    }
    if (scopes.length === 0) {
        return callback(new Error(`validateClientScope: scopes parameter is empty while validating scopes for application name:${appName}`));
    }

    ServiceDetails.getAppServiceDetail(appName, function (err, details) {
        if (err) {
            err.code = 'SYS_ERROR';
            return callback(err);
        }

        if (!details ||
            !details.allowedScopes ||
            !details.allowedScopes.length) {

            err = new Error(`Scopes are missing in application details for app-name:${appName}, check your application type scopes in go/fulcrum`);
            err.code = 'VALIDATION_ERROR';
            return callback(err);
        }

        for (var i = 0; i < scopes.length; i+=1) {
            if (details.allowedScopes.indexOf(scopes[i]) === -1) {
                err = new Error(`Scope:${scopes[i]} is not permitted for app-name:${appName}, allowed scopes are\n\t${details.allowedScopes.join('\n\t')}\nCompare the service config scopes in config.json with your application scopes in go/fulcrum`);
                err.code = 'VALIDATION_ERROR';
                return callback(err);
            }
        }

        callback(null, details);

    });
};
