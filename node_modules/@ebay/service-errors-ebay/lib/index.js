'use strict';

const logger = require('@ebay/logging-inc').logger('service-errors-ebay');
const Formatter = require('./formatter');

module.exports = function errorMiddlewareFactory(options) {
    return function errorMiddleware(err, req, res, next) {
        logger.error(err);
        const contentType = res.get('content-type');
        const data = Formatter.format(err, options);

        if (!res.headersSent) {
            const statusCode = err.status || err.statusCode;
            if (statusCode) {
                res.status(statusCode);
            }
            else {
                res.status(500);
            }
            res.set('content-type', contentType || 'application/json');
            res.json(data);
            return;
        }

        res.write(JSON.stringify(data));
        res.end();
    };
};

Object.assign(module.exports, Formatter);
