'use strict';

/**
 * Use NODE_ENV to detect simulated or real environment where the app runs for ou convenience.
 * The modulel environment-ebay use DEPLOY_ENV which is only set in real environment with the same value as NODE_ENV
 */
const env = Object.assign({}, require('@ebay/environment-ebay'), {
    _env: () => {
        return process.env.NODE_ENV;
    }
});

if (env.isDev()) {
    const detectSwallowedErrors = process.env.DETECT_EVENT_EMITTER_ERRORS;
    // Sometimes the platform modules are swallowing errors
    if (detectSwallowedErrors) {
        const EventEmitter = require('events').EventEmitter;
        const emit = EventEmitter.prototype.emit;
        EventEmitter.prototype.emit = function(type, err) {
            if (type === 'error') {
                const error = `${err.stack || err}`;
                // eslint-disable-next-line no-console
                console.error('EVENT EMITTED ERROR', error);
            }
            // eslint-disable-next-line
            return emit.apply(this, arguments);
        };
    }
}

const _exit = process.exit;
process.exit = function (...args) {
    if (env.isQA() || env.isProd()) {
        // eslint-disable-next-line no-console
        console.trace('[Gatekeeper] Detected process exit initiated from this stack trace');
    }
    return _exit.call(process, ...args);
};    
