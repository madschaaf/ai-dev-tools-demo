# gatekeeper-ebay
[![Build Status](https://go/-/nodejsci/job/nodejs/job/gatekeeper-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/gatekeeper-ebay/job/master)  [![Dependency Status](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/gatekeeper-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/gatekeeper-ebay)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/gatekeeper-ebay)](http://sonar/dashboard/index?id=gatekeeper-ebay)


Module that gatekeeps requests, response, errors and gracefully shuts down the server after safely closing response.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/gatekeeper-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

`npm install gatekeeper-ebay --save`

[gatekeeper-ebay](https://github.corp.ebay.com/nodejs/brogan-ebay/blob/master/config/config.json#L34) is configured in brogan-ebay by default.

# Usage

## Middleware

gatekeeper with default error handler that redirects to error page.
```javascript
var gatekeeper = require('@ebay/gatekeeper-ebay');
var app = express();

app.use(gatekeeper());
```

gatekeeper with custom error handler
```javascript
app.use(gatekeeper({
    errorHandler: function errorHandler(err, request, response, callback) {
        response.status(503).end('Server error');
        callback();
    }
}));
```

In context of web app it is part of brogan-ebay where you can configure it in middleware section:
```json
{
    "middleware": {
        "gatekeeper": {
            "errorHandler": "path:./errors/my-error-handler.js",
            "delay-restart": {
                "memory-threshold": 700000000,
                "error-threshold": 20
            }
        }
    }
}
```
memory-threshold and error-threshold are optional.
If specified these options may delay restart till one of the conditions are not met.
* memory-thershold cannot be bigger than 700M.

## Traps

There are a few traps that can be used to get more idea what is going on with your application. 

### Event errors

To capture hidden error emitted by event emitters but hidden by some reason, a developer can use the following environment variable to expose it.

```
export DETECT_EVENT_EMITTER_ERRORS=true
```

### Process exit

In some cases some module may invke process exit without authorization which can cause unexpected worker restarts without any idea what caused it.
This module allows to capture this kind of error by printing the stacktrace of who initiated the call into error output.
