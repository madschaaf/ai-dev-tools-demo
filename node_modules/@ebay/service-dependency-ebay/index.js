'use strict';
const Fs = require('fs');
const Path = require('path');
const yaml = require('js-yaml');
const main = require('./lib/main');

module.exports = function (modulePath = '.', outputFilename, format) {
    return new Promise(resolve => {
        const registry = main.discover(modulePath);
        if (Object.keys(registry).length === 0) {
            resolve();
            return;
        }

        main.loadServiceDetails(registry, services => {
            const obj = { dependencies: services };

            if (outputFilename) {
                // eslint-disable-next-line no-param-reassign
                outputFilename = Path.join(modulePath, outputFilename);
                if (!format) {
                    writeToJSON(obj);
                    writeToYAML(obj);
                } else if (format === 'yaml') {
                    writeToYAML(obj);
                } else {
                    writeToJSON(obj);
                }
            }
            resolve(services);
        });
    });

    function writeToJSON(services) {
        Fs.writeFileSync(`${outputFilename}.json`, JSON.stringify(services, null, '\t'));
        console.info('Service dependencies JSON file created at ', outputFilename);
    }

    function writeToYAML(services) {
        const yamlFormat = yaml.safeDump(services);
        Fs.writeFileSync(`${outputFilename}.yaml`, yamlFormat);
        console.info('Service dependencies YAML file created at ', outputFilename);
    }
};
