import { expectType, expectError } from 'tsd';
import modConfig from '@ebay/module-config-inc';

const testFunction = (module: NodeModule, httpunch: any) => {
    modConfig(module, (err, config) => {
        expectType<any>(config.get('services:sessionkeysvc'));
    });

    modConfig(__dirname, (err, config) => {
        expectType<any>(config.get('services:sessionkeysvc'));
        config.on('change', () => {});
        config.once('change', () => {});
    });

    expectError(modConfig.registerConfig('unique-name', {}));

    function registerConfig(configObject: modConfig.ConfigObject) {
        modConfig.registerConfig('unique-name', configObject);
    }

    function makeUrlCall(cb: any) {
        modConfig(module, (err: any, cfg: modConfig.ConfigObject) => {
            if (err) {
                return cb(err);
            }
            const url = cfg.get('targetURL');
            httpunch.get(url, cb);
        });
    }

    let _config: modConfig.ConfigObject;
    let _someValue: any;

    function readConfig(cb: any) {
        if (_config) {
            return cb(null, _config);
        }
        modConfig(module, (err: any, cfg: modConfig.ConfigObject) => {
            if (err) {
                console.error(err);
                return cb(err);
            }
            _config = cfg;
            _someValue = _config.get('someValue');
            _config.on('change', () => {
                if (cfg.get('someValue') !== _someValue) {
                    console.log('value has been changed, do something with it');
                }
            });
        });
    }
};

expectType<any>(modConfig.cache.Cache());
expectType<void>(modConfig.cache.clear());
expectType<any>(modConfig.cache.get('someValue'));