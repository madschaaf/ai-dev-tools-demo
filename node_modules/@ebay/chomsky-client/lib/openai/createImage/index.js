'use strict';
const chomskyRequest = require('../../chomskyRequest');
const MODELS = require('../../models');

/**  
 * @typedef {import("openai").CreateImageRequest} CreateImageRequest  
 */

/**
 * @summary Creates an image from the input text.
 * @param {CreateImageRequest} createImageRequest
 * @param {*} [options] Override http request option.
 * @throws {RequiredError}
 * @returns {Promise<CreateImageResponse>}
 */
async function createImage(createImageRequest, options) {
    const {
        prompt: caption,
        n,
        size,
        response_format,
        user
    } = createImageRequest;

    return chomskyRequest.openaiRequest(
        '_openai_dalle',
        {
            model: MODELS.OPENAI.IMAGE.AZURE_TEXT_TO_IMAGE_DALLE,
            caption,
            n,
            size,
            response_format,
            user
        },
        options
    ).then(async res => {
        let response = res;
        let totalTime = 0;
        let ms = 1000;
        // Wait for the image to be generated
        while (response.status != 'Succeeded') {
            // If the image takes more than 20 seconds to generate, throw an error
            if (totalTime > 20000) {
                throw new Error('Timeout');
            }
            // Wait for 1 second before checking again
            await timeout(ms);
            // Get the image
            response = await getImage(res.id);
            // Add the time waited to the total time waited
            totalTime += ms;
        }
        return response;
    });
}

/**
 * Gets the generated image from the given id
 * 
 * @param {string} id id of the image to retrieve
 * @returns 
 */
async function getImage(id) {
    return chomskyRequest.openaiRequest(
        '_openai_dalle', { id, model: MODELS.OPENAI.IMAGE.AZURE_TEXT_TO_IMAGE_DALLE_IMAGE_DETAILS }, {}
    )
}

async function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

module.exports = createImage;
