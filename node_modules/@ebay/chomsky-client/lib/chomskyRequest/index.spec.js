'use strict';
const { assert } = require('chai');
const { openaiRequest } = require('.');
const nock = require('nock');
const AppContext = require('@ebay/app-context-ebay');
AppContext.appName = 'usvbff';

describe(__filename, () => {
    
    afterEach(() => {
        nock.cleanAll();
    });

    it('error handling, status 500', async () => {
        const expectedError = {
            error: {
                code: '500',
                message: 'Internal Server Error'
            }
        };

        const session = nock('https://chomskygw.vip.qa.ebay.com')
            .post('/api/v1/genai')
            .reply(500, expectedError);

        const err = await openaiRequest('_openai_chat_completion',
            `/chat/completions?api-version=2023-03-15-preview`,
            {}).catch(error => error);

        session.done();
        assert.deepEqual(err.message, 'Internal Server Error');
    });

    it('error handling, status 200 with array of errors', async () => {
        const expectedError = {
            errors: [{
                code: '500',
                message: 'Internal Server Error',
                type: 'internal'
            }]
        };

        const session = nock('https://chomskygw.vip.qa.ebay.com')
            .post('/api/v1/genai')
            .reply(200, expectedError);

        const err = await openaiRequest('_openai_chat_completion',
            {}).catch(error => error);

        session.done();
        assert.deepEqual(err.type, expectedError.errors[0].type);
        assert.deepEqual(err.code, expectedError.errors[0].code);
        assert.deepEqual(err.message, expectedError.errors[0].message);
    });

    it('error handling, status 200 with error object', async () => {
        const expectedError = {
            error: {
                code: '500',
                message: 'Internal Server Error',
                type: 'internal'
            }
        };

        const session = nock('https://chomskygw.vip.qa.ebay.com')
            .post('/api/v1/genai')
            .reply(200, expectedError);

        const err = await openaiRequest('_openai_chat_completion',
            {}).catch(error => error);

        session.done();
        assert.deepEqual(err.type, expectedError.error.type);
        assert.deepEqual(err.code, expectedError.error.code);
        assert.deepEqual(err.message, expectedError.error.message);
    });

    it('error handling, status 200 with error string', async () => {
        const expectedError = {
            error: 'BOOM'
        };

        const session = nock('https://chomskygw.vip.qa.ebay.com')
            .post('/api/v1/genai')
            .reply(200, expectedError);

        const err = await openaiRequest('_openai_chat_completion',
            {}).catch(error => error);

        session.done();
        assert.deepEqual(err.message, 'BOOM');
    });

    it('should be allowed to send bespoke headers', async () => {
        const session = nock('https://chomskygw.vip.qa.ebay.com', {
            reqheaders: {
                'x-custom-header': () => true,
            }
        })
            .post('/api/v1/genai')
            .reply(200, {});
        const err = await openaiRequest('_openai_chat_completion',
            {}, {
            headers: {
                'x-custom-header': 'test'
            }
        });

        session.done();
    });
});