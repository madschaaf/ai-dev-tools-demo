# cookies-ebay 

[![Build Status](https://go/-/nodejsci/job/nodejs/job/cookies-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/cookies-ebay/job/master/) [![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/cookies-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/cookies-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/cookies-ebay)](http://sonar/dashboard/index?id=cookies-ebay)


The `@ebay/cookies-ebay` modules provides an API for reading and writing eBay cookies with the following features:
- Serializing and deserializing the following (proprietary) eBay cookie formats:
 - delim-persist
 - delim-session
 - delimited
 - packed
 - unpacked
- Automatically setting cookie max age/expiry time based on eBay metadata
- Automatic refresh of cookie expiry times for cookies set to auto-refresh
- Support for mutli-value cookies (aka, "packed cookies")
 - NOTE: A cookie within a cookie is known as a "cookielet"
- Support for reading and writing cookies with CRC32 checksum
- Support for reading IPE-protected cookies (currently verification step is skipped)
- Automatic flushing of modified/deleted/created cookies for every request
- Reading and setting cookie bits
- Future: Verify IPE signature and generate IPE signature

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/cookies-ebay/blob/master/CHANGELOG.md#changelog)

# Installation
```
npm install @ebay/cookies-ebay --save
```

# Usage

## Middleware
In order to use the `@ebay/cookies-ebay` module, the following middleware must be enabled:

This is  typically handled for you in a Unified Node.js
application by the config/middleware.json file.

If you need to employ this middleware directly in express then do

```javascript
app.use(require('@ebay/cookies-ebay/middleware')());
```

After the above middleware runs, a new `cookies` object will be available via CLS
for reading and writing eBay cookies. In addition, the cookies-ebay middleware will also automatically
commit any modified cookies by writing the response cookie headers.

_NOTE_: Cookies should be set before the response is committed (i.e. before the HTTP response headers are committed).

## Reading a Cookie/Cookielet

Once `@ebay/cookies-ebay` is configured in middleware section of config.json, accessing commons' API is as easy as this.

```javascript
module.exports = function (req, res, next) {
    var cookies = req.ebay.cookies;
    var userId = cookies.getCookieValue('USERID_SIGNIN');
}
```

## Writing a Cookie/Cookielet

```javascript
module.exports = function (req, res, next) {
    var cookies = req.ebay.cookies;
    cookies.setCookieValue('USER_LOCALE', 'US');
}
```

## Removing a Cookie/Cookielet

```javascript
module.exports = function (req, res, next) {
    var cookies = req.ebay.cookies;
    cookies.removeCookie('USER_LOCALE');
}
```

## Check if a flag bit is set on the Cookie

```javascript
module.exports = function (req, res, next) {
    var cookies = req.ebay.cookies;
    cookies.hasFlag('SFE_SORT_BIT3');
}
```

## Set/Unset a flag bit in the Cookie

```javascript
module.exports = function (req, res, next) {
    var cookies = req.ebay.cookies;
    //set a flag
    cookies.setFlag('SFE_SORT_BIT3', true);
    //unset a flag
    cookies.setFlag('PDP_COLLAPSED_BIT2', false);
}
```

## Creating and registering new cookie / cookie bit flag

[Process to create and register a new cookie/bit flag](https://wiki.vip.corp.ebay.com/display/IS/Marketplaces+Cookie+SOP)

Once the cookie is approved, you need

### Additional Information
To get a list of all of the latest supported eBay cookies by nodejs framework, you can go to [@ebay/cookies-resources-ebay](https://github.corp.ebay.com/nodejs/cookies-resources-ebay/tree/main/resources)

## skipUpdate flag
```json
"cookies-ebay": {
        "skipUpdate": true
    },
```
The skipUpdate flag in the cookies-ebay configuration is used to control whether the cookie configuration should be persisted or not.
In the persistToConfigBean function, if skipUpdate is true, the function returns immediately 
and does not persist the cookie configuration to the config bean. This means that the current 
cookie configuration will not be updated with the new configuration from the authzCookies service.
