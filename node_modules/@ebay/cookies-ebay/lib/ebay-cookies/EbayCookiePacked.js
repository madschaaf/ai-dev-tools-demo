'use strict';

var util = require('util');
var EbayCookie = require('./EbayCookie');
var EbayCookielet = require('./EbayCookielet');
var debug = require('debug')('cookies:packed');

function EbayCookiePacked(meta, rawCookie) {
    EbayCookie.apply(this, arguments);
    this._cookieletsMap = {};
    this._hasAutoRefreshCookielet = false;
    this._invalidCookielets = false;
}

util.inherits(EbayCookiePacked, EbayCookie);

var proto = EbayCookiePacked.prototype;

proto.setValidator = function (validator) {
    this._validator = validator;
};
proto.validate = function (cb) {
    var validated = this.isValidated();
    if (!validated) {
        this._validator(this, cb);
    } else {
        cb(null, this._valid);
    }
};
proto.afterDeserialize = function () {
    this._rawCookie.setModified(this._hasAutoRefreshCookielet || this._invalidCookielets);
};
proto.getAllCookielets = function () {
    this.deserialize();
    if (this._enforceValidation() && this.isValid()) {
        var cookieletsMap = this._cookieletsMap;
        return Object.keys(cookieletsMap).reduce(function reduce(memo, key) {
            var cookielet = cookieletsMap[key];
            if (!cookielet.isDeleted()) {
                memo.push(cookielet);
            }
            return memo;
        }, []);
    } else {
        return [];
    }
};
proto.forEachCookielet = function (callback, thisObj) {
    this.deserialize();
    if (this._enforceValidation() && this.isValid()) {
        for (var id in this._cookieletsMap) {
            var cookielet = this._cookieletsMap[id];
            if (cookielet.isDeleted()) {
                // skip deleted cookielets
                continue;
            }
            callback.call(thisObj, cookielet);
        }
    }
};
proto.getCookieletValue = function (cookieletMeta) {
    this.deserialize();
    if (this._enforceValidation() && this.isValid()) {
        if (cookieletMeta.parent !== this.meta) {
            console.error('INVALID PARENT: ', cookieletMeta.parent, '\n----\n', this.meta);
            throw new Error('Cookielet (' + cookieletMeta.idName + ') does not belong to cookie (' + this.meta.idName + ').');
        }
        var cookielet = this._cookieletsMap[cookieletMeta.id];
        return cookielet ? cookielet.getValue() : null;
    } else {
        return null;
    }
};
proto.getCookieletCreationDate = function (cookieletMeta) {
    this.deserialize();

    if (this._enforceValidation() && this.isValid()) {
        if (cookieletMeta.parent !== this.meta) {
            console.error('INVALID PARENT: ', cookieletMeta.parent, '\n----\n', this.meta);
            throw new Error('Cookielet (' + cookieletMeta.idName + ') does not belong to cookie (' + this.meta.idName + ').');
        }
        var cookielet = this._cookieletsMap[cookieletMeta.id];
        return cookielet ? cookielet.getCreationDate() : null;
    }
    return null;
};

proto.getCookieletCount = function (includeDeleted) {
    this.deserialize();
    var count = 0;
    if (this._enforceValidation() && this.isValid()) {
        var map = this._cookieletsMap;
        for (var k in map) {
            if (map.hasOwnProperty(k) && (includeDeleted || !map[k].isDeleted())) {
                count++;
            }
        }
    }
    return count;
};
proto.addCookielet = function (cookielet) {
    if (!cookielet) {
        throw new Error('invalid args');
    }
    this.deserialize();

    if (this._enforceValidation()) {
        // Make sure the cookie supports cookielets
        if (!(cookielet instanceof EbayCookielet)) {
            throw new Error('Invalid argument: ' + cookielet);
        }

        var cookieletMeta = cookielet.meta;
        if (cookieletMeta.parent !== this.meta) {
            throw new Error('Cookielet (' + cookieletMeta.idName + ') does not belong to cookie (' + this.meta.idName + ').');
        }
        if (cookielet.meta.maxAge !== -1) {
            // Ensure that the cookielet has an expiry time set
            // and also refresh an old expiry time if auto refresh
            // is set to true for this cookielet
            cookielet.refresh();
        }
        if (cookielet.isValid()) {
            var id = cookieletMeta.id;
            this._cookieletsMap[id] = cookielet;
            // Mark the underlying cookie as modified so that it will
            // be committed
            this._rawCookie.setModified(true);
            // given we are adding new cookie, mark it valid as it is no longer empty/invalid
            this.setValid(true); 
            if (cookieletMeta.autoRefresh) {
                this._hasAutoRefreshCookielet = true;
            }
        } else {
            this._invalidCookielets = true;
        }
    }
};
proto.hasCookielets = function () {
    this.deserialize();
    if (this._enforceValidation() && this.isValid()) {
        for (var id in this._cookieletsMap) {
            if (this._cookieletsMap.hasOwnProperty(id)) {
                return true;
            }
        }
    }
    return false;
};
proto.removeAllCookielets = function () {
    this.deserialize();
    if (!this.hasCookielets()) {
        return false;
    }
    // Make sure the cookie supports cookielets
    this._cookieletsMap = {};
    // Mark the underlying cookie as modified so that it will
    // be committed
    this._rawCookie.setModified(true);
};
proto.removeCookielet = function (cookieletMeta) {
    this.deserialize();
    // Make sure the cookie supports cookielets
    if (this._cookieletsMap[cookieletMeta.id]) {
        // Remove all of the cookielets by maring as deleted
        // we need this to allow others read original value in case one needs it
        // we will clear it at cookies commit time
        this._cookieletsMap[cookieletMeta.id].setDeleted(true);
        // Mark the underlying cookie as modified so that it will
        // be committed
        this._rawCookie.setModified(true);
    }
};
proto.isValidated = function () {
    return this._validated !== false;
};
proto.setValidated = function (validated) {
    debug('Setting validated for cookie: %s to %s', this.meta.name, validated);
    this._validated = validated;
};

module.exports = EbayCookiePacked;
