'use strict';

const fs = require('fs');
const entitiesJSON = fs.readFileSync(require.resolve('@ebay/cookies-resources-ebay/resources/EbayCookiesAndCookielets.json')).toString();
const cookieFlagsJSON = fs.readFileSync(require.resolve('@ebay/cookies-resources-ebay/resources/EbayCookieBitFlagsVersion2.json')).toString();
const metadataJSON = fs.readFileSync(require.resolve('@ebay/cookies-resources-ebay/resources/EbayCookiesAndCookielets_metadata.json')).toString();

module.exports.load = function load(registry) {
    /**
     * When there are multuple cookies ebay modules present global metadata, entities, cookiesFlags.
     * Use JSON Parse to create clone, thus multiple versions of cookies ebay can be present still not step on each other's global metadata.
     */
    var maxAges = {};
    var metadata = JSON.parse(metadataJSON);
    var entities = JSON.parse(entitiesJSON).EbayEntities;
    var cookieFlags = JSON.parse(cookieFlagsJSON).CookieFlags;

    // add the default max age constants
    registry.addConstant({
        name: 'DEFAULT_MAX_AGE',
        value: metadata.EbayMaxAge.ONE_HOUR_IN_SEC.value
    });
    registry.addConstant({
        name: 'DEFAULT_SESSION_MAX_AGE',
        value: metadata.EbayMaxAge.L1_COOKIE_EXPIRY_TIME.value
    });

    Object.keys(metadata.EbayMaxAge).forEach(function (key) {
        var ebayMaxAge = metadata.EbayMaxAge[key];
        maxAges[ebayMaxAge.name] = ebayMaxAge.value;
        registry.addConstant(ebayMaxAge);
    });

    Object.keys(metadata.EbayCookies).forEach(function (key) {
        var eBayCookie = metadata.EbayCookies[key];
        var idName = eBayCookie.id;
        eBayCookie.id = entities[idName];
        eBayCookie.idName = idName;
        entities[idName] = eBayCookie;
        eBayCookie.cookielet = false;
        eBayCookie.unpacked = eBayCookie.format === 'unpacked';
        if (eBayCookie.maxAge) {
            eBayCookie.maxAge = maxAges[eBayCookie.maxAge];
        } else {
            eBayCookie.maxAge = -1;
        }
        // Process partitioned property if present
        if (eBayCookie.partitioned !== undefined) {
            eBayCookie.partitioned = eBayCookie.partitioned === true;
        }
    });

    Object.keys(metadata.EbayCookielets).forEach(function (key) {
        var ebayCookielet = metadata.EbayCookielets[key];
        var idName = ebayCookielet.id;
        ebayCookielet.id = entities[idName];
        ebayCookielet.idName = idName;
        entities[idName] = ebayCookielet;
        ebayCookielet.cookielet = true;
        if (ebayCookielet.maxAge) {
            ebayCookielet.maxAge = maxAges[ebayCookielet.maxAge];
        } else {
            ebayCookielet.maxAge = -1;
        }
    });

    Object.keys(metadata.EbayCookieletValue).forEach(function (key) {
        var ebayCookieletValue = metadata.EbayCookieletValue[key];
        registry.addConstant(ebayCookieletValue);
    });

    // 2nd pass
    Object.keys(metadata.EbayCookies).forEach(function (key) {
        var eBayCookie = metadata.EbayCookies[key];
        if (eBayCookie.cidHashCookielet) {
            eBayCookie.cidHashCookielet = entities[eBayCookie.cidHashCookielet];
        }
        registry.addCookieMeta(eBayCookie);
    });

    Object.keys(metadata.EbayCookielets).forEach(function (key) {
        var ebayCookielet = metadata.EbayCookielets[key];
        if (ebayCookielet.parent && typeof ebayCookielet.parent === 'string') {
            ebayCookielet.parent = entities[ebayCookielet.parent];
            if (ebayCookielet.autoRefresh) {
                // If any of the cookielets in a parent cookie
                // are auto refreshed then the parent cookie
                // should also be marked as auto-refreshed
                // so that we know to rewrite it
                ebayCookielet.parent.autoRefresh = true;
            }
        }
        if (ebayCookielet.replacedBy) {
            ebayCookielet.replacedBy = entities[ebayCookielet.replacedBy];
        }
        registry.addCookieMeta(ebayCookielet);
    });

    Object.keys(cookieFlags).forEach(function (key) {
        var cookieFlag = cookieFlags[key];
        registry.addFlag(cookieFlag);
    });

};
