'use strict';

var consts = require('../utils/constants');
var cookieUtils = require('../utils/utils');
var metadata = require('../ebay-cookies/metadata');
var EbayCookielet = require('../ebay-cookies/EbayCookielet');

module.exports = {
    serialize: function (ebayCookie) {
        var buf = [],
            result;
        ebayCookie.forEachCookielet(function (cookielet) {
            if (cookielet.isValid()) {
                buf.push(consts.COOKIELET_DELIMITER);
                buf.push(cookielet.getDelimitedName());
                buf.push(consts.EQUALS);
                buf.push(cookielet.getValue());
            }
        });
        if (buf.length === 0) {
            // Nothing to commit
            return null;
        }
        buf.push(consts.COOKIELET_DELIMITER);
        result = cookieUtils.encode(buf.join(''));
        return result;
    },
    deserialize: function (ebayCookie, cookie) {
        var decodedValue = cookieUtils.decode(cookie.getValue() + '');
        var start = decodedValue.indexOf(consts.COOKIELET_DELIMITER) + 1;
        if (start > 0) {
            var equals = decodedValue.indexOf(consts.EQUALS, start) + 1;
            if (equals > start) {
                var next = decodedValue.indexOf(consts.COOKIELET_DELIMITER, equals) + 1;
                while (true) {
                    var cookieletMeta = metadata.getCookieMetaByName(decodedValue.substring(start, equals - 1), true);
                    if (cookieletMeta) {
                        var cookieletValue = next > equals ? decodedValue.substring(equals, next - 1) : decodedValue.substring(equals);
                        var cookielet = new EbayCookielet(cookieletMeta, cookieletValue);
                        ebayCookie.addCookielet(cookielet);
                    }
                    start = next;
                    if (start <= 0) {
                        break;
                    }
                    equals = decodedValue.indexOf(consts.EQUALS, start) + 1;
                    if (equals <= 0) {
                        break;
                    }
                    next = decodedValue.indexOf(consts.COOKIELET_DELIMITER, equals) + 1;
                }
            }
        }
    }
};