'use strict';

var consts = require('../utils/constants');
var cookieUtils = require('../utils/utils');
var metadata = require('../ebay-cookies/metadata');
var EbayCookielet = require('../ebay-cookies/EbayCookielet');

var encode = cookieUtils.encode,
    decode = cookieUtils.decode;


module.exports = {
    serialize: function (ebayCookie) {
        var buf = [consts.FORMAT_DELIM_PERSIST];
        // format name for delim-persist
        ebayCookie.forEachCookielet(function (cookielet) {
            if (cookielet.isValid()) {
                buf.push(encode(cookielet.getDelimitedName()));
                buf.push(consts.NAME_VALUE_DELIMITER);
                // ok, delimited persistent cookielets aren't really "signed",
                // but if that flag is set, then we use a custom base-64 encoding
                if (cookielet.needsSecurity()) {
                    //ebay use '*' instead of '=' for padding
                    buf.push(new Buffer(cookielet.getValue() + '').toString('base64').replace(/\=/g, '*'));
                } else {
                    buf.push(encode(cookielet.getValue() + ''));
                }
                // Append expiration in hex format, no delimiter
                buf.push(cookielet.getExpiryTime().toString(16));
                buf.push(consts.COOKIELET_DELIMITER);
            }
        });
        if (buf.length === 1) {
            return null;    // Don't bother writing this cookie since it is empty...
        }
        return buf.join('');
    },
    deserialize: function (ebayCookie, cookie) {
        var cookieString = cookie.getValue() + '';
        var format = cookieString.charAt(0);
        // Verify valid format
        if (consts.FORMAT_DELIM_PERSIST === format) {
            var start = 1;
            var equals = cookieString.indexOf(consts.NAME_VALUE_DELIMITER, start) + 1;
            if (equals > 0) {
                var next = cookieString.indexOf(consts.COOKIELET_DELIMITER, equals) + 1;
                while (true) {
                    var cookieName = decode(cookieString.substring(start, equals - 1));
                    var cookieletMeta = metadata.getCookieMetaByName(cookieName, true);
                    if (cookieletMeta) {
                        var rawValue = null;
                        var expirationInHex = null;
                        if (next > equals) {
                            expirationInHex = cookieString.substring(next - 9, next - 1);
                            rawValue = cookieString.substring(equals, next - 9);
                        } else {
                            expirationInHex = cookieString.substring(cookieString.length - 8);
                            rawValue = cookieString.substring(equals, cookieString.length - 8);
                        }
                        var expirationInSeconds = parseInt(expirationInHex, 16);
                        var decodedValue = null;
                        if (cookieletMeta.signed) {
                            decodedValue = new Buffer(rawValue.replace(/\*/g, '='), 'base64').toString('utf8');
                        } else {
                            decodedValue = decode(rawValue);
                        }
                        var cookielet = new EbayCookielet(cookieletMeta, decodedValue);
                        cookielet.setExpiryTime(expirationInSeconds);
                        ebayCookie.addCookielet(cookielet);
                    }
                    start = next;
                    if (start <= 0) {
                        break;
                    }
                    equals = cookieString.indexOf(consts.NAME_VALUE_DELIMITER, start) + 1;
                    if (equals <= 0) {
                        break;
                    }
                    next = cookieString.indexOf(consts.COOKIELET_DELIMITER, equals) + 1;
                }
            }
        }
    }
};