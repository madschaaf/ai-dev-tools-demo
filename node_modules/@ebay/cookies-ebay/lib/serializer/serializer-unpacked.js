/*global unescape:false*/

'use strict';

var cookieUtils = require('../utils/utils');

function calculateChecksumChar(str) {
    var buf = unescape(encodeURIComponent(str));
    var sum = 0;
    for (var i = 0; i < buf.length; i++) {
        sum += buf.charCodeAt(i);
    }
    sum = 10 - sum % 10 + 100;
    return String.fromCharCode(sum);
}

module.exports = {
    serialize: function (ebayCookie) {
        var unpackedValue = ebayCookie.getUnpackedValue();
        var cookieMeta = ebayCookie.meta;
        if (unpackedValue && cookieMeta.checksumRequired) {
            var checksumChar = calculateChecksumChar(unpackedValue);
            return cookieUtils.encode(unpackedValue) + checksumChar;
        }
        return cookieUtils.encode(unpackedValue);
    },
    deserialize: function (ebayCookie, cookie) {
        var value = cookie.getValue() + '';
        var cookieMeta = ebayCookie.meta;
        if (cookieMeta.checksumRequired) {
            var checksumChar = value.charAt(value.length - 1);
            value = value.slice(0, -1);
            var expChecksumChar = calculateChecksumChar(value);
            if (checksumChar !== expChecksumChar) {
                ebayCookie.setValid(false);
                return;
            }
        }
        ebayCookie.setUnpackedValue(value);
    }
};