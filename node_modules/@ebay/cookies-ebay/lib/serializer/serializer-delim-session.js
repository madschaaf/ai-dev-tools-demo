'use strict';

var consts = require('../utils/constants');
var cookieUtils = require('../utils/utils');
var metadata = require('../ebay-cookies/metadata');
var EbayCookielet = require('../ebay-cookies/EbayCookielet');

var encode = cookieUtils.encode,
    decode = cookieUtils.decode,
    FAR_FUTURE = (Date.now() + 631138519494) / 1000,
    COOKIE_LAST_SEARCH_STRING = metadata.Cookies.LAST_SEARCH_STRING;

module.exports = {
    serialize: function (ebayCookie) {
        var buf = [consts.FORMAT_DELIM_SESSION];
        // format name for delim-persist
        ebayCookie.forEachCookielet(function (cookielet) {
            if (cookielet.isValid()) {
                buf.push(encode(cookielet.getDelimitedName()));
                buf.push(consts.NAME_VALUE_DELIMITER);
                // ok, delimited persistent cookielets aren't really "signed",
                // but if that flag is set, then we use a custom base-64 encoding
                if (cookielet.needsSecurity()) {
                    //ebay use '*' instead of '=' for padding
                    buf.push(new Buffer(cookielet.getValue() + '').toString('base64').replace(/\=/g, '*'));
                } else {
                    buf.push(encode(cookielet.getValue() + ''));
                }
                if (cookielet.meta === COOKIE_LAST_SEARCH_STRING) {
                    //this is legacy bug, can't be fixed 100% at cookie phase3, need to be removed for good.
                    buf.push(FAR_FUTURE.toString(16));
                }
                buf.push(consts.COOKIELET_DELIMITER);
            }
        });
        if (buf.length === 1) {
            return null;
        }
        return buf.join('');
    },
    deserialize: function (ebayCookie, cookie) {
        var cookieString = cookie.getValue() + '';
        var format = cookieString.charAt(0);
        var start = 1;
        // first char of first name always at pos 1, after format char
        if (consts.FORMAT_DELIM_SESSION !== format) {
            start = 0;
        }
        var equals = cookieString.indexOf(consts.NAME_VALUE_DELIMITER, start) + 1;
        if (equals > 0) {
            var next = cookieString.indexOf(consts.COOKIELET_DELIMITER, equals) + 1;
            while (true) {
                var cookieName = decode(cookieString.substring(start, equals - 1));
                var cookieletMeta = metadata.getCookieMetaByName(cookieName, true);
                if (cookieletMeta) {
                    var trailingCharsToSkip = 0;
                    if (cookieletMeta === COOKIE_LAST_SEARCH_STRING) {
                        trailingCharsToSkip = 8;
                    }
                    var rawValue = null;
                    if (next > equals) {
                        rawValue = cookieString.substring(equals, next - 1 - trailingCharsToSkip);
                    } else {
                        rawValue = cookieString.substring(equals, cookieString.length - trailingCharsToSkip);
                    }
                    var decodedValue = null;
                    if (cookieletMeta.signed) {
                        decodedValue = new Buffer(rawValue.replace(/\*/g, '='), 'base64').toString('utf8');
                    } else {
                        decodedValue = decode(rawValue);
                    }
                    var cookielet = new EbayCookielet(cookieletMeta, decodedValue);
                    ebayCookie.addCookielet(cookielet);
                }
                start = next;
                if (start <= 0) {
                    break;
                }
                equals = cookieString.indexOf(consts.NAME_VALUE_DELIMITER, start) + 1;
                if (equals <= 0) {
                    break;
                }
                next = cookieString.indexOf(consts.COOKIELET_DELIMITER, equals) + 1;
            }
        }
    }
};