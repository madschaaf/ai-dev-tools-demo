# device-detection-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/device-detection-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/device-detection-ebay/job/master/) [![Dependency Status](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/device-detection-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/device-detection-ebay)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/device-detection-ebay)](http://sonar/dashboard/index?id=device-detection-ebay)


A server side utility (written as express middleware) to detect information of the client device based on the userAgent header of incoming request.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/device-detection-ebay/blob/master/CHANGELOG.md#changelog)

### Usage

```javascript
	npm install device-detection-ebay
```

#### As Middleware

To use Device detection as a Middleware add the following line:

```javascript
	app.use(require('@ebay/device-detection-ebay').middleware());
```

Note that the above installation and use is typically handled for you in a Unified Node.js
application by the config/middleware.json file.


This middleware will set the `Device Info` to the request Object.

```javascript
	console.log(req.deviceInfo);
```

#### As a module

To use the device detection module, pass the user-agent string as input.
```javascript
	require('@ebay/device-detection-ebay').getDeviceInfo("your user agent", function (error, response){
		console.log(response);
	});
```

#### Enable/Disable per route

```
	{
        "path": "* /:id",
        "handler": "require:./src/pages/mypage",
        "pageName": "pagename",
        "dds": {
            "enabled": true
        }
    },
```
### API Response


Please make sure to check the Fallback scenario also. https://github.corp.ebay.com/nodejs/device-detection-ebay#fallback

https://github.scm.corp.ebay.com/Raptor/DeviceDetectionService#inputoutput

<a id="Response"></a>


| Property Name     | Type      | Description
|-------------      |-----------|-------------
| browser           | String    | Browser Name, `Safari Webkit, Firefox Gecko etc `
| browserVersion    | String    | "4.0.4" - Safari Web Kit 4.X
| cpu               | String    | Cpu information about the device
| deviceOS          | String    | Operating System for the device , iOS, Android etc.
| displayHeight     | Integer   | ViewPort max, height avaialble for the Device
| displayWidth      | Integer   | ViewPort max, width avaialble for the Device
| displayWidth      | Integer   | ViewPort max, width avaialble for the Device
| isCookie          | Boolean   | Is Cookie Supported on the Browser / Device
| isDesktop         | Boolean   | Is the incomming request is Desktop
| isHTTPS           | Boolean   | Is HTTPS supported
| isJS              | Boolean   | Is Javascript Supported
| isLocalStorage    | Boolean   | Is Local Storage Supported
| isSessionStorage  | Boolean   | Is Session Storage Supported
| isSessionStorage  | Boolean   | Is Session Storage Supported
| isSvg             | Boolean   | SVG Supported on the Device
| isMobile          | Boolean   | Is the request from mobile (only the mobile devices, iPads would return false)
| isTablet          | Boolean   | Is the request from tablet
| isTouchScreen     | Boolean   | Is the requested device have touch feature, (Mobile, Tablets should return true)
| isFSOM            | Boolean   | Is user requested switch to Full Site On Mobile (URL Param should be redirect=mobile)
| isWebSockets      | Boolean   | Is the requested device have support for WebSockets
| memory            | String    | Maximum memory available for the device
| osName            | String    | Operating System for the Device
| osVersion         | String    | Operating System version for the Device
| screenHeight      | Integer   | Max screen height for the device
| screenWidth       | Integer   | Max screen height for the device
| isSmall	        | Boolean   | Identifies if the requested device is a small screen (Ex: iPhone, Android Etc)
| isLarge           | Boolean   | Identifies if the requested device is a large screen (Ex: Tablet, Desktop Etc)
| isNative           | Boolean   | Identifies if the request is from eBay's Native app


==

### DeviceProperties
<a id="deviceproperties"></a>
#### Following Properties Applicable for Devices(mobile / tablets) Only Object

|Properties
|-------------
| cpu
| deviceOS
| displayHeight
| displayWidth
| displayWidth
| memory
| osName
| osVersion
| screenHeight
| screenWidth
| isTouchScreen


#### Sample Response

```javascript
	{
		screenHeight: 0,
		isCookie: false,
		osVersion: '',
		browserVersion: '',
		isTouchScreen: false,
		isGeoLocation: false,
		cpu: '',
		isJS: false,
		isWebSockets: false,
		displayWidth: 0,
		isLocalStorage: false,
		memory: '',
		displayHeight: 0,
		deviceOSVersion: '',
		screenWidth: 0,
		isHTTPS: false,
		isTablet: false,
		browser: '',
		isDesktop: true,
		isSessionStorage: false,
		isSvg: false,
		isMobile: false,
		osName: '',
		deviceOS: 'OTHER' ,
		isFSOM: false
	}

```

### Examples :

1. [Identify Large Screen](./test/classification-test.js#L93)

2. [Identify Small Screen](./test/classification-test.js#L94)

3. [Identify WebView](./test/classification-test.js#L95)


### Fallback

if the Device detection service API endpoint fails, this module uses the (express-useragent) [https://github.com/biggora/express-useragent] parser module to find out basic properties.

To distinguish the Response from fallback - the property "fallback" will be set to true.

Following are the properties set by the fallback

`isTouchScreen` , `isTV`, `isTablet`, `isMobile`, `isRobot`, `osName`, `browserVersion`, `isDesktop`, `browser` and `fallback`

Always check for the property `fallback` before accessing other properties from the API Response.

### Device Detection Service


https://github.scm.corp.ebay.com/Raptor/DeviceDetectionService

https://wiki.vip.corp.ebay.com/pages/viewpage.action?pageId=207620963

For the DDS V3 migration, it will take priorities from below config beans / global config:

1. forceDdsVersion: v2/v3, app/machine config bean
2. v3ApiApps: [app1, app2], global config nodedds allowlist
3. ddsVersion: v2/v3, global config feature switch