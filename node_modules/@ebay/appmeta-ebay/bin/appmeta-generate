#!/usr/bin/env node

var argv = require('optimist').argv;
var assert = require('assert');
var appmeta = require('../lib/index');

// var nconf = require('nconf');
var path = require('path');
var fs = require('fs');
var assert = require('assert');
var shush = require('shush');
// var logger = require('log4js').getLogger('appmeta-ebay:appmeta-generate');
// var logger = require('@ebay/logging-inc').getLogger('appmeta-ebay:appmeta-generate');
var debug = require('debug')('appmeta-ebay:appmeta-generate');

var appName = argv.appName;
var outputFile = argv.outputFile;
var quiet = argv.quiet;

// console.log('argv:', argv);

// Trap all uncaught exception here.
process.on("uncaughtException", function (error) {
    console.trace();
    console.log('system error: ' + (error.stack || error));
});

function resolvePath(filePath) {
    if (filePath.substr(0, 1) === '~')
        filePath = process.env.HOME + filePath.substr(1)
    return path.resolve(filePath)
}

function validate() {
    // console.log("appName cannot be empty! Usage: appmeta-generate --appName=nodedemo1 --outputFile=config.json");
    // console.log("Usage: appmeta-generate --appName=nodedemo1 --outputFile=config.json");
    if (!quiet) {
        if (!appName) {
            console.log("appName cannot be empty! Usage example : appmeta-generate --appName=nodedemo1 --outputFile=config.json");
            return false;
        }
        if (!outputFile) {
            console.log("outputFile cannot be empty ! Usage example : appmeta-generate --appName=nodedemo1 --outputFile=config.json");
            return false;
        }
    }
    if (outputFile) {
        outputFile = resolvePath(outputFile);
    }
    return true;
}

function generateJsonFile(appName, outputFile) {
    if (!appName) {
        // logger.warn("appName cannot be empty! Usage: appmeta-generate --appName=nodedemo1 --outputFile=config.json");
        console.log("appName cannot be empty! Usage: appmeta-generate --appName=nodedemo1 --outputFile=config.json");
        return;
    }
    // assert.ok(appName, "appName cannot be empty! Usage: appmeta-generate --appName=nodedemo1 --outputFile=config.json");
    debug('appName:', appName);
    if (!outputFile) {
        console.trace('empty output file');
    }
    assert.ok(outputFile, "outputFile cannot be empty!");
    debug('outputFile:', outputFile);
    // var filePath = path.resolve(process.cwd(), outputFile);
    var filePath = resolvePath(outputFile);
    debug('filePath:', filePath);
    appmeta.saveMetadataToFile(appName, filePath, function (err, meta) {
        if (!err) {
            // logger.info('saved metadata to file ' + filePath);
            console.log('saved metadata to file ' + filePath);
        } else {
            // logger.error('error when saving metadata: ' + err);
            console.log('error when saving metadata: ' + err);
        }
    });
}


function getShortAppName(){
    var appName = null;
    var pkgRoot = process.cwd();
    var pos = pkgRoot.indexOf('node_modules');
    if(pos !== -1){
        pkgRoot = pkgRoot.substring(0,pos);
    }
    var pkgFile = path.resolve(pkgRoot, 'package.json');
    if( pkgFile && fs.existsSync(pkgFile) ) {
        try {
            var pkgJson = JSON.parse(fs.readFileSync(pkgFile, 'utf-8'));
            var ebayProps = pkgJson && pkgJson.ebay;
            appName = ebayProps && ( ebayProps['short-app-name'] || ebayProps.name || ebayProps.shortAppName);
        } catch ( err ) {
            console.log('parse package.json for appname error:', err);
        }
    }
    return appName;
}


//main begin

// console.log(__dirname);
// var metadataFilename = path.resolve(__dirname,'../config/metadata.json');
// console.log(metadataFilename);
//validate input parameters

// console.log('hello world!');
var postEnabled = false;

if(!postEnabled){
    return;
}

if(quiet){
    appName = appName || getShortAppName();
    outputFile = outputFile || path.resolve(__dirname, '../config/metadata.json');
}


// console.log(process.cwd());
// console.log('appName:', appName);
// console.log('outputFile:', outputFile);


if (!validate()) {
    console.log('validation warning!');
    return;
}


// console.log('appName:', appName);
// console.log('outputFile:', outputFile);
console.log('Save application metadata of ', appName, ' to file: ', outputFile);
generateJsonFile(appName, outputFile);
