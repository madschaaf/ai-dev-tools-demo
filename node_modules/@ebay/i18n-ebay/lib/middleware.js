'use strict';

var path = require('path');

var logger = require('@ebay/logging-inc').logger('i18n-ebay:middleware');
var managerProvider = require('./manager-provider');
var defaultRoot = process.cwd();

module.exports = function (options) {
    options = options || {};

    return function i18nMiddleware(req, res, next) {
        var contentManager = managerProvider.fromRequest(req);
        contentManager.defaultRoot = defaultRoot;

        var routeConfig = req.route && req.route.config && req.route.config.i18n;

        var preload = options.preload && options.preload.slice() || [];
        if (routeConfig) {
            preload = Array.from(new Set([...preload, ...(routeConfig.preload || [])]));
        }

        if (preload && preload.length) {
            logger.begin('middleware', 'i18n', function (tx) {
                let pending = preload.length;

                for (const bundleName of preload) {
                    if (typeof bundleName === 'string') {
                        loadBundle(defaultRoot, bundleName);
                    } else if (typeof bundleName.module === 'string' && Array.isArray(bundleName.preload)) {
                        const nestedRoot = defaultRoot + path.sep + 'node_modules' + path.sep + bundleName.module;
                        pending += bundleName.preload.length - 1;
                        for (const nestedBundleName of bundleName.preload) {
                            loadBundle(nestedRoot, nestedBundleName);
                        }
                    }
                }
    
                function loadBundle(root, bundleName) {
                    contentManager.getBundle(bundleName, root, function (err, bundle) {
                        contentManager.preloaded[bundleName] = bundle;

                        if (pending === -1) {
                            return;
                        }
        
                        if (err) {
                            pending = -1;
                            tx.fail('Unable to get bundle', err);
                            return next(err);
                        }
        
                        if (--pending === 0) {
                            tx.end();
                            next();
                        }
                    });
                }
            });
        } else {
            next();
        }
    };
};

module.exports.setDefaultRoot = function (newRoot) {
    defaultRoot = newRoot;
};
