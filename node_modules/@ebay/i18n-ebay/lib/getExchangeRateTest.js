'use strict';

var Assert = require('assert');
var Async = require('async');
var nock = require('nock');
var Cache = require('lru-backup-cache');
var KernelServ = require('../lib/index');

describe(__filename, function () {

    it('should get exchange rate for USD > EUR', function(done) {
        KernelServ.getExchangeRate('USD', 'EUR')
            .then(rate => {
                Assert.ok(rate > 0);
                done();
            })
            .catch(done);
    });

    it('should get exchange rate for USD > EUR with when param', function(done) {
        KernelServ.getExchangeRate('USD', 'EUR', new Date(Date.now() - (1000 * 60 * 60 * 24 * 100)))
            .then(rate => {
                Assert.ok(rate > 0);
                done();
            })
            .catch(done);
    });

    it('should fail with invalid from', done => {
        KernelServ.getExchangeRate('WRONG', 'EUR')
            .then(rate => {
                // Assert.ok(rate > 0);
                done(new Error('Should have failed'));
            })
            .catch(err => {
                Assert.equal('Parameter \'from\' WRONG is invalid, should be a valid currency code', err.message);
                done();
            });
    });

    it('should fail with missing from', () => {
        Assert.throws(() => {
            KernelServ.getExchangeRate('', 'EUR');
        }, /Invalid fromCurrency "", should be valid currency code/);
    });

    it('should fail with invalid to', done => {
        KernelServ.getExchangeRate('USD', 'WRONG')
            .then(rate => {
                // Assert.ok(rate > 0);
                done(new Error('Should have failed'));
            })
            .catch(err => {
                Assert.equal('Parameter \'to\' WRONG is invalid, should be a valid currency code', err.message);
                done();
            });
    });

    it('should fail with missing to', () => {
        Assert.throws(() => {
            KernelServ.getExchangeRate('EUR');
        }, /Invalid toCurrency "undefined", should be valid currency code/);
    });

    it('should fail with incorrect when format', () => {
        Assert.throws(() => {
            KernelServ.getExchangeRate('EUR', 'USD', 'some-date');
        }, /whenTime parameter must be provided as a Date object, actual:some-date/);
    });

    it('should fail with incorrect when format, number', () => {
        Assert.throws(() => {
            KernelServ.getExchangeRate('EUR', 'USD', 11111);
        }, /whenTime parameter must be provided as a Date object, actual:11111/);
    });

    describe('cache', () => {
        afterEach(() => {
            KernelServ.$internals.reset();
            nock.cleanAll();
        });

        it('should use cached version', done => {
            this.timeout(5000);
            // setup fast expring cache
            KernelServ.$internals.rateCache = new Cache({ max: 300, maxAge: 4000 });
            KernelServ.$internals.setRateMaxAge(2000);
            let _rate;
            Async.series([
                next => {
                    // should fail to get excange and since no cache, it will return error
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(500);

                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(rate => {
                        next(new Error('Should have failed'));
                    })
                    .catch(err => {
                        try {
                            session.done();
                            next();
                        }
                        catch (err) {
                            next(err);
                        }
                    });
                },

                next => {
                    // should get exchange rate
                    nock.cleanAll();
                    KernelServ.getExchangeRate('CAD', 'EUR')
                        .then(rate => {
                            Assert.ok(rate > 0);
                            _rate = rate;
                            next();
                        })
                        .catch(next);
                },

                next => {
                    // should use cached version as max age is not expired yet
                    nock.cleanAll();
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(500);

                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(otherRate => {
                        Assert.equal(_rate, otherRate);
                        Assert.ok(!session.isDone());
                        next();
                    })
                    .catch(next);
                },

                // let cache expire
                next => setTimeout(next, 2100),

                next => {
                    nock.cleanAll();
                    // now cache is expired, make it fail to get a new rate
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(500);
                    // so it should use backup version
                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(otherRate => {
                        Assert.equal(_rate, otherRate);
                        session.done();
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // should handle wrong response with missing rate property
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(200, {
                        nothing: 'here'
                    });
                    // so it get the new version
                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(rate => {
                        session.done();
                        Assert.equal(_rate, rate);
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // now allow successful rate retrieval
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(200, {
                        rate: 12
                    });
                    // so it get the new version
                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(rate => {
                        session.done();
                        Assert.equal(12, rate);
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // now it should use the same cache during RATE_MAX_AGE period
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(200, {
                        rate: 100
                    });
                    // keeps using cache
                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(rate => {
                        Assert.ok(!session.isDone());
                        Assert.equal(12, rate);
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // now it should get the new as when is beyound refesh period
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(200, {
                        rate: 100
                    });

                    // so it get the new version
                    KernelServ.getExchangeRate('CAD', 'EUR', new Date(Date.now() + KernelServ.$internals.getRateMaxAge() + 1))
                    .then(rate => {
                        session.done();
                        Assert.equal(100, rate);
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // keep getting the same cache for the new period
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(200, {
                        rate: 200
                    });
                    // so it get the new version
                    KernelServ.getExchangeRate('CAD', 'EUR', new Date(Date.now() + KernelServ.$internals.getRateMaxAge() + 1))
                    .then(rate => {
                        Assert.ok(!session.isDone());
                        Assert.equal(100, rate);
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // still use cache for previous period
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(200, {
                        rate: 200
                    });
                    // so it get the new version
                    KernelServ.getExchangeRate('CAD', 'EUR')
                    .then(rate => {
                        Assert.ok(!session.isDone());
                        Assert.equal(12, rate);
                        next();
                    })
                    .catch(next);
                },

                next => {
                    nock.cleanAll();
                    // should not allow fallback when 'when' parameter is used
                    const session = nock('http://seskeysvc-phx-1-web-envf7jokk59vh.stratus.phx.qa.ebay.com')
                    .get(/exchange-rate/)
                    .reply(500, {
                        rate: 200
                    });
                    // so it get the new version
                    KernelServ.getExchangeRate('CAD', 'EUR', new Date(Date.now() + 2 * KernelServ.$internals.getRateMaxAge() + 1))
                    .then(rate => {
                        next(new Error('Should not happen'));
                    })
                    .catch(err => {
                        session.done();
                        next();
                    });
                }
            ], done);

        });
    });
});
