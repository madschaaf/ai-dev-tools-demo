'use strict';

const Utils = require('@ebay/utils-ebay');
const Urls = require('@ebay/urls-ebay');
const UrlUtils = require('url');

module.exports = function formatLink(element, data, context) {
    if (typeof data !== 'string') {
        throw new Error(`value must be string, actual:${data}`);
    }

    const options = element.options || {};

    if (options.relative === true) {
        return data;
    }

    const urlParts = UrlUtils.parse(data);

    const locality = context.locality;
    const baseHost = Utils.getBaseHost(urlParts.hostname);
    const targetBaseHost = Urls.getBaseUrl(locality && locality.siteId || 0);
    urlParts.hostname = urlParts.hostname.replace(baseHost, targetBaseHost);
    delete urlParts.host;

    if (options.secure) {
        urlParts.protocol = 'https:';
        if (urlParts.port === '80') {
            urlParts.port = '443';
        }
    }
    else {
        urlParts.protocol = 'http:';
        if (urlParts.port === '443') {
            urlParts.port = '80';
        }
    }

    return UrlUtils.format(urlParts);
};
