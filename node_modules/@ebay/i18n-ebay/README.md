# i18n-ebay

[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=i18n-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/i18n-ebay)
[![Security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/i18n-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/i18n-ebay/)
[![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/i18n-ebay)](http://sonar/dashboard/index?id=i18n-ebay)

This module provides support for reading localized content from content bundles stored as `.properties` files.

## Changelog

See [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/i18n-ebay/blob/master/CHANGELOG.md#changelog)

# Table of Contents

- [i18n-ebay](#i18n-ebay)
  - [Changelog](#changelog)
- [Table of Contents](#table-of-contents)
- [Installation](#installation)
- [Sample Code](#sample-code)
  - [Sample Properties File](#sample-properties-file)
  - [JavaScript API Sample Usage](#javascript-api-sample-usage)
  - [Template Sample Usage](#template-sample-usage)
    - [Marko Sample](#marko-sample)
- [Usage](#usage)
  - [JavaScript Usage](#javascript-usage)
    - [Asynchronously reading a bundle](#asynchronously-reading-a-bundle)
    - [Synchronously reading a bundle](#synchronously-reading-a-bundle)
      - [Pre-loading i18n Bundles for Routes](#pre-loading-i18n-bundles-for-routes)
      - [Pre-loading Bundles via Middleware Configuration](#pre-loading-bundles-via-middleware-configuration)
      - [node_module preloads](#node_module-preloads)
      - [Preloaded bundle shorthand](#preloaded-bundle-shorthand)
    - [Accessing Content Elements](#accessing-content-elements)
      - [Simple Content](#simple-content)
      - [Content with variables](#content-with-variables)
      - [Content with Links](#content-with-links)
      - [Content placeholders](#content-placeholders)
        - [Placeholder formatters](#placeholder-formatters)
        - [Date placeholders](#date-placeholders)
        - [Money placeholders](#money-placeholders)
        - [Number placeholders](#number-placeholders)
        - [Link placeholders](#link-placeholders)
      - [Tag instrumentation](#tag-instrumentation)
        - [Tag referencing](#tag-referencing)
        - [Tag formatting](#tag-formatting)
        - [Standard set of tag formatters](#standard-set-of-tag-formatters)
      - [Lists/Arrays](#listsarrays)
      - [Maps](#maps)
  - [Marko Usage](#marko-usage)
  - [Module Usage](#module-usage)
    - [Usage](#usage-1)
    - [Folder Structure](#folder-structure)
  - [Marko V3 Upgrade](#marko-v3-upgrade)
- [Path Syntax](#path-syntax)
- [Client-side Usage](#client-side-usage)
  - [Vite / Webpack](#vite--webpack)
  - [Lasso](#lasso)
- [Testing](#testing)
  - [Unit testing](#unit-testing)
    - [Vitest](#vitest)
    - [Tooling](#tooling)
  - [In browser testing](#in-browser-testing)
  - [Overriding the locality for a request](#overriding-the-locality-for-a-request)
  - [Overriding the locality for Marko template rendering](#overriding-the-locality-for-marko-template-rendering)
- [JavaScript API](#javascript-api)
  - [req.ebay.i18n](#reqebayi18n)
    - [getBundle(bundleName\[, from, callback\])](#getbundlebundlename-from-callback)
  - [ContentBundle](#contentbundle)
    - [get(key\[, data\])](#getkey-data)
    - [getText(key\[, data\])](#gettextkey-data)
  - [ResolvedContent](#resolvedcontent)
    - [get(\[data\])](#getdata)
    - [getText(\[data\])](#gettextdata)
  - [Requesting Localized Content using the L10n Hub](#requesting-localized-content-using-the-l10n-hub)
  - [Overriding Localized Content](#overriding-localized-content)
  - [How to enable ETS L10N Spec Support](#how-to-enable-ets-l10n-spec-support)

# Installation

First, you must install this module into your project:

```bash
npm install @ebay/i18n-ebay --save
```

If you're using Marko & lasso, also install the taglib:

```bash
npm install @ebay/i18n-marko-ebay --save
```

Second, you must enable the `@ebay/i18n-ebay` middleware:

```js
app.use(require("@ebay/i18n-ebay").middleware());
```

Note that the above installation is typically handled for you in a Unified Node.js
application by the config/middleware.json file with the following middleware entry:

```json
"ebay-i18n": {
    "enabled": true,
    "priority": 120,
    "module": "@ebay/i18n-ebay/middleware"
}
```

# Sample Code

## Sample Properties File

_my-app/locales/en/MyProject/test.properties:_

```
foo=bar

greeting=Hello {name}!

someList[0]=Hello {name}
someList[1]=World

someMap.foo=bar
someMap.hello=world

contentWithLink=<a href="{myLink}"><span>{followerCount}</span> follower(s)</a>

contentWithCss=<span class="{app-class}">{followerCount}</span> follower(s)

testTarget.@target[Default]=Default
testTarget.@target[EBAY_DE]=Germany
```

**NOTE** when @target is used for the content element it should be also added to default version as ".@target[Default]"

This replicates the key functionality that was provided by legacy V4Content:

- Simple content elements
- Content List
- Content Map
- Content Structure
- Placeholders in content strings
- Master en/ folder holding all project owned content
- Use of @target to allow country-specific content variations in the en/ folder
- Retains the Project/Bundle/Element concepts from V4 Content

Within the project structure, the content normally resides under the appRoot/locales
folder. The structure is as follows:

```
locales/
       en/
         ProjectName/
           xxx.properties
           yyy.properties
       US/
         en/
           ProjectName/
             xxx.properties
             yyy.properties
       DE/
         de/
          ProjectName/
            xxx.properties
            yyy.properties
```

Only the en/ folder should be used by the project for adding/changing content. The other
locales will be created by the L10N team.

## JavaScript API Sample Usage

```js
req.ebay.i18n.getBundle("MyProject/test", function (err, bundle) {
  // Text replacement
  var greeting = bundle.getText("greeting", { name: "Frank" });

  // Working with lists
  var someList = bundle.get("someList");
  var someList0 = someList[0].getText({ name: "Frank" });

  // Working with maps
  var someMap = bundle.get("someMap");
  var someMapFoo = someMap.foo.getText();

  // Working with links
  var linkHtml = bundle.getText("contentWithLink", {
    myLink: "http://www.ebay.com",
    followerCount: 20,
  });

  // Working with targets
  var testTarget = bundle.getText("testTarget"); // Return value depends on target user's country
});
```

## Template Sample Usage

### Marko Sample

```html
<i18n-use b1="MyProject/bundle1" b2="MyProject/bundle2" />

<div>${b1.get('hello', {name: 'John'})} ${b2.get('world')}</div>
```

# Usage

## JavaScript Usage

### Asynchronously reading a bundle

```js
req.ebay.i18n.getBundle("MyProject/my-bundle", function (err, bundle) {
  var text = bundle.getText("hello");
});
```

### Synchronously reading a bundle

#### Pre-loading i18n Bundles for Routes

A bundle can be read synchronously if it is configured to be pre-loaded for each route in your application's `routes.json`.

For example:

```json
[
  {
    "path": "GET /my-page",
    "handler": "require:./src/pages/my-page",
    "pageName": "MyPage",
    "i18n": {
      "preload": ["MyProject/my-bundle"]
    }
  }
]
```

#### Pre-loading Bundles via Middleware Configuration

Alternatively, bundles can be pre-loaded through your application's middleware.json configuration. This method is particularly useful for global resources that need to be available across multiple routes.

For example:

```json
"ebay-i18n": {
    "enabled": true,
    "priority": 118,
    "module": {
        "name": "@ebay/i18n-ebay/middleware",
        "arguments": [
            {
                "preload": [
                    {
                        "module": "@ebay/seek-ui",
                        "preload": ["seekstrings"]
                    }
                ]
            }
        ]
    }
}
```

Synchronously reading a bundle that has been pre-loaded:

```js
var myBundle = req.ebay.i18n.getBundle("MyProject/my-bundle");
var text = myBundle.getText("hello");
```

#### node_module preloads

You can also preload bundles from within `node_modules` by passing an object with `module` and `preload` properties in the `i18n.preload` array.

For example:

```json
[
  {
    "path": "GET /my-page",
    "handler": "require:./src/pages/my-page",
    "pageName": "MyPage",
    "i18n": {
      "preload": [
        {
          "module": "@ebay/shui-dialog",
          "preload": ["dialog"]
        }
      ]
    }
  }
]
```

#### Preloaded bundle shorthand

If a bundle has been preloaded, you can also leverage the `t` helper exposed from this module during a request.

```js
import { t } from "@ebay/i18n-ebay";

// Some express request handler
export default function (req, res) {
  const text = t("MyProject/my-bundle", "hello");
  // ...
}
```

> **Note:**
> When loading locales from nested modules they are _merged_ with existing locales and will overwrite any with the same name.
> For this reason you must currently ensure that all `.properties` file names are uniquely namespaced in your app and `node_modules`.

### Accessing Content Elements

#### Simple Content

```js
var myBundle = req.ebay.i18n.getBundle("MyProject/my-bundle");
var text = myBundle.getText("hello");
```

#### Content with variables

```js
var myBundle = req.ebay.i18n.getBundle("MyProject/my-bundle");
var text = myBundle.getText("greeting", { name: "Frank" });
```

#### Content with Links

```js
var myBundle = req.ebay.i18n.getBundle("MyProject/my-bundle");
// note: the link will not be auto-adgusted to correct environment, so you need to always pass the link coressponding to the env (prod, qa)
var text = myBundle.get("contentWithLink", { myLink: "http://www.ebay.com" });
```

If you are using Marko, you better do everything in Marko.
This will relieve you from pre-loading bundle.

```html
<i18n-use b1="MyProject/bundle1" />

<div>$!{b1.get('contentWithLink', {myLink: data.myLink})}</div>
```

**Note:** An exclamation mark before '$' is to tell Marko that you are aware of any security vulnerabilities of outputting html from arbitrary sources and want to prevent default security escaping of the content by Marko.

In javascript code:

```js
template.render(
  {
    myLink: "http://www.ebay.com",
  },
  res
);
```

#### Content placeholders

The module provides basic placeholders like date, money, number.

Examples:

```
greeting=The current date is {now, date}!
bin=Buy it now for ${price, money}
count=The total account value is ${total, number}
```

Note: the second parameter specifies the data format

##### Placeholder formatters

The placeholders can be modified based on context via designated formatters.

```js
function myCustomFormatter(value, context, options) {
  return value; // modify value here
}
```

The formatters can be assigned via config.json or directly via context during value resolution

Context example:

```
greeting=Hello {name,nameFormatter}
```

Providing formatters via runtime context:

```js
bundle.getText("greetins", {
  formatters: {
    nameFormatter: (value) => `"${value}"`,
  },
});
```

Providing formatters via local config.json:

```json
{
  "i18n-ebay": {
    "formatters": {
      "nameFormatter": "path:../to/name/formatter/function"
    }
  }
}
```

The formatter options can be specified as part of the placeholder

```
sellAction.custom=Sell on {sellDate, date("dateFormat":"SHORT", "timeFormat":"MEDIUM")}
```

Reading options in format function

```js
function dateFormatter(value, context, options) {
  return DateFormatter.format(value, options.dateFormat, options.timeFormat);
}
```

##### Date placeholders

```
sellAction.default=Sell on {sellDate, date}
sellAction.custom=Sell on {sellDate, date("dateFormat":"SHORT", "timeFormat":"MEDIUM")}
```

Options:

- dateFormat {
  none, short, shortclean, medium, numeric, numericnoday, long, full, fullComplete, fullnoyear
  }
- timeFormat {
  none, short, shortampm, shortzone, shortampmzone, medium, long, longampm
  }

##### Money placeholders

```
priceAction.default=Buy it now for {price, money}
priceAction.custom=Buy it now for {price, money("currencySymbolType":"SIMPLE")}
```

Options:

- currencySymbolType { simple, standard, fancy, all }

##### Number placeholders

```
total=Total number is {value, number("currencySymbolType":"SIMPLE")}
```

##### Link placeholders

For link placeholder one can use link type and provide some options on what needs to happen with the link.
By default all tags and placeholder would be escaped to prevent any html/xml conflicts as the output context is expected to be HTML.
In case of links with parameters it is possible to disable escaping by using escape:false parameter

- Example of the link without escaping

```
text=Click on {href, link("escape":false)}
```

- Example of the link which will be escaping by default

```
text=Click on {href, link}
```

In case you need to use relative link (/path?foo=bar), you can use relative:true attribute.

```
text=Click on {href, link(escape:false, relative:true)}
```

In case of absolute link (https://www.ebay.com/path?foo=bar) that you do not want to change according to site preferences, you can use absolute:true attribute

```
text=Click on {href, link(escape:false, absolute:true)}
```

#### Tag instrumentation

The module represents html or custom tags as dynamic elements. Their attributes or formatting can be controlled.

Example:

```
link=You must <a elementType="URL_EBAY" href="http://www.ebay.com/sigin">Sign in</a>
```

##### Tag referencing

The tags can be referenced via elementId, regular id or its generic name.

- By elementId

```
link=You must <a elementId="MyLink" href="http://www.ebay.com/sigin">Sign in</a>
```

Note: the elementId will be automatically removed before rendering

- By id

```
link=You must <a id="MyLink" href="http://www.ebay.com/sigin">Sign in</a>
```

- By elementType

```
link=You must <a elementType="URL_EBAY" href="http://www.ebay.com/sigin">Sign in</a>
```

Note: the elementType will be automatically removed before rendering

##### Tag formatting

The tag formatting can be customized via formatters mapped by elementId, id, elementType or generic tag name.

```js
function linkFormatter(element, data, context) {
  // resolve tag data
  element.attributes.href = EbayLinkFormatter.format(element.attributes.href);
  // render tag
  return context.renderTag(element, data, context);
}
```

##### Standard set of tag formatters

The module provides link and image ebay formatters

Link formatting

```
link=You must <a elementType="URL_EBAY" href="http://www.ebay.com/sigin">Sign in</a>
```

Image formating

```json
img=Use <img elementType="EBAY_IMAGE" src="/some/buyitnow.png">
```

#### Lists/Arrays

If a path resolves to an array then you can loop over the content elements as shown in the sample code below:

```js
var list = bundle.get("someList");
for (var i = 0; i < list.length; i++) {
  console.log("element (" + i + "): ", list[i].getText());
}
```

#### Maps

Square brackets or sub-properties can be used to access map elements:

```js
var foo = bundle.getText("someMap[foo]");
var bar = bundle.getText("someMap.bar");
```

You can also access the map object:

```js
var someMap = bundle.get("someMap");

for (var k in someMap) {
  console.log(k + ": " + someMap[k].getText());
}
```

## Marko Usage

The `i18n-use` custom element can be used to create local variables that reference loaded `ContentBundle` instances as shown in the following sample code:

```html
<i18n-use b1="MyProject/bundle1" b2="MyProject/bundle2" />

<div>${b1.get('hello', {name: 'John'})} ${b2.get('world')}</div>
```

_NOTE: `get()` should be used over `getText()` inside Marko to prevent double-escaping of localized content._

The first argument to the `get()` method should be the content "path" and the second argument should be any optional variables. See the `Path Syntax` below for more details on specifying a content path.

Alternatively, you can use the `<i18n-bundle>` tag as shown below:

```html
<i18n-bundle name="MyProject/bundle1" var="b1" />
<i18n-bundle name="MyProject/bundle2" var="b2" />

<div>${b1.get('hello', {name: 'John'})} ${b2.get('world')}</div>
```

## Module Usage

The `@ebay/i18n-ebay` content bundles can be used from javascript modules, you can abstract the template usage and prime the content based on the locale and pass it as the viewmodel to the template.

### Usage

```js
var i18n = require("@ebay/i18n-ebay").use(module);
i18n.getBundle("test", function (err, bundle) {
  console.log(bundle.get("greetings"));
});
```

### Folder Structure

Maintain the `locales` folder at the top-level folder strucutre of your module, this enables `i18n` module to discover the locales relative to the module.

## Marko V3 Upgrade

Install `@ebay/i18n-marko-ebay` module to support Marko V3+ compatible taglib.

https://github.corp.ebay.com/nodejs/i18n-marko-ebay

# Path Syntax

The following examples show typical content references:

- `foo`
- `myArray[1]`
- `myMap.someKey`
- `myMap[someKey]`
- `myMap[someKey].someNestedProperty`

# Client-side Usage

## Vite / Webpack

- Include the `<ebay-i18n>` tag in the `<head>` of your page or before rendering any components.
- Prefer the use over `t("bundle-name", "path")` over `<i18n-use />`

## Lasso

To use a content bundle on the client with lasso you must add a content dependency to your `browser.json` or `browser.json` file. For example:

```json
{
  "dependencies": ["content: MyProject/bundle1", "require: i18n-ebay"]
}
```

And add lasso i18n plugin (i18n-ebay/optimizer/plugin) into config.json

```json
    "lasso": {
        "plugins": [
            "@ebay/optimizer-plugin-inc",
            "@ebay/i18n-ebay/optimizer/plugin",
        ],
    ...
    },
```

Assuming the above `browser.json` or `browser.json` is included, you can then read the bundle in the browser (either synchronously or asynchronously):

```js
var contentManager = require("@ebay/i18n-ebay").getContentManager();
var bundle1 = contentManager.getBundle("MyProject/bundle1");
var foo = bundle1.getText("foo");
```

# Testing

## Unit testing

By default, when using the `t("bundleName", "path")` API, an implementation exists that yields mock resources. More specifically, the `t(...)` function yields an identity string. For example, if your component uses the code snippet above, it will
receive a string literal of `'i18n.t("bundleName", "path", json-stringified-inputs)'` when invoked.

If you wish to use real localized values, please the [#Tooling](#tooling) section.

### Vitest

Vitest users can use `@ebay/i18n-ebay/test/vitest` to easily utilize app-locale
locale values during test. See [#Tooling](#tooling) for more.

Example:

```ts
// .vitest/setup/browser.ts
import { setup } from "@ebay/i18n-ebay/test/vitest";
await setup(); // installs the vi.preloadI18nBundles utility fn

// my-widget.browser.test.ts
import { vi } from "vitest";

describe("<my-widget />", () => {
  beforeAll(async () => {
    // load in all bundles, or a subset of bundles
    await vi.preloadI18nBundles();
  });

  it("should render my widget", async () => {
    const i18nValue = t("TestPrj/helloworld", "contentElement.hello");
    await render(MyWidget, { i18nValue });
    // Do great work, e.g. screen.getByText("Hello world")
  });
});
```

### Tooling

For tools that consume i18n resources outside of your standard node.js server, you can
install i18n tools to consume your actual locale resources. For example, you may
with to use real localized values:

1. In tests. You can use meaningful a11y queries when using [testing-library](https://testing-library.com/).
2. In storybook. You can preview actual, meaningful text in your components, without required need for wrapper/higher-order components.

To leverage such capability, see the following example:

```ts
import {
  bindGlobalContentManager,
  createI18NBundlePreloader,
} from "@ebay/i18n-ebay/lib/test/common";
const contentManager = await bindGlobalContentManager();
const preloadI18nBundles = createI18NBundlePreloader({ contentManager });

/**
 * @see {@link lib/test/common.js|Full API & defaults}
 */
await preloadI18nBundles({
  contentManager,

  // optional
  allowMissing: true,
  localesDirname: "test/locales",
  locale: "en",
});
```

**Warning**: test tooling may _squash/monkey-patch_ some module i18n-ebay private methods.
Please see [bindGlobalContentManager](./lib/test/common.js) for more.

## In browser testing

The simplest way to test different locales is to edit your `/etc/hosts` file and add:

```
127.0.0.1       local.qa.ebay.com
127.0.0.1       local.qa.ebay.it
127.0.0.1       local.qa.ebay.de
127.0.0.1       local.qa.ebay.co.uk
127.0.0.1       local.qa.ebay.es
127.0.0.1       local.qa.ebay.fr
```

You can now access your localized pages at the symbolic addresses above (ex: https://local.qa.ebay.de/mypage will render `/mypage` in German).

In development you can also test the output for a given locality overriding the locality in the following ways:

## Overriding the locality for a request

```js
req.locality = {
  locale: "en-US",
  country: "US",
};
```

## Overriding the locality for Marko template rendering

```js
var template = require("./template.marko");
template.render(
  {
    $global: {
      locale: "en-US",
      country: "US",
    },
    name: "Frank",
  },
  out
);
```

# JavaScript API

## req.ebay.i18n

### getBundle(bundleName[, from, callback])

Provides a loaded `ContentBundle`. If `from` is provided then the bundle is searched for relative to the provided directory by searching up and looking for a `locales` directory. If a `callback` is provided then the Node.js-style callback will be called when the loaded `ContentBundle` is provided. If no callback is provided then the loaded `ContentBundle` will be returned if (and only if) the bundle was configured to be preloaded.

Examples:

Asynchronous API:

```js
req.ebay.i18n.getBundle("MyProject/my-bundle", function (err, bundle) {
  var text = bundle.getText("hello");
});
```

Access a pre-loaded bundle:

```js
var bundle = req.ebay.i18n.getBundle("MyProject/my-bundle");
var text = bundle.getText("hello");
```

## ContentBundle

### get(key[, data])

Looks up the content for the specified key. The returned value will vary based on what the key resolves to as shown below:

- Simple: A `ResolvedContent` instance where the underlying value is the `String` value
- List: An `Array` where each element is an instance of `ResolvedContent`
- Map: An `Object` where each property value is an instance of `ResolvedContent`

If the `data` argument is provided and the key resolves to "simple" content then the data will merged into the dynamic placeholders and a `String` value will be returned.

_NOTE: If the resolved content is a `String` then it is wrapped with an object with a `toString()` method that returns the actual `String`. This is done to prevent double escaping of HTML since most templating engines will automatically escape `String` values (but not non-`String` values)._

```js
req.ebay.i18n.getBundle("MyProject/my-bundle", function (err, bundle) {
  var resolvedContent = bundle.get("hello");
  var resolvedContentStr = resolvedContent.toString();
});
```

### getText(key[, data])

This method is similar to `get(key[, data])` except that `String` values are never wrapped.

## ResolvedContent

### get([data])

Returns the underlying value for resolved content.

If the `data` argument is provided and the key resolves to "simple" content then the data will merged into the dynamic placeholders and a `String` value will be returned.

_NOTE: If the resolved content is a `String` then it is wrapped with an object with a `toString()` method that returns the actual `String`. This is done to prevent double escaping of HTML since most templating engines will automatically escape `String` values (but not non-`String` values)._

### getText([data])

This method is similar to `get([data])` except that `String` values are never wrapped.

## Requesting Localized Content using the L10n Hub

All eBay applications with localized content should obtain localized content
by going through the eBay localization process. To submit a request to have an
application's content bundles be localized you should visit the
[eBay L10n Hub](https://l10n-hub.corp.ebay.com/).

**NOTE:** Nodejs apps should use krakenjs profile when request content translation.

## Overriding Localized Content

If you have specific content that you don't want to go through the localization process, you can add it in the "en" directory.

For instance if you want a specific title and subtitle for a site, do the following in the "en" content file:

```
TITLE.@target[Default]=Free shipping
SUB_TITLE.@target[Default]=Get your items today

#l10n:translate="no"
TITLE.@target[EBAY_ES]=Envío libre para todos
SUB_TITLE.@target[EBAY_ES]=Conseguir sus artículos al día siguiente
SUB_TITLE.@target[EBAY_FR,EBAY_CAFR]=Obtenez vos articles le lendemain
#l10n:translate="yes"
```

**NOTE:** With comma separated sites as the @target, you cannot have spaces.

<a id="ets_l10n">

## How to enable ETS L10N Spec Support

By default accept-language headers uses only supported languages for each site.

Note: If your application wants to support a language other than site support languages, you can skip site support languages validation by adding configuration:

```json
{
  "i18n-ebay": {
    "onlySiteSupportLanguages": false
  }
}
```
