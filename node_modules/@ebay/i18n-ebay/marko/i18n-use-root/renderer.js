var managerProvider = require('../../lib/manager-provider');

module.exports = function render(data, out) {
    var renderBody = data.renderBody;

    if (!renderBody) {
        return;
    }

    var contentManager = managerProvider.fromRenderContext(out);

    var bundleNames = data.bundleNames;


    var asyncOut = null;
    var done = false;

    function doRenderBody(e, loadedBundles) {
        done = true;
        // When invoking the body we are going to either render to the async out (if
        // one or more bundles needed to be asynchronously loaded) or the original
        // out if all bundles were able to be loaded synchronously
        var targetOut = asyncOut || out;

        if (e) {
            // If bundle loading failed then emit the error on the async writer
            return targetOut.error(e);
        } else {
            // Otherwise, all of the bundles have been loaded and we are ready to invoke
            // the body function. The first argument will always be the "out" that
            // all of the code will render to and the remaining arguments will be the loaded
            // bundles in the order that maps to the associated variables that were found at
            // compile time
            data.renderBody.apply(this, [targetOut].concat(loadedBundles));
        }

        if (asyncOut) {
            // If we did start asynchronous writer then we need to end it now
            asyncOut.end();
        }
    }

    contentManager._getBundles(bundleNames, data.dirname, doRenderBody);

    if (!done) {
        asyncOut = out.beginAsync({ name: 'getBundles:' + bundleNames.join(',')});
    }
};
