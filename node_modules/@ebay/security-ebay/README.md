# @ebay/security-ebay

[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=security-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/security-ebay) [![security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/security-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/security-ebay/)

The module provides security capabilities that is required to secure NodeJS apps

Current list of features:
* Automatically validate the URL of the 302 Redirect response against a domain whitelist
* Automatically logs any XSS vectors found in URL path, URL path parameters, query string, form inputs and JSON body.
* Sanitizing URL path, URL path parameters, query string and JSON body for XSS vectors by explicit config.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/security-ebay/blob/master/CHANGELOG.md#changelog)

## Install
```bash
npm install @ebay/security-ebay
```
## Middleware
* Removes `X-Powered-By` or `x-powered-by` header from response for security reasons.
* Rejects(404) any requests with `qualys-scan` header
* Adds `X-Content-Type-Options` header to response for security reasons.
* Adds `Strict-Transport-Security` header to the response after config is enabled. Refer section.
* Middleware is hooked automatically in `@ebay/brogan-ebay`

## API
The module provides below API's

### isValidRedirect(url) - checks if the redirection URL is of a valid ebay domain

### isValidNativeEbayDomain(host) - checks if the given host belongs to ebay domain list, example: sell.ebay.com

### maskObject(object) - Masks object keys if exists in blacklist and stringifies object

### Config Info

* [Production Raptor Config](http://www.cfgedit.stratus.ebay.com/cfgedit/editor.html?domain=E%7Cebay.com&target=Global&project=framework&release=0.0.1#framework.security-ebay)

* [QA Raptor Config](http://configedit.stg.stratus.qa.ebay.com/cfgedit/editor.html?domain=E%7Cqa.ebay.com&target=Global&project=framework&release=0.0.1#framework.security-ebay)


### Users who have access to modify the Raptor config

* Dathrika, Mahesh <mdathrika@ebay.com>
* Semenov, Dmytro <dsemenov@ebay.com>
* Pattanayak, Piyush <ppatnayak@ebay.com>
* Sanyal, Indranil <isanyal@ebay.com>


### Domain Whitelisting Process

* Reach DL-eBay-Redirect-Domain-Whitelisting <DL-eBay-Redirect-Domain-Whitelisting@ebay.com> to modify any data in the Raptor config
* Need to make same changes in the [config.json](https://github.corp.ebay.com/nodejs/security-ebay/blob/master/config/config.json) and issue a pull request. This file is used as fallback incase of Raptor config failures. It's very critical to keep this data upto data which is same as Raptor configuration.
* Please inform DL-eBay-NodeJS-Platform about the PR and change, so that we can release the module with latest data.

### XSS Filter

XSS Filtering middleware logs any XSS vectors found in the request path, path parameters, query strings, form inputs and JSON body. Applications can enable filtering by adding following configuration object to `config.json`

```
    "xss-security-ebay": {
        "xss.UrlCheck" : true,
        "xss.requestParameterCheck" : true,
        "xss.strictMode": "true",
        "xss.fullExemptions" : "comma-seperated-list-of-parameter-names-that-should-be-excluded-from-xss-filteration",
        "xss.partialExemptions" :  "comma-seperated-list-of-parameter-names-that-are-allowed-contain-single-or-double-quotes"
    }
```

#### Parameter Key Sanitization

By default, XSS filtering only sanitizes parameter values. To also sanitize parameter keys (which can contain XSS payloads), enable the `sanitizeParameterKeys` flag:

- **Config**: Set the following in `config.json`:
```json
"security-ebay": {
    "sanitizeParameterKeys": true
}
```

This feature addresses XSS vulnerabilities where malicious scripts are injected in URL parameter keys (e.g., `?</script><script>alert(1)</script>=value`). When enabled, parameter keys are sanitized using the same rules as parameter values, and violations are logged separately.

**Note**: This feature is disabled by default to maintain backward compatibility.

This application wide configuration can be overriden per path mapping in the `routes.json`, path specific setting overrride the application wide settings.

```
{
    {
        "path": "GET /ep",
        "handler": "require:./src/pages/experimentation",
        "pageName": "root"
        "xss.UrlCheck" : true,
        "xss.requestParameterCheck" : true
        "xss.strictMode": "true",
        "xss.fullExemptions" : "comma-seperated-list-of-parameter-names-that-should-be-excluded-from-xss-filteration",
        "xss.partialExemptions" :  "comma-seperated-list-of-parameter-names-that-are-allowed-contain-single-or-double-quotes"
    }
}

```

This middleware has 2 components one that operates on URL path and the other that operates on the payload.

#### URL Path Filter

In the default mode, this filter just checks for XSS vectors on the request path and emits a CAL `XSSUrlCheck` event when the request path contains the following tokens

```
    <
    >
    '
    "
    %3C
    %3E
    %27
    %22
    data:
    data%3A
```

This filter can be configured to remove such tokens from URL path, by setting `xss.UrlCheck` property of a given path mapping in the `routes.json` to `true`. Application wide filteration can be enabled by setting  `xss-security-ebay.xss.UrlCheck` to `"true"` in the `config.json`.


#### Payload Filter

In the default mode, this filter just checks for the following XSS vectors in path parameters, query string, form inputs and JSON body and emits a CAL `warning` event.

When the parameter type is `string` following tokens are considered to be XSS vectors.

```
    '
    "
    <script
    <applet
    <object
    <iframe,
    <embed,
    <![CDATA[
    <[[
    </script>
    </applet>
    </object>
    </iframe>
    </embed>
    ]]>
    <
    >
    //
    javascript:
    data:
```

When the parameter type is `URL` following tokens are considered to be XSS vectors.

```
    <script
    %3Cscript
    Q3cscript
    <applet
    <object
    <iframe
    <embed
    <![CDATA[
    <[[
    </script>
    script%3E
    scriptQ3e
    </applet>
    </object>
    </iframe>
    </embed>
    ]]>
    <
    %3C
    Q3c
    >
    %3E
    Q3e
    [
    %5B
    Q5b
    ]
    %5D
    Q5d
    javascript%3A
    data%3A
```

This filter can be configured to remove such tokens from parameters, by setting `xss.requestParameterCheck` property of a given path mapping in the `routes.json` to `true`. Application wide filteration can be enabled by setting  `xss-security-ebay.xss.requestParameterCheck` to `"true"` in the `config.json`.

It is possible to allow parameters to contain single and double quotes listing them out the parameter names, using `xss.partialExemptions` parameter of a path mapping (value of must be a comma seperated string). Application wide partial exemptions can be enabled by setting  `xss-security-ebay.xss.partialExemptions` in the `config.json`.

Also certain parameters can be excluded from XSS filtering completely by listing them out usng `xss.fullExemptions` parameter of a path mapping (value must be a string of comma seperated values). Application wide partial exemptions can be enabled by setting  `xss-security-ebay.xss.fullExemptions` in the `config.json`.

## HSTS - Strict Transport Security

Middleware adds HSTS header to the response if the config is enabled. Switch enabled flag to true to enable HSTS. Max-age has only three options which are the following:

* zero  -   0 seconds
* min   -   10 minutes (600 seconds)
* full  -   1 year (31536000 seconds)

Following lines need to be added to config.json to disable HSTS. 

```
"security-ebay": {
    "hsts": { 
        "enabled": false
    }
}
```

Following lines need to be added to config.json to enable HSTS with set max-age to 10 minutes. 

```
"security-ebay": {
    "hsts": { 
        "enabled": true,
        "max_age": "min"
    }
}
```
