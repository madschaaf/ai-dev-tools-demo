'use strict';
const NodeUrl = require('url');
const Querystring = require('querystring');
const onHeaders = require('on-headers');
const moduleconfig = require('@ebay/module-config-inc');
const env = require('@ebay/environment-ebay');
const Index = require('./index');

module.exports = function middleware() {
    return function securityMiddleware(req, res, next) {
        // This middleware provides https://blogs.msdn.microsoft.com/ie/2008/09/02/ie8-security-part-vi-beta-2-update
        moduleconfig(module, function(err, config) {
            // validate hosts for non-Dev environment
            // if invalid host is detected, it will be replaced with www.ebay.com
            if (config.get('security-ebay:request-host-validation')) {
                const host = req.headers && req.headers.host;
                if (!env.isDev() && (!host || !Index.isValidEbayDomain(host))) {
                    console.error(`Detected invalid or missing host (${host}) in request.headers, reset to www.ebay.com`);
                    req.headers.host = 'www.ebay.com';
                }
            }

            //This middleware provides fast reject for any security scanner requests
            if (req.headers['qualys-scan'] && config.get('security-ebay:qualyscan-filter')) {
                res.status(404).end('Not found');
                return;
            }

            if (res) {
                onHeaders(res, function removeXPoweredBy() {
                    res.removeHeader('X-Powered-By');
                    res.removeHeader('x-powered-by');
                });

                if (config.get('security-ebay:content-type-enabled') !== false) {
                    res.setHeader('X-Content-Type-Options', 'nosniff');
                }

                if (config.get('security-ebay:hsts:enabled') === true) {
                    if ( config.get('security-ebay:hsts:max_age') === "full") {
                        res.setHeader('Strict-Transport-Security', 'max-age=31536000');
                    }
                    else if (config.get('security-ebay:hsts:max_age') === "min") {
                        res.setHeader('Strict-Transport-Security', 'max-age=600');
                    }
                    else if (config.get('security-ebay:hsts:max_age') === "zero") {
                        res.setHeader('Strict-Transport-Security', 'max-age=0');
                    }
                }
                

                const contextParams = config.get('security-ebay:context');
                if (contextParams) {
                    contextParams.forEach(name => {
                        if (req.query[name]) {
                            req.security = req.security || {};
                            req.security[name] = req.query[name];
                            delete req.query[name];
                        }
                    });
                }
                const sensitiveParams = config.get('security-ebay:sensitive-paramaters');
                if (sensitiveParams && sensitiveParams.length &&
                    req.headers.referer && req.headers.referer.indexOf('?') !== -1) {

                    try {
                        const urlData = NodeUrl.parse(req.headers.referer);
                        const query = Querystring.parse(urlData.query);
                        let modified;
                        sensitiveParams.forEach(name => {
                            if (query[name]) {
                                modified = true;
                                query[name] = '***';
                            }
                        });
                        if (modified) {
                            urlData.search = '?' + Querystring.stringify(query);
                            req.headers.referer = NodeUrl.format(urlData);
                        }
                    } catch (err) {
                        console.error(err);
                    }
                }

                next();
            }
        });

    };
};
