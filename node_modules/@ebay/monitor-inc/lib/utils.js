'use strict';

var path = require('path'),
    fs = require('fs'),
    shell = require('shelljs'),
    util = require('util'),
    ip = require('ip'),
    appContext = require('@ebay/app-context-ebay'),
    getId = require('@ebay/instance-detect-ebay').getInstanceId;

function buildEmailBody(opts) {
    var loginfo = '';    // Don't send mails except in prod-like environments. Cuts down spam.
    opts = opts || {};
    var maxLogLines = opts.maxLogLines || 100;
    var errFileName = getErrorFile();
    var errorLog = path.resolve(process.cwd(), 'logs', errFileName);
    if (fs.existsSync(errorLog)) {
        loginfo = shell.exec('/usr/bin/tail -' + maxLogLines + ' ' + errorLog, {silent: true}).stdout;
    }
    var errorLogURL = util.format('http://%s:8080/admin/v3console/logs?logfile=%s', /.+\.ebay(c3)?\.com/.test(appContext.machineName) ? appContext.machineName : ip.address(), errFileName);
    var mailBody = 'Environment: '+ process.env.NODE_ENV + '\n';
    mailBody += 'Error Log: '+ errorLogURL + '\n';
    mailBody += loginfo;

    return mailBody;
}

function buildCalData(numRestarts, restartReason) {
    var data = 'Worker restarted on pid = ' + getId() + '. This is restart number ' + numRestarts + '. Reason: ';
    data += restartReason;
    return data;
}

function deployEmailBody() {
    var deployLogURL = util.format('http://%s:8080/admin/v3console/logs?logfile=deploy.log', /.+\.ebay(c3)?\.com/.test(appContext.machineName) ? appContext.machineName : ip.address());
    var nukeEmailBody = 'Environment: '+ process.env.NODE_ENV + '\n';
    nukeEmailBody += 'Deploy Log: '+ deployLogURL + '\n\n';
    nukeEmailBody += 'Looks like Ops has Nuked the box, this is not Crash.\n Check with Ops team for more details.\n Ops Slack Group: eBAY_SEC\n';
    return nukeEmailBody;
}

function getErrorFile() {
    var errFile = 'err.log';
    var logfile = path.resolve(process.cwd(), 'logs', errFile);

    //If running more than one process
    if (!fs.existsSync(logfile)) {
        // pm2 path for err log files
        errFile = 'err-' + (getId()) + '.log';
    }
    return errFile;
}

exports.buildEmailBody = buildEmailBody;
exports.buildCalData = buildCalData;
exports.deployEmailBody = deployEmailBody;
