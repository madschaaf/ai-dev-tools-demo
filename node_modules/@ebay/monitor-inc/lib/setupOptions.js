'use strict';

var tooBusy = require('toobusy-js'),
    confit = require('confit'),
    path = require('path'),
    detector = require('@ebay/colo-detect-ebay'),
    reportFunctions = require('./reportFunctions'),
    appContext = require('@ebay/app-context-ebay');

// Setup all the options needed for Sherlock reporting and a few other
// once only computations like max file descriptors.
exports.setupOptions = function setupOptions(options, callback) {

    options = options || {};
    var basedir = path.resolve(process.cwd(), 'config');
    confit(basedir).create(function (err, config) {
        options = getOptions(config, options);
        callback(null, options);
    });
};

function getOptions(config, options) {
    var determineMaxFileDescriptors = reportFunctions.determineMaxFileDescriptors;

    // Determine datacenter, MX gateway and application name
    options.colo = detector.coloDetect();
    options.coloMx = detector.coloMxDetect();
    options.pool = appContext.appName;
    options.tenant = options.tenant || 'mp';

    // To addresses for delivery of crash email
    options.monitor = config.get('monitor');
    options.clientEndPoint = options.clientEndPoint || config.get('monitoring:clientEndPoint');
    options.clientGroup = options.clientGroup || config.get('monitoring:clientGroup');

    options.interval  = options.interval || config.get('monitoring:interval');
    options.tenant  = options.tenant || config.get('monitoring:tenant');
    options.maxLag = options.maxLag || config.get('monitoring:maxLag');
    if (options.maxLag) {
        tooBusy.maxLag(options.maxLag);
    }

    options.interval = options.interval || 60; // reporting interval
    options.interval = options.interval * 1000; // make into milliseconds
    determineMaxFileDescriptors(function (err, maxFd) {
        if (!err) {
            options.maxFileDescriptors = maxFd;
        }
    });
    return options;
}
