'use strict';

var util = require('util');
var Transform = require('stream').Transform;
const { getValidUtf8Length } = require('../buffer-utils');

var ChunkedStream = module.exports.ChunkedStream = function ChunkedStream() {
    Transform.call(this);
    this._incompleteBufferData = [];
    this._chunks = [];
};

util.inherits(ChunkedStream, Transform);

ChunkedStream.prototype._pushDataAndResetChunks = function(data){
    try {
        this.push(data);
    } catch (err) {
        console.log('Error is : ', err);
    }
    this._chunks = [];
};
    
ChunkedStream.prototype._transform = function(buffer, encoding, callback) {
    if (buffer instanceof Buffer) {
        if (this._incompleteBufferData.length > 0) {
            // prepend
            buffer = Buffer.from([...this._incompleteBufferData, ...buffer]);
            this._incompleteBufferData = [];
        }
        const validLen = getValidUtf8Length(buffer);
        if (validLen !== buffer.length) {
            // split buffer into valid and incomplete
            this._incompleteBufferData = buffer.slice(validLen, buffer.length);
            if (validLen > 0) {
                buffer = buffer.slice(0, validLen);
            }
            else {
                // nothing to send as only incomplete data got received
                callback();
                return;
            }
        }
    }
    const chunk = buffer instanceof Buffer ? buffer.toString('utf-8') : buffer;
    const pcs = chunk.split('\n\n');
    
    while (pcs.length > 1) {
        this._chunks.push(pcs.shift());
        // emit full chunk
        this._pushDataAndResetChunks(this._chunks.join(''));
    }

    const left = pcs.shift();
    if (left) {
        this._chunks.push(left);
        if (left === "\n")
        {
            const data = this._chunks.join('');
            this._pushDataAndResetChunks(data.substring(0, data.length -2)); //remove trailing \n\n       
        }
    }

    callback();
};


ChunkedStream.prototype._flush = function(cb) {
    if (this._chunks.length) {
        this.push(this._chunks.join(''));
    }
    this._chunks = [];
    cb();
};