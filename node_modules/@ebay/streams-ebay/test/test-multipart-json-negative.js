'use strict';

var utils = require('./utils/index');
var testAapp = utils.testAppMultipartStreamError();
var punch = require('@ebay/httpunch');
var svr;

var streams = require('../index');
var chunked = streams.ChunkedStream;
var MultipartStream = streams.MultipartStream;

var assert = require('assert');
describe(__filename, function() {

    before(function(done) {
        svr = testAapp.listen(2223, done);
    });

    after(function() {
        svr.close();
    });

    it('should recieve end event with undefind for empty chunk', function (done) {
        var cstream = new chunked();
        var stream = new MultipartStream();
        cstream.pipe(stream);
        stream.on('error', done);
        stream.on('data', function() {
            done(new Error('Should not happen'));
        });
        stream.on('end', function(data) {
            assert.equal(undefined, data);
            done();
        });
        cstream.write('');
        cstream.end();
    });

    it('should fail to parse chunk', function (done) {
        var cstream = new chunked();
        var stream = new MultipartStream();
        cstream.pipe(stream);
        stream.on('error', function(err) {
            assert.equal('Unable to parse chunk s', err.message);
            done();
        });
        stream.on('data', function(data) {
            done(new Error('Should not happen'));
        });

        stream.on('end', function(data) {
            done(new Error('Should not happen'));
        });
        cstream.write('s');
        cstream.end();
    });

    it('Should return undefined for 304 request', function(done) {
        this.timeout(2000);

        var stream = new chunked();
        var options = {
            url: 'http://localhost:2223/304'
        };
        var req = punch.get(options);

        var eventParts = new MultipartStream();
        stream.pipe(eventParts);
        req.pipe(stream);
        var chunks = [];
        req.on('response', function(res) {
            //data, error and end should be registered. if only end event is registered, it fails
            res.on('data', function(chunk) {
                chunks.push(chunk.toString());
            });
            res.on('error', function(err){
                done(err);
            });
            res.on('end', function(r) {
                assert.equal(undefined, r);
                done();
            });
        });
    });

});
