'use strict';

const Assert = require('assert');
const { getValidUtf8Length } = require('../lib/buffer-utils'); 

describe(__filename, () => {
    it('should detect incomplete buffer chunks', () => {
        let star = Buffer.from('text★');
        let starArray = [...star];

        Assert.strictEqual(getValidUtf8Length(starArray), 7);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 1)), 4);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 2)), 4);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 3)), 4);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 4)), 3);

        // now deal only with single multi-byte use case
        star = Buffer.from('★');
        starArray = [...star];
        Assert.strictEqual(getValidUtf8Length(starArray), 3);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 1)), 0);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 2)), 0);
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 3)), 0);
        // some mistake to be expected
        Assert.strictEqual(getValidUtf8Length(starArray.slice(0, starArray.length - 4)), 0);
    });
});
