'use strict';

const utils = require('./utils/index');
const punch = require('@ebay/httpunch');

const streams = require('../index');
const chunked = streams.ChunkedStream;
const eventStream = streams.EventStream;

const assert = require('assert');

describe(__filename, function() {
    let svr;
    after(() => {
        svr.close();
    });

    before(next => {
        const testAapp = utils.testAppEvents();
        svr = testAapp.listen(2222, next);
    });

    it('Should pass this test', function(done) {
        this.timeout(2000);
        const response = {};
        const stream = new chunked();
        const options = {
            url: 'http://localhost:2222/?code=304'
        };
        const req = punch.get(options);

        const eventParts = new eventStream();
        eventParts.on('finish', () => {
            assert.deepStrictEqual(response, {
                body: '',
                statusCode: 304
            });
            done();
        });

        stream.pipe(eventParts);
        req.pipe(stream);

        req.on('response', function(res) {
            response.statusCode = res.statusCode;
            const chunks = [];
            res.on('data', function(chunk) {
                chunks.push(chunk.toString());
            });
            res.on('end', function() {
                response.body = chunks.join('').toString();
            });
        });
    });

});