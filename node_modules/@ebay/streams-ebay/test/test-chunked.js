'use strict';

const Assert = require('assert');
const { ChunkedStream } = require('../index');

describe(__filename, () => {
    it('should handle normal chunk', done => {
        const ret = [];
        const stream = new ChunkedStream();

        stream.on('data', (data) => {
            ret.push(data);
        });
        stream.once('finish', () => {
            Assert.strictEqual(Buffer.concat(ret).toString(), 'hello world');
            done();
        });

        stream.write(Buffer.from('hello'));
        stream.write(' ');
        stream.write(Buffer.from('world'));
        stream.end();
    });

    it('should handle multi-byte stream', done => {
        const ret = [];
        const stream = new ChunkedStream();

        stream.on('data', (data) => {
            ret.push(data);
        });
        stream.once('finish', () => {
            Assert.strictEqual(Buffer.concat(ret).toString(), 'hello★world');
            done();
        });

        stream.write(Buffer.from('hello'));
        stream.write(Buffer.from('★'));
        stream.write(Buffer.from('world'));
        stream.end();
    });

    it('should handle single chunk with bad multi-byte, should return it', done => {
        const ret = [];
        const stream = new ChunkedStream();

        stream.on('data', (data) => {
            ret.push(data);
        });
        stream.once('finish', () => {
            Assert.strictEqual(Buffer.concat(ret).toString(), 'hello★world');
            done();
        });

        const hello = Buffer.from('hello★');
        let helloArray = [...hello];

        const hello1 = Uint8Array.from(helloArray.slice(0, helloArray.length - 1));
        const hello2 = Uint8Array.from(helloArray.slice(helloArray.length - 1, helloArray.length));

        stream.write(hello1);
        stream.write(hello2);
        stream.write(Buffer.from('world'));
        stream.end();
    });

    it('should handle incomplete chunk', done => {
        const ret = [];
        const stream = new ChunkedStream();

        stream.on('data', (data) => {
            ret.push(data);
        });
        stream.once('finish', () => {
            Assert.strictEqual(Buffer.concat(ret).toString(), '★');
            done();
        });

        let helloArray = [...Buffer.from('★')];

        const hello1 = Uint8Array.from(helloArray.slice(0, helloArray.length - 2));
        const hello2 = Uint8Array.from(helloArray.slice(1, helloArray.length - 1));
        const hello3 = Uint8Array.from(helloArray.slice(2, helloArray.length));

        stream.write(hello1);
        stream.write(hello2);
        stream.write(hello3);
        stream.end();
    });
});
