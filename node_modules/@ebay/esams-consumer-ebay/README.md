# esams-consumer-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/esams-consumer-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/esams-consumeer-ebay/job/master) 
[![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/esams-consumer-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/esams-consumer-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/esams-consumer-ebay)](http://sonar/dashboard/index?id=esams-consumer-ebay)

The module provides a SOA client for ebay ESAMS service.
Currently only `getSecretKey()`, `getNonKey()`, `getKeyPair()`, `getSertificate()` methods are supported.
`getPrivateKey()` may be implemented later or upon a request

Learn more about migration to [Fidelius](https://wiki.vip.corp.ebay.com/display/PLATSEC/Fidelius+-+Introduction) and supported use-cases.

## Changelog

See [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/esams-consumer-ebay/blob/master/CHANGELOG.md#changelog)

## Prerequisite

In order for your application or service to use the `crypto-ebay` module, you must set up your application
for eSAMS (eBay Security Assets Management System).

The simplified steps are the following:

Idneity file will be provisioned in every box and channleName will be created automtically.

* **Dev**:

For dev mode a default developer identity file will be used.

* **QA, Production and Pre-Production**:

By default, the identity file should be in the /ebay/config/identities/ folder.

If the file is not found, you can open a jira Ticket like this jira ticket:
[esams-jira](https://jirap.corp.ebay.com/browse/ALLPROV-3477).    

You need to open a trace ticket:
[eSams-trace](https://wiki.vip.corp.ebay.com/display/KERNELDOCS/eSams-trace)

## Usage
```js
const esamsConsumer = require('@ebay/esams-consumer-ebay').getNameService();

const secretKey = await esamsConsumer.getSecretKey('site.security.csrf2.secretkey', 1);
console.log('The key is:', secretKey);

const nonKy = await esamsConsumer.getNonKey('site.security.csrf2.nonkey', 1);
console.log('The key is:', result);
```

## API Responses

### NameService API

* `getSecretKey(channelName: string, channelVersion: number = -1): Promise<SecretKeyHolder>`

* `getSealSecretKey(channelName: string, channelVersion: number = -1): Promise<SecretKeyHolder>`

* `getKeyPair(channelName: string, channelVersion: number = -1): Promise<PatronusKeyPairHolder | KeyPairHolder>`

* `getCertificate(channelName: string, channelVersion: number = -1): Promise<X509Certificate>`

* `getNonKey(channelName: string, channelVersion: number = -1): Promise<NonKeyHolder>`

### NameService Types

* Holder
```ts
interface Holder {
    getChannelName(): string;
    getVersion(): number;
    getLabel(): number;
}
```

* EKRHolder:
```ts
interface EKRHolder extends Holder {
  rotationPeriod: number = 0;
  verifyPeriod: number = 0;
  setKeyExpiryDate(dateInMs: number): void;
  getKeyExpiryDate(): number;
  // Whether channel specified (indirectly) by holder is used in automatic key rotation
  isEKR(): number;
  /* Calculates whether "secret id" or lookup value/version used to resolve specific key
   * is current or not. Possible states are current, valid, expired or fromFuture. */
  isCurrent(now = Date.now()): boolean;
  /**
   * Calculates whether "secret id" or lookup value/version used to resolve specific key
   * is current or not. Possible states are current, valid, expired or fromFuture.
   */
  isExpired(now: number = Date.now()): boolean;
  /**
   * Calculates whether "secret id" or lookup value/version used to resolve specific key
   * is 'from future' or not. Possible states are current, valid, expired or 'from future'.
   */
  isFromFuture(now = Date.now()): boolean;
  /**
   * Returns simple int for enum. It specifies how often 'current' key is rotated...thus becoming
   * 'valid' key (not current but still good).
   * 
   * @return Number
   */
  getRotationPeriod(): number;
  /**
   * Sets simple int for enum. It specifies how often 'current' key is rotated...thus becoming
   * 'valid' key (not current but still good).
   */
  setRotationPeriod(rotationPeriod: number): void;
  /**
   * Returns simple int for enum. It specifies how long a key no longer 'current' is still
   * valid for use.
   */
  getVerifyPeriod(): 1|2|3|4|5|6;
  /**
   * Sets simple int for enum. It specifies how long a key no longer 'current' is still
   * valid for use.
   */
  setVerifyPeriod(val: 1|2|3|4|5|6): void;
  isArtifactStillValid(): boolean;
}
```

* SecretKeyHolder:
```ts
interface SecretKeyHolder extends EKRHolder {
  encodedSecretKe: string
  algorithm: string;
  envelopeVersion: number;
  mode: string;
  padding: string;
  digest: string;
  enforceExpiration(): this
}
```

* KeyPairHolder:
```ts
interface KeyPairHolder extends EKRHolder {
  privateKey: string;
	certificates: X509Certificate[];
  getPrivateKey(): string;
  getCertificates(): X509Certificate[];
}
```

* PatronusKeyPairHolder:
```ts
interface PatronusKeyPairHolder extends KeyPairHolder {
  envelopeVersion: number;
  keyId: string;
}
```

* CertificateHolder:
```ts
interface CertificateHolder extends EKRHolder {
  certificate: X509Certificate
}
```

```ts
interface NonKeyHolder extends Holder {
  nonKey: string;
}
```

#### Examples
```js
const nameService = require('@ebay/esams-consumer-ebay').getNameService();

const secretKey = await nameService.getSecretKey(channelName, version = -1);

const sealSecretKey = await nameService.getSealSecretKey(channelName, version = -1);

const keyPair = await nameService.getKeyPair(channelName, version = -1);

const certificate = await nameService.getCertificate(channelName, version = -1);

const nonKey = await nameService.getNonKey(channelName, version = -1);
```

### Legacy API
#### `getKeyPair(channelName, channelVersion)`
result object will contain the following fields:
* `privateKey: {encodedPrivateKey, algorithm}` - pkcs8 encoded public certificate (with begin/end certificate header/footer
    encodedPrivateKey, - private key algorithm name
    algorithm - private key algorithm name
  `certificates: []` - pkcs8 encoded public certificate (with NO begin/end certificate header/footer)
* `rotationPeriod`
* `verifyPeriod`
* `channelVersion` - version of the key

#### `getCertificate(channelName, channelVersion)`
result object will contain the following fields:
* `encodedCertifcate` - pkcs8 encoded public certificate (with NO begin/end certificate header/footer)
* `algorithm` - public key algorithm name
* `rotationPeriod`
* `verifyPeriod`
* `channelVersion` - version of the key

#### `getNonKey(channelName, channelVersion)`
result object will contain the following fields:
* `value` - the non-key value
* `version` - version of the value

#### `getSecretKey(channelName, channelVersion)`
result object will contain the following fields:
* `encodedSecretKey` - secret key value
* `algorithm` - secret key algorithm name
* `keyExpiryDate` - expiration date
* `rotationPeriod`
* `verifyPeriod`
* `version` - version of the key
