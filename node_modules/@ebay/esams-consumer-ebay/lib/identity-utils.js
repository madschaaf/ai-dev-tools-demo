'use strict';

const fs = require('fs');
const path = require('path');
const appContext = require('@ebay/app-context-ebay');
const environment = require('@ebay/environment-ebay');

let paths;

function getIdentityFilePaths() {
    if (paths) {
        return paths;
    }

    paths = [];

    if (environment.isDev() || environment.isTest() || environment.isLocalDebug() || process.env.ESAMS_IDENTITY_FILE && environment.isQA()) {
        if (process.env.ESAMS_IDENTITY_FILE) {
            paths.push(process.env.ESAMS_IDENTITY_FILE);
        }

        paths.push(path.join(__dirname, '../resources/default-dev-esams-identity.xml'));
    } else {
        paths.push(`/ebay/config/identities/${appContext.appName}.xml`);
    }

    return paths;
}

function getDefaultIdentityFile() {
    var paths = module.exports.getIdentityFilePaths();

    for (var i = 0, len = paths.length; i < len; i++) {
        var filePath = paths[i];

        if (fs.existsSync(filePath)) {
            return filePath;
        }
    }

    return null;
}

function getIdentity(identityFile) {
    try {
        var buf = fs.readFileSync(identityFile);
        var identity = buf && buf.toString('base64');

        if (!identity) {
            throw new Error('identity file ' + identityFile + 'is empty');
        }

        return identity;
    } catch (e) {
        throw new Error('Error reading identity file ' + identityFile + e.stack);
    }
}

module.exports = {
    getIdentityFilePaths,
    getDefaultIdentityFile,
    getIdentity,
    reset() {
        paths = undefined;
    }
};
