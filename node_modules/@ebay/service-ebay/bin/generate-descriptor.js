#!/usr/bin/env node

'use strict';

const Path = require('path');
const Fs = require('fs');
const Program = require('commander');
const colors = require('colors');
const tryRequire = require('try-require');
const pkg = tryRequire(Path.resolve(__dirname, '../package.json'));

const generateDescriptor = require('./service-descriptor').generate;

if (!pkg) {
    console.warn('[WARN]: Cannot find package.json');
}

Program
    .version(pkg && pkg.version || '0.1.0')
    .option('--appName <service name>', '[required]')
    .option('-s, --schema <schema_file>', '[required] path to schema json file.')
    .option('-d, --sdd <service_descriptor_file>',
        '[required] path to the service descriptor or where it should be generated.');

Program.command('generate')
    .description('- generates service descriptors out of openapi schema')
    .action(confog => {
        const schema = Program.schema;

        if (!Program.appName) {
            console.error('[ERROR]: Please provide appName');
            usage();
            process.exit(1);
        }

        const options = {
            'app-name': Program.appName
        };
        console.info('Generating sdd for options:', options);
        const sddContent = generateDescriptor(require(schema), options);
        Fs.writeFileSync(Program.sdd, JSON.stringify(sddContent, null, 2));
    });

Program.parse(process.argv);

function usage() {
    Program.outputHelp(colors.red);
}
