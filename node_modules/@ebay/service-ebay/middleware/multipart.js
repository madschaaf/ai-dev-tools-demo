'use strict';

const fs = require('fs'),
    IncomingForm = require('formidable').IncomingForm,
    logger = require('@ebay/logging-inc').logger('service-ebay/middleware/multipart');

/**
 * Filters requests for only those that are `multipart/form-data`
 * @param fn the handler to invoke
 * @returns {Function}
 */
function filter(fn) {
    return function multipart(req, res, next) {
        const contentType = req.headers['content-type'];
        if (typeof contentType === 'string' && ~contentType.indexOf('multipart/form-data')) {
            logger.debug('received multipart request');
            fn(...arguments);
            return;
        }
        next();
    };
}

/**
 * simple forEach that enumerates an object's properties
 * @param obj the object to enumerate
 * @param callback the callback to invoke, with the signature `callback(value, key, obj)`
 */
function forEachValue(obj, callback) {
    Object.keys(obj).forEach(item => {
        callback(obj[item], item, obj);
    });
}

/**
 * Cleanup handler factory
 * @param files the list of files to clean up
 * @returns {function(this:null)}
 */
function cleanify(files) {
    return forEachValue.bind(null, files, funlink);
}

/**
 * Removes the provided file from the filesystem
 * @param file a formidable File object
 */
function funlink(file) {
    const path = file.path || file.filepath;
    logger.debug('removing', file.name || file.originalFilename, ', path', file.path || file.filepath);
    if (typeof path === 'string') {
        fs.unlink(path, err => {
            if (err) {
                logger.error('Failed to remove', path, err);
            }
        });
    }
}

module.exports = function (config) {
    config = config || {};

    return filter((req, res, next) => {
        const form = new IncomingForm(config);
        form.parse(req, (err, fields, files) => {
            if (err) {
                next(err);
                return;
            }

            req.body = fields;
            req.files = files;
            req.body = req.body || {};
            Object.assign(req.body, files);
            res.once('finish', cleanify(files));
            next();
        });
    });
};
