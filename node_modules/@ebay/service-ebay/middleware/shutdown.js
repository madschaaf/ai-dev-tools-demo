'use strict';

const States = {
    CONNECTED: 0,
    DISCONNECTING: 2
};

module.exports = function shutdownFactory(config = {}) {
    const timeout = config.timeout || 30000;
    let state;
    const servers = {};

    function close() {
        state = States.DISCONNECTING;
        process.emit('shutdown', servers, timeout);
    }

    state = States.CONNECTED;

    return function shutdown(req, res, next) {
        if (state === States.DISCONNECTING) {
            const err = new Error('Service is not available.');
            err.statusCode = 503;
            return next(err);
        }

        const port = req.socket.localPort;
        if (!servers[port]) {
            // Lazy-bind - only attempt clean shutdown
            // if we've taken at least one request.
            servers[port] = req.socket.server;
            process.once('SIGTERM', close);
            process.once('SIGINT', close);
        }

        next();
    };
};
