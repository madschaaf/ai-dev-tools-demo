const MultiValue = require('@ebay/header-multi-value-ebay');

module.exports = function () {
    return function service(req, res, next) {
        // should send back node_id and rci if it was generated on this request (if it was not passed)
        const context = req.ebay && req.ebay.getCorrelationRequestId();
        if (context) {
            const traceMeta = {
                node_id: context.getNodeId()
            };
            if (!isRequestRciPresent()) {
                traceMeta.rci = context.getCorrelationRequestId();
            }
            const onHeaders = require('on-headers');
            const responseTrace = MultiValue.create(traceMeta).toString();
            onHeaders(res, () => {
                res.set && res.set('x-ebay-c-response-id', responseTrace);
            });
        }

        next();

        function isRequestRciPresent() {
            const requestTraceInfo = req.headers['x-ebay-c-request-id'];
            if (requestTraceInfo) {
                const reqTrace = MultiValue.parse(requestTraceInfo);
                return !!reqTrace.get('rci');
            }
        }
    };
};
