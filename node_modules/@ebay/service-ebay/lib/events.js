'use strict';

const Hoek = require('hoek');
const debug = require('debug')('@ebay/service-ebay/server');

module.exports = function events(app) {
    process.once('shutdown', async (servers, timeout) => {
        const stop = Hoek.once(code => {
            console.info(`The server stopped ${code === 1 ? 'forced' : 'gracefully'}`);
            try {
                // guard in try catch when the process is
                // shutdown externally
                app.emit('stop');
            }
            catch (err) {
                // skip
            }
            process.exit(code);
        });

        const ok = stop.bind(null, 0);
        const err = stop.bind(null, 1);

        debug('process shutting down');

        console.info(`Gracefully shutting down server instance ...`);
        setTimeout(err, timeout).unref();
        await Promise.all(Object.keys(servers).map(name => new Promise(resolve => {
            servers[name].close(() => {
                resolve();
            });
        })));

        ok();
    });

    return app;
};
