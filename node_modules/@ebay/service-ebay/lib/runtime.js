const { promisify } = require('util');
const runtimeContext = require('@ebay/runtime-context-ebay');
const handlerFactory = require('@ebay/openapi-context-ebay');
const moduleConfig = promisify(require('@ebay/module-config-inc'));

const configPromise = moduleConfig(module);

function tryRequire(name) {
    try {
        return require(name);
    }
    catch (error) {
        // skip
    }
}

function resolveHandlers(handlers) {
    if (handlers && typeof handlers === 'object') {
        Object.keys(handlers).forEach(name => {
            if (typeof handlers[name] === 'string') {
                const handler = tryRequire(handlers[name]);
                if (!handler) {
                    throw new Error(`Failed to resolve handler ${name} at locaiton: ${handlers[name]}`);
                }
                handlers[name] = handler;
            }
        });
    }
    return handlers;
}

module.exports = async (options = {}) => {
    const config = options.config || await configPromise;
    const contentTypeFormatters = Object.assign({}, resolveHandlers(config.get('content-type-formatters')),
        options.contentTypeFormatters);
    return handlerFactory(Object.assign({}, {
        createContext: baseOptions => runtimeContext.create(Object.assign({}, baseOptions, options))
    }, options, { contentTypeFormatters }));
};

module.exports = Object.assign(module.exports, runtimeContext);
