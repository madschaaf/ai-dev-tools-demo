'use strict';

const os = require('os');
const appContext = require('@ebay/app-context-ebay');

const s_xors = [6, 7, 3, 5];

/*
 * req.pageStartTime from commons-inc
 * req.threadId from cal
 */
module.exports.generate = (req) => {
    const idData = [];
    const machineName = getMachineName(appContext.poolName, os.hostname());
    const ts = (req.pageStartTime || Date.now()).toString(16);
    let threadId = req.threadId || 1;
    threadId = '0x' + threadId.toString(16);
    idData.push(machineName);
    idData.push(ts);
    idData.push(threadId);
    return idData.join('-');
};

function getMachineName(poolName, hostname) {
    const machineName = [];
    // staging has odbName suffix
    poolName = poolName + (process.env.ODBMO_NAME &&
        process.env.PAAS_REALM === 'staging' && `-${process.env.ODBMO_NAME}` || '');
    machineName.push(poolName);
    machineName.push(hostname);
    return encodeURIComponent(encrypt(machineName.join('::')));
}

module.exports.getMachineName = getMachineName;

function encrypt(str) {
    const encryptedStr = [];
    for (let i = 0; i < str.length; i++) {
        const k = str.charCodeAt(i);
        const l = k^(s_xors[i % 4]);
        encryptedStr.push(String.fromCharCode(l));
    }
    return encryptedStr.join('');
}
