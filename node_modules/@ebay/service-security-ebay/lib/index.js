'use strict';
const Assert = require('assert');
const logger = require('@ebay/logging-inc').logger('service-security-ebay/index');
const debug = require('debug')('service-security-ebay:index');

const tokenUtils = require('./token-utils');

/* Plan:
* 1 validate route
* 2 get token from header
* 3 if token is reference, get full token
* 4 get attributes from cache
* 5 otherwise, validate token, get attributes and cachd
* 6 validate scope against swagger api scopes for the method
* 7 if error, generate json error
*/

module.exports = function factory(routeSecurity, securitySchemes) {
    const routeScopes = routeSecurity;
    const allowedScopes = securitySchemes &&
        securitySchemes.flows &&
        securitySchemes.flows.clientCredentials &&
        securitySchemes.flows.clientCredentials.scopes;

    // validate scopes
    if (routeScopes) {
        Assert.ok(allowedScopes, `No scopes found in security definitions ${JSON.stringify(securitySchemes)}`);
        routeScopes.forEach(scope => {
            Assert.ok(allowedScopes[scope],
                `Scope "${scope}" is not found in allowed scopes [${Object.keys(allowedScopes).join(', ')}]`);
        });
    }

    return async function security(req) {
        let tokenDetails = null;
        debug('security');

        if (!routeScopes ||
                (routeScopes.length === 0)) {
            const params = ['Authentication is not required for the route "%s"', req.path];
            logger.info(...params);
            debug(...params);
        }
        else {
            try {
                const attributes = await tokenUtils.getTokenDetails(req);
                // in: {attributes: <attrs>}
                tokenUtils.validateScopes(routeScopes, attributes);
                tokenDetails = attributes;
            }
            catch (err) {
                err.statusCode = err.statusCode || 403;
                throw err;
            }
        }

        req.security = {
            getTokenAttributes() {
                const details = this.getTokenDetails();
                return details?.attributes;
            },
            getTokenDetails() {
                return tokenDetails;
            }
        };
    };
};

module.exports.tokenUtils = tokenUtils;
