'use strict';

const logger = require('@ebay/logging-inc').logger('dfpnode/ExpirableCache');

class ExpirableCache {
    constructor(fetch) {
        this.cache = {};
        this.fetch = fetch;
    }

    async get(keyName) {
        if (!keyName) {
            throw new Error('Cache key name should not be empty or missing');
        }
        const doFetch = async () => {
            const val = await this.fetch(keyName).then(val => {
                if (!val.expiry) {
                    throw new Error(`Cache entry should have expiry property, which is the time of token expiration`);
                }
                const hardExpiry = new Date(val.expiry).getTime();
                const softExpiry = Date.now() + parseInt((hardExpiry - Date.now()) / 4);
                val.expireAt = softExpiry;
                val.expireHardAt = hardExpiry;
                return val;
            }).catch(err => err);
            if (val instanceof Error) {
                if (this.cache[keyName] instanceof Promise) {
                    delete this.cache[keyName];
                }
                throw val;
            }
            this.cache[keyName] = val;
            return val;
        };

        const val = this.cache[keyName];
        if (val) {
            if (val instanceof Promise) {
                return val;
            }
            if (val.expireHardAt > Date.now()) {
                if (val.expireAt < Date.now()) {
                    if (val.next) {
                        return val; // refresh promise pending already
                    }
                    val.next = doFetch()
                        .catch(err => {
                            logger.error(err);
                        })
                        .finally(() => {
                            val.next = undefined;
                        });
                }
                // soft expiration, still can return current token
                return val;
            }
        }

        const newVal = this.cache[keyName] = doFetch();
        return newVal;
    }
}

module.exports = {
    ExpirableCache
};
