# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is `@ebay/trust-fabric-ebay`, a Node.js client library for generating TrustFabric tokens to securely call Fidelius (secrets service) and other eBay internal services. The library implements both V3 and V4 token protocols with automatic token refresh, caching, and middleware for request validation.

## Development Commands

### Testing
- `npm test` or `yarn test` - Run all tests with Mocha (removes .beans and .cache directories first)
- `make test` - Alternative test command via Makefile
- To run a single test file: `./node_modules/.bin/mocha test/[specific-test].js --reporter spec --timeout 10s`

### Linting
- `npm run lint` - Run ESLint with checkstyle format
- `npm run lint-fix` - Auto-fix ESLint issues
- `make lint` - Alternative lint command via Makefile (uses JSHint)

### Coverage
- `npm run coverage` - Generate test coverage reports (HTML and text)
- `make coverage` - Alternative coverage command via Makefile

### Build
- `make all` - Run both lint and test (equivalent to CI pipeline)

## Architecture Overview

### Core Components

1. **TokenGenerator** (`lib/TokenGenerator.js`):
   - Main class for token generation and management
   - Supports both V3 and V4 TrustFabric protocols
   - Implements automatic token refresh with background timers
   - Handles DPoP (Demonstration of Proof of Possession) wrapping for V4
   - Manages encrypted token caching to disk
   - Instance limit enforcement (max 5 instances)

2. **Token Validation Middleware** (`middleware.js`):
   - Express middleware for validating incoming TrustFabric tokens
   - Supports enforcement and monitoring modes
   - IP validation and fallback mechanisms
   - Audit logging for security events

3. **Service Clients**:
   - `trust-fabric-service.js` - Communication with TrustFabric API
   - `cmpaas-service.js` - Integration with CMPaaS for grant file generation

4. **Utilities** (`lib/utils.js`):
   - Token expiration checking
   - Grant file reading (V3 and V4/DPoP formats)
   - Keychain integration for private key operations
   - Version detection logic

### Token Flow Architecture

- **V3 Flow**: Grant → Access Token → Refresh Token cycle
- **V4 Flow**: DPoP Grant → DPoP-wrapped tokens with enhanced security
- **Development Mode**: Self-signed JWT tokens for local development
- **Caching**: Encrypted refresh tokens stored on disk with rotating secret keys
- **Background Refresh**: Automatic token renewal at 50% of expiry time

### Configuration

The library uses `@ebay/module-config-inc` for configuration. Key config paths:

```javascript
// Middleware configuration
"trust-fabric-ebay": {
    "interceptHeaders": {
        "enabled": boolean,
        "mode": "disabled|monitoring|enforcement"
    },
    "trf-ip-check": {
        "disabled": boolean,
        "fallback": boolean
    }
}

// Refresh retry configuration
"refreshFailRetry": number // milliseconds for retry delay
```

### Environment-Specific Behavior

- **Development/Test**: Uses self-signed JWT tokens
- **Production**: Full TrustFabric token flow with CMPaaS integration
- **V4 Protocol**: Automatically detected and enabled for newer deployments

### Testing Strategy

- Unit tests for all core components
- Mock services using `nock` for HTTP interactions
- Test fixtures in `test/fixtures/`
- Environment setup via `test/fixtures/env.js`
- Comprehensive coverage of both V3 and V4 flows

### Dependencies

Key eBay-internal dependencies:
- `@ebay/service-client-ebay` - HTTP service client
- `@ebay/module-config-inc` - Configuration management
- `@ebay/app-context-ebay` - Application context
- `@ebay/logging-inc` - Logging framework
- `@ebay/environment-ebay` - Environment detection

External dependencies:
- `jsonwebtoken` - JWT token handling
- `raptor-cache` - Disk caching
- `lru-cache` - Memory caching
- `pino` - High-performance logging

## Special Notes

- The library maintains singleton behavior through the default export while allowing multiple instances via the TokenGenerator class
- Token instances are limited to 5 per process to prevent resource exhaustion
- Automatic failover from V4 to V3 protocols when necessary
- Built-in security measures including encrypted token storage and IP validation
- Comprehensive audit logging for security compliance