# prometheus-ebay

[![Build Status](https://go/-/nodejsci/job/nodejs/job/prometheus-ebay/job/master/badge/icon)](https://go/-/nodejsci/job/nodejs/job/prometheus-ebay/job/master/) [![Dependency Status](https://appvalidator.vip.qa.ebay.com/nodejs/prometheus-ebay.svg)](https://appvalidator.vip.qa.ebay.com/nodejs/prometheus-ebay)
[![Code Coverage](https://badgeme.vip.qa.ebay.com/badge/sonar/v0/coverage/prometheus-ebay)](http://sonar/dashboard/index?id=prometheus-ebay)


Prometheus metrics generator for eBay Node.js apps. Underlying it is using https://github.com/siimon/prom-client, when creating your own metrics, please be sure to read this part of the read me as well.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/prometheus-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

`npm install prometheus-ebay --save`

# Usage

## Middleware (Intercepts http requests)
Middleware to intercept HTTP requests for calculating response time histogram.

### Usage (only by platform use)

```javascript

    "@ebay/prometheus-ebay": {
        "enabled": true,
        "priority": 92,
        "module": {
            "name": "@ebay/prometheus-ebay/middleware"
        }
    }

    // OR
    const app = express();
    const prometheusMiddleware = require('@ebay/prometheus-ebay/middleware');
    ...
    app.use(prometheusMiddleware());
    ...
```

## Adding new platform metrics

```javascript
    const { platformMetrics } = require('@ebay/prometheus-ebay');

    const gauge = platformMetrics.createGauge(
        'nodejs_custom_metrics',
        'Custom Metric Help'
        ['metric_name']
    );

    gauge.set(metric_value);

    const counter = platformMetrics.createCounter(
        'nodejs_custom_metrics',
        'Custom Metric Help'
        ['metric_name']
    );

    counter.inc();
        
    const hist = platformMetrics.createHistogram(
        'nodejs_custom_metrics',
        'Custom Metric Help'
        ['metric_name']
    );
    
    hist.labels(...labels).observe(value)

```

## Adding application metrics

```javascript
    const { applicationMetrics } = require('@ebay/prometheus-ebay');

    // this metrics will be available at <hostname>:8083/admin/prometheus
    const gauge = applicationMetrics.createGauge(
        'nodejs_custom_metrics',
        'Custom Metric Help'
        ['metric_name']
    );

    gauge.set(metric_value);
```
## Adding custom metrics

```javascript
    const { Metrics } = require('@ebay/prometheus-ebay');

    // this metrics will be available at <hostname>:8083/admin/prometheus/your_domain_name
    const metrics = new Metrics('your_domain_name');

    const gauge = metrics.createGauge(
        'nodejs_custom_metrics',
        'Custom Metric Help'
        ['metric_name']
    );

    gauge.set(metric_value);
```

Once you define your app domain name for metrics, please register it with monitor/metrics team as '/admin/prometheus/{app_domain_name}'. You can reach them on slack channel `Sherlock-io-support`.

For more help on metrics definition, refer to https://github.com/siimon/prom-client#api

### Configuration

```javascript
    {
        "prometheus": {
            "enabled": true, //Enable/Disable Prometheus on VI
            "interceptRequest": false, //Enable/Disable intercepting HTTP Requests
            "tlsClientInfo": true, // Enable/Disable TLS client info metrics, true by default
            "histogramBuckets": [5, 10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240] //Histogram Buckets
        }
    }
```

### API

* `readMetrics()` : Returns metrics in JSON format
* `getDefaultMetrics()`: Returns default metrics object, which will have platform default metrics
* `getPrometheusClient`: Returns instance of `prom-client`, it is used for adding custom metrics.
